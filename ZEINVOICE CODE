*&---------------------------------------------------------------------*
*& Report ZMI_EINVOICE_PROCESS
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT zmi_einvoice_process.
INCLUDE zmi_einvoice_process_top.
DATA : lv_wbtl_url TYPE zeinv_wbtl_cred-url_einv_gen .

SELECTION-SCREEN BEGIN OF BLOCK b7 WITH FRAME TITLE TEXT-005.
  PARAMETERS sd_einv RADIOBUTTON GROUP rb2 USER-COMMAND us1 DEFAULT 'X'.
  PARAMETERS sd_sez RADIOBUTTON GROUP rb2 .
  PARAMETERS fi_einv RADIOBUTTON GROUP rb2. " MODIF ID hid.
SELECTION-SCREEN END OF BLOCK b7.

DATA print TYPE c LENGTH 1.
DATA : irnftxla TYPE char1 .

DATA : ex_days TYPE  i,
       ex_time TYPE  cva_time.

SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE TEXT-001.
  SELECT-OPTIONS so_bukrs FOR vbrk-bukrs NO-EXTENSION NO INTERVALS OBLIGATORY . """ default '1000'.
  SELECT-OPTIONS so_werks FOR vbrp-werks.
  SELECT-OPTIONS so_fkdat FOR vbrk-fkdat.
  SELECT-OPTIONS so_vbeln FOR vbrk-vbeln.
  SELECT-OPTIONS so_gjahr FOR vbrk-gjahr NO-EXTENSION NO INTERVALS MODIF ID md3.
SELECTION-SCREEN END OF BLOCK b1.

SELECTION-SCREEN BEGIN OF BLOCK b3 WITH FRAME TITLE TEXT-003.
  PARAMETERS disply RADIOBUTTON GROUP rb1 DEFAULT 'X' MODIF ID md1.
  PARAMETERS create RADIOBUTTON GROUP rb1 MODIF ID md4.
  PARAMETERS change RADIOBUTTON GROUP rb1 MODIF ID md2.
*              print  RADIOBUTTON GROUP rb1 MODIF ID md1.
  PARAMETERS qrb2c RADIOBUTTON GROUP rb1 MODIF ID hid.
SELECTION-SCREEN END OF BLOCK b3.

SELECTION-SCREEN BEGIN OF BLOCK b9 WITH FRAME TITLE TEXT-009.
*  parameters irnftxla as checkbox. "*DEFAULT 'X'.
  PARAMETERS: irnwbtl   AS CHECKBOX DEFAULT 'X' .
SELECTION-SCREEN END OF BLOCK b9.

" ===================================================================
" class lcl_event_receiver: local class to handle event DOUBLE_CLICK
" ==================================================================

CLASS lcl_event_receiver DEFINITION.
  PUBLIC SECTION.
    METHODS handle_double_click FOR EVENT double_click OF cl_gui_alv_grid IMPORTING e_row
                                                                                    e_column.
ENDCLASS.

" ----------------------------------------------------------------------*
" CLASS lcl_event_receiver IMPLEMENTATION
" ----------------------------------------------------------------------*
CLASS lcl_event_receiver IMPLEMENTATION.
  METHOD handle_double_click.
    " read selected row from internal table gt_sflight
    CLEAR gw_final.
    READ TABLE gt_final INDEX e_row-index INTO gw_final.
    IF e_column = 'VBELN'.
      IF gw_final-vbeln IS NOT INITIAL.
        SET PARAMETER ID 'VF' FIELD gw_final-vbeln.
        CALL TRANSACTION 'VF03' AND SKIP FIRST SCREEN.
      ENDIF.
    ELSEIF e_column = 'ITEM'.
      CLEAR wa_data.
      CLEAR gw_itm.
      REFRESH gt_itm[].
      LOOP AT ot_final INTO wa_data WHERE vbeln = gw_final-vbeln AND bukrs = gw_final-bukrs.
        MOVE-CORRESPONDING wa_data TO gw_itm.
        APPEND gw_itm TO gt_itm.
        CLEAR gw_itm.
        CLEAR wa_data.
      ENDLOOP.
      PERFORM display_itm_data.
    ENDIF.
  ENDMETHOD.

ENDCLASS.
""""***End For Double click

INITIALIZATION.
  REFRESH so_fkdat[].
  so_fkdat-low    = sy-datum - 1.
  so_fkdat-high   = sy-datum.
  so_fkdat-sign   = 'I'.
  so_fkdat-option = 'BT'.
  APPEND so_fkdat.

  """***For data referesh in internal table/ALV
  ls_stable-row = 'X'.
  ls_stable-col = 'X'.
  ""******

AT SELECTION-SCREEN.

AT SELECTION-SCREEN OUTPUT.
  PERFORM handle_sel_screen.

START-OF-SELECTION.

  IF sd_einv = 'X' or sd_sez = 'X'.
    SELECT werks FROM vbrp INTO TABLE @DATA(i_vbrp) WHERE werks IN @so_werks.
    SELECT * FROM zeinv_auth INTO TABLE @DATA(auth).
    LOOP AT i_vbrp INTO DATA(w_vbrp).
      READ TABLE auth TRANSPORTING NO FIELDS WITH KEY werks = w_vbrp-werks.
      IF sy-subrc IS NOT INITIAL.
        MESSAGE | You are not authorized for plant { w_vbrp-werks } | TYPE 'E'.
      ENDIF.
    ENDLOOP.

    PERFORM get_data.
    PERFORM prepare_field.
  ELSEIF fi_einv = 'X'.
    IF so_gjahr-low IS INITIAL.
      MESSAGE 'Please fill fiscal year' TYPE 'S' DISPLAY LIKE 'E'.
      LEAVE TO CURRENT TRANSACTION.
    ELSE.
      PERFORM get_data_fi.
      PERFORM prepare_data_fi.
    ENDIF.
  ENDIF.

  PERFORM display_rep.
*&---------------------------------------------------------------------*
*& Form GET_DATA
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_data.
  REFRESH gt_vbrk[].
  REFRESH gt_vbrp[].
  REFRESH gt_adrc[].
  REFRESH gt_cadrc[].
  REFRESH gt_vbpa[].
  REFRESH gt_kna1[].
  REFRESH gt_branch[].
  REFRESH gt_1bt001wv[].
  REFRESH gt_vbak[].
  REFRESH gt_vbap[].
  REFRESH gt_t001w[].
  REFRESH gt_marc[].
  REFRESH gt_prcd[].
  REFRESH gt_taxnum[].
  REFRESH gt_adr6[].
  REFRESH gt_cadr6[].
  REFRESH gt_tvzbt[].
  REFRESH gt_t005t[].
  REFRESH gt_irn[].
  REFRESH gt_tvfkt[].
  REFRESH gt_t005u[].

  SELECT * FROM vbrk
    INTO TABLE @gt_vbrk
    WHERE fkdat IN @so_fkdat
      AND vbeln IN @so_vbeln
      AND bukrs IN @so_bukrs
      AND fkart IN ( 'ZAFM', 'ZAST', 'ZEX1', 'ZEX2', 'ZFOC', 'ZG2', 'ZJOB', 'ZL2', 'ZOEM', 'ZOTH', 'ZREN', 'ZRE',
                     'ZREX' , 'ZREO', 'ZREA' , 'ZROH', 'ZSAM', 'YSTO', 'ZSCR', 'ZSER', 'ZTRD' , 'ZFOE' , 'ZTOL' , 'ZECM' , 'ZSPD' ,
                     'ZRLT' , 'ZSEZ' , 'ZWRE' , 'ZTLS' , 'ZTOL' ,  'ZEVH' , 'ZDEM', 'YRTO', 'ZINP' )  """ 'ZDOM' REMOVE SUMIT / RAJAT 23.12.21
      AND fksto  = ' '
      AND sfakn  = ' '
      AND rfbsk = 'C'.

  IF gt_vbrk[] IS INITIAL.
    RETURN.
  ENDIF.

  SELECT * FROM tvfkt
    INTO TABLE gt_tvfkt
    FOR ALL ENTRIES IN gt_vbrk
    WHERE fkart = gt_vbrk-fkart AND spras = 'E'.

  SELECT * FROM zsd_einvoice
    INTO TABLE gt_irn
    FOR ALL ENTRIES IN gt_vbrk
    WHERE vbeln = gt_vbrk-vbeln.     "" AND bukrs = gt_vbrk-bukrs.

  SELECT * FROM vbrp
    INTO TABLE @gt_vbrp
    FOR ALL ENTRIES IN @gt_vbrk
    WHERE vbeln  = @gt_vbrk-vbeln
      AND werks IN @so_werks AND fkimg <> '0.00'. "*AND vkgrp IN @so_vtweg.

  SELECT * FROM prcd_elements
    INTO CORRESPONDING FIELDS OF TABLE @gt_prcd
    FOR ALL ENTRIES IN @gt_vbrk
    WHERE knumv = @gt_vbrk-knumv
      AND kinak = ' '.

  SELECT * FROM vbak
    INTO TABLE @gt_vbak
    FOR ALL ENTRIES IN @gt_vbrp
    WHERE vbeln = @gt_vbrp-aubel.

  SELECT * FROM vbap
    INTO TABLE @gt_vbap
    FOR ALL ENTRIES IN @gt_vbrp
    WHERE vbeln = @gt_vbrp-aubel
      AND matnr = @gt_vbrp-matnr
      AND posnr = @gt_vbrp-aupos.

  SELECT * FROM vbpa
    INTO TABLE @gt_vbpa
    FOR ALL ENTRIES IN @gt_vbrp
    WHERE vbeln = @gt_vbrp-vbeln.

  SELECT * FROM adrc
    INTO TABLE @gt_cadrc
    FOR ALL ENTRIES IN @gt_vbpa
    WHERE addrnumber = @gt_vbpa-adrnr.

  SELECT * FROM kna1
    INTO TABLE @gt_kna1
    FOR ALL ENTRIES IN @gt_vbpa
*             FOR ALL ENTRIES IN @GT_VBRK
    WHERE kunnr = @gt_vbpa-kunnr.

  SELECT * FROM t005u
    INTO TABLE gt_t005u
    FOR ALL ENTRIES IN gt_cadrc
    WHERE spras = 'E'
      AND bland = gt_cadrc-region.

  SELECT * FROM t005t
    INTO TABLE @gt_t005t
    FOR ALL ENTRIES IN @gt_cadrc
    WHERE land1 = @gt_cadrc-country AND spras = 'E'.

  SELECT * FROM adr6
    INTO TABLE @gt_cadr6
    FOR ALL ENTRIES IN @gt_kna1
    WHERE addrnumber = @gt_kna1-adrnr.

  SELECT * FROM j_1bbranch
    INTO TABLE @gt_branch.
  " for all entries in @gt_vbrp
  " where branch  = @gt_vbrp-werks.
  " AND BUKRS   = @GT_VBRP-

*     SELECT * FROM J_1BT001WV
*              INTO TABLE @GT_1BT001WV
*              FOR ALL ENTRIES IN @GT_BRANCH
*              WHERE J_1BBRANCH = @GT_BRANCH-J_1BBRANCH.
  " AND POSNR  = @GT_VBRP-POSNR.

  SELECT * FROM t001w
    INTO TABLE @gt_t001w
    FOR ALL ENTRIES IN @gt_vbrp
    WHERE werks = @gt_vbrp-werks.

  SELECT * FROM t005u
    APPENDING TABLE gt_t005u
    FOR ALL ENTRIES IN gt_t001w
    WHERE spras = 'E'
      AND bland = gt_t001w-regio.

  SELECT * FROM adrc
    INTO TABLE @gt_adrc
    FOR ALL ENTRIES IN @gt_t001w
    WHERE addrnumber = @gt_t001w-adrnr.

  SELECT * FROM adr6
    INTO TABLE @gt_adr6
    FOR ALL ENTRIES IN @gt_t001w
    WHERE addrnumber = @gt_t001w-adrnr.

  SELECT * FROM dfkkbptaxnum
    INTO TABLE @gt_taxnum
    FOR ALL ENTRIES IN @gt_vbpa
    WHERE partner = @gt_vbpa-kunnr.

  SELECT * FROM marc
    INTO TABLE @gt_marc
    FOR ALL ENTRIES IN @gt_vbrp
    WHERE matnr = @gt_vbrp-matnr
      AND werks = @gt_vbrp-werks.

  SELECT * FROM tvzbt
    INTO TABLE @gt_tvzbt
    FOR ALL ENTRIES IN @gt_vbrk
    WHERE zterm = @gt_vbrk-zterm AND spras = 'E'.

  SELECT * FROM zsez_cust_einv
    INTO TABLE @gt_sez_cust
    FOR ALL ENTRIES IN @gt_vbrk
    WHERE kunnr = @gt_vbrk-kunag. " AND spras = 'E'.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form PREPARE_FIELD
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM prepare_field.
  REFRESH gt_final[].
  REFRESH ot_final[].
  CLEAR gw_final.

  LOOP AT gt_vbrp INTO gw_vbrp.

    REFRESH color_tab[].
    REFRESH lt_edit[].
    CLEAR gw_vbrk.
    CLEAR gw_t001w.
    CLEAR gw_adrc.
    CLEAR gw_vbpa_bp.
    CLEAR gw_vbpa_sh.
    CLEAR gw_kna1_bp.
    CLEAR gw_kna1_sh.
    CLEAR gw_cadrc_bp.
    CLEAR gw_cadrc_sh.
    CLEAR gw_vbap.
    CLEAR gw_vbak.
    CLEAR gw_marc.
    CLEAR gw_branch.
    CLEAR gw_taxnum_bp.
    CLEAR gw_taxnum_sh.
    CLEAR gw_adr6.
    CLEAR gw_cadr6_bp.
    CLEAR gw_cadr6_sh.
    CLEAR gw_vbpa_py.
    CLEAR gw_kna1_py.
    CLEAR gw_cadrc_py.
    CLEAR gw_tvzbt.
    CLEAR gw_t005t_bp.
    CLEAR gw_irn.
    CLEAR gw_tvfkt.
    CLEAR gw_t005u.

    READ TABLE gt_vbrk INTO gw_vbrk WITH KEY vbeln = gw_vbrp-vbeln.
    READ TABLE gt_t001w INTO gw_t001w WITH KEY werks = gw_vbrp-werks.
    READ TABLE gt_adrc INTO gw_adrc WITH KEY addrnumber = gw_t001w-adrnr.
    READ TABLE gt_adr6 INTO gw_adr6 WITH KEY addrnumber = gw_t001w-adrnr.

    READ TABLE gt_vbpa INTO gw_vbpa_bp WITH KEY vbeln = gw_vbrk-vbeln
                                                parvw = 'RE'.
    READ TABLE gt_kna1 INTO gw_kna1_bp WITH KEY kunnr = gw_vbpa_bp-kunnr.
    READ TABLE gt_cadrc INTO gw_cadrc_bp WITH KEY addrnumber = gw_vbpa_bp-adrnr.
    READ TABLE gt_cadr6 INTO gw_cadr6_bp WITH KEY addrnumber = gw_kna1_bp-adrnr.
    READ TABLE gt_t005t INTO gw_t005t_bp WITH KEY land1 = gw_cadrc_bp-country.

    READ TABLE gt_vbpa INTO gw_vbpa_sh WITH KEY vbeln = gw_vbrk-vbeln
                                                parvw = 'WE'.
    READ TABLE gt_kna1 INTO gw_kna1_sh WITH KEY kunnr = gw_vbpa_sh-kunnr.
    READ TABLE gt_cadrc INTO gw_cadrc_sh WITH KEY addrnumber = gw_vbpa_sh-adrnr.
    READ TABLE gt_cadr6 INTO gw_cadr6_sh WITH KEY addrnumber = gw_kna1_sh-adrnr.

    READ TABLE gt_vbpa INTO gw_vbpa_py WITH KEY kunnr = gw_vbrk-kunag
                                                parvw = 'PY'.
    READ TABLE gt_kna1 INTO gw_kna1_py WITH KEY kunnr = gw_vbpa_py-kunnr.
    READ TABLE gt_cadrc INTO gw_cadrc_py WITH KEY addrnumber = gw_kna1_py-adrnr.

    READ TABLE gt_vbap INTO gw_vbap WITH KEY vbeln = gw_vbrp-aubel
                                             matnr = gw_vbrp-matnr
                                             posnr = gw_vbrp-aupos.
    READ TABLE gt_vbak INTO gw_vbak WITH KEY vbeln = gw_vbap-vbeln.

    READ TABLE gt_marc INTO gw_marc WITH KEY matnr = gw_vbrp-matnr
                                             werks = gw_vbrp-werks.
    READ TABLE gt_branch INTO gw_branch WITH KEY bukrs  = gw_vbrk-bukrs
                                                 branch = gw_vbrk-bupla.

    READ TABLE gt_taxnum INTO gw_taxnum_bp WITH KEY partner = gw_vbpa_bp-kunnr.
    READ TABLE gt_taxnum INTO gw_taxnum_sh WITH KEY partner = gw_vbpa_sh-kunnr.

    READ TABLE gt_tvzbt INTO gw_tvzbt WITH KEY zterm = gw_vbrk-zterm.

    READ TABLE gt_irn INTO gw_irn WITH KEY vbeln = gw_vbrp-vbeln.         "" bukrs = gw_vbrk-bukrs.
    READ TABLE gt_tvfkt INTO gw_tvfkt WITH KEY fkart = gw_vbrk-fkart.

**    GW_FINAL-VAL_TOTINVVAL    = GW_vbrk-NETWR + gw_vbrk-MWSBk.

    gw_final-vbeln         = gw_vbrp-vbeln.
    gw_final-posnr         = gw_vbrp-posnr.
    gw_final-bukrs         = gw_vbrk-bukrs.
    gw_final-gstin         = gw_branch-gstin.
    gw_final-taxsch        = ' '.
    gw_final-version       = ' '.
    gw_final-irn           = gw_irn-irn.
    gw_final-server_dtl    = gw_irn-server_dtl.
    gw_final-cancd_irn     = gw_irn-cancd_irn.
    gw_final-einv_ack_no   = gw_irn-einv_ack_no.
    gw_final-einv_ack_date = gw_irn-einv_ack_date.
    gw_final-stat_ind      = '@5D@'. "*Yellow
    gw_final-item          = '@7Z@'. " 5G, HB, XP, 46, 7Z, P3

**BREAK mawai_abap.
    """IRN VALIDATION
    IF create = 'X' OR disply = 'X'.       "SK
      SELECT SINGLE fkdat, erzet FROM vbrk INTO @DATA(mm)
       WHERE vbeln = @gw_vbrk-vbeln
       AND FKART = 'ZOEM' .

      IF sy-subrc = 0.
        SELECT SINGLE * FROM zein_tab INTO @DATA(nb) WHERE vbeln =  @gw_vbrk-vbeln AND allowed = 'Y'.
        IF sy-subrc NE 0.
          IF mm-fkdat NE sy-datum.
            CALL FUNCTION 'SCOV_TIME_DIFF'
              EXPORTING
                im_date1              = mm-fkdat
                im_date2              = sy-datum
                im_time1              = mm-erzet
                im_time2              = sy-uzeit
              IMPORTING
                ex_days               = ex_days
                ex_time               = ex_time
              EXCEPTIONS
                start_larger_than_end = 1
                OTHERS                = 2.
            IF sy-subrc <> 0.
* Implement suitable error handling here
            ENDIF.
            IF ex_days GT 0 AND ex_time GT 0.
              " More than 24 hours have lapsed
*              MESSAGE |E-invoice generation is not possible as 24 hours have lapsed for invoice { wa_data-vbeln }.| TYPE 'E'.
              gw_final-irn = |E-invoice generation is not possible as 24 hours have lapsed for invoice { wa_data-vbeln }|.
              gw_irn-irn = |E-invoice generation is not possible as 24 hours have lapsed for invoice { wa_data-vbeln }|.
*              CONTINUE.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.

    """IRN VALIDATION

    """"****For Cell Color
    CLEAR wa_color.
    wa_color-fname = 'IRN'.
    wa_color-color-col = 3. " red color   5: "green color   3: "yellow    7:  "violet

    IF gw_irn-irn <> 'null' AND gw_irn-irn IS NOT INITIAL.
      gw_final-stat_ind = '@5B@'. "*Green

      """"****For Cell Color
      CLEAR wa_color.
      wa_color-fname = 'IRN'.
      wa_color-color-col = 5. " red color   5: "green color   3: "yellow    7:  "violet


      IF gw_final-cancd_irn = 'X'.    "gw_irn-cancd_irn = 'X'.
        gw_final-stat_ind = '@02@'. "*Cancel

        """"****For Cell Color
        CLEAR wa_color.
        wa_color-fname = 'IRN'.
        wa_color-color-col = 6. " red color   5: "green color   3: "yellow    7:  "violet
        "*GW_FINAL-ROWCOLOR = 'C311'.
        """****End:Row Color

      ENDIF.



      READ TABLE gt_irn INTO DATA(lv_irn) WITH KEY vbeln = gw_vbrp-vbeln cancd_irn = 'X' .
      IF lv_irn-cancd_irn = 'X' .
        gw_final-stat_ind = '@02@'. "*Cancel

        """"****For Cell Color
        CLEAR wa_color.
        wa_color-fname = 'IRN'.
        wa_color-color-col = 6. " red color   5: "green color   3: "yellow    7:  "violet
        "*GW_FINAL-ROWCOLOR = 'C311'.
        """****End:Row Color
        CLEAR lv_irn.
      ENDIF .

    ENDIF.
    APPEND wa_color TO color_tab.

    """*******Enable/Disable check Box.
    IF disply = 'X'.
      CLEAR ls_edit.
      ls_edit-fieldname = 'CHECK'.
      ls_edit-style     = cl_gui_alv_grid=>mc_style_disabled.
      ls_edit-style2    = space.
      ls_edit-style3    = space.
      ls_edit-style4    = space.
      ls_edit-maxlen    = 10.
      INSERT ls_edit INTO TABLE lt_edit.
    ELSEIF create = 'X'.
    ELSEIF change = 'X'.
    ENDIF.
    """*******End:Enable/Disable check Box.

    gw_final-sd_doc_typ   = gw_vbrk-fkart.
    gw_final-doc_typ_desc = gw_tvfkt-vtext.

    IF irnwbtl = 'X'.
      gw_final-server_dtl = 'WEBTEL'.
    ELSEIF irnftxla = 'X'.
      gw_final-server_dtl = 'TXLA'.
    ELSE.
      gw_final-server_dtl = 'MI'.
    ENDIF.

    IF
*      gw_vbrk-fkart = 'ZDOM'
          gw_vbrk-fkart = 'ZAFM'
       OR gw_vbrk-fkart = 'ZOEM'
       OR gw_vbrk-fkart = 'ZSPD'
       OR gw_vbrk-fkart = 'ZAST'
       OR gw_vbrk-fkart = 'ZFOC'
       OR gw_vbrk-fkart = 'ZOTH'
       OR gw_vbrk-fkart = 'ZROH'
       OR gw_vbrk-fkart = 'ZDMD'
       OR gw_vbrk-fkart = 'ZSAM'
       OR gw_vbrk-fkart = 'ZSCR'
       OR gw_vbrk-fkart = 'ZRE'
       OR gw_vbrk-fkart = 'ZREN'
*     or gw_vbrk-fkart = 'ZINV'
       OR gw_vbrk-fkart = 'ZJOB'
*     or gw_vbrk-fkart = 'ZSP'
       OR gw_vbrk-fkart = 'ZSER'
       OR gw_vbrk-fkart = 'ZTRD'
       OR gw_vbrk-fkart = 'YSTO'
       OR gw_vbrk-fkart = 'ZREX'
       OR gw_vbrk-fkart = 'ZREO'
       OR gw_vbrk-fkart = 'ZREA'
       OR gw_vbrk-fkart = 'ZRLT'
       OR gw_vbrk-fkart = 'ZTOL'
       OR gw_vbrk-fkart = 'ZTLS'
*       or gw_vbrk-fkart = 'ZDEM'
       OR gw_vbrk-fkart = 'ZEVH'
       OR gw_vbrk-fkart = 'ZWRE'
      """ or gw_vbrk-fkart = 'ZSEZ'
       OR gw_vbrk-fkart = 'ZECM'
       OR gw_vbrk-fkart = 'ZINP'
       OR gw_vbrk-fkart = 'YRTO'.
      " or gw_vbrk-fkart = 'ZFOE'.

      gw_final-tran_catg = 'B2B'. "

    ELSEIF (    gw_vbrk-fkart = 'ZG2'
             OR gw_vbrk-fkart = 'ZL2' ) AND gw_vbrk-vtweg <> 30.
      gw_final-tran_catg = 'B2B'. "

    ELSEIF (    gw_vbrk-fkart = 'ZG2'
             OR gw_vbrk-fkart = 'ZL2' ) AND gw_vbrk-vtweg = 30.
      gw_final-tran_catg = 'EXPWOP'. "

    ELSEIF gw_vbrk-fkart = 'ZEX2'.
      gw_final-tran_catg = 'EXPWP'.  "

    ELSEIF gw_vbrk-fkart = 'ZDEM'.
      gw_final-tran_catg = 'DEXP'.  "

    ELSEIF gw_vbrk-fkart = 'ZEX1' OR gw_vbrk-fkart = 'ZFOE'.
      gw_final-tran_catg = 'EXPWOP'. "

    ELSEIF gw_vbrk-fkart = 'ZSEZ'.
      gw_final-tran_catg = 'SEZWOP'. "
**                                                                                      "
*    ELSEIF ( gw_vbrk-fkart = 'ZSEZ' ) . ""OR gw_vbrk-fkart = 'ZDR' OR gw_vbrk-fkart = 'ZRE' )."AND gw_vbrk-pltyp EQ '4' AND gw_vbrp-kzwi4 EQ 0.
*      gw_final-tran_catg        = 'SEZWOP'.

*    ELSEIF ( gw_vbrk-fkart  = 'ZTLE'
*         OR gw_vbrk-fkart = 'ZTRE'
*         OR gw_vbrk-fkart = 'ZRLE'
*         OR gw_vbrk-fkart = 'ZFC2'
*         OR gw_vbrk-fkart = 'ZEX1'
*         OR gw_vbrk-fkart = 'ZEX2'
*         OR gw_vbrk-fkart = 'ZSER'
*         OR gw_vbrk-fkart = 'ZTM2'
*         OR gw_vbrk-fkart = 'ZRME' ) AND gw_vbrp-kzwi4 EQ 0.
*      gw_final-tran_catg        = 'EXPWOP'.

**    ELSEIF ( gw_vbrk-fkart  = 'ZTLE'
**         OR gw_vbrk-fkart = 'ZTRE'
**         OR gw_vbrk-fkart = 'ZRLE'
**         OR gw_vbrk-fkart = 'ZFC2'
**         OR gw_vbrk-fkart = 'ZEX1'
**         OR gw_vbrk-fkart = 'ZEX2'
**         OR gw_vbrk-fkart = 'ZSER'
**         OR gw_vbrk-fkart = 'ZTM2'
**         OR gw_vbrk-fkart = 'ZRME' ) AND gw_vbrp-kzwi4 NE 0.
**      gw_final-tran_catg        = 'EXPWP'.

**    ELSEIF gw_vbrk-fkart = 'ZDMD'.
**      gw_final-tran_catg        = 'DEXP'.
**
**    ELSEIF gw_vbrk-fkart = 'ZSEZ' AND gw_vbrp-kzwi4 EQ 0.
**      gw_final-tran_catg        = 'SEZWOP'.
**
**    ELSEIF gw_vbrk-fkart = 'ZSEZ' AND gw_vbrp-kzwi4 NE 0.
**      gw_final-tran_catg        = 'SEZWP'.

    ENDIF.
 IF sd_sez = 'X'.
   gw_final-tran_catg = 'SEZWOP'. " #NV
 ENDIF.

    gw_final-tran_regrev = 'RG'.

    IF gw_vbpa_bp-kunnr = gw_vbpa_sh-kunnr.
      gw_final-tran_typ = 'REG'. ""Charge Type
    ELSE.
      gw_final-tran_typ = 'SHP'. ""Charge Type
    ENDIF.

    gw_final-tran_ecmtrn   = ' '.
    gw_final-tran_ecmgstin = ' '.

    IF    gw_vbrk-fkart = 'ZAFM'
       OR gw_vbrk-fkart = 'ZOEM'
       OR gw_vbrk-fkart = 'ZSPD'
       OR gw_vbrk-fkart = 'ZAST'
       OR gw_vbrk-fkart = 'ZFOC'
       OR gw_vbrk-fkart = 'ZOTH'
       OR gw_vbrk-fkart = 'ZROH'
       OR gw_vbrk-fkart = 'ZDMD'
       OR gw_vbrk-fkart = 'ZSAM'
       OR gw_vbrk-fkart = 'ZSCR'
       OR gw_vbrk-fkart = 'ZJOB'
       OR gw_vbrk-fkart = 'ZSER'
       OR gw_vbrk-fkart = 'ZTRD'
       OR gw_vbrk-fkart = 'YSTO'
       OR gw_vbrk-fkart = 'ZRLT'
       OR gw_vbrk-fkart = 'ZREN'
       OR gw_vbrk-fkart = 'ZTOL'
       OR gw_vbrk-fkart = 'ZTOL'
       OR gw_vbrk-fkart = 'ZTLS'
       OR gw_vbrk-fkart = 'ZDEM'
       OR gw_vbrk-fkart = 'ZEVH'
      OR gw_vbrk-fkart = 'ZFOE'
       OR gw_vbrk-fkart = 'ZSEZ'
       OR gw_vbrk-fkart = 'ZECM'
       OR gw_vbrk-fkart = 'ZEX1'
       OR gw_vbrk-fkart = 'ZEX2'
       OR gw_vbrk-fkart = 'YRTO'
       OR gw_vbrk-fkart = 'ZINP'.
      gw_final-doc_typ = 'INV'.
    ELSEIF gw_vbrk-fkart = 'ZG2' OR gw_vbrk-fkart = 'ZRE' OR gw_vbrk-fkart = 'ZREN' OR gw_vbrk-fkart = 'ZREX' OR gw_vbrk-fkart = 'ZREA' OR gw_vbrk-fkart = 'ZREO' OR gw_vbrk-fkart = 'ZWRE'.
      gw_final-doc_typ = 'CRN'.
    ELSEIF gw_vbrk-fkart = 'ZL2'.
      gw_final-doc_typ = 'DBN'.
    ENDIF.

*    gw_final-doc_no           = gw_vbrk-vbeln.
    gw_final-doc_no         = gw_vbrk-xblnr.
    gw_final-doc_orginvno   = gw_vbak-xblnr.
    gw_final-doc_dt         = gw_vbrk-fkdat.

    gw_final-billfrom_gstin = gw_branch-gstin.
    gw_final-billfrom_trdnm = gw_t001w-name1 && gw_t001w-name2.
    gw_final-billfrom_bno   = gw_adrc-street && gw_adrc-str_suppl1.
    gw_final-billfrom_bnm   = gw_adrc-str_suppl2 && gw_adrc-str_suppl3.
    gw_final-billfrom_flno  = gw_adrc-str_suppl3.
    gw_final-billfrom_loc   = gw_adrc-city1.
    gw_final-billfrom_dst   = gw_adrc-city1.
    gw_final-billfrom_pin   = gw_adrc-post_code1.
    gw_final-billfrom_stcd  = gw_t001w-regio.
    gw_final-billfrom_ph    = gw_adrc-tel_number.
    gw_final-billfrom_em    = gw_adr6-smtp_addr.

    gw_final-shipfrom_gstin = gw_branch-gstin.
    gw_final-shipfrom_trdnm = gw_t001w-name1 && gw_t001w-name2.
    gw_final-shipfrom_bno   = gw_adrc-street && gw_adrc-str_suppl1.
    gw_final-shipfrom_bnm   = gw_adrc-str_suppl2 && gw_adrc-str_suppl3.
    gw_final-shipfrom_flno  = gw_adrc-str_suppl3.
    gw_final-shipfrom_loc   = gw_adrc-city1.
    gw_final-shipfrom_dst   = gw_adrc-city1.
    gw_final-shipfrom_pin   = gw_adrc-post_code1.
    CLEAR gw_t005u.
    READ TABLE gt_t005u INTO gw_t005u WITH KEY bland = gw_t001w-regio
                                               land1 = gw_t001w-land1.

    gw_final-shipfrom_stcd = gw_t005u-bland. " GW_T001W-REGIO. " deepak
    gw_final-shipfrom_ph   = gw_adrc-tel_number.
    gw_final-shipfrom_em   = gw_adr6-smtp_addr.

    " * GW_FINAL-SHIPFROM_GSTIN   = GW_TAXNUM_SH-TAXNUM.
    " * GW_FINAL-SHIPFROM_TRDNM   = GW_CADRC_SH-NAME1 && GW_CADRC_SH-NAME2.
    " * GW_FINAL-SHIPFROM_BNO     = GW_CADRC_SH-STREET && GW_CADRC_SH-STR_SUPPL1.
    " * GW_FINAL-SHIPFROM_BNM     = GW_CADRC_SH-STREET && GW_CADRC_SH-STR_SUPPL2.
    " * GW_FINAL-SHIPFROM_FLNO    = ' '.
    " * GW_FINAL-SHIPFROM_LOC     = GW_CADRC_SH-CITY1.
    " * GW_FINAL-SHIPFROM_DST     = GW_CADRC_SH-CITY2.
    " * GW_FINAL-SHIPFROM_PIN     = GW_CADRC_SH-POST_CODE1.
    " * CLEAR: GW_T005U.
    " * READ TABLE GT_T005U INTO GW_T005U WITH KEY BLAND = GW_CADRC_SH-REGION LAND1 = GW_CADRC_SH-COUNTRY.
    " * GW_FINAL-SHIPFROM_STCD    = GW_T005U-BEZEI. "GW_CADRC_SH-REGION.
    " * GW_FINAL-SHIPFROM_PH      = GW_CADRC_SH-TEL_NUMBER.
    " * GW_FINAL-SHIPFROM_EM      = GW_CADR6_SH-SMTP_ADDR.

    IF gw_vbrk-vtweg = '30'. "*pltyp = '2'.
      gw_final-billto_gstin = 'URP'.
    ELSE.
      gw_final-billto_gstin = gw_kna1_bp-stcd3. "*GW_TAXNUM_BP-TAXNUM.  ""
    ENDIF.

    gw_final-billto_trdnm = gw_cadrc_bp-name1 && gw_cadrc_bp-name2.
    gw_final-billto_bno   = gw_cadrc_bp-street && gw_cadrc_bp-str_suppl1.
    gw_final-billto_bnm   = gw_cadrc_bp-street && gw_cadrc_bp-str_suppl2.
    gw_final-billto_flno  = ' '.
    gw_final-billto_loc   = gw_cadrc_bp-city1.
    gw_final-billto_dst   = gw_cadrc_bp-city2.

    IF gw_vbrk-vtweg = '30'. "*pltyp = '2'.
      gw_final-billto_pin  = '999999'.
      gw_final-billto_stcd = '96'.

    ELSE.
      gw_final-billto_pin  = gw_cadrc_bp-post_code1.
      gw_final-billto_stcd = gw_cadrc_bp-region.
    ENDIF.

    gw_final-billto_ph = gw_cadrc_bp-tel_number.
    gw_final-billto_em = gw_cadr6_bp-smtp_addr.

**    IF gw_final-tran_catg = 'DEXP' AND gw_final-tran_typ = 'SHP' AND gw_vbrk-land1 NE 'IN'.            """"" ADDED BY SUMIT 01.04.2021
**      gw_final-shipto_gstin = 'URP'.                                                                   """"" ADDED BY SUMIT 01.04.2021
**    ELSEIF  gw_vbrk-pltyp = '2'.
**      gw_final-shipto_gstin = 'URP'.

    IF gw_vbrk-vtweg = '30'.
      gw_final-shipto_gstin = 'URP'.
    ELSE.
      gw_final-shipto_gstin = gw_kna1_sh-stcd3.
    ENDIF.

    gw_final-shipto_trdnm = gw_cadrc_sh-name1 && gw_cadrc_sh-name2.
    gw_final-shipto_bno   = gw_cadrc_sh-street && gw_cadrc_sh-str_suppl1.
    gw_final-shipto_bnm   = gw_cadrc_sh-street && gw_cadrc_sh-str_suppl2.
    gw_final-shipto_flno  = ' '.
    gw_final-shipto_loc   = gw_cadrc_sh-city1.
    gw_final-shipto_dst   = gw_cadrc_sh-city2.

**    IF gw_final-tran_catg = 'DEXP' AND gw_final-tran_typ = 'SHP' AND gw_vbrk-land1 NE 'IN'.            """"" ADDED BY SUMIT 01.04.2021
**      gw_final-shipto_pin       = '999999'.                                                            """"" ADDED BY SUMIT 01.04.2021
**    ELSEIF  gw_vbrk-vtweg = '20'.
**      gw_final-shipto_pin       = '999999'.

    IF gw_vbrk-vtweg = '30'.
      gw_final-shipto_pin = '999999'.
    ELSE.
      gw_final-shipto_pin = gw_cadrc_sh-post_code1.
    ENDIF.

**    IF gw_final-tran_catg = 'DEXP' AND gw_final-tran_typ = 'SHP' AND gw_vbrk-land1 NE 'IN'.            """"" ADDED BY SUMIT 01.04.2021
**      gw_final-shipto_stcd = '97'.                                                                     """"" ADDED BY SUMIT 01.04.2021
**      gw_cadrc_sh-region   = '97'.                                                                     """"" ADDED BY SUMIT 01.04.2021
**    ELSE
    IF gw_vbrk-vtweg = '30'.
      gw_cadrc_sh-region   = '96'.
      gw_final-shipto_stcd = '96'.
    ELSE.
      CLEAR gw_t005u.
      READ TABLE gt_t005u INTO gw_t005u WITH KEY bland = gw_cadrc_sh-region
                                                 land1 = gw_cadrc_sh-country.
      gw_final-shipto_stcd = gw_t005u-bland. "gw_t005u-bezei. deepak
    ENDIF.

    gw_final-shipto_ph = gw_cadrc_sh-tel_number.
    gw_final-shipto_em = gw_cadr6_sh-smtp_addr.

    """"**********For B2C Customer*************
**    if gw_final-billto_gstin = 'URP' and ( gw_vbrk-vtweg = '10' or gw_vbrk-vtweg = '30' ).
**      gw_final-tran_catg     = 'B2C'.
**    endif.
    """"**********End: For B2C Customer*************

    IF gw_vbap-kdmat IS NOT INITIAL.
      gw_final-item_prdnm = gw_vbap-kdmat.
    ELSE.
      gw_final-item_prdnm = gw_vbrp-matnr.
    ENDIF.

    gw_final-item_prddesc = gw_vbrp-arktx. " From Read text 0002
    IF gw_vbrp-arktx IS INITIAL.

      CLEAR gv_vbeln.
      CLEAR gw_tdline.
      REFRESH gt_tdline[].
      gv_vbeln = gw_vbrk-vbeln && gw_vbrp-posnr.
      CALL FUNCTION 'READ_TEXT'
        EXPORTING
          client                  = sy-mandt
          id                      = 'GRUN'
          language                = 'E'
          name                    = gv_vbeln
          object                  = 'VBBP'
          archive_handle          = 0
          local_cat               = ' '
        TABLES
          lines                   = gt_tdline[]
        EXCEPTIONS
          id                      = 1
          language                = 2
          name                    = 3
          not_found               = 4
          object                  = 5
          reference_check         = 6
          wrong_access_to_archive = 7
          OTHERS                  = 8.

      READ TABLE gt_tdline INTO gw_tdline INDEX 1.
      gw_final-item_prddesc = gw_tdline-tdline.

    ENDIF.

    gw_final-item_hsncd = gw_marc-steuc.
    gw_final-item_qty   = gw_vbrp-fkimg.

    SELECT SINGLE * FROM zunit INTO @DATA(lw_unit) WHERE vrkme = @gw_vbrp-vrkme.

    gw_final-item_unit      = lw_unit-unit.
    " GW_FINAL-ITEM_UNIT        = GW_VBRP-VRKME.

    gw_final-item_barcde    = ' '.
    gw_final-item_freeqty   = ' '.

    gw_final-itm_sr_num     = gw_vbrp-posnr. "*Mandatory

    gw_final-itm_is_service = 'N'. "*Mandatory
    " BREAK MAWAI_ABAP .
    SELECT SINGLE hsncode FROM zsd_hsn INTO @DATA(hsn_code) WHERE hsncode = @gw_final-item_hsncd.
    IF hsn_code IS NOT INITIAL.
      gw_final-itm_is_service = 'Y'.
    ENDIF.
    CLEAR hsn_code.

    gw_final-itm_cntry_orgin = gw_t001w-land1. "'52'. "GW_T001W-LAND1.     "*Mandatory
    IF gw_final-itm_cntry_orgin IS INITIAL.
      gw_final-itm_cntry_orgin = '52'. " GW_T001W-LAND1.     "*Mandatory
    ENDIF.
    gw_final-itm_odr_line_ref      = gw_vbrp-vgpos.     "*Mandatory
    gw_final-itm_prodct_sr_num     = gw_vbrp-vgpos.     "*Mandatory
    gw_final-atr_itm_attribte_detl = 'ATTR-1'.          "*Mandatory
    gw_final-atr_itm_attribte_val  = 'Attribute Value'. "*Mandatory

    CLEAR item_unitprice.
*    item_unitprice = ( gw_vbrp-kzwi1 / gw_final-item_qty ).
*    gw_final-item_unitprice   = item_unitprice * gw_vbrk-kurrf.

    gw_final-itm_pre_tax_val = ' '.
    gw_final-item_discount   = ' '.
    gw_final-val_disc        = ' '.

**    LOOP AT gt_vbrp INTO DATA(xs_vbrp) WHERE vbeln = gw_vbrp-vbeln AND posnr = gw_vbrp-posnr.
**      gw_final-val_othchrg      = gw_final-val_othchrg + gw_vbrp-kzwi5 * gw_vbrk-kurrf.
**
**      gw_final-item_totamt      = gw_final-item_totamt + gw_vbrp-kzwi2 * gw_vbrk-kurrf.
**      gw_final-item_assamt      = gw_final-item_assamt + gw_vbrp-kzwi2 * gw_vbrk-kurrf.
**      gw_final-val_assval       = gw_final-val_assval + gw_vbrp-kzwi2 * gw_vbrk-kurrf.
**
**      CLEAR: xs_vbrp.
**    ENDLOOP.

    CLEAR itm_totamt.
*      .
    LOOP AT gt_prcd INTO gw_prcd WHERE knumv = gw_vbrk-knumv AND kposn = gw_vbrp-posnr.
*      if gw_vbrk-waerk = 'USD' or gw_vbrk-waerk = 'GBP' or gw_vbrk-waerk = 'EUR'.
*        if gw_vbrk-waerk = 'GBP'.
*          gw_prcd-kwert /= 100.
*        else.
*          gw_prcd-kwert /= 100.
*        endif.
*      endif.
      IF gw_prcd-kschl = 'ZPR0' OR gw_prcd-kschl = 'ZMAN' OR gw_prcd-kschl = 'ZMRP'.
        IF gw_vbrp-fkimg <> '0.00' AND gw_vbrp-fkimg IS NOT INITIAL.
          item_unitprice = ( gw_prcd-kwert * gw_vbrk-kurrf ) / gw_vbrp-fkimg.
        ENDIF.
        IF gw_vbrk-vtweg EQ '30' AND gw_vbrk-waerk NE 'INR'.
          gw_final-item_unitprice = item_unitprice / 1000.
        ELSE.
          gw_final-item_unitprice = item_unitprice.
        ENDIF.

      ELSEIF    gw_prcd-kschl = 'JTC1' OR gw_prcd-kschl = 'JTC2' OR gw_prcd-kschl = 'YTCS'
             OR gw_prcd-kschl = 'ZINS' OR gw_prcd-kschl = 'ZFOB'.
        gw_final-val_othchrg    += ( gw_prcd-kwert * gw_vbrk-kurrf ).

      ELSEIF gw_prcd-kschl = 'JOCG'.
        gw_final-item_cgstrt   = gw_prcd-kbetr.
        gw_final-val_cgstval  += gw_prcd-kwert * gw_vbrk-kurrf.
        gw_final-itm_gst_rate += gw_prcd-kbetr.
        gw_final-itm_cgst_amt  = gw_prcd-kwert * gw_vbrk-kurrf.

      ELSEIF gw_prcd-kschl = 'JOSG' OR gw_prcd-kschl = 'JOUG'.
        gw_final-item_sgstrt   = gw_prcd-kbetr.
        gw_final-val_sgstval  += gw_prcd-kwert * gw_vbrk-kurrf.
        gw_final-itm_gst_rate += gw_prcd-kbetr.
        gw_final-itm_sgst_amt  = gw_prcd-kwert * gw_vbrk-kurrf.

      ELSEIF gw_prcd-kschl = 'JOIG'.
        gw_final-item_igstrt   = gw_prcd-kbetr.
        gw_final-val_igstval  += gw_prcd-kwert * gw_vbrk-kurrf.
        gw_final-itm_gst_rate += gw_prcd-kbetr.
        IF gw_vbrk-vtweg EQ '30' AND gw_vbrk-waerk NE 'INR'.
          gw_final-itm_igst_amt  = gw_prcd-kwert * gw_vbrk-kurrf / 1000.
        ELSE.
          gw_final-itm_igst_amt  = gw_prcd-kwert * gw_vbrk-kurrf.
        ENDIF.

      ELSEIF gw_prcd-kschl = 'DIFF'. """ VAL_DT_ROUNDOFF
        gw_final-val_dt_roundoff += ( gw_prcd-kwert * gw_vbrk-kurrf ).

      ELSEIF    gw_prcd-kschl = 'ZMDS' OR gw_prcd-kschl = 'ZCSD' OR gw_prcd-kschl = 'ZTRD' OR gw_prcd-kschl = 'ZTR1'
             OR gw_prcd-kschl = 'ZTR2'.

        gw_final-val_disc += ( gw_prcd-kwert * gw_vbrk-kurrf ).

      ENDIF.

*      IF gw_prcd-kschl = 'ZPR0'.
*        itm_totamt = ( gw_prcd-kwert * gw_vbrk-kurrf ) + itm_totamt.
*        gw_final-item_totamt = itm_totamt.
*      ENDIF.

      IF gw_prcd-kschl = 'ZGST'.
        IF gw_vbrk-vtweg EQ '30' AND gw_vbrk-waerk NE 'INR'.
          gw_final-item_totamt += gw_prcd-kwert * gw_vbrk-kurrf / 1000.
          gw_final-item_assamt += gw_prcd-kwert * gw_vbrk-kurrf / 1000.
          gw_final-val_assval  += gw_prcd-kwert * gw_vbrk-kurrf / 1000.
        ELSE.
          gw_final-item_totamt += gw_prcd-kwert * gw_vbrk-kurrf.
          gw_final-item_assamt += gw_prcd-kwert * gw_vbrk-kurrf.
          gw_final-val_assval  += gw_prcd-kwert * gw_vbrk-kurrf.
        ENDIF.
      ENDIF.

      CLEAR gw_prcd.
    ENDLOOP.

**    gw_final-item_assamt = gw_final-item_assamt + gw_final-item_discount.
**    gw_final-val_assval       = gw_final-val_assval + gw_final-item_discount.
    gw_final-item_totitemval           = gw_final-item_assamt + gw_final-itm_cgst_amt + gw_final-itm_sgst_amt + gw_final-itm_igst_amt.
    gw_final-val_totinvval            += gw_final-item_totitemval + gw_final-val_othchrg.
    gw_final-itm_cess_amt              = ' '.
    gw_final-itm_stat_cess_amt         = ' '.
    gw_final-itm_stat_cess_nadvol_amt  = ' '.

    gw_final-item_cesrt                = ' '.
    gw_final-item_cesnonadval          = ' '.
    gw_final-item_stateces             = ' '.
    gw_final-item_batch_nm             = ' '.
    gw_final-item_batch_expdt          = ' '.
    gw_final-item_batch_wrdt           = ' '.
    gw_final-val_cesval                = ' '.
    gw_final-val_stcesval              = ' '.
    gw_final-val_cesnonadval           = ' '.
    gw_final-val_dt_tot_inv_ac         = ' '.

    " GW_FINAL-PAY_NAM          = GW_CADRC_PY-NAME1 && GW_CADRC_PY-NAME2.
    gw_final-pay_mode                  = gw_tvzbt-vtext.
    gw_final-pay_payterm               = ' '.
    gw_final-pay_payinstr              = ' '.
    gw_final-pay_dirdr                 = ' '.
    gw_final-pay_crday                 = ' '.
    gw_final-pay_balamt                = ' '.
    gw_final-pay_payduedt              = ' '.
    gw_final-account_details           = ' '.
    gw_final-credit_transfer           = ' '.
    gw_final-branch_or_ifsc            = ' '.
    gw_final-payee_name                = ' '.

    gw_final-contrct_recpt_adv_num     = ' '.
    gw_final-contrct_recpt_adv_dat     = ' '.
    gw_final-contrct_batch_ref_num     = ' '.
    gw_final-contrct_contrct_ref_num   = ' '.
    gw_final-contrct_othr_ref          = ' '.
    gw_final-contrct_proj_ref_num      = ' '.
    gw_final-contrct_ven_po_ref_num    = ' '.
    gw_final-contrct_ven_po_ref_dat    = ' '.

    gw_final-addl_sup_doc_url          = ' '.
    gw_final-addl_sup_doc              = ' '.
    gw_final-addl_info                 = ' '.
    gw_final-oth_ref                   = '122'.

    CLEAR gv_vbeln.
    CLEAR gw_tdline.
    REFRESH gt_tdline[].
    gv_vbeln = gw_vbrk-vbeln.
    CALL FUNCTION 'READ_TEXT'
      EXPORTING
        client                  = sy-mandt
        id                      = '0002'
        language                = 'E'
        name                    = gv_vbeln
        object                  = 'VBBK'
        archive_handle          = 0
        local_cat               = ' '
      TABLES
        lines                   = gt_tdline[]
      EXCEPTIONS
        id                      = 1
        language                = 2
        name                    = 3
        not_found               = 4
        object                  = 5
        reference_check         = 6
        wrong_access_to_archive = 7
        OTHERS                  = 8.

    READ TABLE gt_tdline INTO gw_tdline INDEX 1.
    gw_final-ref_invrmk    = gw_tdline-tdline.

    gw_final-ref_invstdt   = ' '.
    gw_final-ref_invenddt  = ' '.
    gw_final-ref_precinvno = ' '.
    gw_final-ref_precinvdt = ' '.

    gw_final-exp_shipbno   = ' '.
    gw_final-exp_shipbdt   = ' '.

    CLEAR gv_vbeln.
    CLEAR gw_tdline.
    REFRESH gt_tdline[].
    gv_vbeln = gw_vbrk-vbeln.
    CALL FUNCTION 'READ_TEXT'
      EXPORTING
        client                  = sy-mandt
        id                      = 'ZR04'
        language                = 'E'
        name                    = gv_vbeln
        object                  = 'VBBK'
        archive_handle          = 0
        local_cat               = ' '
      TABLES
        lines                   = gt_tdline[]
      EXCEPTIONS
        id                      = 1
        language                = 2
        name                    = 3
        not_found               = 4
        object                  = 5
        reference_check         = 6
        wrong_access_to_archive = 7
        OTHERS                  = 8.

    READ TABLE gt_tdline INTO gw_tdline INDEX 1.
    gw_final-exp_port    = gw_tdline-tdline.

    gw_final-exp_forcur  = gw_vbrk-waerk.     "
    gw_final-exp_cntcode = gw_t005t_bp-landx. "
    gw_final-rfnd_clm    = 'N'.

    gw_final-payee_acc   = '054075221001'.
    gw_final-payee_ifsc  = 'HSBC0110005'.

    " *********    added by sumit  -----------------  "" 05.03.2021
    CLEAR gw_final-billfrom_ph.
    CLEAR gw_final-billfrom_ph.
    CLEAR gw_final-shipfrom_ph.
    CLEAR gw_final-shipto_ph.
    " *********    ---------------------------------

    """""" special charater .

    REPLACE ALL OCCURRENCES OF ',' IN gw_final-shipfrom_ph WITH '' .
    REPLACE ALL OCCURRENCES OF '"' IN gw_final-shipfrom_ph WITH '' .
    REPLACE ALL OCCURRENCES OF ':' IN gw_final-shipfrom_ph WITH '' .
    REPLACE ALL OCCURRENCES OF '-' IN gw_final-shipfrom_ph WITH '' .
    REPLACE ALL OCCURRENCES OF ',' IN gw_final-shipfrom_ph WITH '' .

    """"""""""""""""""

    """*****Condense all field
    CONDENSE gw_final-check.
    CONDENSE gw_final-gstin.
    CONDENSE gw_final-taxsch.
    CONDENSE gw_final-version.
    CONDENSE gw_final-irn.
    CONDENSE gw_final-tran_catg.
    CONDENSE gw_final-tran_regrev.
    CONDENSE gw_final-tran_typ.
    CONDENSE gw_final-tran_ecmtrn.
    CONDENSE gw_final-tran_ecmgstin.
    CONDENSE gw_final-doc_typ.
    CONDENSE gw_final-doc_no.
    CONDENSE gw_final-doc_orginvno.
    CONDENSE gw_final-doc_dt.
    CONDENSE gw_final-billfrom_gstin.
    CONDENSE gw_final-billfrom_trdnm.
    CONDENSE gw_final-billfrom_bno.
    CONDENSE gw_final-billfrom_bnm.
    CONDENSE gw_final-billfrom_flno.
    CONDENSE gw_final-billfrom_loc.
    CONDENSE gw_final-billfrom_dst.
    CONDENSE gw_final-billfrom_pin.
    CONDENSE gw_final-billfrom_stcd.
    CONDENSE gw_final-billfrom_ph.
    CONDENSE gw_final-billfrom_em.
    CONDENSE gw_final-billto_gstin.
    CONDENSE gw_final-billto_trdnm.
    CONDENSE gw_final-billto_bno.
    CONDENSE gw_final-billto_bnm.
    CONDENSE gw_final-billto_flno.
    CONDENSE gw_final-billto_loc.
    CONDENSE gw_final-billto_dst.
    CONDENSE gw_final-billto_pin.
    CONDENSE gw_final-billto_stcd.
    CONDENSE gw_final-billto_ph.
    CONDENSE gw_final-billto_em.
    CONDENSE gw_final-shipfrom_gstin.
    CONDENSE gw_final-shipfrom_trdnm.
    CONDENSE gw_final-shipfrom_bno.
    CONDENSE gw_final-shipfrom_bnm.
    CONDENSE gw_final-shipfrom_flno.
    CONDENSE gw_final-shipfrom_loc.
    CONDENSE gw_final-shipfrom_dst.
    CONDENSE gw_final-shipfrom_pin.
    CONDENSE gw_final-shipfrom_stcd.
    CONDENSE gw_final-shipfrom_ph.
    CONDENSE gw_final-shipfrom_em.
    CONDENSE gw_final-shipto_gstin.
    CONDENSE gw_final-shipto_trdnm.
    CONDENSE gw_final-shipto_bno.
    CONDENSE gw_final-shipto_bnm.
    CONDENSE gw_final-shipto_flno.
    CONDENSE gw_final-shipto_loc.
    CONDENSE gw_final-shipto_dst.
    CONDENSE gw_final-shipto_pin.
    CONDENSE gw_final-shipto_stcd.
    CONDENSE gw_final-shipto_ph.
    CONDENSE gw_final-shipto_em.
    CONDENSE gw_final-item_prdnm.
    CONDENSE gw_final-item_prddesc.
    CONDENSE gw_final-item_hsncd.
    CONDENSE gw_final-item_barcde.
    CONDENSE gw_final-item_qty.
    CONDENSE gw_final-item_freeqty.
    CONDENSE gw_final-item_unit.
    CONDENSE gw_final-item_unitprice.
    CONDENSE gw_final-item_totamt.
    CONDENSE gw_final-item_discount.
    CONDENSE gw_final-item_othchrg.
    CONDENSE gw_final-item_assamt.
    CONDENSE gw_final-item_cgstrt.
    CONDENSE gw_final-item_sgstrt.
    CONDENSE gw_final-item_igstrt.
    CONDENSE gw_final-item_cesrt.
    CONDENSE gw_final-item_cesnonadval.
    CONDENSE gw_final-item_stateces.
    CONDENSE gw_final-item_totitemval.
    CONDENSE gw_final-item_batch_nm.
    CONDENSE gw_final-item_batch_expdt.
    CONDENSE gw_final-item_batch_wrdt.
    CONDENSE gw_final-val_assval.
    CONDENSE gw_final-val_cgstval.
    CONDENSE gw_final-val_sgstval.
    CONDENSE gw_final-val_igstval.
    CONDENSE gw_final-val_cesval.
    CONDENSE gw_final-val_stcesval.
    CONDENSE gw_final-val_cesnonadval.
    CONDENSE gw_final-val_disc.
    CONDENSE gw_final-val_othchrg.
    CONDENSE gw_final-val_totinvval.
    CONDENSE gw_final-pay_mode.
    CONDENSE gw_final-pay_payterm.
    CONDENSE gw_final-pay_payinstr.
    CONDENSE gw_final-pay_dirdr.
    CONDENSE gw_final-pay_crday.
    CONDENSE gw_final-pay_balamt.
    CONDENSE gw_final-pay_payduedt.
    CONDENSE gw_final-ref_invrmk.
    CONDENSE gw_final-ref_invstdt.
    CONDENSE gw_final-ref_invenddt.
    CONDENSE gw_final-ref_precinvno.
    CONDENSE gw_final-ref_precinvdt.
    CONDENSE gw_final-exp_shipbno.
    CONDENSE gw_final-exp_shipbdt.
    CONDENSE gw_final-exp_port.
    CONDENSE gw_final-exp_forcur.
    CONDENSE gw_final-exp_cntcode.
    CONDENSE gw_final-itm_pre_tax_val.
    CONDENSE gw_final-itm_gst_rate.
    CONDENSE gw_final-itm_cgst_amt.
    CONDENSE gw_final-itm_sgst_amt.
    CONDENSE gw_final-itm_igst_amt.
    CONDENSE gw_final-val_dt_roundoff.

******    ------------------------------------------ *reduce* REDUCING DECIMALS TO 2 DIGIT ADDED BY SUMIT ... 05.03.2021
**       .
    CLEAR lv_curr_con.
    lv_curr_con = gw_final-itm_pre_tax_val.
    CLEAR gw_final-itm_pre_tax_val.
    gw_final-itm_pre_tax_val = lv_curr_con.

**    CLEAR : LV_CURR_CON.
**    LV_CURR_CON = GW_FINAL-ITM_GST_RATE.
**    CLEAR : GW_FINAL-ITM_GST_RATE.
**    GW_FINAL-ITM_GST_RATE = LV_CURR_CON .

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-itm_cgst_amt.
    CLEAR gw_final-itm_cgst_amt.
    gw_final-itm_cgst_amt = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-itm_sgst_amt.
    CLEAR gw_final-itm_sgst_amt.
    gw_final-itm_sgst_amt = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-itm_igst_amt.
    CLEAR gw_final-itm_igst_amt.
    gw_final-itm_igst_amt = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-val_dt_roundoff.
    CLEAR gw_final-val_dt_roundoff.
    gw_final-val_dt_roundoff = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-val_totinvval.
    CLEAR gw_final-val_totinvval.
    gw_final-val_totinvval = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-val_disc.
    CLEAR gw_final-val_disc.
    gw_final-val_disc = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-val_othchrg.
    CLEAR gw_final-val_othchrg.
    gw_final-val_othchrg = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-val_assval.
    CLEAR gw_final-val_assval.
    gw_final-val_assval = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-val_cgstval.
    CLEAR gw_final-val_cgstval.
    gw_final-val_cgstval = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-val_sgstval.
    CLEAR gw_final-val_sgstval.
    gw_final-val_sgstval = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-val_igstval.
    CLEAR gw_final-val_igstval.
    gw_final-val_igstval = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-item_totitemval.
    CLEAR gw_final-item_totitemval.
    gw_final-item_totitemval = lv_curr_con.

    " * CLEAR : LV_CURR_CON.
    " * LV_CURR_CON = GW_FINAL-ITEM_CGSTRT.
    " * CLEAR : GW_FINAL-ITEM_CGSTRT.
    " * GW_FINAL-ITEM_CGSTRT = LV_CURR_CON .
    "
    " * CLEAR : LV_CURR_CON.
    " * LV_CURR_CON = GW_FINAL-ITEM_SGSTRT.
    " * CLEAR : GW_FINAL-ITEM_SGSTRT..
    " * GW_FINAL-ITEM_SGSTRT = LV_CURR_CON .
    "
    " * CLEAR : LV_CURR_CON.
    " * LV_CURR_CON = GW_FINAL-ITEM_IGSTRT.
    " * CLEAR : GW_FINAL-ITEM_IGSTRT..
    " * GW_FINAL-ITEM_IGSTRT = LV_CURR_CON .

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-item_assamt.
    CLEAR gw_final-item_assamt.
    gw_final-item_assamt = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-item_unitprice.
    CLEAR gw_final-item_unitprice.
    gw_final-item_unitprice = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-item_totamt.
    CLEAR gw_final-item_totamt.
    gw_final-item_totamt = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-item_discount.
    CLEAR gw_final-item_discount.
    gw_final-item_discount = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-item_othchrg.
    CLEAR gw_final-item_othchrg.
    gw_final-item_othchrg = lv_curr_con.

    CLEAR lv_curr_con.
    lv_curr_con = gw_final-val_dt_roundoff.
    CLEAR gw_final-val_dt_roundoff.
    gw_final-val_dt_roundoff = lv_curr_con.

    CONDENSE gw_final-itm_pre_tax_val.
    CONDENSE gw_final-val_dt_roundoff.
    CONDENSE gw_final-itm_gst_rate.
    CONDENSE gw_final-itm_cgst_amt.
    CONDENSE gw_final-itm_sgst_amt.
    CONDENSE gw_final-itm_igst_amt.
    CONDENSE gw_final-val_dt_roundoff.
    CONDENSE gw_final-val_totinvval.
    CONDENSE gw_final-val_disc.
    CONDENSE gw_final-val_othchrg.
    CONDENSE gw_final-val_assval.
    CONDENSE gw_final-val_cgstval.
    CONDENSE gw_final-val_sgstval.
    CONDENSE gw_final-val_igstval.
    CONDENSE gw_final-item_totitemval.
    CONDENSE gw_final-item_cgstrt.
    CONDENSE gw_final-item_sgstrt.
    CONDENSE gw_final-item_igstrt.
    CONDENSE gw_final-item_assamt.
    CONDENSE gw_final-item_unitprice.
    CONDENSE gw_final-item_totamt.
    CONDENSE gw_final-item_discount.
    CONDENSE gw_final-item_othchrg.
    CONDENSE gw_final-item_unit.
    " *********    ---------------------------------

    CLEAR gw_sez_cust.
    READ TABLE gt_sez_cust INTO gw_sez_cust WITH KEY "  vbeln = gw_vbrk-vbeln
                                                                              kunnr = gw_vbrk-kunrg.
    IF sy-subrc = 0.
      gw_final-tran_catg    = gw_sez_cust-supply_type.
      gw_final-billto_gstin = gw_sez_cust-buyer_gstin.
      gw_final-billto_pin   = gw_sez_cust-buyer_pin.
      gw_final-billto_stcd  = gw_sez_cust-buyer_statecode.
      gw_final-shipto_gstin = gw_sez_cust-ship_gstin.
      gw_final-shipto_pin   = gw_sez_cust-ship_pin.
      gw_final-shipto_stcd  = gw_sez_cust-ship_statecode.

      CONDENSE gw_final-tran_catg.
      CONDENSE gw_final-billto_gstin.
      CONDENSE gw_final-billto_pin.
      CONDENSE gw_final-billto_stcd.
      CONDENSE gw_final-shipto_gstin.
      CONDENSE gw_final-shipto_pin.
      CONDENSE gw_final-shipto_stcd.

    ENDIF.

    INSERT LINES OF color_tab INTO TABLE gw_final-colortab.
    INSERT LINES OF lt_edit   INTO TABLE gw_final-style.

    "   .
    IF sy-sysid = 'ELD' OR sy-sysid = 'ELQ'.

**        gw_final-gstin =  '09AAAPG7885R002' .
**        gw_final-BILLFROM_GSTIN =  '09AAAPG7885R002' .
**        gw_final-BILLFROM_PIN  = '201301' .
**        gw_final-BILLFROM_STCD = '09' .
    ENDIF.

    APPEND gw_final TO gt_final.

    CLEAR gw_vbrp.
    CLEAR gw_final.
    CLEAR gv_oth_charge_gst.
  ENDLOOP.

  IF gt_final[] IS NOT INITIAL.
    ot_final[] = gt_final[].
  ENDIF.

  SORT gt_final BY vbeln
                   bukrs.
  DELETE ADJACENT DUPLICATES FROM gt_final COMPARING vbeln bukrs.
* .
  LOOP AT gt_final INTO DATA(w_f).
    REFRESH t_f[].
    t_f[] = ot_final[].
    SORT t_f[] BY vbeln
                  bukrs.
    DELETE t_f WHERE bukrs <> w_f-bukrs.
    DELETE t_f WHERE vbeln <> w_f-vbeln.
    CLEAR w_f-val_assval.
    CLEAR w_f-val_cgstval.
    CLEAR w_f-val_sgstval.
    CLEAR w_f-val_igstval.
    CLEAR w_f-val_cesval.
    CLEAR w_f-branch_or_ifsc.
    CLEAR w_f-val_totinvval.
    CLEAR w_f-val_stcesval.
    CLEAR w_f-val_disc.
    CLEAR w_f-val_othchrg.
    CLEAR w_f-itm_gst_rate.
    CLEAR w_f-val_dt_roundoff.
    LOOP AT t_f INTO DATA(tw_f).

      w_f-val_cgstval     += tw_f-itm_cgst_amt.
      w_f-val_sgstval     += tw_f-itm_sgst_amt.
      w_f-val_igstval     += tw_f-itm_igst_amt.
      w_f-val_cesval      += tw_f-val_cesval.
      w_f-branch_or_ifsc  += tw_f-branch_or_ifsc.
      w_f-val_totinvval   += tw_f-val_totinvval.
      w_f-val_stcesval    += tw_f-val_stcesval.
      w_f-val_disc        += tw_f-val_disc.
      w_f-val_assval      += tw_f-val_assval.
      w_f-val_othchrg     += tw_f-val_othchrg.
      w_f-val_dt_roundoff += tw_f-val_dt_roundoff.
*      gw_final-val_dt_roundoff

      CLEAR tw_f.
    ENDLOOP.
    CONDENSE w_f-val_assval.
    CONDENSE w_f-val_cgstval.
    CONDENSE w_f-val_sgstval.
    CONDENSE w_f-val_igstval.
    CONDENSE w_f-val_cesval.
    CONDENSE w_f-branch_or_ifsc.
    CONDENSE w_f-val_totinvval.
    CONDENSE w_f-val_stcesval.
    CONDENSE w_f-val_disc.
    CONDENSE w_f-val_dt_roundoff.
    CONDENSE w_f-val_othchrg.

    MODIFY gt_final FROM w_f TRANSPORTING val_assval val_cgstval val_sgstval val_igstval val_cesval branch_or_ifsc val_totinvval val_dt_roundoff
                        val_stcesval val_disc val_othchrg WHERE vbeln = w_f-vbeln AND bukrs = w_f-bukrs.
    CLEAR w_f.
    CLEAR tw_f.
  ENDLOOP.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form DISPLAY_REP
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_rep.
  IF create = 'X'.
    DELETE gt_final WHERE stat_ind <> '@5D@'.
  ELSEIF change = 'X'.
    DELETE gt_final WHERE stat_ind <> '@5B@'.
  ELSEIF print = 'X'.
    DELETE gt_final WHERE irn IS INITIAL.
    DELETE gt_final WHERE stat_ind = '@02@'.
  ELSEIF disply = 'X'.
  ELSEIF qrb2c = 'X'.
    DELETE gt_final WHERE tran_catg <> 'B2C'.
    DELETE gt_final WHERE stat_ind <> '@5D@'.
  ENDIF.

  CALL SCREEN 9001.
ENDFORM.
*&---------------------------------------------------------------------*
*& Module STATUS_9001 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE status_9001 OUTPUT.

  IF disply = 'X'.
    SET PF-STATUS 'ZMI_STAT_9001_DISP'.
    SET TITLEBAR 'ZTIT_9001_DISP'.
  ELSEIF create = 'X'.
    SET PF-STATUS 'ZMI_STAT_9001_CREATE'.
    SET TITLEBAR 'ZTIT_9001_CREATE'.
  ELSEIF change = 'X'.
    SET PF-STATUS 'ZMI_STAT_9001_CHANGE'.
    SET TITLEBAR 'ZTIT_9001_CHANGE'.
  ELSEIF print = 'X'.
    SET PF-STATUS 'ZMI_STAT_9001_PRINT'.
    SET TITLEBAR 'ZTIT_9001_PRINT'.
  ELSEIF qrb2c = 'X'.
    SET PF-STATUS 'ZMI_STAT_9001_QRB2C'.
    SET TITLEBAR 'ZTIT_9001_QRB2C'.
*  ELSEIF DETAIL = 'X'.
*    SET PF-STATUS 'ZMI_STAT_9001_DTL'.
*    SET TITLEBAR 'ZTIT_9001_DTL'.
  ENDIF.

*  IF SY-UNAME = 'MAWAI_ABAP'.
*    SET PF-STATUS 'ZSTAT_9001_MI'.
*     SET TITLEBAR 'ZTIT_9001'.
*  ENDIF.


  PERFORM prepare_and_display_alv.
ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_9001  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE user_command_9001 INPUT.
  CLEAR gw_girn.
  CLEAR gw_cirn.
  CASE sy-ucomm.

    WHEN 'BACK'.
      PERFORM free_objects_sd.
      PERFORM free_used_variables.
      LEAVE TO SCREEN 0.

    WHEN 'EXIT'.
      PERFORM free_objects_sd.
      PERFORM free_used_variables.
      LEAVE TO SCREEN 0.

    WHEN 'CANCEL'.
      PERFORM free_objects_sd.
      PERFORM free_used_variables.
      LEAVE TO SCREEN 0.

    WHEN 'PRINT'.
      osd_grid->check_changed_data( ).
*      """"******
      osd_grid->refresh_table_display( is_stable = ls_stable ).
*      """"******
      PERFORM print_invoice.
      osd_grid->check_changed_data( ).
*      """"******
      osd_grid->refresh_table_display( is_stable = ls_stable ).
*      """"******
      """"For Mater India API.
    WHEN 'MIIRN'.
*      """"""""PC(12.11.25)""""""
*      select single * from @gt_prcd as prcd
*         where kschl in ( 'JOIG' ,'JOCG' , 'JOSG' )
*        into @data(w_prcd).
*        if sy-subrc ne 0.
*          MESSAGE 'No tax applied on sales invoice' TYPE 'E'.
*          endif.
*      """"""""""""""""""""""""""
      CLEAR gw_girn.
      CLEAR gw_cirn.
      CLEAR gw_canbdoc.
      gw_girn = 'X'.
      osd_grid->check_changed_data( ).
*      """"******
      osd_grid->refresh_table_display( is_stable = ls_stable ).
*      """"******
      CLEAR gs_irn.
      IF irnwbtl = 'X' .
        PERFORM generate_irn_from_webtel.
      ELSEIF irnftxla IS INITIAL.
        PERFORM get_credential_data.
        PERFORM get_token_from_mi.
        PERFORM generate_irn_form_mi.
      ELSEIF irnftxla = 'X'.
        PERFORM generate_irn_form_taxila.
      ENDIF.
      osd_grid->check_changed_data( ).
*      """"******
      osd_grid->refresh_table_display( is_stable = ls_stable ).
*      """"******

    WHEN 'MICIRN'.
      CLEAR gw_girn.
      CLEAR gw_cirn.
      CLEAR gw_canbdoc.
      gw_cirn = 'X'.
      osd_grid->check_changed_data( ).
*      """"******
      osd_grid->refresh_table_display( is_stable = ls_stable ).
*      """"******
      .
      IF irnwbtl = 'X' .
        PERFORM cancel_irn_from_webtel.
      ELSEIF irnftxla IS INITIAL.
        PERFORM get_credential_data.
        PERFORM get_token_from_mi.
        PERFORM cancel_irn_from_mi.
      ELSEIF irnftxla = 'X'.
        PERFORM cancel_irn_from_taxila.
      ENDIF.
      osd_grid->check_changed_data( ).
*      """"******
      osd_grid->refresh_table_display( is_stable = ls_stable ).
*      """"******

    WHEN 'MIGDTL'.
      CLEAR gw_girn.
      CLEAR gw_cirn.
      CLEAR gw_canbdoc.
      gw_cirn = 'X'.
      osd_grid->check_changed_data( ).
*      """"******
      osd_grid->refresh_table_display( is_stable = ls_stable ).
*      """"******
      PERFORM get_credential_data.
      PERFORM get_token_from_mi.
      PERFORM get_irn_detail_mi.
      osd_grid->check_changed_data( ).
*      """"******
      osd_grid->refresh_table_display( is_stable = ls_stable ).
*      """"******
      """"End: For Mater India API.

    WHEN 'QRB2C'.
      CLEAR qr_b2c.
*      """"******
      osd_grid->check_changed_data( ).
      osd_grid->refresh_table_display( is_stable = ls_stable ).
*      """"******

      IF irnftxla IS INITIAL.
        PERFORM get_credential_data.
        PERFORM get_token_from_mi.
        PERFORM generate_qrb2c_form_mi.
      ELSEIF irnftxla = 'X'.

      ENDIF.

*      """"******
      osd_grid->check_changed_data( ).
      osd_grid->refresh_table_display( is_stable = ls_stable ).
*      """"******


  ENDCASE.

ENDMODULE.
*&---------------------------------------------------------------------*
*& Form PREPARE_AND_DISPLAY_ALV
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM prepare_and_display_alv.
  " Creating Docking Container and Grid
  PERFORM create_object_sd.
  " Field Catalog Table
  IF qrb2c <> 'X'.
    PERFORM create_fieldcat_sd.
  ELSE.
    PERFORM create_fieldcat_qrb2c.
  ENDIF.
  " Display the Output
  PERFORM display_output_sd.
ENDFORM.

*&---------------------------------------------------------------------*
*& Form FREE_OBJECTS_SD
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM free_objects_sd.
  osd_grid->free( EXCEPTIONS cntl_error        = 1
                             cntl_system_error = 2
                             OTHERS            = 3 ).
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
               WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form FREE_USED_VARIABLES
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM free_used_variables.
  REFRESH gt_final[].
ENDFORM.

*&---------------------------------------------------------------------*
*& Form CREATE_OBJECT_SD
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_object_sd.
  "*Refresh screen elements
  IF alv_container IS BOUND.
    FREE osd_grid.
    alv_container->free( ).
  ENDIF.

  alv_container = NEW #( container_name = 'SDCONT' ).

  IF sy-subrc = 0.
    osd_grid = NEW #( i_parent = alv_container ).
  ENDIF.

  IF disply IS INITIAL.
    PERFORM hide_alv_function.
  ENDIF.
  PERFORM register_edit_event.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form CREATE_FIELDCAT_SD
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_fieldcat_sd.
  DATA count TYPE i.

  REFRESH sd_fieldcat[].

  """"""********************Start:Main Header****************************************************
  count += 1.
  PERFORM fcat
    USING count
          'CHECK'
          'SELECT'
          '6'
          abap_false.
  count += 1.
  PERFORM fcat
    USING count
          'STAT_IND'
          'STATUS'
          '6'
          abap_false.
  count += 1.
  PERFORM fcat
    USING count
          'DOC_TYP_DESC'
          'Doc Description'
          '15'
          abap_false.
  count += 1.
  PERFORM fcat
    USING count
          'VBELN'
          'Billing Doc'
          '12'
          abap_false.
  count += 1.
  PERFORM fcat
    USING count
          'ITEM'
          'Item'
          '4'
          abap_false.
  count += 1.
  PERFORM fcat
    USING count
          'GSTIN'
          'GSTIN'
          '18'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'IRN'
          'IRN'
          '68'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'SERVER_DTL'
          'Server Detail'
          '10'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'BUKRS'
          'Company Code'
          '10'
          abap_true.
  """"""********************End:Main Header****************************************************

*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'TAXSCH'           'TAXSCH'            '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'VERSION'          'VERSION'           '15' ABAP_TRUE.
  count += 1.
  PERFORM fcat
    USING count
          'TRAN_CATG'
          'Supply_type'
          '15'
          abap_true.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'TRAN_REGREV'      'TRAN_REGREV'       '15' ABAP_TRUE.
  count += 1.
  PERFORM fcat
    USING count
          'TRAN_TYP'
          'Charge_type'
          '15'
          abap_true.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'TRAN_ECMTRN'      'TRAN_ECMTRN'       '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'TRAN_ECMGSTIN'    'Ecommerce_gstin'     '15' ABAP_TRUE.

  """"""********************Start: document_details****************************************************
  count += 1.
  PERFORM fcat
    USING count
          'DOC_TYP'
          'Document_type'
          '15'
          abap_true. " document_type
  count += 1.
  PERFORM fcat
    USING count
          'DOC_NO'
          'Document_number'
          '15'
          abap_true. " document_number
  count += 1.
  PERFORM fcat
    USING count
          'DOC_DT'
          'Document_date'
          '15'
          abap_true. " document_date
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'DOC_ORGINVNO'     'DOC_ORGINVNO'      '15' ABAP_TRUE.
  """"""********************End: document_details****************************************************

  """"""********************Start: Seller_details****************************************************
  count += 1.
  PERFORM fcat
    USING count
          'BILLFROM_GSTIN'
          'Seller gstin'
          '15'
          abap_true. " gstin":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLFROM_TRDNM'
          'Seller:legal_name'
          '15'
          abap_true. " legal_name":'  / "trade_name":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLFROM_BNO'
          'Seller:address1'
          '15'
          abap_true. " address1":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLFROM_BNM'
          'Seller:address2'
          '15'
          abap_true. " address2":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLFROM_LOC'
          'Seller:location'
          '15'
          abap_true. " location":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLFROM_PIN'
          'Seller:pincode'
          '15'
          abap_true. " pincode":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLFROM_STCD'
          'Seller:state_code'
          '15'
          abap_true. " state_code":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLFROM_PH'
          'Seller:phone_number'
          '15'
          abap_true. " phone_number":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLFROM_EM'
          'Seller:email'
          '15'
          abap_true. " email":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'BILLFROM_FLNO'    'BILLFROM_FLNO'     '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'BILLFROM_DST'     'BILLFROM_DST'      '15' ABAP_TRUE.
  """"""********************End: Seller_details****************************************************

  """"""********************Start: Buyer_details****************************************************
  count += 1.
  PERFORM fcat
    USING count
          'BILLTO_GSTIN'
          'Buyer gstin'
          '15'
          abap_true. " gstin":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLTO_TRDNM'
          'Buyer:legal_name'
          '15'
          abap_true. " legal_name":'  / "trade_name":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLTO_BNO'
          'Buyer:address1'
          '15'
          abap_true. " address1":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLTO_BNM'
          'Buyer:address2'
          '15'
          abap_true. " address2":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLTO_LOC'
          'Buyer:location'
          '15'
          abap_true. " location":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLTO_PIN'
          'Buyer:pincode'
          '15'
          abap_true. " pincode":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLTO_STCD'
          'Buyer:state_code'
          '15'
          abap_true. " state_code":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLTO_PH'
          'Buyer:phone_number'
          '15'
          abap_true. " phone_number":'
  count += 1.
  PERFORM fcat
    USING count
          'BILLTO_EM'
          'Buyer:email'
          '15'
          abap_true. " email":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'BILLTO_FLNO'      'BILLTO_FLNO'       '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'BILLTO_DST'       'BILLTO_DST'        '15' ABAP_TRUE.
  """"""********************End: Buyer_details****************************************************

  """"""********************Start: dispatch_details****************************************************
  count += 1.
  PERFORM fcat
    USING count
          'SHIPFROM_GSTIN'
          'Dispatch:GSTIN'
          '15'
          abap_true. " gstin":'
  count += 1.
  PERFORM fcat
    USING count
          'SHIPFROM_TRDNM'
          'Dispatch:company_name'
          '15'
          abap_true. " company_name"
  count += 1.
  PERFORM fcat
    USING count
          'SHIPFROM_BNO'
          'Dispatch:address1'
          '15'
          abap_true. " address1"
  count += 1.
  PERFORM fcat
    USING count
          'SHIPFROM_BNM'
          'Dispatch:address2'
          '15'
          abap_true. " address2"
  count += 1.
  PERFORM fcat
    USING count
          'SHIPFROM_LOC'
          'Dispatch:location'
          '15'
          abap_true. " location":'
  count += 1.
  PERFORM fcat
    USING count
          'SHIPFROM_PIN'
          'Dispatch:pincode'
          '15'
          abap_true. " pincode":'
  count += 1.
  PERFORM fcat
    USING count
          'SHIPFROM_STCD'
          'Dispatch:state_code'
          '15'
          abap_true. " state_code":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'SHIPFROM_FLNO'    'SHIPFROM_FLNO'     '15' ABAP_TRUE.
  count += 1.
  PERFORM fcat
    USING count
          'SHIPFROM_PH'
          'Dispatch: PH. No.'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'SHIPFROM_EM'
          'Dispatch: Email '
          '15'
          abap_true.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'SHIPFROM_DST'     'SHIPFROM_DST'      '15' ABAP_TRUE.
  """"""********************End: dispatch_details****************************************************

  """"""********************Start: ship_details****************************************************
  count += 1.
  PERFORM fcat
    USING count
          'SHIPTO_GSTIN'
          'Ship:GSTIN'
          '15'
          abap_true. " gstin":
  count += 1.
  PERFORM fcat
    USING count
          'SHIPTO_TRDNM'
          'Ship:company_name'
          '15'
          abap_true. " legal_name":'  / "trade_name":'
  count += 1.
  PERFORM fcat
    USING count
          'SHIPTO_BNO'
          'Ship:address1'
          '15'
          abap_true. " address1"
  count += 1.
  PERFORM fcat
    USING count
          'SHIPTO_BNM'
          'Ship:address2'
          '15'
          abap_true. " address2"
  count += 1.
  PERFORM fcat
    USING count
          'SHIPTO_LOC'
          'Ship:location'
          '15'
          abap_true. " location":'
  count += 1.
  PERFORM fcat
    USING count
          'SHIPTO_PIN'
          'Ship:pincode'
          '15'
          abap_true. " pincode":'
  count += 1.
  PERFORM fcat
    USING count
          'SHIPTO_STCD'
          'Ship:state_code'
          '15'
          abap_true. " state_code":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'SHIPTO_FLNO'      'SHIPTO_FLNO'       '15' ABAP_TRUE.
  count += 1.
  PERFORM fcat
    USING count
          'SHIPTO_PH'
          'Ship: PH No.'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'SHIPTO_EM'
          'Ship: Email'
          '15'
          abap_true.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'SHIPTO_DST'       'SHIPTO_DST'        '15' ABAP_TRUE.
  """"""********************End: ship_details****************************************************

  """"""********************Start:Item Detail****************************************************
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITM_SR_NUM'       'Item_serial_number'        '15' ABAP_TRUE.     "item_serial_number":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_PRDDESC'     'Product_description'      '15' ABAP_TRUE.     "product_description":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITM_IS_SERVICE'   'Is_service'    '15' ABAP_TRUE.     "is_service":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_HSNCD'       'HSN_code'        '15' ABAP_TRUE.     "hsn_code":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_PRDNM'       'ITEM_PRDNM'        '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_BARCDE'      'Bar_code'       '15' ABAP_TRUE.     "bar_code":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_QTY'         'Quantity'          '15' ABAP_TRUE.     "quantity":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_FREEQTY'     'Free_quantity'      '15' ABAP_TRUE.     "free_quantity":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_UNIT'        'Unit'         '15' ABAP_TRUE.     "unit":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_UNITPRICE'   'Unit_price'    '15' ABAP_TRUE.     "unit_price":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_TOTAMT'      'Total_amount'       '15' ABAP_TRUE.     "total_amount":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITM_PRE_TAX_VAL'  'Pre_tax_value'   '15' ABAP_TRUE.     "pre_tax_value":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_DISCOUNT'    'Discount'     '15' ABAP_TRUE.     "discount":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_OTHCHRG'     'Other_charge'      '15' ABAP_TRUE.     "other_charge":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_ASSAMT'      'Assessable_value'       '15' ABAP_TRUE.     "assessable_value":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITM_GST_RATE'     'GST_rate'         '15' ABAP_TRUE.     "gst_rate":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITM_IGST_AMT'     'IGST_amount'      '15' ABAP_TRUE.     "igst_amount":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITM_CGST_AMT'     'CGST_amount'      '15' ABAP_TRUE.     "cgst_amount":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITM_SGST_AMT'     'SGST_amount'      '15' ABAP_TRUE.     "sgst_amount":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_CESRT'       'Cess_rate'        '15' ABAP_TRUE.   "cess_rate"
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITM_CESS_AMT'     'Cess_amount'      '15' ABAP_TRUE.   "cess_amount":  """"""""Need To Add
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_CESNONADVAL' 'Cess_nonadvol_value'   '15' ABAP_TRUE.   "cess_nonadvol_value"
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITM_STAT_CESS_RATE'       'State_cess_rate'             '15' ABAP_TRUE.   "state_cess_rate":'            """"""""Need To Add
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITM_STAT_CESS_AMT'        'State_cess_amount'           '15' ABAP_TRUE.   "state_cess_amount":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITM_STAT_CESS_NADVOL_AMT' 'State_cess_nonadvol_amount'  '15' ABAP_TRUE.   "state_cess_nonadvol_amount":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_TOTITEMVAL'  'Total_item_value'       '15' ABAP_TRUE.      "total_item_value":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITM_CNTRY_ORGIN'   'Country_origin'        '15' ABAP_TRUE.      "country_origin":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITM_ODR_LINE_REF'  'Order_line_reference'  '15' ABAP_TRUE.      "order_line_reference":'
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITM_PRODCT_SR_NUM' 'Product_serial_number' '15' ABAP_TRUE.      "product_serial_number":'
***  COUNT = COUNT + 1.
***  PERFORM FCAT USING COUNT 'ITEM_STATECES'    'ITEM_STATECES'     '15' ABAP_TRUE.
***  COUNT = COUNT + 1.
***  PERFORM FCAT USING COUNT 'ITEM_CGSTRT'      'ITEM_CGSTRT'       '15' ABAP_TRUE.
***  COUNT = COUNT + 1.
***  PERFORM FCAT USING COUNT 'ITEM_SGSTRT'      'ITEM_SGSTRT'       '15' ABAP_TRUE.
***  COUNT = COUNT + 1.
***  PERFORM FCAT USING COUNT 'ITEM_IGSTRT'      'ITEM_IGSTRT'       '15' ABAP_TRUE.
  """"""********************End:Item Detail****************************************************

  """""************Start: Batch & Attribute Detail*******************************************
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_BATCH_NM'    'Attribute:name'     '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_BATCH_EXPDT' 'Attribute:expiry_date'  '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ITEM_BATCH_WRDT'  'Attribute:warranty_dateT'   '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ATR_ITM_ATTRIBTE_DETL' 'Attribute:item_details'   '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'ATR_ITM_ATTRIBTE_VAL'  'Attribute:item_value'    '15' ABAP_TRUE.
  """""*************End:Batch & Attribute Detail**************************************************

  """"""********************Start:Value Detail****************************************************
  count += 1.
  PERFORM fcat
    USING count
          'VAL_ASSVAL'
          'Total assessable value'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'VAL_DISC'
          'Total Discount value'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'VAL_CGSTVAL'
          'total_cgst_value'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'VAL_SGSTVAL'
          'total_sgst_value'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'VAL_IGSTVAL'
          'total_igst_value'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'VAL_OTHCHRG'
          'total othr charges'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'VAL_CESVAL'
          'total_cess_value'
          '15'
          abap_true.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'VAL_CESNONADVAL'  'total_cess_nonadvol_value'   '15' ABAP_TRUE.
  count += 1.
  PERFORM fcat
    USING count
          'VAL_TOTINVVAL'
          'total_invoice_value'
          '15'
          abap_true.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'VAL_STCESVAL'       'total_cess_value_of_state'     '15' ABAP_TRUE.
  count += 1.
  PERFORM fcat
    USING count
          'VAL_DT_ROUNDOFF'
          'round_off_amount'
          '15'
          abap_true.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'VAL_DT_TOT_INV_AC'  'total_inv_value_addl_curr'     '15' ABAP_TRUE.

*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'VAL_OTHCHRG'      'VAL_OTHCHRG'       '15' ABAP_TRUE.
  """"""********************End:Value Detail****************************************************

*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'PAY_NAM'          'PAY_NAM'           '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'PAY_MODE'         'PAY_MODE'          '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'PAY_FININSBR'     'PAY_FININSBR'      '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'PAY_PAYTERM'      'PAY_PAYTERM'       '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'PAY_PAYINSTR'     'PAY_PAYINSTR'      '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'PAY_CRTRN'        'PAY_CRTRN'         '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'PAY_DIRDR'        'PAY_DIRDR'         '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'PAY_CRDAY'        'PAY_CRDAY'         '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'PAY_BALAMT'       'PAY_BALAMT'        '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'PAY_PAYDUEDT'     'PAY_PAYDUEDT'      '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'PAY_ACCTDET'      'PAY_ACCTDET'       '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'REF_INVRMK'       'REF_INVRMK'        '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'REF_INVSTDT'      'REF_INVSTDT'       '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'REF_INVENDDT'     'REF_INVENDDT'      '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'REF_PRECINVNO'    'REF_PRECINVNO'     '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'REF_PRECINVDT'    'REF_PRECINVDT'     '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'REF_RECADVREF'    'REF_RECADVREF'     '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'REF_TENDREF'      'REF_TENDREF'       '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'REF_CONTRREF'     'REF_CONTRREF'      '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'REF_EXTREF'       'REF_EXTREF'        '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'REF_PROJREF'      'REF_PROJREF'       '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'REF_POREF'        'REF_POREF'         '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'EXP_EXPCAT'       'EXP_EXPCAT'        '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'EXP_WTHPAY'       'EXP_WTHPAY'        '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'EXP_INVFORCUR'    'EXP_INVFORCUR'     '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'GETQRIMG'         'GETQRIMG'          '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'GETSIGNEDINVOICE' 'GETSIGNEDINVOICE'  '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'CDKEY'            'CDKEY'             '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'EFUSERNAME'       'EFUSERNAME'        '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'EFPASSWORD'       'EFPASSWORD'        '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'EINVUSERNAME'     'EINVUSERNAME'      '15' ABAP_TRUE.
*  COUNT = COUNT + 1.
*  PERFORM FCAT USING COUNT 'EINVPASSWORD'     'EINVPASSWORD'      '15' ABAP_TRUE.

  """"""********************Start:Export Details****************************************************
  count += 1.
  PERFORM fcat
    USING count
          'EXP_SHIPBNO'
          'ship_bill_number'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'EXP_SHIPBDT'
          'ship_bill_date'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'EXP_PORT'
          'port_code'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'EXP_FORCUR'
          'foreign_currency'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'EXP_CNTCODE'
          'country_code'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'RFND_CLM'
          'Refund Claim'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'EINV_ACK_NO'
          'Ack. No'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'EINV_ACK_DATE'
          'Ack. Date'
          '15'
          abap_true.
  """"""********************End:Export Details****************************************************

ENDFORM.

*&---------------------------------------------------------------------*
*& Form DISPLAY_OUTPUT_SD
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_output_sd.
  " pass the column name of the internal table
  " which contains the color sequence to the layout of the grid
  wa_layo-ctab_fname = 'COLORTAB'. "*For Column Coluring
  wa_layo-info_fname = 'ROWCOLOR'. "*For Row coloring
  wa_layo-stylefname = 'STYLE'.

  " Displaying the output
  osd_grid->set_table_for_first_display( EXPORTING  is_variant                    = sd_variant
                                                    i_save                        = 'A'
                                                    is_layout                     = wa_layo
                                                    it_toolbar_excluding          = it_toolbar[]
                                         CHANGING   it_outtab                     = gt_final
                                                    it_fieldcatalog               = sd_fieldcat
                                         EXCEPTIONS invalid_parameter_combination = 1
                                                    program_error                 = 2
                                                    too_many_lines                = 3
                                                    OTHERS                        = 4 ).

  PERFORM update_internal_table.

  """"*****Hot spot logic start
  event_receiver = NEW #( ).
  SET HANDLER event_receiver->handle_double_click FOR osd_grid.

  cl_gui_control=>set_focus( control = osd_grid ).
  """"*****Hot spot logic End

ENDFORM.

*&---------------------------------------------------------------------*
*& Form HIDE_ALV_FUNCTION
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM hide_alv_function.
  CLEAR fs_func.
  CLEAR it_toolbar[].
  fs_func = cl_gui_alv_grid=>mc_fc_maximum.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_minimum.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_subtot.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_sum.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_sort.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_sort_asc.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_sort_dsc.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_filter.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_detail.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_deselect_all.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_loc_copy.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_loc_cut.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_pc_file.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_print.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_refresh.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_loc_append_row.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_loc_delete_row.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_loc_insert_row.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_loc_undo.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_find.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_info.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_views.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_mb_export.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_check.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_graph.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_loc_paste_new_row.
  APPEND fs_func TO it_toolbar.
  fs_func = cl_gui_alv_grid=>mc_fc_excl_all.
  APPEND fs_func TO it_toolbar.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form UPDATE_INTERNAL_TABLE
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM update_internal_table.
  osd_grid->check_changed_data( ).
  osd_grid->refresh_table_display( ).
ENDFORM.

FORM fcat
  USING p_col_pos
        p_fieldname
        p_seltext_l
        p_outputlen
        p_key.

  wsd_fieldcat-col_pos = p_col_pos.
  IF p_fieldname = 'CHECK'.
    wsd_fieldcat-checkbox = 'X'. " Setting Check box
    wsd_fieldcat-edit     = 'X'.
  ENDIF.

  IF p_fieldname = 'PAYEE_ACC' OR p_fieldname = 'PAYEE_IFSC'.
    wsd_fieldcat-edit = 'X'.
  ENDIF.

  IF p_fieldname = 'STAT_IND'.
    wsd_fieldcat-icon    = 'X'.
    wsd_fieldcat-inttype = 'C'.
  ENDIF.

*  if p_fieldname = 'ITEM'.
*    wsd_fieldcat-hotspot = 'X'.
*  endif.

  wsd_fieldcat-fieldname = p_fieldname.
  wsd_fieldcat-tabname   = 'GT_FINAL'.
  wsd_fieldcat-scrtext_m = p_seltext_l.
  wsd_fieldcat-outputlen = p_outputlen.
  wsd_fieldcat-key       = p_key.
  APPEND wsd_fieldcat TO sd_fieldcat.
  CLEAR wsd_fieldcat.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form PRINT_INVOICE
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM print_invoice.
  TYPES: BEGIN OF ty_vbeln,
           vbeln TYPE vbrk-vbeln,
         END OF ty_vbeln.

  " TODO: variable is assigned but only used in commented-out code (ABAP cleaner)
  DATA wa_vbeln TYPE ty_vbeln.

  " DATA:it_vbeln TYPE STANDARD TABLE OF ty_vbeln.

  TABLES nast.

  "   S2 CANCEL INVOICE  INVOICE-OTHERS
  " ZCOT COTTON  INVOICE-OTHERS
  " ZJBW JOB WORK REWINDING  INVOICE-OTHERS
  " ZRE  RETURN  INVOICE-OTHERS
  " ZS1  CANCEL  INVOICE-OTHERS
  " ZSCO SCRAP INVOICE-OTHERS
  " ZWFI WASTE INVOICE-OTHERS
  " ZYRN YARN SALE INVOICE-OTHERS
  "
  " CTPL/NI01/QE01 BILLING TYPES ZSDPRINT-OUTPUT TYPE
  " ZGRY GREY SALE INVOICE
  " ZJBW JOB WORK SALE INVOICE
  " ZS1  CANCEL  INVOICE
  " ZSCO SCRAP INVOICE-OTHERS
  " ZWFI WASTE INVOICE-OTHERS
  " ZYRN YARN  INVOICE-OTHERS

  LOOP AT gt_final INTO gw_final WHERE check = 'X'.
    IF    gw_final-sd_doc_typ = 'ZS1'  OR gw_final-sd_doc_typ = 'ZGRY' OR gw_final-sd_doc_typ = 'ZDNM' OR gw_final-sd_doc_typ = 'ZDYD'
       OR gw_final-sd_doc_typ = 'ZJBW' OR gw_final-sd_doc_typ = 'ZSJB' OR gw_final-sd_doc_typ = 'ZFJB'.

      SUBMIT zsvc_taxinv_gst_prg_v_qr WITH so_vbeln = gw_final-vbeln AND RETURN. " invoice

    ELSEIF gw_final-sd_doc_typ = 'ZEXP'.
      " flag = 'Z'.
      SUBMIT zsvc_expinv_qr WITH bill_no = gw_final-vbeln AND RETURN.

    ELSEIF    gw_final-sd_doc_typ = 'S2'   OR gw_final-sd_doc_typ = 'ZCOT' OR gw_final-sd_doc_typ = 'ZJBW' OR gw_final-sd_doc_typ = 'ZYEX'
           OR gw_final-sd_doc_typ = 'ZRE'  OR gw_final-sd_doc_typ = 'ZS1'  OR gw_final-sd_doc_typ = 'ZSCO' OR gw_final-sd_doc_typ = 'ZDOM'
           OR gw_final-sd_doc_typ = 'ZWFI' OR gw_final-sd_doc_typ = 'ZYRN' OR gw_final-sd_doc_typ = 'ZMIS' OR gw_final-sd_doc_typ = 'ZWAR'.

      " flag = 'X'.
      SUBMIT zsvc_sd_taxinvoice_qr WITH bill_no = gw_final-vbeln AND RETURN. " invoice others
      wa_vbeln-vbeln = gw_final-vbeln.
*      APPEND wa_vbeln to it_vbeln.
*      APPEND INITIAL LINE TO it_vbeln.

    ENDIF.

    CLEAR gw_final.
  ENDLOOP.

*  IF flag = 'X'.
*   EXPORT it_vbeln_m FROM it_vbeln to MEMORY id 'ZMRM'.
*   submit zsvc_sd_taxinvoice_qr with bill_no = gw_final-vbeln and return.
*    ELSEIF flag = 'Z'.
*     EXPORT it_vbeln_m FROM it_vbeln to MEMORY id 'ZMR2'.
*    submit zsvc_expinv_qr with bill_no = gw_final-vbeln and return.
*    ELSEIF flag = 'Y'.
*   EXPORT it_vbeln_m FROM it_vbeln to MEMORY id 'ZMR3'.
*   submit zsvc_taxinv_gst_prg_v_qr with so_vbeln = gw_final-vbeln and return.
*  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form SAVE_DATA_INTO_ZTABLE
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM save_data_into_ztable.
  osd_grid->check_changed_data( ).

  REFRESH st_final[].
  LOOP AT gt_final INTO gw_final WHERE vbeln = wa_data-vbeln. " CHECK = 'X'.

    REFRESH color_tab[].
    REFRESH lt_edit[].
    gs_index = sy-tabix.
    MOVE-CORRESPONDING gw_final TO sw_final.

    "*SW_FINAL-ERDAT      = SY-DATUM.
    "*SW_FINAL-UZEIT      = SY-UZEIT.

    IF gw_cirn = 'X'.
      CLEAR gw_final-colortab.
      gw_final-stat_ind   = '@02@'. "*Cancel
      sw_final-cancd_irn  = canc_irn.
      sw_final-cancd_ack  = cancd_ack.
      sw_final-cancd_date = cancd_date.
      sw_final-cancd_by   = sy-uname.
      sw_final-cancd_date = sy-datum.
      sw_final-cancd_time = sy-uzeit.
      gw_final-check = ' '.

      """"****For Cell Color
      CLEAR wa_color.
      wa_color-fname = 'IRN'.
      wa_color-color-col = 6. " red color   5: "green color   3: "yellow    7:  "violet
      APPEND wa_color TO color_tab.
      INSERT LINES OF color_tab INTO TABLE gw_final-colortab.
      """"****End: For Cell Color

      """****For Disable Row
      ls_edit-style = cl_gui_alv_grid=>mc_style_disabled.
      INSERT ls_edit INTO TABLE lt_edit.
      INSERT LINES OF lt_edit INTO TABLE gw_final-style.
      """****End: For Disable Row

    ELSEIF gw_girn = 'X' AND gs_irn IS NOT INITIAL.

      CLEAR gw_final-colortab.
      gw_final-stat_ind      = '@5B@'. "*OK
      sw_final-irn           = gs_irn.
      sw_final-signed_inv    = signedinvoice.
      sw_final-signed_qrcode = signedqrcode.
      sw_final-irn_gen_by    = sy-uname.
      sw_final-irn_gen_date  = sy-datum.
      sw_final-irn_gen_time  = sy-uzeit.
      IF irnwbtl = 'X'.
        sw_final-server_dtl = 'WEBTEL'.
      ELSEIF irnftxla = 'X'.
        sw_final-server_dtl = 'TXLA'.
      ELSE.
        sw_final-server_dtl = 'MI'.
      ENDIF.

      " Soc for Ackno & Ackdate by Gaurav(07.01.2021)
      sw_final-einv_ack_no   = ackno.
      sw_final-einv_ack_date = ackdate.
      " Eoc for Ackno & Ackdate by Gaurav(07.01.2021)

      """"****For Cell Color
      CLEAR wa_color.
      wa_color-fname = 'IRN'.
      wa_color-color-col = 5. " red color   5: "green color   3: "yellow    7:  "violet
      APPEND wa_color TO color_tab.
      INSERT LINES OF color_tab INTO TABLE gw_final-colortab.
      """"****End: For Cell Color

      """****For Disable Row
      ls_edit-style = cl_gui_alv_grid=>mc_style_disabled.
      INSERT ls_edit INTO TABLE lt_edit.
      INSERT LINES OF lt_edit INTO TABLE gw_final-style.
      """****End: For Disable Row

    ELSEIF gw_girn = 'X' AND gs_irn IS INITIAL.
      CLEAR gw_final-colortab.
      gw_final-stat_ind = '@1B@'. "*Error
      sw_final-irn           = gs_irn.
      sw_final-signed_inv    = signedinvoice.
      sw_final-signed_qrcode = signedqrcode.
    ENDIF.

    gw_final-check = ' '.

    APPEND sw_final TO st_final.

    ""**Start: Udate Final table for display
    gw_final-irn = gs_irn.
    MODIFY gt_final FROM gw_final INDEX gs_index TRANSPORTING irn
                                                              cancd_irn
                                                              stat_ind
                                                              check
                                                              colortab
                                                              style
                                                              irn_gen_by
                                                              irn_gen_date
                                                              irn_gen_time
                                                              cancd_by
                                                              cancd_date
                                                              cancd_time.
    ""**End: Udate Final table for display

    CLEAR gw_final.
    CLEAR sw_final.
  ENDLOOP.

  IF st_final[] IS NOT INITIAL.
    IF gw_cirn = 'X' .
      SELECT * FROM   zsd_einvoice INTO TABLE @DATA(lv_del_x) WHERE vbeln = @wa_data-vbeln .
      LOOP AT lv_del_x ASSIGNING FIELD-SYMBOL(<fxx>) .
        <fxx>-cancd_irn  = 'X'.
        <fxx>-cancd_ack  = cancd_ack.
        <fxx>-cancd_date = cancd_date.
        <fxx>-cancd_by   = sy-uname.
        <fxx>-cancd_date = sy-datum.
        <fxx>-cancd_time = sy-uzeit.
*         <FXX>-check = ' '.

      ENDLOOP .
      REFRESH st_final .
      st_final[] = lv_del_x[] .

    ENDIF .
    MODIFY zsd_einvoice FROM TABLE st_final[].
  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form UPDATE_ZTABLE_FOR_ERROR
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM update_ztable_for_error.
  osd_grid->check_changed_data( ).

  REFRESH st_final[].
  LOOP AT gt_final INTO gw_final WHERE vbeln = wa_data-vbeln. " CHECK = 'X'.

    gs_index = sy-tabix.
    gw_final-stat_ind = '@1B@'. "*Error
    gw_final-check    = ' '.
    MODIFY gt_final FROM gw_final INDEX gs_index TRANSPORTING stat_ind check.

    CLEAR gw_final.
  ENDLOOP.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form VALIDATE_ALREDAY_DONE_ACTION
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM validate_alreday_done_action.
  IF gw_girn = 'X'.
    IF wa_data-stat_ind = '@5B@'.
      " TODO: check spelling: alreday (typo) -> already (ABAP cleaner)
      MESSAGE 'IRN for selected document alreday generated' TYPE 'I'.
    ENDIF.
  ELSEIF gw_cirn = 'X'.
    IF wa_data-stat_ind = '@02@'.
      " TODO: check spelling: alreday (typo) -> already (ABAP cleaner)
      MESSAGE 'Selected document alreday cancelled' TYPE 'I'.
    ENDIF.
  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form CANCEL_BILLING_DOCUMENT
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM cancel_billing_document.
  DATA d_bill_doc         LIKE bapivbrksuccess-bill_doc.
  "*---declaration for fun module
  DATA gt_bapireturn1     LIKE bapireturn1 OCCURS 0 WITH HEADER LINE.
  DATA gt_bapivbrksuccess LIKE bapivbrksuccess OCCURS 0 WITH HEADER LINE.

  IF fi_einv = 'X'.
    PERFORM cancel_bill.
  ELSEIF sd_einv = 'X' or sd_sez = 'X'.
    LOOP AT gt_final INTO gw_final WHERE stat_ind = '@02@'. " CHECK = 'X'.

      CLEAR d_bill_doc.
      d_bill_doc = gw_final-vbeln.

      REFRESH gt_bapireturn1[].
      REFRESH gt_bapivbrksuccess[].
      "*---cancel billing doc (transaction VF11)
      CALL FUNCTION 'BAPI_BILLINGDOC_CANCEL1'
        EXPORTING
          billingdocument = d_bill_doc
        TABLES
          return          = gt_bapireturn1
          success         = gt_bapivbrksuccess.

      "*---commit
      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.

      CLEAR gw_final.
    ENDLOOP.
  ENDIF.
ENDFORM.

*&---------------------------------------------------------------------*
*& Form GET_TOKEN_FROM_MI
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_token_from_mi.

  DATA mi_uname                 TYPE string.
  DATA mi_pass                  TYPE string.
  DATA mi_clnt                  TYPE string.
  DATA mi_scrt                  TYPE string.
  DATA mi_grnt                  TYPE string.
  " data Variables declaration for passing URL, Result String(Using get_cdata())
  DATA mi_url                   TYPE string.
  DATA miw_string               TYPE c LENGTH 5000.
  " data Variables declaration for passing the xml input data into API as a string and lenth
  DATA mi_rlength               TYPE i.
  DATA mi_string                TYPE string.
  DATA mi_http_client           TYPE REF TO if_http_client.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA mi_http_return_code      TYPE i.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA mi_http_error_descr      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA mi_http_error_descr_long TYPE xstring.
  DATA mi_xml_result_str        TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA at1                      TYPE string.
  DATA at2                      TYPE string.
  DATA at3                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA at4                      TYPE string.

  FIELD-SYMBOLS <mi_fs>.

  " TODO: remove needless CLEAR (ABAP cleaner)
  CLEAR mi_uname.
  " TODO: remove needless CLEAR (ABAP cleaner)
  CLEAR mi_pass.
  " TODO: remove needless CLEAR (ABAP cleaner)
  CLEAR mi_clnt.
  " TODO: remove needless CLEAR (ABAP cleaner)
  CLEAR mi_scrt.
  " TODO: remove needless CLEAR (ABAP cleaner)
  CLEAR mi_grnt.
  mi_uname = '"' && gw_credential-mi_uname && '",'. "*'"pcsharma@chiripalgroup.com",'.            "*'"testeway@mastersindia.co",'.
  mi_pass  = '"' && gw_credential-mi_pass && '",'.  "*'"Mawai@123",'.                             "*'"Test@1234",'.
  mi_clnt  = '"' && gw_credential-mi_clnt && '",'.  "*'"GzaWgNPuhgoHrSLOOp",'.                    "*'"fIXefFyxGNfDWOcCWn",'.
  mi_scrt  = '"' && gw_credential-mi_scrt && '",'.  "*'"X046gKaYizSpTz5330oZyrdE",'.              "*'"QFd6dZvCGqckabKxTapfZgJc",'.
  mi_grnt  = '"' && gw_credential-mi_grnt && '"'.   "*'"password"'.                               "*'"password"'.

  mi_url = gw_credential-url_auth_token. "*'https://pro.mastersindia.co/oauth/access_token'. "*'https://clientbasic.mastersindia.co/oauth/access_token'.
  CLEAR miw_string.
  miw_string = '{'
  && '"username":' && mi_uname
  && '"password":' && mi_pass
  && '"client_id":' && mi_clnt
  && '"client_secret":' && mi_scrt
  && '"grant_type":' && mi_grnt
  && '}'.

  " * PERFORM CALCULATE_STRING_LENGTH.
  """*********************************************"""""
  CLEAR mi_rlength.
  mi_string = miw_string. "= LV_JSON.
  mi_rlength = strlen( mi_string ).

  """*********************************************"""""
  " * PERFORM CREATE_URL.
  """*********************************************"""""
  " ****Creation of HTTP Client
  cl_http_client=>create_by_url( EXPORTING  url                = mi_url
                                            ssl_id             = 'DFAULT'
                                 IMPORTING  client             = mi_http_client
                                 EXCEPTIONS argument_not_found = 1
                                            plugin_not_active  = 2
                                            internal_error     = 3
                                            OTHERS             = 4 ).

  """*********************************************"""""
  " * PERFORM SET_CALLING_METHOD.
  """*********************************************"""""
  " **** Set up the HTTP data passing method
  mi_http_client->request->set_method( method = 'POST' ).

  """*********************************************"""""
  " * PERFORM SET_VERSION.
  """*********************************************"""""
  " ** Set up the HTTP Post version
  mi_http_client->request->set_version( version = if_http_request=>co_protocol_version_1_1 ). " 1001

  """*********************************************"""""
  " * PERFORM SET_CONTENT_TYPE.
  """*********************************************"""""
  " ***set the content type of request data
  mi_http_client->request->if_http_entity~set_content_type( content_type = 'application/json; charset=utf-8' ).

  """*********************************************"""""
  " * PERFORM SETUP_HTTP_HEADER.
  """*********************************************"""""
  " ***Set up the HTTP header
  mi_http_client->request->set_header_field( name  = 'Host'
                                             value = mi_url ).

  """*********************************************"""""
  " * PERFORM PASS_DATA_TO_API.
  """*********************************************"""""
  " * Set up the HTTP data i.e pass/set the data into API
  mi_http_client->request->set_cdata( data   = mi_string
                                      offset = 0
                                      length = mi_rlength ).

  """*********************************************"""""
  " * PERFORM SEND_HTTP_REQUEST.
  """*********************************************"""""
  " ** Send the HTTP Post request to the URL.
  mi_http_client->send( EXPORTING  timeout                    = 15   " 15 Seconds
                        EXCEPTIONS http_communication_failure = 1
                                   http_invalid_state         = 2 ).

  """*********************************************"""""
  " * PERFORM RECEIVE_RESPONSE.
  """*********************************************"""""
  " ***Read the Response from API
  mi_http_client->receive( EXCEPTIONS http_communication_failure = 1
                                      http_invalid_state         = 2
                                      http_processing_failed     = 3 ).

  """*********************************************"""""
  " * PERFORM DISPLAY_RESPONSE.
  """*********************************************"""""
  " Get the HTTP return code from the HTTP POST:
  mi_http_client->response->get_status( IMPORTING code = mi_http_return_code ).
  mi_http_client->response->get_status( IMPORTING reason = mi_http_error_descr ).
  mi_http_error_descr_long = mi_http_client->response->get_raw_message( ).

  mi_http_client->refresh_request( EXCEPTIONS http_action_failed = 1
                                              OTHERS             = 2 ).

  " ****Write the data received back from the POST to the screen:
  CLEAR mi_xml_result_str.
  mi_xml_result_str = mi_http_client->response->get_cdata( ).
  sy-tmaxl = strlen( mi_xml_result_str ).
  UNASSIGN <mi_fs>.
  ASSIGN mi_xml_result_str TO <mi_fs>.
  WRITE / <mi_fs>(sy-tmaxl).

  CLEAR at1.
  CLEAR at2.
  SPLIT <mi_fs> AT ':' INTO at1 at2.
  SPLIT at2 AT ',' INTO at3 at4.
  REPLACE ALL OCCURRENCES OF '"' IN at3 WITH space.
  CLEAR access_token.
  access_token = at3.

  " {
  " access_token":"a78e74508f285f5cd120716b81d8e91f2af96326",
  " expires_in":21600,
  " token_type":"bearer"
  " }

ENDFORM.

*&---------------------------------------------------------------------*
*& Form GENERATE_IRN_FORM_MI
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM generate_irn_form_mi.
  ""-------------------------------------------------------------------
  ""--------------Create Itab for the Returned Message----------------------------""

  TYPES: BEGIN OF ty_return,
           vbeln               TYPE vbrk-vbeln,
           contentencoding     TYPE c LENGTH 10,
           contenttype         TYPE c LENGTH 10,
           ackno               TYPE c LENGTH 40,
           ackdt               TYPE c LENGTH 40,
           irn                 TYPE c LENGTH 200,
           signedinvoice       TYPE c LENGTH 5000,
           signedqrcode        TYPE c LENGTH 5000,
           status              TYPE c LENGTH 10,
           jsonrequestbehavior TYPE c LENGTH 10,
           maxjsonlength       TYPE c LENGTH 10,
           recursionlimit      TYPE c LENGTH 10,
           reqid               TYPE c LENGTH 100,
         END OF ty_return.

  ""Create Json String
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA gw_string1                TYPE c LENGTH 15000.
  " data Variables declaration for passing URL, Result String(Using get_cdata())
  DATA gp_url1                   TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_line                   TYPE i.
  DATA lv_index                  TYPE sy-tabix.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_idx                    TYPE c LENGTH 100.
  DATA lv_docdtls_dt             TYPE c LENGTH 10.
  DATA lv_space                  TYPE c LENGTH 1.
  " data Variables declaration for passing the xml input data into API as a string and lenth
  DATA grlength1                 TYPE i.
  DATA w_string1                 TYPE string.
  " *****data declaration for creating HTTP Client, Request, Error description, error code etc
  DATA glo_http_client1          TYPE REF TO if_http_client.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA gw_http_return_code1      TYPE i.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA gw_http_error_descr1      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA gw_http_error_descr_long1 TYPE xstring.
  DATA gw_xml_result_str1        TYPE string.
  ""--------------------------------------------------------------------------""
  DATA lv_main                   TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_string1                TYPE string.
  DATA lv_string2                TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_string3                TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_string4                TYPE string.
  DATA lv_success                TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv1                       TYPE c LENGTH 255.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv2                       TYPE c LENGTH 255.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv3                       TYPE c LENGTH 255.
  DATA lv4                       TYPE c LENGTH 255.
  DATA lv5                       TYPE c LENGTH 255.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv6                       TYPE c LENGTH 5000.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv7                       TYPE c LENGTH 5000.
  DATA lv8                       TYPE string.
  DATA lv9                       TYPE string.
  DATA lv10                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv11                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv12                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv13                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv14                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv15                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv16                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv17                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv18                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv19                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv20                      TYPE c LENGTH 200.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv21                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv22                      TYPE c LENGTH 5000.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv23                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv24                      TYPE c LENGTH 5000.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv25                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv26                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv27                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv28                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv29                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv30                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv31                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv32                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv33                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv34                      TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv35                      TYPE c LENGTH 100.
**"SOC for Acknowledgement No & date by Gaurav(21.10.2020)
  DATA gv_lv1                    TYPE c LENGTH 50.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA gv_lv2                    TYPE c LENGTH 50.
  DATA gv_lv3                    TYPE c LENGTH 50.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA gv_lv4                    TYPE c LENGTH 50.
  DATA lt_string_comp            TYPE TABLE OF swastrtab.
  DATA lv_longtext               TYPE string.
  DATA lw_string_comp            TYPE swastrtab.

  FIELD-SYMBOLS <gfs1>.

**"EOC for Acknowledgement No & date by Gaurav(21.10.2020)

  ""-------------------------------------------------------------------

  " GW_STRING1        TYPE STRING,
  " GGW_STRING1(5000) TYPE C.

  CLEAR charge_type.

  PERFORM clear_variables.

  DATA(ct_final) = gt_final[].
  DELETE ct_final WHERE check <> 'X'.

  CLEAR gw_string1.
  gp_url1 = gw_credential-url_einv_gen. "'https://pro.mastersindia.co/generateEinvoice'.
  LOOP AT ct_final INTO wa_data WHERE check = 'X'. " LOOP AT GT_FINAL INTO WA_DATA WHERE CHECK = 'X'.
    CLEAR mij_itm_gw_string.
    REFRESH li_final[].
    li_final[] = ot_final[].
    DELETE li_final WHERE vbeln <> wa_data-vbeln.
    DESCRIBE TABLE li_final LINES lv_line.

    WAIT UP TO 3 SECONDS.
    PERFORM validate_alreday_done_action.

    lv_index = sy-tabix.
    CLEAR lv_idx.
    CLEAR lv_docdtls_dt.
    lv_idx = lv_index.
    CONDENSE lv_idx.

    CLEAR gw_string1.
    lv_idx = 1.

    mij_access_token = '"' && access_token && '",'. " access_token":
    mij_user_gstin   = '"' && user_gstin && '",'.   " user_gstin":
    mij_data_source  = '"' && data_source && '",'.  " DATA_SOURCE":

    " Transaction Details Started
    IF charge_type IS INITIAL.
      charge_type = 'N'.
    ENDIF.
    mij_category_of_transaction = '"' && wa_data-tran_catg && '",'.    " category_of_transaction":
    mij_charge_type             = '"' && charge_type && '",'. " charge_type":
    mij_transaction_type        = '"' && wa_data-tran_typ && '",'.     " transaction_type":
    mij_ecommerce_transaction   = '"' && wa_data-tran_ecmtrn && '",'.  " ecommerce_transaction":
    mij_ecommerce_gstin         = '"' && wa_data-tran_ecmgstin && '"'. " ecommerce_gstin":
    ""Transaction Details Closed

    ""Document Details Started
    lv_docdtls_dt = wa_data-doc_dt+0(4) && '-' && wa_data-doc_dt+4(2) && '-' && wa_data-doc_dt+6(2).
    mij_document_type            = '"' && wa_data-doc_typ      && '",'.  " document_type":
    mij_document_number          = '"' && wa_data-doc_no       && '",'.  " document_number":
    mij_document_date            = '"' && lv_docdtls_dt        && '"'.   " document_date":            "&& '",'.  "document_date":
    mij_original_document_number = '"' && wa_data-doc_orginvno && '",'.  " original_document_number":
    ""Document Details Closed

    " "Seller Details Started
    " WA_DATA-BILLFROM_PIN  = '201309'.
    " WA_DATA-BILLFROM_STCD = '09'.
    mij_seller_gstin      = '"' && wa_data-billfrom_gstin && '",'. " gstin":
    mij_seller_trade_name = '"' && wa_data-billfrom_trdnm && '",'. " trade_name":
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-billfrom_bno WITH lv_space.
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-billfrom_bnm WITH lv_space.
    mij_seller_building_number = '"' && wa_data-billfrom_bno  && '",'. " building_number"
    mij_seller_building_name   = '"' && wa_data-billfrom_bnm  && '",'. " building_name":
    mij_seller_floor_number    = '"' && wa_data-billfrom_flno && '",'. " floor_number":
    mij_seller_location        = '"' && wa_data-billfrom_loc  && '",'. " location":
    mij_seller_district        = '"' && wa_data-billfrom_dst  && '",'. " district":
    mij_seller_pincode         = '"' && wa_data-billfrom_pin  && '",'. " pincode":
    mij_seller_state_code      = '"' && wa_data-billfrom_stcd && '",'. " state_code":
    mij_seller_phone_number    = '"' && wa_data-billfrom_ph   && '",'. " phone_number":
    mij_seller_email           = '"' && wa_data-billfrom_em   && '"'.  " email":
*    ""Seller Details Closed

*    ""Buyer Details Started
    mij_buyer_gstin      = '"' && wa_data-billto_gstin && '",'. " gstin":
    mij_buyer_trade_name = '"' && wa_data-billto_trdnm && '",'. " trade_name":
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-billto_bno WITH lv_space.
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-billto_bnm WITH lv_space.
    mij_buyer_building_number = '"' && wa_data-billto_bno  && '",'. " building_number":
    mij_buyer_building_name   = '"' && wa_data-billto_bnm  && '",'. " building_name":
    mij_buyer_floor_number    = '"' && wa_data-billto_flno && '",'. " floor_number":
    mij_buyer_location        = '"' && wa_data-billto_loc  && '",'. " location":
    mij_buyer_district        = '"' && wa_data-billto_dst  && '",'. " district":
    mij_buyer_pincode         = '"' && wa_data-billto_pin  && '",'. " pincode":
    mij_buyer_state_code      = '"' && wa_data-billto_stcd && '",'. " state_code":
    mij_buyer_phone_number    = '"' && wa_data-billto_ph   && '",'. " phone_number":
    mij_buyer_email           = '"' && wa_data-billto_em   && '"'.  " email":
*    ""Buyear Details Closed

    " "Dispatch Details Started
    " WA_DATA-SHIPFROM_PIN    = '201309'.
    " WA_DATA-SHIPFROM_STCD   = '09'.
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-shipfrom_bno WITH lv_space.
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-shipfrom_bnm WITH lv_space.
    mij_dispatch_gstin           = '"' && wa_data-shipfrom_gstin && '",'. " gstin":
    mij_dispatch_trade_name      = '"' && wa_data-shipfrom_trdnm && '",'. " trade_name":
    mij_dispatch_building_number = '"' && wa_data-shipfrom_bno   && '",'. " building_number":
    mij_dispatch_building_name   = '"' && wa_data-shipfrom_bnm   && '",'. " building_name":
    mij_dispatch_floor_number    = '"' && wa_data-shipfrom_flno  && '",'. " floor_number":
    mij_dispatch_location        = '"' && wa_data-shipfrom_loc   && '",'. " location":
    mij_dispatch_district        = '"' && wa_data-shipfrom_dst   && '",'. " district":
    mij_dispatch_pincode         = '"' && wa_data-shipfrom_pin   && '",'. " pincode":
    mij_dispatch_state_code      = '"' && wa_data-shipfrom_stcd  && '"'. " state_code": "*&& '",'. "state_code":
    mij_dispatch_phone_number    = '"' && wa_data-shipfrom_ph    && '",'. " phone_number":
    mij_dispatch_email           = '"' && wa_data-shipfrom_em    && '"'.  " email":
*    ""Dispatch Details Closed
*
*    ""Ship Details Started
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-shipto_bno WITH lv_space.
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-shipto_bnm WITH lv_space.
    mij_ship_gstin           = '"' && wa_data-shipto_gstin && '",'.
    mij_ship_trade_name      = '"' && wa_data-shipto_trdnm && '",'.
    mij_ship_building_number = '"' && wa_data-shipto_bno   && '",'.
    mij_ship_building_name   = '"' && wa_data-shipto_bnm   && '",'.
    mij_ship_floor_number    = '"' && wa_data-shipto_flno  && '",'.
    mij_ship_location        = '"' && wa_data-shipto_loc   && '",'.
    mij_ship_district        = '"' && wa_data-shipto_dst   && '",'.
    mij_ship_pincode         = '"' && wa_data-shipto_pin   && '",'.
    mij_ship_state_code      = '"' && wa_data-shipto_stcd  && '"'. "*'&& '",'.
    mij_ship_phone_number    = '"' && wa_data-shipto_ph    && '",'.
    mij_ship_email           = '"' && wa_data-shipto_em    && '"'.
*    ""Ship Details Closed
*
*    ""Export Details Started
    "*MIJ_EXPORT_EXPORT_CATEGORY      = '"' && WA_DATA-EXPORT_CATEGORY            && '",'.
    mij_export_ship_bill_number = '"' && wa_data-exp_shipbno && '",'.
    mij_export_ship_bill_date   = '"' && wa_data-exp_shipbdt && '",'.
    mij_export_country_code     = '"' && wa_data-exp_cntcode && '",'.
    mij_export_foreign_currency = '"' && wa_data-exp_forcur && '",'.
    " MIJ_EXPORT_INVOICE_VALUE_IN_FC  = '"' && WA_DATA-TOTAL_INVOICE_VALUE_IN_FC  && '",'.
    mij_export_port_code        = '"' && wa_data-exp_port && '"'. "&& '",'.
    " MIJ_EXPORT_EXPORT_PAYMENT       = '"' && WA_DATA-EXPORT_PAYMENT             && '"'.
*    ""Export Details Closed

*    ""Payment Details Started
    mij_payment_account_details  = '"' && wa_data-account_details && '",'.
    mij_payment_paid_amount      = '"' && wa_data-pay_balamt      && '",'.
    mij_payment_credit_days      = '"' && wa_data-pay_crday       && '",'.
    mij_payment_credit_transfer  = '"' && wa_data-credit_transfer && '",'.
    mij_payment_direct_debit     = '"' && wa_data-pay_dirdr       && '",'.
    mij_payment_branch_or_ifsc   = '"' && wa_data-branch_or_ifsc  && '",'.
    mij_payment_payment_mode     = '"' && wa_data-pay_mode        && '",'.
    mij_payment_payee_name       = '"' && wa_data-payee_name      && '",'.
    mij_payment_payment_due_date = '"' && wa_data-pay_payduedt    && '",'.
    mij_payment_instruction      = '"' && wa_data-pay_payinstr    && '",'.
    mij_payment_payment_term     = '"' && wa_data-pay_payterm     && '"'.
*    ""Payment Details Closed

*    ""Reference Details Started
    mij_ref_contract_ref_number    = '"' && wa_data-contrct_contrct_ref_num && '",'. " contract_reference_number":
    mij_ref_other_reference        = '"' && wa_data-contrct_othr_ref        && '",'. " other_reference":
    mij_ref_inv_period_start_date  = '"' && wa_data-ref_invstdt             && '",'. " invoice_period_start_date":
    mij_ref_inv_period_end_date    = '"' && wa_data-ref_invenddt            && '",'. " invoice_period_end_date":
    mij_ref_inv_reference_number   = '"' && wa_data-ref_precinvno           && '",'. " invoice_reference_number":
    mij_ref_inv_remarks            = '"' && wa_data-ref_invrmk              && '",'. " invoice_remarks":
    mij_ref_vendor_po_ref_number   = '"' && wa_data-contrct_ven_po_ref_num  && '",'. " vendor_po_reference_number":
    "*MIJ_REF_PRECEDING_INV_DATE      = '"' && WA_DATA-PRECEDING_INVOICE_DATE      && '",'. "preceding_invoice_date":
    "*MIJ_REF_PRECEDING_INV_NUMBER    = '"' && WA_DATA-PRECEDING_INVOICE_NUMBER    && '",'. "preceding_invoice_number":
    mij_ref_project_ref_number     = '"' && wa_data-contrct_proj_ref_num    && '",'. " project_reference_number":
    mij_ref_receipt_advice_number  = '"' && wa_data-contrct_recpt_adv_num   && '",'. " receipt_advice_number":
    mij_ref_batch_reference_number = '"' && wa_data-contrct_batch_ref_num   && '"'.  " batch_reference_number":
*    ""Reference Details Closed

    IF wa_data-val_assval IS INITIAL.
      wa_data-val_assval = '0'.
    ENDIF.

    IF wa_data-val_cgstval IS INITIAL.
      wa_data-val_cgstval = '0'.
    ENDIF.

    IF wa_data-val_sgstval IS INITIAL.
      wa_data-val_sgstval = '0'.
    ENDIF.

    IF wa_data-val_igstval IS INITIAL.
      wa_data-val_igstval = '0'.
    ENDIF.

    IF wa_data-val_cesval IS INITIAL.
      wa_data-val_cesval = '0'.
    ENDIF.

    IF wa_data-branch_or_ifsc IS INITIAL.
      wa_data-branch_or_ifsc = '0'.
    ENDIF.

    IF wa_data-val_totinvval IS INITIAL.
      wa_data-val_totinvval = '0'.
    ENDIF.

    IF wa_data-val_stcesval IS INITIAL.
      wa_data-val_stcesval = '0'.
    ENDIF.

    " if WA_DATA-VAL_OTHCHRG  ca '-'.
    "   replace '-' in WA_DATA-VAL_OTHCHRG  with ' '.
    "   WA_DATA-VAL_OTHCHRG  = '-' && WA_DATA-VAL_OTHCHRG .
    " endif.

*    ""Value Details Started
    mij_value_total_assess_value   = '' && wa_data-val_assval     && ','. " total_assessable_value":
    mij_value_total_cgst_value     = '' && wa_data-val_cgstval    && ','. " total_cgst_value":
    mij_value_total_sgst_value     = '' && wa_data-val_sgstval    && ','. " total_sgst_value":
    mij_value_total_igst_value     = '' && wa_data-val_igstval    && ','. " total_igst_value":
    mij_value_total_cess_value     = '' && wa_data-val_cesval     && ','. " total_cess_value":
    mij_value_total_cess_non_value = '' && wa_data-branch_or_ifsc && ','. " total_cess_nonadvol_value":
    mij_value_total_invoice_value  = '' && wa_data-val_totinvval  && ','. " total_invoice_value":
    mij_value_total_cess_v_state   = '' && wa_data-val_stcesval   && ','. " total_cess_value_of_state":
    mij_value_discount             = '"' && wa_data-val_disc && '",'. " discount":
    mij_value_other_charge         = '' && wa_data-val_othchrg && ','. " other_charge":
*    ""Value Details Closed

    " MIJ_EXPORT_SHIP_BILL_NUMBER    = '"qwe1233",'.       "*Mandatory
    " MIJ_EXPORT_SHIP_BILL_DATE      = '"08/02/2020",'.    "*Mandatory
    " MIJ_EXPORT_COUNTRY_CODE        = '"IN",'.            "*Mandatory
    " MIJ_EXPORT_FOREIGN_CURRENCY    = '"INR",'.           "*Mandatory
    " MIJ_EXPORT_PORT_CODE           = '"232434"'.         "*Mandatory
    "
    " MIJ_PAYMENT_ACCOUNT_DETAILS    = '"Account Details",'.        "*Mandatory
    " MIJ_PAYMENT_PAID_AMOUNT        = '100,'.
    " MIJ_PAYMENT_CREDIT_DAYS        = '2,'.
    " MIJ_PAYMENT_CREDIT_TRANSFER    = '"Credit Transfer",'.        "*Mandatory
    " MIJ_PAYMENT_DIRECT_DEBIT       = '"Direct Debit",'.           "*Mandatory
    " MIJ_PAYMENT_BRANCH_OR_IFSC     = '"KKK000180",'.              "*Mandatory
    " MIJ_PAYMENT_PAYMENT_MODE       = '"CASH",'.                   "*Mandatory
    " MIJ_PAYMENT_PAYEE_NAME         = '"Payee Name",'.             "*Mandatory
    " MIJ_PAYMENT_PAYMENT_DUE_DATE   = '"08/02/2020",'.
    " MIJ_PAYMENT_INSTRUCTION        = '"Payment Instruction",'.    "*Mandatory
    " MIJ_PAYMENT_PAYMENT_TERM       = '"Terms of Payment"'.        "*Mandatory
    "
    " MIJ_REF_INV_REMARKS            = '"Invoice Remarks",'.       "*Mandatory
    " MIJ_REF_INV_PERIOD_START_DATE  = '"2020-01-01",'.            "*Mandatory
    " MIJ_REF_INV_PERIOD_END_DATE    = '"2020-01-30",'.            "*Mandatory
    " MIJ_ORIGINAL_DOCUMENT_NUMBER   = '"CFRT/0009",'.             "*Mandatory
    " MIJ_REF_PRECEDING_INV_DATE     = '"08/02/2020",'.            "*Mandatory

    """""******Start:New: JSON:Master India: 07.03.2020*****************************************************"""""""""""""""
    " CONTRCT_RECPT_ADV_NUM          = 'aaa'.            "*Mandatory
    " CONTRCT_RECPT_ADV_DAT          = '10/02/2020'.     "*Mandatory
    " CONTRCT_BATCH_REF_NUM          = '2334'.           "*Mandatory
    " CONTRCT_CONTRCT_REF_NUM        = '2334'.           "*Mandatory
    " CONTRCT_OTHR_REF               = '2334'.           "*Mandatory
    " CONTRCT_PROJ_REF_NUM           = '2334'.           "*Mandatory
    " CONTRCT_VEN_PO_REF_NUM         = '233433454545'.   "*Mandatory
    " CONTRCT_VEN_PO_REF_DAT         = '10/02/2020'.     "*Mandatory
    "
    " ADDL_SUP_DOC_URL               = ''.  "*Not Mandatory
    " ADDL_SUP_DOC                   = ''.  "*Not Mandatory
    " ADDL_INFO                      = ''.  "*Not Mandatory

    " EWAY_TRANSP_ID                 = '05AAABB0639G1Z8'.
    " EWAY_TRANSP_NAME               = 'Jay Trans'.
    " EWAY_TRANSP_MODE               = '1'.
    " EWAY_TRANSP_DIST               = '120'.
    " EWAY_TRANSP_DOC_NUM            = '1230'.
    " EWAY_TRANSP_DOC_DAT            = '08/02/2020'.
    " EWAY_VECH_NUM                  = 'PQR1234'.
    " EWAY_VECH_TYPE                 = 'R'.

    val_dt_roundoff   = '0'. "*Not Mandatory But should be zero
    val_dt_tot_inv_ac = '0'. "*Not Mandatory But should be zero

    """"***New Field
    supply_typ              = '"' && wa_data-tran_catg && '",'. " supply_type":
    slr_lgl_name            = '"' && wa_data-billfrom_trdnm  && '",'. " legal_name"
    slr_adr1                = '"' && wa_data-billfrom_bno    && '",'. " address1":
    slr_adr2                = '"' && wa_data-billfrom_bnm    && '",'. " address2":
    byr_lgl_name            = '"' && wa_data-billto_trdnm    && '",'. " legal_name"
    byr_adr1                = '"' && wa_data-billto_bno      && '",'. " address1":
    byr_adr2                = '"' && wa_data-billto_bnm      && '",'. " address2":
    byr_pls_supply          = '"' && wa_data-billto_stcd     && '",'.
    disp_comp_name          = '"' && wa_data-shipfrom_trdnm  && '",'. " company_name"
    disp_adr1               = '"' && wa_data-shipfrom_bno    && '",'. " address1"
    disp_adr2               = '"' && wa_data-shipfrom_bnm    && '",'. " address2"
    shp_lgl_name            = '"' && wa_data-shipto_trdnm    && '",'. " legal_name"
    shp_adr1                = '"' && wa_data-shipto_bno      && '",'. " address1":
    shp_adr2                = '"' && wa_data-shipto_bnm      && '",'. " address2":
    rfnd_clm                = '"' && rfnd_clm                && '",'. " refund_claim"

    pymnt_acc_no            = '"' && pymnt_acc_no            && '",'. " port_code"
    ref_inv_remark          = '"' && ref_inv_remark          && '",'.
    ref_inv_prd_strt        = '"' && ref_inv_prd_strt        && '",'.
    ref_inv_prd_end         = '"' && ref_inv_prd_end         && '",'.
    prcdg_inv_dat           = '"' && prcdg_inv_dat           && '",'.
    oth_ref                 = '"' && oth_ref                 && '"'.
    contrct_recpt_adv_num   = '"' && contrct_recpt_adv_num   && '",'.
    contrct_recpt_adv_dat   = '"' && contrct_recpt_adv_dat   && '",'.
    contrct_batch_ref_num   = '"' && contrct_batch_ref_num   && '",'.
    contrct_contrct_ref_num = '"' && contrct_contrct_ref_num && '",'.
    contrct_othr_ref        = '"' && contrct_othr_ref        && '",'.
    contrct_proj_ref_num    = '"' && contrct_proj_ref_num    && '",'.
    contrct_ven_po_ref_num  = '"' && contrct_ven_po_ref_num  && '",'.
    contrct_ven_po_ref_dat  = '"' && contrct_ven_po_ref_dat  && '"'.
    addl_sup_doc_url        = '"' && addl_sup_doc_url        && '",'.
    addl_sup_doc            = '"' && addl_sup_doc            && '",'.
    addl_info               = '"' && addl_info               && '"'.
    val_dt_roundoff         = ''  && val_dt_roundoff         && ','.
    val_dt_tot_inv_ac       = ''  && val_dt_tot_inv_ac       && ''.
    eway_transp_id          = '"' && eway_transp_id          && '",'.
    eway_transp_name        = '"' && eway_transp_name        && '",'.
    eway_transp_mode        = '"' && eway_transp_mode        && '",'.
    eway_transp_dist        = '"' && eway_transp_dist        && '",'.
    eway_transp_doc_num     = '"' && eway_transp_doc_num     && '",'.
    eway_transp_doc_dat     = '"' && eway_transp_doc_dat     && '",'.
    eway_vech_num           = '"' && eway_vech_num           && '",'.
    eway_vech_type          = '"' && eway_vech_type          && '"'.
    """""****End New Field.

    user_gstin  = mij_seller_gstin. "'"09AAAPG7885R002",'.
    "*MIJ_BUYER_GSTIN                = '"05AAAPG7885R002",'.
    data_source = '"erp",'.
    """""******Start:New: JSON:Master India: 07.03.2020*****************************************************"""""""""""""""

    PERFORM condense_variables.
    PERFORM prepare_hdr_data.

    CLEAR mij_gw_string.
    mij_gw_string = '{'
     && '"access_token":'    && mij_access_token
     && '"user_gstin":'      && user_gstin
     && '"data_source":'     && data_source
     && '"transaction_details":'
     && '{'
     && '"supply_type":'     && supply_typ
     && '"charge_type":'     && mij_charge_type
     && '"ecommerce_gstin":' && mij_ecommerce_gstin
     && '},'
     && '"document_details":'
     && '{'
     && '"document_type":'   && mij_document_type
     && '"document_number":' && mij_document_number
     && '"document_date":'   && mij_document_date
     && '},'
     && '"seller_details":'
     && '{'
     && '"gstin":'           && user_gstin "'"09AAAPG7885R002",'
     && '"legal_name":'      && slr_lgl_name
     && '"trade_name":'      && mij_seller_trade_name
     && '"address1":'        && slr_adr1
     && '"address2":'        && slr_adr2
     && '"location":'        && mij_seller_location
     && '"pincode":'         && mij_seller_pincode
     && '"state_code":'      && mij_seller_state_code
     && '"phone_number":'    && mij_seller_phone_number
     && '"email":'           && mij_seller_email
     && '},'
     && '"buyer_details":'
     && '{'
     && '"gstin":'           && mij_buyer_gstin
     && '"legal_name":'      && byr_lgl_name
     && '"trade_name":'      && mij_buyer_trade_name
     && '"address1":'        && byr_adr1
     && '"address2":'        && byr_adr2
     && '"location":'        && mij_buyer_location
     && '"pincode":'         && mij_buyer_pincode
     && '"place_of_supply":' && byr_pls_supply
     && '"state_code":'      && mij_buyer_state_code
     && '"phone_number":'    && mij_buyer_phone_number
     && '"email":'           && mij_buyer_email
     && '},'.

    " **"SOC for ship details changes
    IF wa_data-tran_typ = 'SHP'.
      mij_gw_string = mij_gw_string
     && '"ship_details":'
     && '{'
     && '"gstin":'      && mij_ship_gstin
     && '"legal_name":' && shp_lgl_name
     && '"trade_name":' && mij_ship_trade_name
     && '"address1":'   && shp_adr1
     && '"address2":'   && shp_adr2
     && '"location":'   && mij_ship_location
     && '"pincode":'    && mij_ship_pincode
     && '"state_code":' && mij_ship_state_code
     && '},'.
    ENDIF.
    " **"EOC for ship details changes

    IF wa_data-tran_catg = 'EXPWOP' OR wa_data-tran_catg = 'EXPWP'.
      SELECT SINGLE kunag FROM vbrk INTO @DATA(lv_kun) WHERE vbeln = @wa_data-vbeln.
      IF sy-subrc = 0.
        SELECT SINGLE land1 FROM kna1 INTO @DATA(lv_con) WHERE kunnr = @lv_kun.
      ENDIF.

      mij_gw_string = mij_gw_string

        && '"export_details":'
        && '{'
*        && '"ship_bill_number":'  && '"",'
*        && '"ship_bill_date":' &&  '"24/04/2023",'
        && '"country_code":' && |"{ lv_con }"|
*        && '"foreign_currency":'  && '"INR",'
*        && '"refund_claim":'  && '"N",'
*        && '"port_code":' &&  '"",'
*        && '"export_duty":' && 3524-24
        && '},'.
    ENDIF.

**     &&  '"dispatch_details":'
**     &&  '{'
**     &&  '"company_name":'    && disp_comp_name
**     &&  '"address1":'        && disp_adr1
**     &&  '"address2":'        && disp_adr2
**     &&  '"location":'        && mij_dispatch_location
**     &&  '"pincode":'         && mij_dispatch_pincode
**     &&  '"state_code":'      && mij_dispatch_state_code
**     &&  '},'
**     &&  '"ship_details":'
**     &&  '{'
**     &&  '"gstin":'           && mij_ship_gstin
**     &&  '"legal_name":'      && shp_lgl_name
**     &&  '"trade_name":'      && mij_ship_trade_name
**     &&  '"address1":'        && shp_adr1
**     &&  '"address2":'        && shp_adr2
**     &&  '"location":'        && mij_ship_location
**     &&  '"pincode":'         && mij_ship_pincode
**     &&  '"state_code":'      && mij_ship_state_code
**     &&  '},'.

    """"******Start:B-4 This Block Can be skip in case of domestic
    " CLEAR: MIJ_EXP_ARRAY.

    " MIJ_EXP_ARRAY = MIJ_EXP_ARRAY
    "    &&  '"export_details":'
    "    &&  '{'
    "
    "    &&  '"ship_bill_number": "qwe1233",'
    "    &&  '"ship_bill_date": "15/03/2020",'
    "    &&  '"country_code": "IN",'
    "    &&  '"foreign_currency": "INR",'
    "    &&  '"refund_claim": "N",'
    "    &&  '"port_code": "232434"'
    " *     &&  '"ship_bill_number":' && MIJ_EXPORT_SHIP_BILL_NUMBER
    " *     &&  '"ship_bill_date":'   && MIJ_EXPORT_SHIP_BILL_DATE
    " *     &&  '"country_code":'     && MIJ_EXPORT_COUNTRY_CODE
    " *     &&  '"foreign_currency":' && MIJ_EXPORT_FOREIGN_CURRENCY
    " *     &&  '"refund_claim":'     && RFND_CLM
    " *     &&  '"port_code":'        && MIJ_EXPORT_PORT_CODE
    "    &&  '},'.
    " CONDENSE MIJ_EXP_ARRAY.
    " IF WA_DATA-TRAN_CATG = 'EXP'.
    "   MIJ_GW_STRING = MIJ_GW_STRING && MIJ_EXP_ARRAY.
    " ENDIF.
    """"******Start:B-4 This Block Can be skip in case of domestic

    """"******Start:B-3 This Block Can be skip
    " &&  '"payment_details":'
    " &&  '{'
    " &&  '"bank_account_number":' && MIJ_PAYMENT_ACCOUNT_DETAILS
    " &&  '"paid_balance_amount":' && MIJ_PAYMENT_PAID_AMOUNT
    " &&  '"credit_days":'         && MIJ_PAYMENT_CREDIT_DAYS
    " &&  '"credit_transfer":'     && MIJ_PAYMENT_CREDIT_TRANSFER
    " &&  '"direct_debit":'        && MIJ_PAYMENT_DIRECT_DEBIT
    " &&  '"branch_or_ifsc":'      && MIJ_PAYMENT_BRANCH_OR_IFSC
    " &&  '"payment_mode":'        && MIJ_PAYMENT_PAYMENT_MODE
    " &&  '"payee_name":'          && MIJ_PAYMENT_PAYEE_NAME
    " &&  '"payment_due_date":'    && MIJ_PAYMENT_PAYMENT_DUE_DATE
    " &&  '"payment_instruction":' && MIJ_PAYMENT_INSTRUCTION
    " &&  '"payment_term":'        && MIJ_PAYMENT_PAYMENT_TERM
    " &&  '},'
    """"******Start:B-3 This Block Can be skip

    """"******Start:B-2 This Block Can be skip
    " &&  '"reference_details":'
    " &&  '{'
    " &&  '"invoice_remarks":'           &&  MIJ_REF_INV_REMARKS
    " &&  '"invoice_period_start_date":' &&  MIJ_REF_INV_PERIOD_START_DATE
    " &&  '"invoice_period_end_date":'   &&  MIJ_REF_INV_PERIOD_END_DATE
    " &&  '"preceding_document_details":'
    " &&  '['
    " &&  '{'
    " &&  '"reference_of_original_invoice":' && MIJ_ORIGINAL_DOCUMENT_NUMBER
    " &&  '"preceding_invoice_date":'        && MIJ_REF_PRECEDING_INV_DATE
    " &&  '"other_reference":'               && OTH_REF
    " &&  '}'
    " &&  '],'
    " &&  '"contract_details":'
    " &&  '['
    " &&  '{'
    " &&  '"receipt_advice_number":'         && CONTRCT_RECPT_ADV_NUM
    " &&  '"receipt_advice_date":'           && CONTRCT_RECPT_ADV_DAT
    " &&  '"batch_reference_number":'        && CONTRCT_BATCH_REF_NUM
    " &&  '"contract_reference_number":'     && CONTRCT_CONTRCT_REF_NUM
    " &&  '"other_reference":'               && CONTRCT_OTHR_REF
    " &&  '"project_reference_number":'      && CONTRCT_PROJ_REF_NUM
    " &&  '"vendor_po_reference_number":'    && CONTRCT_VEN_PO_REF_NUM
    " &&  '"vendor_po_reference_date":'      && CONTRCT_VEN_PO_REF_DAT
    " &&  '}'
    " &&  ']'
    " &&  '},'
    " &&  '"additional_document_details":'
    " &&  '['
    " &&  '{'
    " &&  '"supporting_document_url":'        && ADDL_SUP_DOC_URL
    " &&  '"supporting_document":'            && ADDL_SUP_DOC
    " &&  '"additional_information":'         && ADDL_INFO
    " &&  '}'
    " &&  '],'
    """"******Start:B-2 This Block Can be skip

    mij_gw_string = mij_gw_string
    && '"value_details":'
    && '{'

    && '"total_assessable_value":'                  && mij_value_total_assess_value
    && '"total_cgst_value":'                        && mij_value_total_cgst_value
    && '"total_sgst_value":'                        && mij_value_total_sgst_value
    && '"total_igst_value":'                        && mij_value_total_igst_value
    && '"total_cess_value":'                        && mij_value_total_cess_value
    && '"total_cess_nonadvol_value":'               && mij_value_total_cess_non_value
    && '"total_other_charge":'                      && mij_value_other_charge
    && '"total_invoice_value":'                     && mij_value_total_invoice_value
    && '"total_cess_value_of_state":'               && mij_value_total_cess_v_state
    && '"round_off_amount":'                        && val_dt_roundoff
    && '"total_invoice_value_additional_currency":' && val_dt_tot_inv_ac

*  &&  '"total_assessable_value": 1,'
*  &&  '"total_cgst_value": 0,'
*  &&  '"total_sgst_value": 0,'
*  &&  '"total_igst_value": 0.01,'
*  &&  '"total_cess_value": 0,'
*  &&  '"total_cess_nonadvol_value": 0,'
*  &&  '"total_invoice_value": 1.01,'
*  &&  '"total_cess_value_of_state": 0,'
*  &&  '"round_off_amount": 0,'
*  &&  '"total_invoice_value_additional_currency": 0'

    && '},'

""""******Start:B-1 This Block Can be skip
*     &&  '"ewaybill_details":'
*     &&  '{'
*     &&  '"transporter_id":'                &&     EWAY_TRANSP_ID
*     &&  '"transporter_name":'              &&     EWAY_TRANSP_NAME
*     &&  '"transportation_mode":'           &&     EWAY_TRANSP_MODE
*     &&  '"transportation_distance":'       &&     EWAY_TRANSP_DIST
*     &&  '"transporter_document_number":'   &&     EWAY_TRANSP_DOC_NUM
*     &&  '"transporter_document_date":'     &&     EWAY_TRANSP_DOC_DAT
*     &&  '"vehicle_number":'                &&     EWAY_VECH_NUM
*     &&  '"vehicle_type":'                  &&     EWAY_VECH_TYPE
*     &&  '},'
""""******End:B-1 This Block Can be skip

    && '"item_list": '
    && '['
    && '{'.

    CLEAR itm_count.
    CLEAR line_itm.
    DESCRIBE TABLE li_final LINES line_itm.

    LOOP AT li_final INTO lw_data.
      itm_count += 1.

*    ""Item Details Started
      IF lw_data-item_freeqty IS INITIAL.
        lw_data-item_freeqty = 0.
      ENDIF.

      IF lw_data-item_unitprice IS INITIAL.
        lw_data-item_unitprice = 0.
      ENDIF.

      IF lw_data-item_totamt IS INITIAL.
        lw_data-item_totamt = 0.
      ENDIF.

      IF lw_data-item_discount IS INITIAL.
        lw_data-item_discount = 0.
      ENDIF.

      IF lw_data-item_othchrg IS INITIAL.
        lw_data-item_othchrg = 0.
      ENDIF.

      IF lw_data-item_assamt IS INITIAL.
        lw_data-item_assamt = 0.
      ENDIF.

      IF wa_data-item_sgstrt IS INITIAL.
        wa_data-item_sgstrt = 0.
      ENDIF.

      IF lw_data-item_cgstrt IS INITIAL.
        lw_data-item_cgstrt = 0.
      ENDIF.

      IF lw_data-item_igstrt IS INITIAL.
        lw_data-item_igstrt = 0.
      ENDIF.

      IF lw_data-item_cesrt IS INITIAL.
        lw_data-item_cesrt = 0.
      ENDIF.

      IF lw_data-item_cesnonadval IS INITIAL.
        lw_data-item_cesnonadval = 0.
      ENDIF.

      IF lw_data-item_stateces IS INITIAL.
        lw_data-item_stateces = 0.
      ENDIF.

      IF lw_data-item_totitemval IS INITIAL.
        lw_data-item_totitemval = 0.
      ENDIF.

      IF lw_data-item_barcde IS INITIAL. "*Mandatory
        lw_data-item_barcde = '123497'.
      ENDIF.

      IF lw_data-item_batch_nm IS INITIAL. "*Mandatory
        lw_data-item_batch_nm = 'TEST123'.
      ENDIF.

      IF lw_data-item_batch_expdt IS INITIAL. "*Mandatory
        lw_data-item_batch_expdt = '31/12/2021'.
      ENDIF.

      IF lw_data-item_batch_wrdt IS INITIAL. "*Mandatory
        lw_data-item_batch_wrdt = '31/12/2021'.
      ENDIF.

      IF lw_data-itm_pre_tax_val IS INITIAL.
        lw_data-itm_pre_tax_val = '0'.
      ENDIF.

      IF lw_data-itm_gst_rate IS INITIAL.
        lw_data-itm_gst_rate = '0'.
      ENDIF.

      IF lw_data-itm_igst_amt IS INITIAL.
        lw_data-itm_igst_amt = '0'.
      ENDIF.

      IF lw_data-itm_cgst_amt IS INITIAL.
        lw_data-itm_cgst_amt = '0'.
      ENDIF.

      IF lw_data-itm_sgst_amt IS INITIAL.
        lw_data-itm_sgst_amt = '0'.
      ENDIF.

      IF lw_data-itm_cess_amt IS INITIAL.
        lw_data-itm_cess_amt = '0'.
      ENDIF.

      IF lw_data-itm_stat_cess_amt IS INITIAL.
        lw_data-itm_stat_cess_amt = '0'.
      ENDIF.

      IF lw_data-itm_stat_cess_nadvol_amt IS INITIAL.
        lw_data-itm_stat_cess_nadvol_amt = '0'.
      ENDIF.
      lw_data-item_discount *= -1.

      "   if LW_DATA-ITEM_OTHCHRG  ca '-'.
      "   replace '-' in LW_DATA-ITEM_OTHCHRG  with ' '.
      "   LW_DATA-ITEM_OTHCHRG  = '-' && LW_DATA-ITEM_OTHCHRG .
      " endif.

      mij_item_product_name        = '"' && lw_data-item_prdnm       && '",'. " product_name":
      mij_item_product_description = '"' && lw_data-item_prddesc     && '",'. " product_description":
      mij_item_hsn_code            = '"' && lw_data-item_hsncd       && '",'. " hsn_code":
      mij_item_bar_code            = '"' && lw_data-item_barcde      && '",'. " bar_code":
      mij_item_quantity            = ''  && lw_data-item_qty         && ','. " quantity":
      mij_item_free_quantity       = ''  && lw_data-item_freeqty     && ','. " free_quantity":
      mij_item_unit                = '"' && lw_data-item_unit        && '",'. " unit":
      mij_item_unit_price          = ''  && lw_data-item_unitprice   && ','. " unit_price":
      mij_item_total_amount        = ''  && lw_data-item_totamt      && ','. " total_amount":
      mij_item_discount            = ''  && lw_data-item_discount    && ','. " discount":
      mij_item_other_charge        = ''  && lw_data-item_othchrg     && ','. " other_charge":
      mij_item_assessable_value    = ''  && lw_data-item_assamt      && ','. " assessable_value":
      mij_item_sgst_rate           = ''  && lw_data-item_sgstrt      && ','. " sgst_rate":
      mij_item_cgst_rate           = ''  && lw_data-item_cgstrt      && ','. " cgst_rate":
      mij_item_igst_rate           = ''  && lw_data-item_igstrt      && ','. " igst_rate":
      mij_item_cess_rate           = ''  && lw_data-item_cesrt       && ','. " cess_rate":
      mij_item_cess_nonadvol_value = ''  && lw_data-item_cesnonadval && ','. " cess_nonadvol_value":
      mij_item_state_cess_rate     = ''  && lw_data-item_stateces    && ','. " state_cess_rate":
      mij_item_total_item_value    = ''  && lw_data-item_totitemval  && ','.  " total_item_value":
      mij_item_batch_name          = '"' && lw_data-item_batch_nm    && '",'. " name":
      mij_item_batch_expiry_date   = '"' && lw_data-item_batch_expdt && '",'. " expiry_date":
      mij_item_batch_warranty_date = '"' && lw_data-item_batch_wrdt  && '"'.  " warranty_date":

      itm_sr_num                   = '"' && lw_data-itm_sr_num               && '",'.
      itm_is_service               = '"' && lw_data-itm_is_service           && '",'.
      itm_pre_tax_val              = ''  && lw_data-itm_pre_tax_val          && ','.
      itm_gst_rate                 = ''  && lw_data-itm_gst_rate             && ','.
      itm_igst_amt                 = ''  && lw_data-itm_igst_amt             && ','.
      itm_cgst_amt                 = ''  && lw_data-itm_cgst_amt             && ','.
      itm_sgst_amt                 = ''  && lw_data-itm_sgst_amt             && ','.
      itm_cess_amt                 = ''  && lw_data-itm_cess_amt             && ','.
      itm_stat_cess_amt            = ''  && lw_data-itm_stat_cess_amt        && ','.
      itm_stat_cess_nadvol_amt     = ''  && lw_data-itm_stat_cess_nadvol_amt && ','.
      itm_cntry_orgin              = '"' && lw_data-itm_cntry_orgin          && '",'.
      itm_odr_line_ref             = '"' && lw_data-itm_odr_line_ref         && '",'.
      itm_prodct_sr_num            = '"' && lw_data-itm_prodct_sr_num        && '",'.
      atr_itm_attribte_detl        = '"' && lw_data-atr_itm_attribte_detl    && '",'.
      atr_itm_attribte_val         = '"' && lw_data-atr_itm_attribte_val     && '"'.

      PERFORM condense_variables.
*      CLEAR : MIJ_ITM_GW_STRING.

      mij_itm_gw_string = mij_itm_gw_string
        && '"item_serial_number":'         && itm_sr_num
        && '"product_description":'        && mij_item_product_description
        && '"is_service":'                 && itm_is_service
        && '"hsn_code":'                   && mij_item_hsn_code
        && '"bar_code":'                   && mij_item_bar_code
        && '"quantity":'                   && mij_item_quantity
        && '"free_quantity":'              && mij_item_free_quantity
        && '"unit":'                       && mij_item_unit
        && '"unit_price":'                 && mij_item_unit_price
        && '"total_amount":'               && mij_item_total_amount
        && '"pre_tax_value":'              && itm_pre_tax_val
        && '"discount":'                   && mij_item_discount
        && '"other_charge":'               && mij_item_other_charge
        && '"assessable_value":'           && mij_item_assessable_value
        && '"gst_rate":'                   && itm_gst_rate
        && '"igst_amount":'                && itm_igst_amt
        && '"cgst_amount":'                && itm_cgst_amt
        && '"sgst_amount":'                && itm_sgst_amt
        && '"cess_rate":'                  && mij_item_cess_rate
        && '"cess_amount":'                && itm_cess_amt
        && '"cess_nonadvol_value":'        && mij_item_cess_nonadvol_value
        && '"state_cess_rate":'            && mij_item_state_cess_rate
        && '"state_cess_amount":'          && itm_stat_cess_amt
        && '"state_cess_nonadvol_amount":' && itm_stat_cess_nadvol_amt
        && '"total_item_value":'           && mij_item_total_item_value
        && '"country_origin":'             && itm_cntry_orgin
        && '"order_line_reference":'       && itm_odr_line_ref
        && '"product_serial_number":'      && itm_prodct_sr_num

*  &&  '"item_serial_number": "8965",'
*  &&  '"product_description": "Wheat desc",'
*  &&  '"is_service": "N",'
*  &&  '"hsn_code": "1001",'
*  &&  '"bar_code": "1212",'
*  &&  '"quantity": 1,'
*  &&  '"free_quantity": 0,'
*  &&  '"unit": "KGS",'
*  &&  '"unit_price": 1,'
*  &&  '"total_amount": 1,'
*  &&  '"pre_tax_value": 0,'
*  &&  '"discount": 0,'
*  &&  '"other_charge": 0,'
*  &&  '"assessable_value": 1,'
*  &&  '"gst_rate": 0,'
*  &&  '"igst_amount": 0,'
*  &&  '"cgst_amount": 1,'
*  &&  '"sgst_amount": 0,'
*  &&  '"cess_rate": 0,'
*  &&  '"cess_amount": 0,'
*  &&  '"cess_nonadvol_amount": 0,'
*  &&  '"state_cess_rate": 0,'
*  &&  '"state_cess_amount": 0,'
*  &&  '"state_cess_nonadvol_amount": 0,'
*  &&  '"total_item_value": 1,'
*  &&  '"country_origin": "52",'
*  &&  '"order_line_reference": "5236",'
*  &&  '"product_serial_number": "14785",'

        && '"batch_details":'
        && '{'
        && '"name":'          && mij_item_batch_name
        && '"expiry_date":'   && mij_item_batch_expiry_date
        && '"warranty_date":' && mij_item_batch_warranty_date
*  &&  '"name": "aaa",'
*  &&  '"expiry_date": "10/02/2020",'
*  &&  '"warranty_date": "20/02/2020"'
        && '},'

        && '"attribute_details":'
        && '['
        && '{'
        && '"item_attribute_details":' && atr_itm_attribte_detl
        && '"item_attribute_value":'   && atr_itm_attribte_val
*  &&  '"item_attribute_details": "aaa",'
*  &&  '"item_attribute_value": "147852"'
        && '}'
        && ']'.

      " * &&  '}'
      " * &&  ']'.

      IF line_itm = itm_count.
        mij_itm_gw_string = mij_itm_gw_string && '}'.
      ELSE.
        mij_itm_gw_string = mij_itm_gw_string && '},{'.
      ENDIF.

      PERFORM clear_itm_variables.
      CLEAR lw_data.
    ENDLOOP.

**    BREAK mawai_abap.
    mij_gw_string = mij_gw_string
      && mij_itm_gw_string
**      &&  '}'.
      && ']}'.

    CONDENSE mij_gw_string.
    """""******End:New: JSON:Master India: 07.03.2020*****************************************************"""""""""""""""

    """""******End: Old: JSON:Master India*****************************************************"""""""""""""""
    " CLEAR: MIJ_GW_STRING.
    " PERFORM TEST_NEW_JSON.

    """*********************************************"""""
    " * PERFORM CALCULATE_STRING_LENGTH.
    """*********************************************"""""

    CLEAR grlength1.
    w_string1 = mij_gw_string.
    grlength1 = strlen( w_string1 ).

    """*********************************************"""""
    " * PERFORM CREATE_URL.
    """*********************************************"""""
    " ****Creation of HTTP Client
    cl_http_client=>create_by_url( EXPORTING  url                = gp_url1
                                   IMPORTING  client             = glo_http_client1
                                   EXCEPTIONS argument_not_found = 1
                                              plugin_not_active  = 2
                                              internal_error     = 3
                                              OTHERS             = 4 ).

    " **** Set up the HTTP data passing method
    glo_http_client1->request->set_method( method = 'POST' ).

    " ** Set up the HTTP Post version
    glo_http_client1->request->set_version(
*                                            version = '1001'.
      version = if_http_request=>co_protocol_version_1_1 ). " 1001

    " ***set the content type of request data
    glo_http_client1->request->if_http_entity~set_content_type( content_type = 'application/json; charset=utf-8' ).

    " ***Set up the HTTP header
    glo_http_client1->request->set_header_field( name  = 'Host'
                                                 value = gp_url1 ). """http://einvoice.mawaiweb.com/api//Invoice/All

    " * Set up the HTTP data i.e pass/set the data into API
    glo_http_client1->request->set_cdata( data   = w_string1
                                          offset = 0
                                          length = grlength1 ).

    " ** Send the HTTP Post request to the URL.
    glo_http_client1->send( EXPORTING  timeout                    = 15   " 15 Seconds
                            EXCEPTIONS http_communication_failure = 1
                                       http_invalid_state         = 2 ).

    " ***Read the Response from API
    glo_http_client1->receive( EXCEPTIONS http_communication_failure = 1
                                          http_invalid_state         = 2
                                          http_processing_failed     = 3 ).

    " Get the HTTP return code from the HTTP POST:
    glo_http_client1->response->get_status( IMPORTING code = gw_http_return_code1 ).
    glo_http_client1->response->get_status( IMPORTING reason = gw_http_error_descr1 ).
    gw_http_error_descr_long1 = glo_http_client1->response->get_raw_message( ).

    glo_http_client1->refresh_request( EXCEPTIONS http_action_failed = 1
                                                  OTHERS             = 2 ).

    " ****Write the data received back from the POST to the screen:
    CLEAR gw_xml_result_str1.
    gw_xml_result_str1 = glo_http_client1->response->get_cdata( ).
    glo_http_client1->close( ).
    sy-tmaxl = strlen( gw_xml_result_str1 ).
    ASSIGN gw_xml_result_str1 TO <gfs1>.
    CLEAR gv_api_ret_msg.
    gv_api_ret_msg = <gfs1>.
    WRITE / <gfs1>(sy-tmaxl).

    IF <gfs1> IS ASSIGNED.
      lv_main = <gfs1>.
    ENDIF.

    CLEAR lv_string1.
    CLEAR lv_string2.
    CLEAR lv_string3.
    CLEAR lv_string4.
    SPLIT lv_main AT '"status":"' INTO lv_string1 lv_string2.
    IF lv_string2 IS NOT INITIAL.
      lv_success = lv_string2+0(7).
      IF lv_success = 'Success'.

        ASSIGN gw_xml_result_str1 TO <gfs1>.
        CLEAR lv1.
        CLEAR lv2.
        CLEAR lv3.
        CLEAR lv4.
        CLEAR lv5.
        CLEAR lv6.
        CLEAR lv7.
        CLEAR lv8.
        CLEAR lv9.
        CLEAR lv10.
        CLEAR lv11.
        CLEAR lv12.
        CLEAR lv13.
        CLEAR lv14.
        CLEAR lv15.
        CLEAR lv16.
        CLEAR lv17.
        CLEAR lv18.
        CLEAR lv19.
        CLEAR lv20.
        CLEAR lv21.
        CLEAR lv22.
        CLEAR lv23.
        CLEAR lv24.
        CLEAR lv25.
        CLEAR lv26.
        CLEAR lv27.
        CLEAR lv28.
        CLEAR lv29.
        CLEAR lv30.
        CLEAR lv31.
        CLEAR lv32.
        CLEAR lv33.
        CLEAR lv34.
        CLEAR lv35.
        CLEAR signedqrcode.
        CLEAR irn_value.
        CLEAR signedinvoice.

        " SPLIT <GFS1> AT ',' INTO LV1 LV2 LV3 LV4 LV5 LV6 LV7 LV8 LV9 lv10 lv11 lv12 lv13 lv14.
        SPLIT <gfs1> AT ':' INTO lv1 lv2 lv3 lv4 lv5 lv6 lv7 lv8 lv9 lv10 lv11 lv12 lv13 lv14.
        SPLIT lv10   AT ',' INTO signedqrcode  lv16.
        SPLIT lv8    AT ',' INTO irn_value     lv18.
        SPLIT lv9    AT ',' INTO signedinvoice lv20.
        REPLACE ALL OCCURRENCES OF '"' IN signedqrcode  WITH space.
        REPLACE ALL OCCURRENCES OF '"' IN irn_value     WITH space.
        REPLACE ALL OCCURRENCES OF '"' IN signedinvoice WITH space.
        CONDENSE signedqrcode.
        CONDENSE irn_value.
        CONDENSE signedinvoice.

**"SOC for AckNo & AckDate by Gaurav(07.01.2021)
        CLEAR gv_lv1.
        CLEAR gv_lv2.
        CLEAR gv_lv3.
        CLEAR gv_lv4.
        CLEAR ackno.
        CLEAR ackdate.
        SPLIT lv4 AT ',' INTO gv_lv1 gv_lv2.
        SPLIT lv5 AT ''  INTO gv_lv3 gv_lv4.
        REPLACE ALL OCCURRENCES OF '"' IN gv_lv1 WITH space.
        REPLACE ALL OCCURRENCES OF '"' IN gv_lv3 WITH space.
        CONDENSE gv_lv1.
        CONDENSE gv_lv3.
        ackno   = gv_lv1.
        ackdate = gv_lv3.
        CONDENSE ackno.
        CONDENSE ackdate.
**"EOC for AckNo & AckDate by Gaurav(07.01.2021)

        CLEAR gs_irn.
        gs_irn = irn_value.
        "-------Saving the QR Code Returned by Govt. Portal Into invoice respective Text-ID----------"
        IF gs_irn IS NOT INITIAL.

          CLEAR gw_head.
          IF fi_einv IS INITIAL.

            gw_head-tdobject = 'VBBK'.
            gw_head-tdname   = wa_data-vbeln.
            gw_head-tdid     = 'ZIRN'.
            gw_head-tdspras  = sy-langu.

          ELSE.

            IF wa_data-bukrs = '1000'.
              gw_head-tdobject = 'VBBK'.
              gw_head-tdname   = wa_data-vbeln.
              gw_head-tdid     = 'ZIR1'.
              gw_head-tdspras  = sy-langu.
            ENDIF.

**            IF wa_data-bukrs = '6000'.
**              gw_head-tdobject = 'BELEG'.
**              gw_head-tdname   = wa_data-vbeln.
**              gw_head-tdid     = 'ZDSI'.
**              gw_head-tdspras  = sy-langu.
**            ENDIF.
**
**            IF wa_data-bukrs = '2000'.
**              gw_head-tdobject = 'BELEG'.
**              gw_head-tdname   = wa_data-vbeln.
**              gw_head-tdid     = 'ZCTI'.
**              gw_head-tdspras  = sy-langu.
**            ENDIF.
**
**            IF wa_data-bukrs = '3000'.
**              gw_head-tdobject = 'BELEG'.
**              gw_head-tdname   = wa_data-vbeln.
**              gw_head-tdid     = 'ZSSI'.
**              gw_head-tdspras  = sy-langu.
**            ENDIF.
**
**            IF wa_data-bukrs = '4000'.
**              gw_head-tdobject = 'BELEG'.
**              gw_head-tdname   = wa_data-vbeln.
**              gw_head-tdid     = 'ZNII'.
**              gw_head-tdspras  = sy-langu.
**            ENDIF.
**
**            IF wa_data-bukrs = '5000'.
**              gw_head-tdobject = 'BELEG'.
**              gw_head-tdname   = wa_data-vbeln.
**              gw_head-tdid     = 'ZQEI'.
**              gw_head-tdspras  = sy-langu.
**            ENDIF.
**
**            IF wa_data-bukrs = '7000'.
**              gw_head-tdobject = 'BELEG'.
**              gw_head-tdname   = wa_data-vbeln.
**              gw_head-tdid     = 'ZSEI'.
**              gw_head-tdspras  = sy-langu.
**            ENDIF.
**
**            IF wa_data-bukrs = '8000'.
**              gw_head-tdobject = 'BELEG'.
**              gw_head-tdname   = wa_data-vbeln.
**              gw_head-tdid     = 'ZSEE'.
**              gw_head-tdspras  = sy-langu.
**            ENDIF.

          ENDIF.

          REFRESH gt_lines[].
          gw_lines-tdformat = '*'.
          gw_lines-tdline   = gs_irn.
          APPEND gw_lines TO gt_lines.
          CLEAR gw_lines.

          IF gw_head IS NOT INITIAL. """" added by sumit 03.03.2021
            CALL FUNCTION 'SAVE_TEXT'
              EXPORTING
                client          = sy-mandt
                header          = gw_head
                savemode_direct = 'X'
              TABLES
                lines           = gt_lines.

          ENDIF.
        ENDIF.

        IF signedqrcode IS NOT INITIAL.

          CLEAR gw_head.
          IF fi_einv IS INITIAL.
            gw_head-tdobject = 'VBBK'.
            gw_head-tdname   = wa_data-vbeln.
            gw_head-tdid     = 'ZQRC'.
            gw_head-tdspras  = sy-langu.
          ELSE.

            IF wa_data-bukrs = '1000'.
              gw_head-tdobject = 'VBBK'.
              gw_head-tdname   = wa_data-vbeln.
              gw_head-tdid     = 'ZQR1'.
              gw_head-tdspras  = sy-langu.
            ENDIF.

**            IF wa_data-bukrs = '6000'.
**              gw_head-tdobject = 'BELEG'.
**              gw_head-tdname   = wa_data-vbeln.
**              gw_head-tdid     = 'ZDSP'.
**              gw_head-tdspras  = sy-langu.
**            ENDIF.
**
**            IF wa_data-bukrs = '2000'.
**              gw_head-tdobject = 'BELEG'.
**              gw_head-tdname   = wa_data-vbeln.
**              gw_head-tdid     = 'ZCTP'.
**              gw_head-tdspras  = sy-langu.
**            ENDIF.
**
**            IF wa_data-bukrs = '3000'.
**              gw_head-tdobject = 'BELEG'.
**              gw_head-tdname   = wa_data-vbeln.
**              gw_head-tdid     = 'ZSSP'.
**              gw_head-tdspras  = sy-langu.
**            ENDIF.
**
**            IF wa_data-bukrs = '4000'.
**              gw_head-tdobject = 'BELEG'.
**              gw_head-tdname   = wa_data-vbeln.
**              gw_head-tdid     = 'ZNIP'.
**              gw_head-tdspras  = sy-langu.
**            ENDIF.
**
**            IF wa_data-bukrs = '5000'.
**              gw_head-tdobject = 'BELEG'.
**              gw_head-tdname   = wa_data-vbeln.
**              gw_head-tdid     = 'ZQEP'.
**              gw_head-tdspras  = sy-langu.
**            ENDIF.
**
**            IF wa_data-bukrs = '7000'.
**              gw_head-tdobject = 'BELEG'.
**              gw_head-tdname   = wa_data-vbeln.
**              gw_head-tdid     = 'ZSEL'.
**              gw_head-tdspras  = sy-langu.
**            ENDIF.
**
**            IF wa_data-bukrs = '8000'.
**              gw_head-tdobject = 'BELEG'.
**              gw_head-tdname   = wa_data-vbeln.
**              gw_head-tdid     = 'ZSPL'.
**              gw_head-tdspras  = sy-langu.
**            ENDIF.

          ENDIF.

          REFRESH lt_string_comp[].
          CLEAR lv_longtext.
          lv_longtext = signedqrcode.
          CALL FUNCTION 'SWA_STRING_SPLIT'
            EXPORTING
              input_string         = lv_longtext     " string to be split
              max_component_length = 130
            TABLES
              string_components    = lt_string_comp.

          REFRESH gt_lines[].
          LOOP AT lt_string_comp INTO lw_string_comp.

            gw_lines-tdformat = '*'.
            gw_lines-tdline   = lw_string_comp-str. " LS_RETURN-SIGNEDQRCODE.
            APPEND gw_lines TO gt_lines.

            CLEAR gw_lines.
            CLEAR lw_string_comp.
          ENDLOOP.

          " * REFRESH GT_LINES[].
          " * GW_LINES-TDFORMAT = '*'.
          " * GW_LINES-TDLINE   = LS_RETURN-SIGNEDQRCODE.
          " * APPEND GW_LINES TO GT_LINES.
          " * CLEAR : GW_LINES.
          IF gw_head IS NOT INITIAL. """" added by sumit
            CALL FUNCTION 'SAVE_TEXT'
              EXPORTING
                client          = sy-mandt
                header          = gw_head
                savemode_direct = 'X'
              TABLES
                lines           = gt_lines.

          ENDIF.
        ENDIF.

        """"************************************************************************
        CLEAR canc_irn.
        IF gs_irn IS NOT INITIAL.
          ""**Start: Save Data in ztable: ZSD_EINVOICE
          PERFORM save_data_into_ztable.
          ""**End: Save Data in ztable: ZSD_EINVOICE
        ELSE.
          ""**Modify display internal table: in case of error
          PERFORM update_ztable_for_error.
          ""**End: Modify display internal table: : in case of error
        ENDIF.
        """"************************************************************************

      ELSE.
        CLEAR text.
        text = gv_api_ret_msg.
        CALL SCREEN '9002'.
      ENDIF.

    ELSE.
      CLEAR text.
      text = gv_api_ret_msg.
      CALL SCREEN '9002'.
    ENDIF.

    CLEAR wa_data.
  ENDLOOP.
*  ""------------------------------------------------------------------------------------""
  REFRESH ct_final[].

ENDFORM.

*&---------------------------------------------------------------------*
*& Form CLEAR_VARIABLES
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
FORM clear_variables.
  CLEAR mij_access_token.
  CLEAR mij_user_gstin.
  CLEAR mij_data_source.
  CLEAR mij_category_of_transaction.
  CLEAR mij_charge_type.
  CLEAR mij_transaction_type.
  CLEAR mij_ecommerce_transaction.
  CLEAR mij_ecommerce_gstin.
  CLEAR mij_document_type.
  CLEAR mij_document_number.
  CLEAR mij_document_date.
  CLEAR mij_original_document_number.
  CLEAR mij_seller_gstin.
  CLEAR mij_seller_trade_name.
  CLEAR mij_seller_building_number.
  CLEAR mij_seller_building_name.
  CLEAR mij_seller_floor_number.
  CLEAR mij_seller_location.
  CLEAR mij_seller_district.
  CLEAR mij_seller_pincode.
  CLEAR mij_seller_state_code.
  CLEAR mij_seller_phone_number.
  CLEAR mij_seller_email.
  CLEAR mij_buyer_gstin.
  CLEAR mij_buyer_trade_name.
  CLEAR mij_buyer_building_number.
  CLEAR mij_buyer_building_name.
  CLEAR mij_buyer_floor_number.
  CLEAR mij_buyer_location.
  CLEAR mij_buyer_district.
  CLEAR mij_buyer_pincode.
  CLEAR mij_buyer_state_code.
  CLEAR mij_buyer_phone_number.
  CLEAR mij_buyer_email.
  CLEAR mij_dispatch_gstin.
  CLEAR mij_dispatch_trade_name.
  CLEAR mij_dispatch_building_number.
  CLEAR mij_dispatch_building_name.
  CLEAR mij_dispatch_floor_number.
  CLEAR mij_dispatch_location.
  CLEAR mij_dispatch_district.
  CLEAR mij_dispatch_pincode.
  CLEAR mij_dispatch_state_code.
  CLEAR mij_dispatch_phone_number.
  CLEAR mij_dispatch_email.
  CLEAR mij_ship_gstin.
  CLEAR mij_ship_trade_name.
  CLEAR mij_ship_building_number.
  CLEAR mij_ship_building_name.
  CLEAR mij_ship_floor_number.
  CLEAR mij_ship_location.
  CLEAR mij_ship_district.
  CLEAR mij_ship_pincode.
  CLEAR mij_ship_state_code.
  CLEAR mij_ship_phone_number.
  CLEAR mij_ship_email.
  CLEAR mij_export_export_category.
  CLEAR mij_export_ship_bill_number.
  CLEAR mij_export_ship_bill_date.
  CLEAR mij_export_country_code.
  CLEAR mij_export_foreign_currency.
  CLEAR mij_export_invoice_value_in_fc.
  CLEAR mij_export_port_code.
  CLEAR mij_export_export_payment.
  CLEAR mij_payment_account_details.
  CLEAR mij_payment_paid_amount.
  CLEAR mij_payment_credit_days.
  CLEAR mij_payment_credit_transfer.
  CLEAR mij_payment_direct_debit.
  CLEAR mij_payment_branch_or_ifsc.
  CLEAR mij_payment_payment_mode.
  CLEAR mij_payment_payee_name.
  CLEAR mij_payment_payment_due_date.
  CLEAR mij_payment_instruction.
  CLEAR mij_payment_payment_term.
  CLEAR mij_ref_contract_ref_number.
  CLEAR mij_ref_other_reference.
  CLEAR mij_ref_inv_period_start_date.
  CLEAR mij_ref_inv_period_end_date.
  CLEAR mij_ref_inv_reference_number.
  CLEAR mij_ref_inv_remarks.
  CLEAR mij_ref_vendor_po_ref_number.
  CLEAR mij_ref_preceding_inv_date.
  CLEAR mij_ref_preceding_inv_number.
  CLEAR mij_ref_project_ref_number.
  CLEAR mij_ref_receipt_advice_number.
  CLEAR mij_ref_batch_reference_number.
  CLEAR mij_value_total_assess_value.
  CLEAR mij_value_total_cgst_value.
  CLEAR mij_value_total_sgst_value.
  CLEAR mij_value_total_igst_value.
  CLEAR mij_value_total_cess_value.
  CLEAR mij_value_total_cess_non_value.
  CLEAR mij_value_total_invoice_value.
  CLEAR mij_value_total_cess_v_state.
  CLEAR mij_value_discount.
  CLEAR mij_value_other_charge.
  CLEAR mij_item_product_name.
  CLEAR mij_item_product_description.
  CLEAR mij_item_hsn_code.
  CLEAR mij_item_bar_code.
  CLEAR mij_item_quantity.
  CLEAR mij_item_free_quantity.
  CLEAR mij_item_unit.
  CLEAR mij_item_unit_price.
  CLEAR mij_item_total_amount.
  CLEAR mij_item_discount.
  CLEAR mij_item_other_charge.
  CLEAR mij_item_assessable_value.
  CLEAR mij_item_cgst_rate.
  CLEAR mij_item_sgst_rate.
  CLEAR mij_item_igst_rate.
  CLEAR mij_item_cess_rate.
  CLEAR mij_item_cess_nonadvol_value.
  CLEAR mij_item_state_cess_rate.
  CLEAR mij_item_total_item_value.
  CLEAR mij_item_batch_name.
  CLEAR mij_item_batch_expiry_date.
  CLEAR mij_item_batch_warranty_date.
  CLEAR user_gstin.
  CLEAR mij_gw_string.
  CLEAR data_source.
  CLEAR supply_typ.
  CLEAR slr_lgl_name.
  CLEAR slr_adr1.
  CLEAR slr_adr2.
  CLEAR byr_lgl_name.
  CLEAR byr_adr1.
  CLEAR byr_adr2.
  CLEAR byr_pls_supply.
  CLEAR disp_comp_name.
  CLEAR disp_adr1.
  CLEAR disp_adr2.
  CLEAR shp_lgl_name.
  CLEAR shp_adr1.
  CLEAR shp_adr2.
  CLEAR rfnd_clm.
  CLEAR pymnt_acc_no.
  CLEAR ref_inv_remark.
  CLEAR ref_inv_prd_strt.
  CLEAR ref_inv_prd_end.
  CLEAR prcdg_inv_dat.
  CLEAR oth_ref.
  CLEAR contrct_recpt_adv_num.
  CLEAR contrct_recpt_adv_dat.
  CLEAR contrct_batch_ref_num.
  CLEAR contrct_contrct_ref_num.
  CLEAR contrct_othr_ref.
  CLEAR contrct_proj_ref_num.
  CLEAR contrct_ven_po_ref_num.
  CLEAR contrct_ven_po_ref_dat.
  CLEAR addl_sup_doc_url.
  CLEAR addl_sup_doc.
  CLEAR addl_info.
  CLEAR val_dt_roundoff.
  CLEAR eway_transp_id.
  CLEAR eway_transp_name.
  CLEAR eway_transp_mode.
  CLEAR eway_transp_dist.
  CLEAR eway_transp_doc_num.
  CLEAR eway_transp_doc_dat.
  CLEAR eway_vech_num.
  CLEAR eway_vech_type.
  CLEAR itm_sr_num.
  CLEAR itm_is_service.
  CLEAR itm_pre_tax_val.
  CLEAR itm_gst_rate.
  CLEAR itm_igst_amt.
  CLEAR itm_cgst_amt.
  CLEAR itm_sgst_amt.
  CLEAR itm_cess_amt.
  CLEAR itm_stat_cess_amt.
  CLEAR itm_stat_cess_nadvol_amt.
  CLEAR itm_cntry_orgin.
  CLEAR itm_odr_line_ref.
  CLEAR itm_prodct_sr_num.
  CLEAR atr_itm_attribte_detl.
  CLEAR atr_itm_attribte_val.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form TEST_NEW_JSON
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM test_new_json.
  mij_gw_string = '{'
  && '"access_token":' && mij_access_token
  && '"user_gstin": "09AAAPG7885R002",'
  && '"data_source": "erp",'
  && '"transaction_details":'
  && '{'
  && '"supply_type": "B2B",'
  && '"charge_type": "N",'
  && '"ecommerce_gstin": ""'
  && '},'
  && '"document_details":'
  && '{'
  && '"document_type": "INV",'
  && '"document_number": "BMW/015",'
  && '"document_date": "07/03/2020"'
  && '},'
  && '"seller_details":'
  && '{'
  && '"gstin": "09AAAPG7885R002",'
  && '"legal_name": "MastersIndia UP",'
  && '"trade_name": "MastersIndia UP",'
  && '"address1": "Vila",'
  && '"address2": "Vila",'
  && '"location": "Noida",'
  && '"pincode": 201301,'
  && '"state_code": "UTTAR PRADESH",'
  && '"phone_number": 9876543231,'
  && '"email": ""'
  && '},'
  && '"buyer_details":'
  && '{'
  && '"gstin": "05AAAPG7885R002",'
  && '"legal_name": "MastersIndia UT",'
  && '"trade_name": "MastersIndia UT",'
  && '"address1": "Kila",'
  && '"address2": "Kila",'
  && '"location": "Nainital",'
  && '"pincode": 110010,'
  && '"place_of_supply": "9",'
  && '"state_code": "UTTARAKHAND",'
  && '"phone_number": 9876543231,'
  && '"email": ""'
  && '},'
  && '"dispatch_details":'
  && '{'
  && '"company_name": "MastersIndia UP",'
  && '"address1": "Vila",'
  && '"address2": "Vila",'
  && '"location": "Noida",'
  && '"pincode": 201301,'
  && '"state_code": "UTTAR PRADESH"'
  && '},'
  && '"ship_details":'
  && '{'
  && '"gstin": "05AAAPG7885R002",'
  && '"legal_name": "MastersIndia UT",'
  && '"trade_name": "MastersIndia UT",'
  && '"address1": "Kila",'
  && '"address2": "Kila",'
  && '"location": "Nainital",'
  && '"pincode": 110010,'
  && '"state_code": "UTTARAKHAND"'
  && '},'
  && '"export_details": '
  && '{'
  && '"ship_bill_number": "qwe1233",'
  && '"ship_bill_date": "08/02/2020",'
  && '"country_code": "IN",'
  && '"foreign_currency": "INR",'
  && '"refund_claim": "N",'
  && '"port_code": "232434"'
  && '},'
  && '"payment_details":'
  && '{'
  && '"bank_account_number": "Account Details",'
  && '"paid_balance_amount": 100,'
  && '"credit_days": 2,'
  && '"credit_transfer": "Credit Transfer",'
  && '"direct_debit": "Direct Debit",'
  && '"branch_or_ifsc": "KKK000180",'
  && '"payment_mode": "CASH",'
  && '"payee_name": "Payee Name",'
  && '"payment_due_date": "08/02/2020",'
  && '"payment_instruction": "Payment Instruction",'
  && '"payment_term": "Terms of Payment"'
  && '},'
  && '"reference_details":'
  && '{'
  && '"invoice_remarks": "Invoice Remarks",'
  && '"invoice_period_start_date": "2020-01-01",'
  && '"invoice_period_end_date": "2020-01-30",'
  && '"preceding_document_details":'
  && '['
  && '{'
  && '"reference_of_original_invoice": "CFRT/0006",'
  && '"preceding_invoice_date": "08/02/2020",'
  && '"other_reference": "2334"'
  && '}'
  && '],'
  && '"contract_details":'
  && '['
  && '{'
  && '"receipt_advice_number": "aaa",'
  && '"receipt_advice_date": "10/02/2020",'
  && '"batch_reference_number": "2334",'
  && '"contract_reference_number": "2334",'
  && '"other_reference": "2334",'
  && '"project_reference_number": "2334",'
  && '"vendor_po_reference_number": "233433454545",'
  && '"vendor_po_reference_date": "10/02/2020"'
  && '}'
  && ']'
  && '},'
  && '"additional_document_details":'
  && '['
  && '{'
  && '"supporting_document_url": "",'
  && '"supporting_document": "india",'
  && '"additional_information": "india"'
  && '}'
  && '],'
  && '"value_details":'
  && '{'
  && '"total_assessable_value": 1,'
  && '"total_cgst_value": 0,'
  && '"total_sgst_value": 0,'
  && '"total_igst_value": 0.01,'
  && '"total_cess_value": 0,'
  && '"total_cess_nonadvol_value": 0,'
  && '"total_invoice_value": 1.01,'
  && '"total_cess_value_of_state": 0,'
  && '"round_off_amount": 0,'
  && '"total_invoice_value_additional_currency": 0'
  && '},'
  && '"ewaybill_details":'
  && '{'
  && '"transporter_id": "05AAABB0639G1Z8",'
  && '"transporter_name": "Jay Trans",'
  && '"transportation_mode": "1",'
  && '"transportation_distance": "120",'
  && '"transporter_document_number": "1230",'
  && '"transporter_document_date": "08/02/2020",'
  && '"vehicle_number": "PQR1234",'
  && '"vehicle_type": "R"'
  && '},'
  && '"item_list": '
  && '['
  && '{'
  && '"item_serial_number": "8965",'
  && '"product_description": "Wheat desc",'
  && '"is_service": "N",'
  && '"hsn_code": "1001",'
  && '"bar_code": "1212",'
  && '"quantity": 1,'
  && '"free_quantity": 0,'
  && '"unit": "KGS",'
  && '"unit_price": 1,'
  && '"total_amount": 1,'
  && '"pre_tax_value": 0,'
  && '"discount": 0,'
  && '"other_charge": 0,'
  && '"assessable_value": 1,'
  && '"gst_rate": 0,'
  && '"igst_amount": 0,'
  && '"cgst_amount": 1,'
  && '"sgst_amount": 0,'
  && '"cess_rate": 0,'
  && '"cess_amount": 0,'
  && '"cess_nonadvol_amount": 0,'
  && '"state_cess_rate": 0,'
  && '"state_cess_amount": 0,'
  && '"state_cess_nonadvol_amount": 0,'
  && '"total_item_value": 1,'
  && '"country_origin": "52",'
  && '"order_line_reference": "5236",'
  && '"product_serial_number": "14785",'
  && '"batch_details":'
  && '{'
  && '"name": "aaa",'
  && '"expiry_date": "10/02/2020",'
  && '"warranty_date": "20/02/2020"'
  && '},'
  && '"attribute_details":'
  && '['
  && '{'
  && '"item_attribute_details": "aaa",'
  && '"item_attribute_value": "147852"'
  && '}]'
  && '}]'
  && '}'.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form CANCEL_IRN_FROM_MI
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM cancel_irn_from_mi.
  " data Variables declaration for passing URL, Result String(Using get_cdata())

  DATA cp_url                   TYPE string.
  DATA cancl_irn                TYPE string.
  DATA cw_string                TYPE string.
  " data Variables declaration for passing the xml input data into API as a string and lenth
  DATA crlength                 TYPE i.
  " *****data declaration for creating HTTP Client, Request, Error description, error code etc
  DATA clo_http_client          TYPE REF TO if_http_client.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA cw_http_return_code      TYPE i.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA cw_http_error_descr      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA cw_http_error_descr_long TYPE xstring.
  DATA cw_xml_result_str        TYPE string.
  """"""""""***************************************
  DATA lv_main                  TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_string1               TYPE string.
  DATA lv_string2               TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_string3               TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_string4               TYPE string.
  DATA lv_success               TYPE string.
  DATA lv1                      TYPE c LENGTH 255.
  DATA lv2                      TYPE c LENGTH 255.
  DATA lv3                      TYPE c LENGTH 255.
  DATA lv4                      TYPE c LENGTH 255.
  DATA lv5                      TYPE c LENGTH 255.
  DATA lv6                      TYPE c LENGTH 5000.
  DATA lv7                      TYPE c LENGTH 5000.
  DATA lv8                      TYPE c LENGTH 255.
  DATA lv9                      TYPE c LENGTH 255.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv10                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv11                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv12                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv13                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv14                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv15                     TYPE c LENGTH 100.
  DATA lv16                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv17                     TYPE c LENGTH 100.
  DATA lv18                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv19                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv20                     TYPE c LENGTH 200.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv21                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv22                     TYPE c LENGTH 5000.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv23                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv24                     TYPE c LENGTH 5000.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv25                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv26                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv27                     TYPE c LENGTH 100.
  DATA lv28                     TYPE c LENGTH 100.
  DATA lv29                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv30                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv31                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv32                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv33                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv34                     TYPE c LENGTH 100.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv35                     TYPE c LENGTH 100.

  FIELD-SYMBOLS <cfs>.

  cp_url = gw_credential-url_einv_canc. "'https://pro.mastersindia.co/cancelEinvoice'.

  CLEAR wa_data.
  LOOP AT gt_final INTO wa_data WHERE check = 'X'.

    PERFORM validate_alreday_done_action.

    CLEAR cancl_irn.
    cancl_irn = '"' && wa_data-irn && '",'.
    CONDENSE cancl_irn.
    CONDENSE access_token.

    mij_seller_gstin = '"' && wa_data-billfrom_gstin && '",'.
    CONDENSE mij_seller_gstin.
    user_gstin = mij_seller_gstin.

    CLEAR cw_string.
    cw_string = '{'
    && '"access_token":' && '"' && access_token && '",' " 4b2a2c22723bf3715e33dcd72a2e19d76ae91568",
    && '"user_gstin":' && user_gstin "*"09AAAPG7885R002",'
    && '"irn":' && cancl_irn
    && '"cancel_reason":"1",'
    && '"cancel_remarks":"cancel Remarks",'
    && '"ewaybill_cancel":"0"'
    && '}'.

    """*********************************************"""""
    CLEAR crlength.
    cw_string = cw_string. "= LV_JSON.
    crlength = strlen( cw_string ).

    """*********************************************"""""
    " * PERFORM CREATE_URL.
    """*********************************************"""""
    " ****Creation of HTTP Client
    cl_http_client=>create_by_url( EXPORTING  url                = cp_url
                                   IMPORTING  client             = clo_http_client
                                   EXCEPTIONS argument_not_found = 1
                                              plugin_not_active  = 2
                                              internal_error     = 3
                                              OTHERS             = 4 ).

    """*********************************************"""""
    " * PERFORM SET_CALLING_METHOD.
    """*********************************************"""""
    " **** Set up the HTTP data passing method
    clo_http_client->request->set_method( method = 'POST' ).

    """*********************************************"""""
    " * PERFORM SET_VERSION.
    """*********************************************"""""
    " ** Set up the HTTP Post version
    clo_http_client->request->set_version( version = if_http_request=>co_protocol_version_1_1 ). " 1001

    """*********************************************"""""
    " * PERFORM SET_CONTENT_TYPE.
    """*********************************************"""""
    " ***set the content type of request data
    clo_http_client->request->if_http_entity~set_content_type( content_type = 'application/json; charset=utf-8' ).

    """*********************************************"""""
    " * PERFORM SETUP_HTTP_HEADER.
    """*********************************************"""""
    " ***Set up the HTTP header
    clo_http_client->request->set_header_field( name  = 'Host'
                                                value = cp_url ).

    """*********************************************"""""
    " * PERFORM PASS_DATA_TO_API.
    """*********************************************"""""
    " * Set up the HTTP data i.e pass/set the data into API
    clo_http_client->request->set_cdata( data   = cw_string
                                         offset = 0
                                         length = crlength ).

    """*********************************************"""""
    " * PERFORM SEND_HTTP_REQUEST.
    """*********************************************"""""
    clo_http_client->propertytype_logon_popup = if_http_client=>co_disabled.

    " ** Send the HTTP Post request to the URL.
    clo_http_client->send( EXPORTING  timeout                    = 15   " 15 Seconds
                           EXCEPTIONS http_communication_failure = 1
                                      http_invalid_state         = 2 ).

    """*********************************************"""""
    " * PERFORM RECEIVE_RESPONSE.
    """*********************************************"""""
    " ***Read the Response from API
    clo_http_client->receive( EXCEPTIONS http_communication_failure = 1
                                         http_invalid_state         = 2
                                         http_processing_failed     = 3 ).

    """*********************************************"""""
    " * PERFORM DISPLAY_RESPONSE.
    """*********************************************"""""
    " Get the HTTP return code from the HTTP POST:
    clo_http_client->response->get_status( IMPORTING code = cw_http_return_code ).
    clo_http_client->response->get_status( IMPORTING reason = cw_http_error_descr ).
    cw_http_error_descr_long = clo_http_client->response->get_raw_message( ).

    clo_http_client->refresh_request( EXCEPTIONS http_action_failed = 1
                                                 OTHERS             = 2 ).

    " ****Write the data received back from the POST to the screen:
    CLEAR cw_xml_result_str.
    cw_xml_result_str = clo_http_client->response->get_cdata( ).
    sy-tmaxl = strlen( cw_xml_result_str ).
    ASSIGN cw_xml_result_str TO <cfs>.
    "* WRITE:/ <CFS>(SY-TMAXL).

    IF <cfs> IS ASSIGNED.
      lv_main = <cfs>.
      gv_api_ret_msg = <cfs>.
    ENDIF.

    CLEAR lv_string1.
    CLEAR lv_string2.
    CLEAR lv_string3.
    CLEAR lv_string4.
    CLEAR canc_irn.
    SPLIT lv_main AT '"status":"' INTO lv_string1 lv_string2.
    IF lv_string2 IS NOT INITIAL.
      lv_success = lv_string2+0(7).
      IF lv_success = 'Success'.

        canc_irn = 'X'.

      ELSE.
        CLEAR text.
        text = gv_api_ret_msg.
        CALL SCREEN '9002'.
      ENDIF.

    ELSE.
      CLEAR text.
      text = gv_api_ret_msg.
      CALL SCREEN '9002'.
    ENDIF.

    """"""""""***************************************
    "-----------------------------------------------------------------------"
    CLEAR lv1.
    CLEAR lv2.
    CLEAR lv3.
    CLEAR lv4.
    CLEAR lv5.
    CLEAR lv6.
    CLEAR lv7.
    CLEAR lv8.
    CLEAR lv9.
    CLEAR lv10.
    CLEAR lv11.
    CLEAR lv12.
    CLEAR lv13.
    CLEAR lv14.
    CLEAR lv15.
    CLEAR lv16.
    CLEAR lv17.
    CLEAR lv18.
    CLEAR lv19.
    CLEAR lv20.
    CLEAR lv21.
    CLEAR lv22.
    CLEAR lv23.
    CLEAR lv24.
    CLEAR lv25.
    CLEAR lv26.
    CLEAR lv27.
    CLEAR lv28.
    CLEAR lv29.
    CLEAR lv30.
    CLEAR lv31.
    CLEAR lv32.
    CLEAR lv33.
    CLEAR lv34.
    CLEAR lv35.

    SPLIT <cfs> AT ',' INTO lv1 lv2 lv3 lv4 lv5 lv6 lv7 lv8 lv9.

    SPLIT lv1 AT ':' INTO lv10  lv11.                ""CONTENTENCODING
    SPLIT lv2 AT ':' INTO lv12  lv13.                ""CONTENTTYPE
    SPLIT lv3 AT ':' INTO lv14  lv15 lv16.           ""ACKNO
    SPLIT lv4 AT ':' INTO lv17  lv18.                ""ACKDT
    SPLIT lv5 AT ':' INTO lv19  lv20.                ""IRN
    SPLIT lv6 AT ':' INTO lv21  lv22.                ""SIGNED INVOICE
    SPLIT lv7 AT ':' INTO lv23  lv24.                ""SIGNEDQRCODE
    SPLIT lv8 AT ':' INTO lv25  lv26.                ""STATUS
    SPLIT lv9 AT ':' INTO lv27  lv28 lv29 lv30 lv31. ""JsonRequestBehavior

    REPLACE ALL OCCURRENCES OF '"' IN lv18 WITH space.
    REPLACE ALL OCCURRENCES OF '"' IN lv20 WITH space.
    REPLACE ALL OCCURRENCES OF '"' IN lv22 WITH space.
    REPLACE ALL OCCURRENCES OF '"' IN lv26 WITH space.
    REPLACE ALL OCCURRENCES OF '}' IN lv26 WITH space.
    REPLACE ALL OCCURRENCES OF '}' IN lv30 WITH space.
    SPLIT lv28 AT ',' INTO lv32 lv33.
    SPLIT lv29 AT ',' INTO lv34 lv35.

    CLEAR cancd_ack.
    CLEAR cancd_date.
    cancd_ack  = lv16.
    cancd_date = lv18.
    "-----------------------------------------------------------------------"

    CLEAR gs_irn.
    gs_irn = wa_data-irn.

    IF canc_irn IS NOT INITIAL.
      ""**Start: Save Data in ztable: ZSD_EINVOICE
      PERFORM save_data_into_ztable.
      PERFORM cancel_billing_document.
      ""**End: Save Data in ztable: ZSD_EINVOICE
    ELSE.
      ""**Modify display internal table: in case of error
      PERFORM update_ztable_for_error.
      ""**End: Modify display internal table: : in case of error
    ENDIF.

    CLEAR wa_data.
  ENDLOOP.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form GET_IRN_DETAIL_MI
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_irn_detail_mi.
  " data Variables declaration for passing URL, Result String(Using get_cdata())

  DATA cp_url            TYPE string.
  " *****data declaration for creating HTTP Client, Request, Error description, error code etc
  DATA clo_http_client   TYPE REF TO if_http_client.
  DATA cw_xml_result_str TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA result_tab        TYPE TABLE OF string.

  " data Variables declaration for passing the xml input data into API as a string and lenth

  CLEAR wa_data.
  LOOP AT gt_final INTO wa_data WHERE check = 'X'.

    mij_seller_gstin = '"' && wa_data-billfrom_gstin && '",'.
    CONDENSE mij_seller_gstin.
    user_gstin = mij_seller_gstin.

    cp_url = gw_credential-url_einv_dtl "'https://pro.mastersindia.co/getEinvoiceData?'
           && 'access_token=' && access_token " 3cbee98dca1db1ba113568f286796399c63da88b'
           && '&gstin=' && user_gstin "*09AAAPG7885R002'
           && '&irn=' && wa_data-irn. " ccb9d1e6aad8cc245ffd1bf90f2c645d9f157a50089f39f41704c0e77e7a2d26'.

    " ****Creation of HTTP Client
    cl_http_client=>create_by_url( EXPORTING  url                = cp_url
                                   IMPORTING  client             = clo_http_client
                                   EXCEPTIONS argument_not_found = 1
                                              plugin_not_active  = 2
                                              internal_error     = 3
                                              OTHERS             = 4 ).

    " ** Send the HTTP Post request to the URL.
    clo_http_client->send( EXPORTING  timeout                    = 15   " 15 Seconds
                           EXCEPTIONS http_communication_failure = 1
                                      http_invalid_state         = 2 ).

    " ***Read the Response from API
    clo_http_client->receive( EXCEPTIONS http_communication_failure = 1
                                         http_invalid_state         = 2
                                         http_processing_failed     = 3 ).

    CLEAR cw_xml_result_str.
    cw_xml_result_str = clo_http_client->response->get_cdata( ).
    SPLIT cw_xml_result_str AT cl_abap_char_utilities=>cr_lf INTO TABLE result_tab.

    CLEAR wa_data.
  ENDLOOP.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form REGISTER_EDIT_EVENT
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM register_edit_event.
  osd_grid->register_edit_event( i_event_id = cl_gui_alv_grid=>mc_evt_modified ).

ENDFORM.

*&---------------------------------------------------------------------*
*& Form DISPLAY_ITM_DATA
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM display_itm_data.
  DATA it_fieldcat TYPE slis_t_fieldcat_alv.
  DATA w_col       TYPE i.
  DATA wa_fieldcat TYPE slis_fieldcat_alv.

  REFRESH it_fieldcat[].
  CLEAR w_col.

  " * VBELN
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'VBELN'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Document Number'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * POSNR
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'POSNR'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Item Number'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITEM_PRDNM
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITEM_PRDNM'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Item Code'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITM_SR_NUM
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITM_SR_NUM'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'item_serial_number'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITEM_PRDDESC
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITEM_PRDDESC'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Product_description'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITM_IS_SERVICE
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITM_IS_SERVICE'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Service Type'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITEM_HSNCD
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITEM_HSNCD'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'HSN Code'.
  APPEND wa_fieldcat TO it_fieldcat.

  """""****bar_code

  " * ITEM_QTY
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITEM_QTY'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Quantity'.
  APPEND wa_fieldcat TO it_fieldcat.

  """""free_quantity

  " * ITEM_UNIT
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITEM_UNIT'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Unit'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITEM_UNITPRICE
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITEM_UNITPRICE'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Unit Price'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITEM_TOTAMT
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITEM_TOTAMT'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Total_amount'.
  APPEND wa_fieldcat TO it_fieldcat.

  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITEM_ASSAMT'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Ass. Amount'.
  APPEND wa_fieldcat TO it_fieldcat.

  " *  ITM_PRE_TAX_VAL
  " W_COL = W_COL + 1.
  " CLEAR WA_FIELDCAT.
  " WA_FIELDCAT-COL_POS   = W_COL.
  " WA_FIELDCAT-FIELDNAME = 'ITM_PRE_TAX_VAL'.
  " WA_FIELDCAT-TABNAME   = 'GT_ITM'.
  " WA_FIELDCAT-SELTEXT_M = 'Pre_tax_value'.
  " APPEND WA_FIELDCAT TO IT_FIELDCAT.

  " * ITEM_DISCOUNT
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITEM_DISCOUNT'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Discount'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITEM_OTHCHRG
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITEM_OTHCHRG'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Other_charge'.
  APPEND wa_fieldcat TO it_fieldcat.

  """""assessable_value

  " * ITM_GST_RATE
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITM_GST_RATE'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'GST_rate'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITM_IGST_AMT
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITM_IGST_AMT'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'IGST_amount'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITM_CGST_AMT
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITM_CGST_AMT'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'CGST_amount'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITM_SGST_AMT
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITM_SGST_AMT'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'SGST_amount'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITEM_CESRT
  "  W_COL = W_COL + 1.
  "  CLEAR WA_FIELDCAT.
  "  WA_FIELDCAT-COL_POS   = W_COL.
  "  WA_FIELDCAT-FIELDNAME = 'ITEM_CESRT'.
  "  WA_FIELDCAT-TABNAME   = 'GT_ITM'.
  "  WA_FIELDCAT-SELTEXT_M = 'Cess Rate'.
  "  APPEND WA_FIELDCAT TO IT_FIELDCAT.

  " *  ITM_CESS_AMT
  " W_COL = W_COL + 1.
  " CLEAR WA_FIELDCAT.
  " WA_FIELDCAT-COL_POS   = W_COL.
  " WA_FIELDCAT-FIELDNAME = 'ITM_CESS_AMT'.
  " WA_FIELDCAT-TABNAME   = 'GT_ITM'.
  " WA_FIELDCAT-SELTEXT_M = 'CESS_amount'.
  " APPEND WA_FIELDCAT TO IT_FIELDCAT.

  """""cess_nonadvol_value

  """"""state_cess_rate

  " *  ITM_STAT_CESS_AMT
  " W_COL = W_COL + 1.
  " CLEAR WA_FIELDCAT.
  " WA_FIELDCAT-COL_POS   = W_COL.
  " WA_FIELDCAT-FIELDNAME = 'ITM_STAT_CESS_AMT'.
  " WA_FIELDCAT-TABNAME   = 'GT_ITM'.
  " WA_FIELDCAT-SELTEXT_M = 'State_cess_amount'.
  " APPEND WA_FIELDCAT TO IT_FIELDCAT.

  " *  ITM_STAT_CESS_NADVOL_AMT
  " W_COL = W_COL + 1.
  " CLEAR WA_FIELDCAT.
  " WA_FIELDCAT-COL_POS   = W_COL.
  " WA_FIELDCAT-FIELDNAME = 'ITM_STAT_CESS_NADVOL_AMT'.
  " WA_FIELDCAT-TABNAME   = 'GT_ITM'.
  " WA_FIELDCAT-SELTEXT_M = 'State_cess_nonadvol_amount'.
  " APPEND WA_FIELDCAT TO IT_FIELDCAT.

  " * ITEM_TOTITEMVAL
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITEM_TOTITEMVAL'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Total_item_value'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITM_CNTRY_ORGIN
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITM_CNTRY_ORGIN'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Country_origin'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITM_ODR_LINE_REF
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITM_ODR_LINE_REF'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Order_line_reference'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITM_PRODCT_SR_NUM
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITM_PRODCT_SR_NUM'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Product_serial_number'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITEM_BATCH_NM
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITEM_BATCH_NM'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Batch Name'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITEM_BATCH_EXPDT
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITEM_BATCH_EXPDT'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Expiry_date'.
  APPEND wa_fieldcat TO it_fieldcat.

  " * ITEM_BATCH_WRDT
  w_col += 1.
  CLEAR wa_fieldcat.
  wa_fieldcat-col_pos   = w_col.
  wa_fieldcat-fieldname = 'ITEM_BATCH_WRDT'.
  wa_fieldcat-tabname   = 'GT_ITM'.
  wa_fieldcat-seltext_m = 'Warranty_date'.
  APPEND wa_fieldcat TO it_fieldcat.

  " ** ITEM_SGSTRT
  " W_COL = W_COL + 1.
  " CLEAR WA_FIELDCAT.
  " WA_FIELDCAT-COL_POS   = W_COL.
  " WA_FIELDCAT-FIELDNAME = 'ITEM_SGSTRT'.
  " WA_FIELDCAT-TABNAME   = 'GT_ITM'.
  " WA_FIELDCAT-SELTEXT_M = 'SGST Rate'.
  " APPEND WA_FIELDCAT TO IT_FIELDCAT.
  "
  " ** ITEM_CGSTRT
  " W_COL = W_COL + 1.
  " CLEAR WA_FIELDCAT.
  " WA_FIELDCAT-COL_POS   = W_COL.
  " WA_FIELDCAT-FIELDNAME = 'ITEM_CGSTRT'.
  " WA_FIELDCAT-TABNAME   = 'GT_ITM'.
  " WA_FIELDCAT-SELTEXT_M = 'CGST Rate'.
  " APPEND WA_FIELDCAT TO IT_FIELDCAT.

  " ** ITEM_IGSTRT
  " W_COL = W_COL + 1.
  " CLEAR WA_FIELDCAT.
  " WA_FIELDCAT-COL_POS   = W_COL.
  " WA_FIELDCAT-FIELDNAME = 'ITEM_IGSTRT'.
  " WA_FIELDCAT-TABNAME   = 'GT_ITM'.
  " WA_FIELDCAT-SELTEXT_M = 'IGST Rate'.
  " APPEND WA_FIELDCAT TO IT_FIELDCAT.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      i_callback_program      = sy-repid
      i_callback_user_command = 'USER_COMMAND'
      it_fieldcat             = it_fieldcat
    TABLES
      t_outtab                = gt_itm.

ENDFORM.

*&--------------------------------------------------------------------*
*&      Form  USER_COMMAND
*&--------------------------------------------------------------------*
FORM user_command USING r_ucomm     LIKE sy-ucomm
                        rs_selfield TYPE slis_selfield.

  CASE rs_selfield-fieldname.

    WHEN 'VBELN'.
      SET PARAMETER ID 'VF' FIELD gw_final-vbeln.
      CALL TRANSACTION 'VF03' AND SKIP FIRST SCREEN.
*  READ TABLE IT_POPUP INTO DATA(LS_POPUP) INDEX RS_SELFIELD-TABINDEX.
*  SET PARAMETER ID 'BLN' FIELD LS_POPUP-BELNR.
*  SET PARAMETER ID 'BUK' FIELD LS_POPUP-RBUKRS.
*  SET PARAMETER ID 'GJR' FIELD LS_POPUP-GJAHR.
*  CALL TRANSACTION 'FB03' AND SKIP FIRST SCREEN.
  ENDCASE.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form GET_DATA_FI
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_data_fi.
  REFRESH ft_j_1bbranch[].
  REFRESH ft_bkpf[].
  REFRESH ft_bseg[].
  REFRESH ft_t001w[].
  REFRESH ft_adrc_plant[].
  REFRESH ft_adr6_plant[].
  REFRESH ft_kna1[].
  REFRESH ft_adrc_cust[].
  REFRESH ft_adr6_cust[].
  REFRESH ft_lfa1[].
  REFRESH ft_adrc_vend[].
  REFRESH ft_adr6_vend[].
  REFRESH ft_makt[].
  REFRESH ft_bset[].
  REFRESH ft_bseg_k[].
  REFRESH ft_bseg_d[].
  REFRESH ft_bseg_m[].
  REFRESH ft_bseg_p[].
  REFRESH ft_mbew[].

  SELECT * FROM bkpf
    INTO TABLE ft_bkpf
    WHERE bukrs IN so_bukrs
      AND belnr IN so_vbeln
      AND budat IN so_fkdat
      AND gjahr IN so_gjahr
      AND blart IN ( 'DR', 'DG' , 'ZD' ) AND xreversed = ' '.

  IF ft_bkpf[] IS NOT INITIAL.
    SELECT * FROM zsd_einvoice
      INTO TABLE gt_irn
      FOR ALL ENTRIES IN ft_bkpf
      WHERE vbeln = ft_bkpf-belnr AND bukrs = ft_bkpf-bukrs AND gjahr = ft_bkpf-gjahr.

    SELECT * FROM bseg
      INTO TABLE ft_bseg
      FOR ALL ENTRIES IN ft_bkpf
      WHERE bukrs = ft_bkpf-bukrs
        AND belnr = ft_bkpf-belnr
        AND gjahr = ft_bkpf-gjahr.

    IF ft_bseg[] IS NOT INITIAL.
      SELECT * FROM j_1bbranch
        INTO TABLE ft_j_1bbranch
        FOR ALL ENTRIES IN ft_bseg
        WHERE bukrs  = ft_bseg-bukrs
          AND branch = ft_bseg-bupla.

      SELECT * FROM t001w
        INTO TABLE ft_t001w
        FOR ALL ENTRIES IN ft_bseg
        WHERE werks = ft_bseg-bupla.

      SELECT * FROM adrc
        INTO TABLE ft_adrc_plant
        FOR ALL ENTRIES IN ft_t001w
        WHERE addrnumber = ft_t001w-adrnr.

      SELECT * FROM adr6
        INTO TABLE ft_adr6_plant
        FOR ALL ENTRIES IN ft_t001w
        WHERE addrnumber = ft_t001w-adrnr.

      SELECT * FROM kna1
        INTO TABLE ft_kna1
        FOR ALL ENTRIES IN ft_bseg
        WHERE kunnr = ft_bseg-kunnr.

      DATA(ft_kna2) = ft_kna1.
      REFRESH ft_kna2.



*      SELECT * FROM adrc
*        INTO TABLE ft_adrc_cust
*        FOR ALL ENTRIES IN ft_kna1
*        WHERE addrnumber = ft_kna1-adrnr.
      SELECT * FROM adrc
        INTO TABLE ft_adrc_cust
        FOR ALL ENTRIES IN ft_kna2
        WHERE addrnumber = ft_kna2-adrnr.

      SELECT * FROM adr6
        INTO TABLE ft_adr6_cust
        FOR ALL ENTRIES IN ft_kna1
        WHERE addrnumber = ft_kna1-adrnr.

      SELECT * FROM lfa1
        INTO TABLE ft_lfa1
        FOR ALL ENTRIES IN ft_bseg
        WHERE lifnr = ft_bseg-lifnr.

      SELECT * FROM adrc
        INTO TABLE ft_adrc_vend
        FOR ALL ENTRIES IN ft_lfa1
        WHERE addrnumber = ft_lfa1-adrnr.

      SELECT * FROM adr6
        INTO TABLE ft_adr6_vend
        FOR ALL ENTRIES IN ft_lfa1
        WHERE addrnumber = ft_lfa1-adrnr.

      SELECT * FROM makt
        INTO TABLE ft_makt
        FOR ALL ENTRIES IN ft_bseg
        WHERE matnr = ft_bseg-matnr.

      SELECT * FROM bset
        INTO TABLE ft_bset
        FOR ALL ENTRIES IN ft_bkpf
        WHERE belnr = ft_bkpf-belnr
          AND gjahr = ft_bkpf-gjahr
          AND bukrs = ft_bkpf-bukrs.

      SELECT * FROM mbew
        INTO TABLE ft_mbew
        FOR ALL ENTRIES IN ft_bseg
        WHERE matnr = ft_bseg-matnr
          AND vprsv = 'S'.

    ENDIF.

  ENDIF.

  ft_bseg_k[] = ft_bseg[].
  ft_bseg_d[] = ft_bseg[].
  ft_bseg_m[] = ft_bseg[].
  ft_bseg_p[] = ft_bseg[].

  ft_bseg_m_x[] = ft_bseg[].

  DELETE ft_bseg_k WHERE koart <> 'K'.
  DELETE ft_bseg_d WHERE koart <> 'D'.
  DELETE ft_bseg_m WHERE koart <> 'S' AND buzid <> ' '.
  DELETE ft_bseg_p WHERE koart <> 'P'.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form PREPARE_DATA_FI
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM prepare_data_fi.
  REFRESH ft_final[].
  CLEAR fw_final.

  LOOP AT ft_bkpf INTO fw_bkpf.
    REFRESH color_tab[].
    REFRESH lt_edit[].
    CLEAR fw_bseg_k.
    CLEAR fw_bseg_d.
    CLEAR fw_bseg_m.
    CLEAR fw_bseg_p.
    CLEAR fw_j_1bbranch_k.
    CLEAR fw_j_1bbranch_d.
    CLEAR fw_t001w.
    CLEAR fw_adrc_plant.
    CLEAR fw_adr6_plant.
    CLEAR fw_kna1.
    CLEAR fw_adrc_cust.
    CLEAR fw_adr6_cust.
    CLEAR fw_lfa1.
    CLEAR fw_adrc_vend.
    CLEAR fw_adr6_vend.
    CLEAR fw_makt.
    CLEAR fw_bset.
    CLEAR fw_bseg.
    """"*****Item detail
    DATA : item TYPE i .
    item = '10'.

    IF fw_bkpf-blart = 'ZD'.
      ft_bseg_m[] = ft_bseg_m_x[].
    ENDIF.

    LOOP AT ft_bseg_m INTO fw_bseg_m WHERE ( belnr = fw_bkpf-belnr AND buzid = ' '  AND koart = 'S' )
                                        OR ( ( belnr = fw_bkpf-belnr  AND ( koart = 'S' OR koart =  'A' ) AND buzid NE 'T' ) )."AND ( koart = 'S' AND BUZID NE 'T'  ) ).

      READ TABLE ft_bseg   INTO fw_bseg   WITH KEY bukrs = fw_bkpf-bukrs
                                                   belnr = fw_bkpf-belnr
                                                   gjahr = fw_bkpf-gjahr.
      READ TABLE ft_bseg_k INTO fw_bseg_k WITH KEY bukrs = fw_bkpf-bukrs
                                                   belnr = fw_bkpf-belnr
                                                   gjahr = fw_bkpf-gjahr.
      READ TABLE ft_bseg_d INTO fw_bseg_d WITH KEY bukrs = fw_bkpf-bukrs
                                                   belnr = fw_bkpf-belnr
                                                   gjahr = fw_bkpf-gjahr.

      READ TABLE ft_j_1bbranch  INTO fw_j_1bbranch_d  WITH KEY bukrs  = fw_bseg_d-bukrs
                                                               branch = fw_bseg_d-bupla.
      READ TABLE ft_j_1bbranch  INTO fw_j_1bbranch_k  WITH KEY bukrs  = fw_bseg_k-bukrs
                                                               branch = fw_bseg_k-bupla.
      IF fw_bseg_m-werks IS INITIAL .
        fw_bseg_m-werks = fw_bseg_m-bupla .
      ENDIF .
      " if fw_bseg_d-belnr is not initial.
      IF fw_bkpf-blart = 'ZD'.
        READ TABLE ft_t001w       INTO fw_t001w       WITH KEY werks = fw_bseg_m-bupla.
        SELECT SINGLE ltext FROM t003t INTO fw_final-doc_typ_desc WHERE blart = 'ZD'AND spras = 'E'.
        fw_final-doc_no = fw_bkpf-xblnr_alt.
      ELSE.
        READ TABLE ft_t001w       INTO fw_t001w       WITH KEY werks = fw_bseg_m-werks.
      ENDIF.
      " endif.

*      SELECT SINGLE LTEXT FROM T003 INTO FW_FINAL-DODOC_TYP_DESC WHERE BLART = 'ZD' AND BELNR = fw_bseg_m-belnr.

      " if fw_bseg_k-belnr is not initial.
      "   read table ft_t001w       into fw_t001w       with key werks  = fw_bseg_k-werks.
      " endif.

      READ TABLE ft_adrc_plant  INTO fw_adrc_plant  WITH KEY addrnumber = fw_t001w-adrnr.
      READ TABLE ft_adr6_plant  INTO fw_adr6_plant  WITH KEY addrnumber = fw_t001w-adrnr.

      IF fw_bkpf-blart = 'ZD'.
        READ TABLE ft_lfa1        INTO fw_lfa1        WITH KEY lifnr = fw_bseg_k-lifnr.
      ELSE.
        READ TABLE ft_lfa1        INTO fw_lfa1        WITH KEY lifnr = fw_t001w-lifnr.
      ENDIF.

      READ TABLE ft_kna1        INTO fw_kna1        WITH KEY kunnr = fw_bseg_d-kunnr.

      IF fw_bkpf-blart = 'ZD'.
        READ TABLE ft_adrc_cust   INTO fw_adrc_cust   WITH KEY addrnumber = fw_lfa1-adrnr.
        READ TABLE ft_adr6_cust   INTO fw_adr6_cust   WITH KEY addrnumber = fw_lfa1-adrnr.
      ELSE.
        READ TABLE ft_adrc_cust   INTO fw_adrc_cust   WITH KEY addrnumber = fw_kna1-adrnr.
        READ TABLE ft_adr6_cust   INTO fw_adr6_cust   WITH KEY addrnumber = fw_kna1-adrnr.
      ENDIF.

      READ TABLE gt_irn INTO gw_irn WITH KEY vbeln = fw_bkpf-belnr
                                             bukrs = fw_bkpf-bukrs
                                             gjahr = fw_bkpf-gjahr.

      READ TABLE ft_adrc_vend   INTO fw_adrc_vend   WITH KEY addrnumber = fw_lfa1-adrnr.
      READ TABLE ft_adr6_vend   INTO fw_adr6_vend   WITH KEY addrnumber = fw_lfa1-adrnr.
      "*READ TABLE FT_MAKT        INTO FW_MAKT        WITH KEY MATNR = FW_BSEG_M-MATNR.

      IF fw_bkpf-blart = 'ZD'.
        READ TABLE ft_bseg_m INTO DATA(gs_bseg) WITH KEY belnr = fw_bkpf-belnr
                                                          koart = 'S' .
        IF sy-subrc = 0.
          READ TABLE ft_j_1bbranch  INTO fw_j_1bbranch_c  WITH KEY bukrs  = gs_bseg-bukrs
                                                                   branch = fw_t001w-j_1bbranch.
          IF sy-subrc = 0.
            fw_final-gstin = fw_j_1bbranch_c-gstin.
          ENDIF.
        ENDIF.

      ELSE.
        READ TABLE ft_bseg_m INTO gs_bseg WITH KEY belnr = fw_bkpf-belnr
                                                          buzid = ' '
                                                          koart = 'S'.
        IF sy-subrc = 0.
          READ TABLE ft_j_1bbranch  INTO fw_j_1bbranch_c  WITH KEY bukrs  = gs_bseg-bukrs
                                                                   branch = fw_t001w-j_1bbranch.
          IF sy-subrc = 0.
            fw_final-gstin = fw_j_1bbranch_c-gstin.
          ENDIF.
        ENDIF.

      ENDIF.


      IF fw_bkpf-blart = 'ZD'.
        IF fw_lfa1-land1 = 'IN'.
          fw_final-tran_catg = 'B2B'.
        ELSE.
          fw_final-tran_catg = 'EXPWOP'.
        ENDIF.
      ELSE.
        IF fw_kna1-land1 = 'IN'.
          fw_final-tran_catg = 'B2B'.
        ELSE.
          fw_final-tran_catg = 'EXPWOP'.
        ENDIF.
      ENDIF.

      fw_final-tran_typ      = 'REG'.
      fw_final-vbeln         = fw_bkpf-belnr.
      fw_final-bukrs         = fw_bkpf-bukrs.
      fw_final-gjahr         = fw_bkpf-gjahr.

*    fw_final-tran_catg        = ''.   "* SUPPLY_TYP
      fw_final-tran_ecmgstin = ''. "* MIJ_ECOMMERCE_GSTIN
      IF fw_bkpf-blart = 'DR'.
        fw_final-doc_typ = 'DBN'. " fw_bkpf-blart.   "* MIJ_DOCUMENT_TYPE
      ELSEIF fw_bkpf-blart = 'ZD'.
        fw_final-doc_typ = 'INV'.
      ELSE.
        fw_final-doc_typ = 'CRN'.
      ENDIF.

      IF fw_bkpf-blart NE 'ZD'.
        fw_final-doc_no    = fw_bkpf-belnr. "* MIJ_DOCUMENT_NUMBER
      ENDIF.
      fw_final-doc_dt    = fw_bkpf-budat. "* MIJ_DOCUMENT_DATE

      fw_final-irn       = gw_irn-irn.
      fw_final-cancd_irn = gw_irn-cancd_irn.
      fw_final-stat_ind  = '@5D@'. "*Yellow
      fw_final-item      = '@7Z@'. " 5G, HB, XP, 46, 7Z, P3

      CLEAR wa_color.
      wa_color-fname = 'IRN'.
      wa_color-color-col = 3. " red color   5: "green color   3: "yellow    7:  "violet

      IF gw_irn-irn <> 'null' AND gw_irn-irn IS NOT INITIAL.
        fw_final-stat_ind = '@5B@'. "*Green

        """"****For Cell Color
        CLEAR wa_color.
        wa_color-fname = 'IRN'.
        wa_color-color-col = 5. " red color   5: "green color   3: "yellow    7:  "violet

        IF gw_irn-cancd_irn = 'X'.
          fw_final-stat_ind = '@02@'. "*Cancel
          """"****For Cell Color
          CLEAR wa_color.
          wa_color-fname = 'IRN'.
          wa_color-color-col = 6. " red color   5: "green color   3: "yellow    7:  "violet
          "*GW_FINAL-ROWCOLOR = 'C311'.
          """****End:Row Color

        ENDIF.
      ENDIF.
      APPEND wa_color TO color_tab.

      """*******Enable/Disable check Box.
      IF disply = 'X'.
        CLEAR ls_edit.
        ls_edit-fieldname = 'CHECK'.
        ls_edit-style     = cl_gui_alv_grid=>mc_style_disabled.
        ls_edit-style2    = space.
        ls_edit-style3    = space.
        ls_edit-style4    = space.
        ls_edit-maxlen    = 10.
        INSERT ls_edit INTO TABLE lt_edit.
      ELSEIF create = 'X'.
      ELSEIF change = 'X'.
      ENDIF.
      """*******End:Enable/Disable check Box.

      IF fw_bseg_d-belnr IS NOT INITIAL OR ( fw_bkpf-blart = 'ZD' AND fw_bseg_k-belnr IS NOT INITIAL ).

        " FW_FINAL-GSTIN            =

        fw_final-billfrom_gstin = fw_j_1bbranch_c-gstin. "*
        fw_final-billfrom_trdnm = fw_t001w-name1. "* MIJ_SELLER_TRADE_NAME

        IF fw_adrc_plant-street IS INITIAL AND fw_adrc_plant-str_suppl1 IS INITIAL.
          fw_final-billfrom_bno = fw_adrc_plant-name2.
        ELSE.
          fw_final-billfrom_bno = fw_adrc_plant-street && fw_adrc_plant-str_suppl1.
        ENDIF.

        fw_final-billfrom_bnm  = fw_adrc_plant-str_suppl2 && fw_adrc_plant-str_suppl3. "''.               "* SLR_ADR2
        fw_final-billfrom_loc  = fw_t001w-ort01. "* MIJ_SELLER_LOCATION
        fw_final-billfrom_pin  = fw_t001w-pstlz. "* MIJ_SELLER_PINCODE
        fw_final-billfrom_stcd = fw_t001w-regio.
**        SELECT SINGLE gstcode FROM zgstnstatecode INTO fw_final-billfrom_stcd WHERE regio = fw_t001w-regio.      ""BILLFROM
*        fw_final-billfrom_stcd    = fw_t001w-regio.   "* MIJ_SELLER_STATE_CODE    ""Need Description
        fw_final-billfrom_ph   = fw_adrc_plant-tel_number. "* MIJ_SELLER_PHONE_NUMBER
        fw_final-billfrom_em   = fw_adr6_plant-smtp_addr.  "* MIJ_SELLER_EMAIL

        IF fw_adrc_cust-street IS INITIAL AND fw_adrc_cust-str_suppl1 IS INITIAL.
          fw_final-billto_bno = fw_adrc_cust-name2.
        ELSE.
          fw_final-billto_bno = fw_adrc_cust-street && fw_adrc_cust-str_suppl1.
        ENDIF.

        fw_final-billto_bnm   = fw_adrc_cust-str_suppl2 && fw_adrc_cust-str_suppl3. "''.               "* BYR_ADR2
        fw_final-billto_loc   = fw_adrc_cust-city1. " fw_kna1-mcod3.    "* MIJ_BUYER_LOCATION
        IF fw_bkpf-blart = 'ZD'.
          fw_final-billto_trdnm = fw_lfa1-name1. "* BYR_LGL_NAME
        ELSE.
          fw_final-billto_trdnm = fw_kna1-name1. "* BYR_LGL_NAME
        ENDIF.
        IF fw_bkpf-blart = 'ZD'.
          IF fw_lfa1-land1 = 'IN'.
            fw_final-billto_gstin = fw_lfa1-stcd3. "* MIJ_BUYER_GSTIN
            fw_final-billto_pin   = fw_lfa1-pstlz. "* MIJ_BUYER_PINCODE
            fw_final-billto_stcd  = fw_lfa1-regio.

          ELSE.
            fw_final-billto_gstin = 'URP'.
            fw_final-billto_pin   = '999999'.
            fw_final-billto_stcd  = '96'.
          ENDIF.
        ELSE.

          IF fw_kna1-land1 = 'IN'.
            fw_final-billto_gstin = fw_kna1-stcd3. "* MIJ_BUYER_GSTIN
            fw_final-billto_pin   = fw_kna1-pstlz. "* MIJ_BUYER_PINCODE
            fw_final-billto_stcd  = fw_kna1-regio.

          ELSE.
            fw_final-billto_gstin = 'URP'.
            fw_final-billto_pin   = '999999'.
            fw_final-billto_stcd  = '96'.
          ENDIF.
        ENDIF.
**        SELECT SINGLE gstcode FROM zgstnstatecode INTO fw_final-billto_stcd WHERE regio = fw_kna1-regio.      "BILLTO
*        fw_final-billto_stcd      = fw_kna1-regio.    "* BYR_PLS_SUPPLY
        fw_final-billto_ph = fw_adrc_cust-tel_number. "* MIJ_BUYER_PHONE_NUMBER
        fw_final-billto_em = fw_adr6_cust-smtp_addr.  "* MIJ_BUYER_EMAIL

      ENDIF.

      IF fw_bseg_k-belnr IS NOT INITIAL AND ( fw_bkpf-blart NE 'ZD' ).

        fw_final-billfrom_gstin = fw_lfa1-stcd3. "*
        fw_final-billfrom_trdnm = fw_lfa1-name1. "* SLR_LGL_NAME
        fw_final-billfrom_bno   = fw_lfa1-stras. "* SLR_ADR1
        fw_final-billfrom_bnm   = ''.            "* SLR_ADR2
        fw_final-billfrom_loc   = fw_lfa1-mcod3. "* MIJ_SELLER_LOCATION
        fw_final-billfrom_pin   = fw_lfa1-pstlz. "* MIJ_SELLER_PINCODE
        fw_final-billfrom_stcd  = fw_lfa1-regio. "* MIJ_SELLER_STATE_CODE    ""Need Description
        fw_final-billfrom_ph    = fw_adrc_plant-tel_number. "* MIJ_SELLER_PHONE_NUMBER
        fw_final-billfrom_em    = fw_adr6_plant-smtp_addr.  "* MIJ_SELLER_EMAIL

        fw_final-billto_trdnm   = fw_t001w-name1. "* BYR_LGL_NAME
        fw_final-billto_bno     = fw_t001w-stras. "* BYR_ADR2
        fw_final-billto_bnm     = ''.             "* MIJ_BUYER_LOCATION
        fw_final-billto_loc     = fw_t001w-ort01. "* MIJ_BUYER_PINCODE


        IF fw_kna1-land1 = 'IN' OR fw_lfa1-land1 = 'IN'..
          fw_final-billto_gstin = fw_j_1bbranch_k-gstin. "* MIJ_BUYER_GSTIN
          fw_final-billto_pin   = fw_t001w-pstlz.        "* BYR_PLS_SUPPLY
          fw_final-billto_stcd  = fw_t001w-regio.        "* MIJ_BUYER_PHONE_NUMBER
        ELSE.
          fw_final-billto_gstin = 'URP'.
          fw_final-billto_pin   = '999999'.
          fw_final-billto_stcd  = '96'.
        ENDIF.

        fw_final-billto_ph = fw_adrc_cust-tel_number. "* MIJ_BUYER_PHONE_NUMBER
        fw_final-billto_em = fw_adr6_cust-smtp_addr.  "* MIJ_BUYER_EMAIL

      ENDIF.

      fw_final-shipfrom_gstin = fw_final-billfrom_gstin.
      fw_final-shipfrom_trdnm = fw_final-billfrom_trdnm. "* DISP_COMP_NAME
      fw_final-shipfrom_bno   = fw_final-billfrom_bno. "* DISP_ADR1
      fw_final-shipfrom_bnm   = fw_final-billfrom_bnm. "* DISP_ADR2
      fw_final-shipfrom_loc   = fw_final-billfrom_loc. "* MIJ_DISPATCH_LOCATION
      fw_final-shipfrom_pin   = fw_final-billfrom_pin. "* MIJ_DISPATCH_PINCODE
      fw_final-shipfrom_stcd  = fw_final-billfrom_stcd. "* MIJ_DISPATCH_STATE_CODE

      fw_final-shipto_trdnm   = fw_final-billto_trdnm. "* SHP_LGL_NAME
      fw_final-shipto_bno     = fw_final-billto_bno. "* SHP_ADR1
      fw_final-shipto_bnm     = fw_final-billto_bnm. "* SHP_ADR2
      fw_final-shipto_loc     = fw_final-billto_loc. "* MIJ_SHIP_LOCATION


      IF fw_kna1-land1 = 'IN' OR fw_lfa1-land1 = 'IN'.
        fw_final-shipto_gstin = fw_final-billto_gstin. "* MIJ_SHIP_GSTIN
        fw_final-shipto_pin   = fw_final-billto_pin. "* MIJ_SHIP_PINCODE
        fw_final-shipto_stcd  = fw_final-billto_stcd. "* MIJ_SHIP_STATE_CODE
      ELSE.
        fw_final-shipto_gstin = 'URP'.
        fw_final-shipto_pin   = '999999'.
        fw_final-shipto_stcd  = '96'.
      ENDIF.

      INSERT LINES OF color_tab INTO TABLE fw_final-colortab.
      INSERT LINES OF lt_edit   INTO TABLE fw_final-style.

      " """*****Item detail
      " data(item) = '10'.
      " loop at ft_bseg_m into fw_bseg_m where belnr = fw_bkpf-belnr and buzid = ' ' and koart = 'S'.

      CLEAR fw_makt.
      CLEAR fw_mbew.
      READ TABLE ft_makt INTO fw_makt WITH KEY matnr = fw_bseg_m-matnr.
      READ TABLE ft_mbew INTO fw_mbew WITH KEY matnr = fw_bseg_m-matnr.

      fw_final-itm_sr_num = item.
      CONDENSE fw_final-itm_sr_num .
      IF  item LE '90'.
        CONCATENATE '0000' fw_final-itm_sr_num INTO fw_final-itm_sr_num.
      ELSEIF item GT '90' AND item LE '990'.
        CONCATENATE '000' fw_final-itm_sr_num INTO fw_final-itm_sr_num.
      ELSE .
        CONCATENATE '00' fw_final-itm_sr_num INTO fw_final-itm_sr_num.
      ENDIF.
      item += '10'.
      fw_final-item_prdnm     = fw_bseg_m-matnr.   "* MIJ_ITEM_PRODUCT_NAME
      fw_final-item_prddesc   = fw_makt-maktx.     "* MIJ_ITEM_PRODUCT_DESCRIPTION
      IF  fw_bkpf-blart = 'ZD'.
        SELECT SINGLE hsn_sac FROM bseg INTO fw_final-item_hsncd WHERE belnr = fw_bkpf-belnr
                              AND bukrs = fw_bkpf-bukrs AND gjahr = fw_bkpf-gjahr AND hsn_sac NE ' ' .
      ELSE.
        fw_final-item_hsncd     = fw_bseg_m-hsn_sac. "* MIJ_ITEM_HSN_CODE
      ENDIF.
      fw_final-item_barcde    = '1234'.            "* MIJ_ITEM_BAR_CODE
      fw_final-item_qty       = fw_bseg_m-menge.   "* MIJ_ITEM_QUANTITY
      fw_final-item_freeqty   = ''.                "* MIJ_ITEM_FREE_QUANTITY
      fw_final-item_unit      = 'NOS'. " fw_bseg_m-meins.     "* MIJ_ITEM_UNIT
*      fw_final-item_unitprice            = fw_mbew-stprs.       "* MIJ_ITEM_UNIT_PRICE
*      fw_final-item_totamt               = fw_bseg_m-menge * fw_mbew-stprs.   "* MIJ_ITEM_TOTAL_AMOUNT
      fw_final-item_discount  = ''. "* MIJ_ITEM_DISCOUNT
      fw_final-item_othchrg   = ''. "* MIJ_ITEM_OTHER_CHARGE

      fw_final-itm_is_service = 'N'. "*Mandatory
      SELECT SINGLE hsncode FROM zsd_hsn INTO @DATA(hsn_code) WHERE hsncode = @fw_final-item_hsncd.
      IF hsn_code IS NOT INITIAL.
        fw_final-itm_is_service = 'Y'.
      ENDIF.

      LOOP AT ft_bset INTO fw_bset WHERE bukrs = fw_bkpf-bukrs AND belnr = fw_bkpf-belnr AND gjahr = fw_bkpf-gjahr AND txgrp = fw_bseg_m-txgrp.

        IF fw_bset-kschl = 'JOCG' OR fw_bset-kschl = 'JICR'.
          fw_final-item_cgstrt   = fw_bset-kbetr / 10. "* MIJ_ITEM_CGST_RATE
          fw_final-val_cgstval  += fw_bset-hwste.
          fw_final-itm_gst_rate += fw_bset-kbetr.
          fw_final-itm_cgst_amt  = fw_bset-hwste.
          fw_final-item_assamt   = fw_bset-hwbas. "* MIJ_ITEM_ASSESSABLE_VALUE
          fw_final-item_asses    = fw_bset-hwbas.
        ELSEIF fw_bset-kschl = 'JOSG' OR fw_bset-kschl = 'JISR'.
          fw_final-item_sgstrt   = fw_bset-kbetr / 10. "* MIJ_ITEM_SGST_RATE
          fw_final-val_sgstval  += fw_bset-hwste.
          fw_final-itm_gst_rate += fw_bset-kbetr.
          fw_final-itm_sgst_amt  = fw_bset-hwste.
          fw_final-item_assamt   = fw_bset-hwbas. "* MIJ_ITEM_ASSESSABLE_VALUE
          fw_final-item_asses    = fw_bset-hwbas.
        ELSEIF fw_bset-kschl = 'JOIG' OR fw_bset-kschl = 'JIIR' OR fw_bset-kschl = 'JIIG'  .
          fw_final-item_igstrt   = fw_bset-kbetr / 10. "* MIJ_ITEM_IGST_RATE
          fw_final-val_igstval  += fw_bset-hwste.
          fw_final-itm_gst_rate += fw_bset-kbetr.
          fw_final-itm_igst_amt  = fw_bset-hwste.
          fw_final-item_assamt   = fw_bset-hwbas. "* MIJ_ITEM_ASSESSABLE_VALUE
          fw_final-item_asses    = fw_bset-hwbas.
        ELSEIF fw_bset-kschl = 'JTC1'.
          fw_final-val_othchrg  += fw_bset-hwste.
          fw_final-item_othchrg  = ''. " fw_final-item_othchrg + fw_bset-hwste.
        ENDIF.

*        fw_final-val_assval       = fw_final-val_assval +  fw_final-item_asses."fw_final-item_assamt.                                          "* MIJ_VALUE_TOTAL_ASSESS_VALUE
*        fw_final-val_cgstval      = fw_final-val_cgsttval + ( ( fw_final-item_assamt * fw_final-item_cgstrt ) / 100 ).    "* MIJ_VALUE_TOTAL_CGST_VALUE
*        fw_final-val_sgstval      = fw_final-val_sgstval + ( ( fw_final-item_assamt * fw_final-item_sgstrt ) / 100 ).    "* MIJ_VALUE_TOTAL_SGST_VALUE
*        fw_final-val_igstval      = fw_final-val_igstval + ( ( fw_final-item_assamt * fw_final-item_igstrt ) / 100 ).    "* MIJ_VALUE_TOTAL_IGST_VALUE
        fw_final-val_cesval     = ''. "* MIJ_VALUE_TOTAL_CESS_VALUE
        fw_final-branch_or_ifsc = ''. "* MIJ_VALUE_TOTAL_CESS_NON_VALUE
        fw_final-val_stcesval   = ''. "* MIJ_VALUE_TOTAL_CESS_V_STATE

        CLEAR fw_bset.
      ENDLOOP.

      fw_final-itm_gst_rate /= 10.
      fw_final-val_assval    = fw_final-item_asses.
      CONDENSE fw_final-item_qty.
      IF fw_final-item_qty = '0.000'.
      ELSE.
        fw_final-item_unitprice = fw_final-item_asses / fw_final-item_qty.
      ENDIF.

      fw_final-item_unitprice = round( val = fw_final-item_unitprice
                                       dec = 2 ).
      fw_final-val_totinvval            = fw_final-val_assval
                                          + fw_final-val_cgstval
                                          + fw_final-val_sgstval
                                          + fw_final-val_igstval + fw_final-val_othchrg.

      fw_final-item_totamt              = fw_final-item_asses. " fw_final-item_asses +
      "+ fw_final-itm_cgst_amt
      "+ fw_final-itm_sgst_amt
      "+ fw_final-itm_igst_amt.

      fw_final-item_totitemval          = fw_final-item_asses +
                                           + fw_final-itm_cgst_amt
                                           + fw_final-itm_sgst_amt
                                           + fw_final-itm_igst_amt + fw_final-item_othchrg.

      fw_final-item_cesrt               = ''. "* MIJ_ITEM_CESS_RATE
      fw_final-item_cesnonadval         = ''. "* MIJ_ITEM_CESS_NONADVOL_VALUE
      fw_final-item_stateces            = ''. "* MIJ_ITEM_STATE_CESS_RATE
*      fw_final-item_totitemval           = ''.   "* MIJ_ITEM_TOTAL_ITEM_VALUE
      fw_final-item_batch_nm            = ''. "* MIJ_ITEM_BATCH_NAME
      fw_final-item_batch_expdt         = ''. "* MIJ_ITEM_BATCH_EXPIRY_DATE
      fw_final-item_batch_wrdt          = ''. "* MIJ_ITEM_BATCH_WARRANTY_DATE
*      fw_final-itm_sr_num                = ''.   "* ITM_SR_NUM
*      fw_final-itm_is_service            = 'N'.   "* ITM_IS_SERVICE                "Already used above commented by GJ(01.06.2021)
      fw_final-itm_pre_tax_val          = ''. "* ITM_PRE_TAX_VAL
*      fw_final-itm_gst_rate              = ''.   "* ITM_GST_RATE
*      fw_final-itm_igst_amt              = ''.   "* ITM_IGST_AMT
*      fw_final-itm_cgst_amt              = ''.   "* ITM_CGST_AMT
*      fw_final-itm_sgst_amt              = ''.   "* ITM_SGST_AMT
      fw_final-itm_cess_amt             = ''. "* ITM_CESS_AMT
      fw_final-itm_stat_cess_amt        = ''. "* ITM_STAT_CESS_AMT
      fw_final-itm_stat_cess_nadvol_amt = ''. "* ITM_STAT_CESS_NADVOL_AMT
      fw_final-itm_cntry_orgin          = ''. "* ITM_CNTRY_ORGIN
      fw_final-itm_odr_line_ref         = ''. "* ITM_ODR_LINE_REF
      fw_final-itm_prodct_sr_num        = ''. "* ITM_PRODCT_SR_NUM
      fw_final-atr_itm_attribte_detl    = ''. "* ATR_ITM_ATTRIBTE_DETL
      fw_final-atr_itm_attribte_val     = ''. "* ATR_ITM_ATTRIBTE_VAL

      PERFORM condende_data.

      APPEND fw_final TO ft_final.
      CLEAR fw_bseg_m.
      CLEAR gw_irn.
      CLEAR fw_final.
    ENDLOOP.

    CLEAR fw_bkpf.
    CLEAR fw_final.
  ENDLOOP.

  IF ft_final[] IS NOT INITIAL.
    APPEND LINES OF ft_final TO gt_final[].
  ENDIF.

  IF gt_final[] IS NOT INITIAL.
    ot_final[] = gt_final[].
  ENDIF.

  SORT gt_final BY vbeln.
  DELETE ADJACENT DUPLICATES FROM gt_final COMPARING vbeln.

  LOOP AT gt_final INTO DATA(w_f).
    REFRESH t_f[].
    t_f[] = ot_final[].
    SORT t_f[] BY vbeln.
    DELETE t_f WHERE vbeln <> w_f-vbeln.
    CLEAR w_f-val_assval.
    CLEAR w_f-val_cgstval.
    CLEAR w_f-val_sgstval.
    CLEAR w_f-val_igstval.
    CLEAR w_f-val_cesval.
    CLEAR w_f-branch_or_ifsc.
    CLEAR w_f-val_totinvval.
    CLEAR w_f-val_stcesval.
    CLEAR w_f-val_disc.
    CLEAR w_f-val_othchrg.
    CLEAR w_f-itm_gst_rate.
    LOOP AT t_f INTO DATA(tw_f).
      w_f-val_assval     += tw_f-val_assval.
      w_f-val_cgstval    += tw_f-val_cgstval.
      w_f-val_sgstval    += tw_f-val_sgstval.
      w_f-val_igstval    += tw_f-val_igstval.
      w_f-val_cesval     += tw_f-val_cesval.
      w_f-branch_or_ifsc += tw_f-branch_or_ifsc.
      w_f-val_totinvval  += tw_f-val_totinvval.
      w_f-val_stcesval   += tw_f-val_stcesval.
      w_f-val_disc       += tw_f-val_disc.
      w_f-val_othchrg    += tw_f-val_othchrg.

      CLEAR tw_f.
    ENDLOOP.
    CONDENSE w_f-val_assval.
    CONDENSE w_f-val_cgstval.
    CONDENSE w_f-val_sgstval.
    CONDENSE w_f-val_igstval.
    CONDENSE w_f-val_cesval.
    CONDENSE w_f-branch_or_ifsc.
    CONDENSE w_f-val_totinvval.
    CONDENSE w_f-val_stcesval.
    CONDENSE w_f-val_disc.
    CONDENSE w_f-val_othchrg.

    MODIFY gt_final FROM w_f TRANSPORTING val_assval val_cgstval val_sgstval val_igstval val_cesval branch_or_ifsc val_totinvval
                        val_stcesval val_disc val_othchrg WHERE vbeln = w_f-vbeln.
    CLEAR w_f.
    CLEAR tw_f.
  ENDLOOP.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form CONDENDE_DATA
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM condende_data.
**"""""****Hard Coded
**  "* MIJ_ACCESS_TOKEN
**  "* USER_GSTIN
**  "* DATA_SOURCE
**  "* USER_GSTIN
**  "* MIJ_CHARGE_TYPE
**  "* VAL_DT_ROUNDOFF
**  "* VAL_DT_TOT_INV_AC
**"""""****End: Hard Coded
  CONDENSE fw_final-tran_catg. "* SUPPLY_TYP
  CONDENSE fw_final-tran_ecmgstin. "* MIJ_ECOMMERCE_GSTIN
  CONDENSE fw_final-doc_typ. "* MIJ_DOCUMENT_TYPE
  CONDENSE fw_final-doc_no. "* MIJ_DOCUMENT_NUMBER
  CONDENSE fw_final-doc_dt. "* MIJ_DOCUMENT_DATE
  CONDENSE fw_final-billfrom_trdnm. "* SLR_LGL_NAME
  CONDENSE fw_final-billfrom_trdnm. "* MIJ_SELLER_TRADE_NAME
  CONDENSE fw_final-billfrom_bno. "* SLR_ADR1
  CONDENSE fw_final-billfrom_bnm. "* SLR_ADR2
  CONDENSE fw_final-billfrom_loc. "* MIJ_SELLER_LOCATION
  CONDENSE fw_final-billfrom_pin. "* MIJ_SELLER_PINCODE
  CONDENSE fw_final-billfrom_stcd. "* MIJ_SELLER_STATE_CODE
  CONDENSE fw_final-billfrom_ph.  "* MIJ_SELLER_PHONE_NUMBER
  CONDENSE fw_final-billfrom_em.  "* MIJ_SELLER_EMAIL
  CONDENSE fw_final-billto_gstin.  "* MIJ_BUYER_GSTIN
  CONDENSE fw_final-billto_trdnm.  "* BYR_LGL_NAME
  CONDENSE fw_final-billto_trdnm.  "* MIJ_BUYER_TRADE_NAME
  CONDENSE fw_final-billto_bno. "* BYR_ADR1
  CONDENSE fw_final-billto_bnm. "* BYR_ADR2
  CONDENSE fw_final-billto_loc. "* MIJ_BUYER_LOCATION
  CONDENSE fw_final-billto_pin. "* MIJ_BUYER_PINCODE
  CONDENSE fw_final-billto_stcd.  "* BYR_PLS_SUPPLY
  CONDENSE fw_final-billto_stcd.  "* MIJ_BUYER_STATE_CODE
  CONDENSE fw_final-billto_ph. "* MIJ_BUYER_PHONE_NUMBER
  CONDENSE fw_final-billto_em. "* MIJ_BUYER_EMAIL
  CONDENSE fw_final-shipfrom_trdnm.  "* DISP_COMP_NAME
  CONDENSE fw_final-shipfrom_bno.  "* DISP_ADR1
  CONDENSE fw_final-shipfrom_bnm.  "* DISP_ADR2
  CONDENSE fw_final-shipfrom_loc.  "* MIJ_DISPATCH_LOCATION
  CONDENSE fw_final-shipfrom_pin.  "* MIJ_DISPATCH_PINCODE
  CONDENSE fw_final-shipfrom_stcd.  "* MIJ_DISPATCH_STATE_CODE
  CONDENSE fw_final-shipto_gstin.  "* MIJ_SHIP_GSTIN
  CONDENSE fw_final-shipto_trdnm.  "* SHP_LGL_NAME
  CONDENSE fw_final-shipto_trdnm.  "* MIJ_SHIP_TRADE_NAME
  CONDENSE fw_final-shipto_bno. "* SHP_ADR1
  CONDENSE fw_final-shipto_bnm. "* SHP_ADR2
  CONDENSE fw_final-shipto_loc. "* MIJ_SHIP_LOCATION
  CONDENSE fw_final-shipto_pin. "* MIJ_SHIP_PINCODE
  CONDENSE fw_final-shipto_stcd. "* MIJ_SHIP_STATE_CODE
  CONDENSE fw_final-val_assval. "* MIJ_VALUE_TOTAL_ASSESS_VALUE
  CONDENSE fw_final-val_cgstval. "* MIJ_VALUE_TOTAL_CGST_VALUE
  CONDENSE fw_final-val_sgstval. "* MIJ_VALUE_TOTAL_SGST_VALUE
  CONDENSE fw_final-val_igstval. "* MIJ_VALUE_TOTAL_IGST_VALUE
  CONDENSE fw_final-val_cesval. "* MIJ_VALUE_TOTAL_CESS_VALUE
  CONDENSE fw_final-branch_or_ifsc.  "* MIJ_VALUE_TOTAL_CESS_NON_VALUE
  CONDENSE fw_final-val_totinvval.  "* MIJ_VALUE_TOTAL_INVOICE_VALUE
  CONDENSE fw_final-val_stcesval.  "* MIJ_VALUE_TOTAL_CESS_V_STATE

**""""*****Item detail
  CONDENSE fw_final-item_prdnm. "* MIJ_ITEM_PRODUCT_NAME
  CONDENSE fw_final-item_prddesc. "* MIJ_ITEM_PRODUCT_DESCRIPTION
  CONDENSE fw_final-item_hsncd. "* MIJ_ITEM_HSN_CODE
  CONDENSE fw_final-item_barcde. "* MIJ_ITEM_BAR_CODE
  CONDENSE fw_final-item_qty. "* MIJ_ITEM_QUANTITY
  CONDENSE fw_final-item_freeqty. "* MIJ_ITEM_FREE_QUANTITY
  CONDENSE fw_final-item_unit. "* MIJ_ITEM_UNIT
  CONDENSE fw_final-item_unitprice. "* MIJ_ITEM_UNIT_PRICE
  CONDENSE fw_final-item_totamt. "* MIJ_ITEM_TOTAL_AMOUNT
  CONDENSE fw_final-item_discount. "* MIJ_ITEM_DISCOUNT
  CONDENSE fw_final-item_othchrg. "* MIJ_ITEM_OTHER_CHARGE
  CONDENSE fw_final-item_assamt. "* MIJ_ITEM_ASSESSABLE_VALUE
  CONDENSE fw_final-item_sgstrt. "* MIJ_ITEM_SGST_RATE
  CONDENSE fw_final-item_cgstrt. "* MIJ_ITEM_CGST_RATE
  CONDENSE fw_final-item_igstrt. "* MIJ_ITEM_IGST_RATE
  CONDENSE fw_final-item_cesrt. "* MIJ_ITEM_CESS_RATE
  CONDENSE fw_final-item_cesnonadval. "* MIJ_ITEM_CESS_NONADVOL_VALUE
  CONDENSE fw_final-item_stateces. "* MIJ_ITEM_STATE_CESS_RATE
  CONDENSE fw_final-item_totitemval. "* MIJ_ITEM_TOTAL_ITEM_VALUE
  CONDENSE fw_final-item_batch_nm. "* MIJ_ITEM_BATCH_NAME
  CONDENSE fw_final-item_batch_expdt. "* MIJ_ITEM_BATCH_EXPIRY_DATE
  CONDENSE fw_final-item_batch_wrdt. "* MIJ_ITEM_BATCH_WARRANTY_DATE
  CONDENSE fw_final-itm_sr_num. "* ITM_SR_NUM
  CONDENSE fw_final-itm_is_service. "* ITM_IS_SERVICE
  CONDENSE fw_final-itm_pre_tax_val. "* ITM_PRE_TAX_VAL
  CONDENSE fw_final-itm_gst_rate. "* ITM_GST_RATE
  CONDENSE fw_final-itm_igst_amt. "* ITM_IGST_AMT
  CONDENSE fw_final-itm_cgst_amt. "* ITM_CGST_AMT
  CONDENSE fw_final-itm_sgst_amt. "* ITM_SGST_AMT
  CONDENSE fw_final-itm_cess_amt. "* ITM_CESS_AMT
  CONDENSE fw_final-itm_stat_cess_amt. "* ITM_STAT_CESS_AMT
  CONDENSE fw_final-itm_stat_cess_nadvol_amt. "* ITM_STAT_CESS_NADVOL_AMT
  CONDENSE fw_final-itm_cntry_orgin. "* ITM_CNTRY_ORGIN
  CONDENSE fw_final-itm_odr_line_ref. "* ITM_ODR_LINE_REF
  CONDENSE fw_final-itm_prodct_sr_num. "* ITM_PRODCT_SR_NUM
  CONDENSE fw_final-atr_itm_attribte_detl. "* ATR_ITM_ATTRIBTE_DETL
  CONDENSE fw_final-atr_itm_attribte_val. "* ATR_ITM_ATTRIBTE_VAL

ENDFORM.

*&---------------------------------------------------------------------*
*& Form CONDENSE_VARIABLES
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM condense_variables.
  CONDENSE mij_gw_string.
  CONDENSE mij_access_token.
  CONDENSE mij_user_gstin.
  CONDENSE mij_data_source.
  " CONDENSE  TRAN_DET.
  CONDENSE mij_category_of_transaction.
  CONDENSE mij_charge_type.
  " CONDENSE  LV_V2.
  CONDENSE mij_transaction_type.
  CONDENSE mij_ecommerce_transaction.
  CONDENSE mij_ecommerce_gstin.
  " CONDENSE  DOC_DTLS.
  CONDENSE mij_document_type.
  CONDENSE mij_document_number.
  CONDENSE mij_document_date.
  CONDENSE mij_original_document_number.
  " CONDENSE  SELLER_DET.
  CONDENSE mij_seller_gstin.
  CONDENSE mij_seller_trade_name.
  CONDENSE mij_seller_building_number.
  CONDENSE mij_seller_building_name.
  CONDENSE mij_seller_floor_number.
  CONDENSE mij_seller_location.
  CONDENSE mij_seller_district.
  CONDENSE mij_seller_pincode.
  CONDENSE mij_seller_state_code.
  CONDENSE mij_seller_phone_number.
  CONDENSE mij_seller_email.
  " CONDENSE  BUYER_DET.
  CONDENSE mij_buyer_gstin.
  CONDENSE mij_buyer_trade_name.
  CONDENSE mij_buyer_building_number.
  CONDENSE mij_buyer_building_name.
  CONDENSE mij_buyer_floor_number.
  CONDENSE mij_buyer_location.
  CONDENSE mij_buyer_district.
  CONDENSE mij_buyer_pincode.
  CONDENSE mij_buyer_state_code.
  CONDENSE mij_buyer_phone_number.
  CONDENSE mij_buyer_email.
  " CONDENSE  DISPATCH_DET.
  CONDENSE mij_dispatch_gstin.
  CONDENSE mij_dispatch_trade_name.
  CONDENSE mij_dispatch_building_number.
  CONDENSE mij_dispatch_building_name.
  CONDENSE mij_dispatch_floor_number.
  CONDENSE mij_dispatch_location.
  CONDENSE mij_dispatch_district.
  CONDENSE mij_dispatch_pincode.
  CONDENSE mij_dispatch_state_code.
  CONDENSE mij_dispatch_phone_number.
  CONDENSE mij_dispatch_email.
  " CONDENSE  SHIP_DET.
  CONDENSE mij_ship_gstin.
  CONDENSE mij_ship_trade_name.
  CONDENSE mij_ship_building_number.
  CONDENSE mij_ship_building_name.
  CONDENSE mij_ship_floor_number.
  CONDENSE mij_ship_location.
  CONDENSE mij_ship_district.
  CONDENSE mij_ship_pincode.
  CONDENSE mij_ship_state_code.
  CONDENSE mij_ship_phone_number.
  CONDENSE mij_ship_email.
  " CONDENSE  EXPORT_DET.
  CONDENSE mij_export_export_category.
  CONDENSE mij_export_ship_bill_number.
  CONDENSE mij_export_ship_bill_date.
  CONDENSE mij_export_country_code.
  CONDENSE mij_export_foreign_currency.
  CONDENSE mij_export_invoice_value_in_fc.
  CONDENSE mij_export_port_code.
  CONDENSE mij_export_export_payment.
  " CONDENSE  PAYT_DET.
  CONDENSE mij_payment_account_details.
  CONDENSE mij_payment_paid_amount.
  CONDENSE mij_payment_credit_days.
  CONDENSE mij_payment_credit_transfer.
  CONDENSE mij_payment_direct_debit.
  CONDENSE mij_payment_branch_or_ifsc.
  CONDENSE mij_payment_payment_mode.
  CONDENSE mij_payment_payee_name.
  CONDENSE mij_payment_payment_due_date.
  CONDENSE mij_payment_instruction.
  CONDENSE mij_payment_payment_term.
  " CONDENSE  REF_DET.
  CONDENSE mij_ref_contract_ref_number.
  CONDENSE mij_ref_other_reference.
  CONDENSE mij_ref_inv_period_start_date.
  CONDENSE mij_ref_inv_period_end_date.
  CONDENSE mij_ref_inv_reference_number.
  CONDENSE mij_ref_inv_remarks.
  CONDENSE mij_ref_vendor_po_ref_number.
  CONDENSE mij_ref_preceding_inv_date.
  CONDENSE mij_ref_preceding_inv_number.
  CONDENSE mij_ref_project_ref_number.
  CONDENSE mij_ref_receipt_advice_number.
  CONDENSE mij_ref_batch_reference_number.
  " CONDENSE  VALUE_DET.
  CONDENSE mij_value_total_assess_value.
  CONDENSE mij_value_total_cgst_value.
  CONDENSE mij_value_total_sgst_value.
  CONDENSE mij_value_total_igst_value.
  CONDENSE mij_value_total_cess_value.
  CONDENSE mij_value_total_cess_non_value.
  CONDENSE mij_value_total_invoice_value.
  CONDENSE mij_value_total_cess_v_state.
  CONDENSE mij_value_discount.
  CONDENSE mij_value_other_charge.
  " CONDENSE  ITEM_DET.
  CONDENSE mij_item_product_name.
  CONDENSE mij_item_product_description.
  CONDENSE mij_item_hsn_code.
  CONDENSE mij_item_bar_code.
  CONDENSE mij_item_quantity.
  CONDENSE mij_item_free_quantity.
  CONDENSE mij_item_unit.
  CONDENSE mij_item_unit_price.
  CONDENSE mij_item_total_amount.
  CONDENSE mij_item_discount.
  CONDENSE mij_item_other_charge.
  CONDENSE mij_item_assessable_value.
  CONDENSE mij_item_sgst_rate.
  CONDENSE mij_item_cgst_rate.
  CONDENSE mij_item_igst_rate.
  CONDENSE mij_item_cess_rate.
  CONDENSE mij_item_cess_nonadvol_value.
  CONDENSE mij_item_state_cess_rate.
  CONDENSE mij_item_total_item_value.
  " CONDENSE  ITEM_BATCH_DET.
  CONDENSE mij_item_batch_name.
  CONDENSE mij_item_batch_expiry_date.
  CONDENSE mij_item_batch_warranty_date.
  CONDENSE supply_typ.
  CONDENSE slr_lgl_name.
  CONDENSE slr_adr1.
  CONDENSE slr_adr2.
  CONDENSE byr_lgl_name.
  CONDENSE byr_adr1.
  CONDENSE byr_adr2.
  CONDENSE disp_comp_name.
  CONDENSE disp_adr1.
  CONDENSE disp_adr2.
  CONDENSE shp_lgl_name.
  CONDENSE shp_adr1.
  CONDENSE shp_adr2.
  CONDENSE rfnd_clm.
  CONDENSE pymnt_acc_no.
  CONDENSE ref_inv_remark.
  CONDENSE ref_inv_prd_strt.
  CONDENSE ref_inv_prd_end.
  CONDENSE prcdg_inv_dat.
  CONDENSE oth_ref.
  CONDENSE contrct_recpt_adv_num.
  CONDENSE contrct_recpt_adv_dat.
  CONDENSE contrct_batch_ref_num.
  CONDENSE contrct_contrct_ref_num.
  CONDENSE contrct_othr_ref.
  CONDENSE contrct_proj_ref_num.
  CONDENSE contrct_ven_po_ref_num.
  CONDENSE contrct_ven_po_ref_dat.
  CONDENSE addl_sup_doc_url.
  CONDENSE addl_sup_doc.
  CONDENSE addl_info.
  CONDENSE val_dt_roundoff.
  CONDENSE val_dt_tot_inv_ac.
  CONDENSE eway_transp_id.
  CONDENSE eway_transp_name.
  CONDENSE eway_transp_mode.
  CONDENSE eway_transp_dist.
  CONDENSE eway_transp_doc_num.
  CONDENSE eway_transp_doc_dat.
  CONDENSE eway_vech_num.
  CONDENSE eway_vech_type.
  CONDENSE itm_sr_num.
  CONDENSE itm_is_service.
  CONDENSE itm_pre_tax_val.
  CONDENSE itm_gst_rate.
  CONDENSE itm_igst_amt.
  CONDENSE itm_cgst_amt.
  CONDENSE itm_sgst_amt.
  CONDENSE itm_cess_amt.
  CONDENSE itm_stat_cess_amt.
  CONDENSE itm_stat_cess_nadvol_amt.
  CONDENSE itm_cntry_orgin.
  CONDENSE itm_odr_line_ref.
  CONDENSE itm_prodct_sr_num.
  CONDENSE atr_itm_attribte_detl.
  CONDENSE atr_itm_attribte_val.
ENDFORM.

*&---------------------------------------------------------------------*
*& Form CLEAR_ITM_VARIABLES
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM clear_itm_variables.
  CLEAR mij_item_product_description.
  CLEAR mij_item_hsn_code.
  CLEAR mij_item_bar_code.
  CLEAR mij_item_quantity.
  CLEAR mij_item_free_quantity.
  CLEAR mij_item_unit.
  CLEAR mij_item_unit_price.
  CLEAR mij_item_total_amount.
  CLEAR mij_item_discount.
  CLEAR mij_item_other_charge.
  CLEAR mij_item_assessable_value.
  CLEAR mij_item_cess_rate.
  CLEAR mij_item_cess_nonadvol_value.
  CLEAR mij_item_state_cess_rate.
  CLEAR mij_item_total_item_value.
  CLEAR mij_item_batch_name.
  CLEAR mij_item_batch_expiry_date.
  CLEAR mij_item_batch_warranty_date.
ENDFORM.

*&---------------------------------------------------------------------*
*& Form PREPARE_HDR_DATA
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
FORM prepare_hdr_data.
  gw_hdr-user_gstin                     = user_gstin.
  gw_hdr-data_source                    = data_source.
  gw_hdr-supply_typ                     = supply_typ.
  gw_hdr-mij_charge_type                = mij_charge_type.
  gw_hdr-mij_ecommerce_gstin            = mij_ecommerce_gstin.
  gw_hdr-mij_document_type              = mij_document_type.
  gw_hdr-mij_document_number            = mij_document_number.
  gw_hdr-mij_document_date              = mij_document_date.
  gw_hdr-slr_user_gstin                 = user_gstin.
  gw_hdr-slr_lgl_name                   = slr_lgl_name.
  gw_hdr-mij_seller_trade_name          = mij_seller_trade_name.
  gw_hdr-slr_adr1                       = slr_adr1.
  gw_hdr-slr_adr2                       = slr_adr2.
  gw_hdr-mij_seller_location            = mij_seller_location.
  gw_hdr-mij_seller_pincode             = mij_seller_pincode.
  gw_hdr-mij_seller_state_code          = mij_seller_state_code.
  gw_hdr-mij_seller_phone_number        = mij_seller_phone_number.
  gw_hdr-mij_seller_email               = mij_seller_email.
  gw_hdr-mij_buyer_gstin                = mij_buyer_gstin.
  gw_hdr-byr_lgl_name                   = byr_lgl_name.
  gw_hdr-mij_buyer_trade_name           = mij_buyer_trade_name.
  gw_hdr-byr_adr1                       = byr_adr1.
  gw_hdr-byr_adr2                       = byr_adr2.
  gw_hdr-mij_buyer_location             = mij_buyer_location.
  gw_hdr-mij_buyer_pincode              = mij_buyer_pincode.
  gw_hdr-byr_pls_supply                 = byr_pls_supply.
  gw_hdr-mij_buyer_state_code           = mij_buyer_state_code.
  gw_hdr-mij_buyer_phone_number         = mij_buyer_phone_number.
  gw_hdr-mij_buyer_email                = mij_buyer_email.
  gw_hdr-disp_comp_name                 = disp_comp_name.
  gw_hdr-disp_adr1                      = disp_adr1.
  gw_hdr-disp_adr2                      = disp_adr2.
  gw_hdr-mij_dispatch_location          = mij_dispatch_location.
  gw_hdr-mij_dispatch_pincode           = mij_dispatch_pincode.
  gw_hdr-mij_dispatch_state_code        = mij_dispatch_state_code.
  gw_hdr-mij_ship_gstin                 = mij_ship_gstin.
  gw_hdr-shp_lgl_name                   = shp_lgl_name.
  gw_hdr-mij_ship_trade_name            = mij_ship_trade_name.
  gw_hdr-shp_adr1                       = shp_adr1.
  gw_hdr-shp_adr2                       = shp_adr2.
  gw_hdr-mij_ship_location              = mij_ship_location.
  gw_hdr-mij_ship_pincode               = mij_ship_pincode.
  gw_hdr-mij_ship_state_code            = mij_ship_state_code.
  gw_hdr-mij_value_total_assess_value   = mij_value_total_assess_value.
  gw_hdr-mij_value_total_cgst_value     = mij_value_total_cgst_value.
  gw_hdr-mij_value_total_sgst_value     = mij_value_total_sgst_value.
  gw_hdr-mij_value_total_igst_value     = mij_value_total_igst_value.
  gw_hdr-mij_value_total_cess_value     = mij_value_total_cess_value.
  gw_hdr-mij_value_total_cess_non_value = mij_value_total_cess_non_value.
  gw_hdr-mij_value_total_invoice_value  = mij_value_total_invoice_value.
  gw_hdr-mij_value_total_cess_v_state   = mij_value_total_cess_v_state.
  gw_hdr-val_dt_roundoff                = val_dt_roundoff.
  gw_hdr-val_dt_tot_inv_ac              = val_dt_tot_inv_ac.

  APPEND gw_hdr TO gt_hdr.

ENDFORM.

INCLUDE zmi_envoice_process_user_coi01.


*&---------------------------------------------------------------------*
*& Form HANDLE_SEL_SCREEN
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM handle_sel_screen.
  IF sd_einv = 'X' or sd_sez = 'X'.
    LOOP AT SCREEN.
      IF screen-group1 = 'MD3'.
        screen-input  = '0'.
        screen-active = '0'.
      ENDIF.
      MODIFY SCREEN.

      IF screen-group1 = 'HID'.
        screen-active = 0.
        MODIFY SCREEN.
      ENDIF.
    ENDLOOP.
  ENDIF.

  " if sy-tcode = 'ZDEINVOICE'.
  " *    clear: disply, create, print.
  " *    print = 'X'.
  "   loop at screen.
  "     if screen-group1 = 'MD4'  or screen-group1 = 'MD2'.
  "       screen-input = '0'.
  "       screen-active = '0'.
  "     endif.
  "     modify screen.
  "   endloop.
  " endif.
  "
  " if sy-tcode = 'ZEINVOICE'.
  " *    clear: disply, create, print.
  " *    print = 'X'.
  "   loop at screen.
  "     if screen-group1 = 'MD7'.
  "       screen-input = '0'.
  "       screen-active = '0'.
  "     endif.
  "     modify screen.
  "   endloop.
  " endif.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form CHECK_AUTH
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM check_auth_sd.
  AUTHORITY-CHECK OBJECT 'ZACTVT'
  ID 'ACTVT' FIELD 'SD'.

  IF sy-subrc <> 0.
    MESSAGE 'No authorization for company code' TYPE 'E'.
  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form CHECK_AUTH_FI
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM check_auth_fi.
  AUTHORITY-CHECK OBJECT 'ZACTVT'
  ID 'ACTVT' FIELD 'FI'.

  IF sy-subrc <> 0.
    MESSAGE 'No authorization for company code' TYPE 'E'.
  ENDIF.
ENDFORM.

*&---------------------------------------------------------------------*
*& Form CANCEL_BILL
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM cancel_bill.
  f_option-updmode = 'S'.
  f_option-defsize = 'X'.
  f_option-dismode = 'N'.

  LOOP AT gt_final INTO gw_final WHERE stat_ind = '@02@'.

    READ TABLE ft_bkpf INTO fw_bkpf WITH KEY belnr = gw_final-vbeln.

    PERFORM bdc_dynpro USING 'SAPMF05A'
                             '0105'.
    PERFORM bdc_field USING 'BDC_CURSOR'
                            'UF05A-STGRD'.
    PERFORM bdc_field USING 'BDC_OKCODE'
                            '=BU'.
    PERFORM bdc_field USING 'RF05A-BELNS'
                            gw_final-vbeln.
    PERFORM bdc_field USING 'BKPF-BUKRS'
                            fw_bkpf-bukrs.
    PERFORM bdc_field USING 'RF05A-GJAHS'
                            fw_bkpf-gjahr.
    PERFORM bdc_field USING 'UF05A-STGRD'
                            '01'.
    PERFORM bdc_dynpro USING 'SAPMF05A'
                             '0105'.
    PERFORM bdc_field USING 'BDC_OKCODE'
                            '/ECNC'.
    PERFORM bdc_field USING 'BDC_CURSOR'
                            'RF05A-BELNS'.
    PERFORM bdc_dynpro USING 'SAPLSPO1'
                             '0200'.
    PERFORM bdc_field USING 'BDC_OKCODE'
                            '=YES'.
*    PERFORM bdc_transaction USING 'FB08'.
    PERFORM bdc_dynpro USING 'SAPMF05A'
                             '0105'.
    PERFORM bdc_field USING 'BDC_CURSOR'
                            'RF05A-GJAHS'.
    PERFORM bdc_field USING 'BDC_OKCODE'
                            '=BU'.
    CALL TRANSACTION 'FB08' USING it_bdcdata OPTIONS FROM f_option MESSAGES INTO it_msg.
    CLEAR it_bdcdata.
  ENDLOOP.

  LOOP AT it_msg INTO wa_msg. " WHERE msgnr = '117' OR msgtyp = 'E' OR msgnr = '312'.
    CALL FUNCTION 'FORMAT_MESSAGE'
      EXPORTING
        id        = wa_msg-msgid
        lang      = 'EN'
        no        = wa_msg-msgnr
        v1        = wa_msg-msgv1
        v2        = wa_msg-msgv2
        v3        = wa_msg-msgv3
        v4        = wa_msg-msgv4
      IMPORTING
        msg       = gs_mess-msg
      EXCEPTIONS
        not_found = 1
        OTHERS    = 2.
    IF sy-subrc <> 0.
      " IMPLEMENT SUITABLE ERROR HANDLING HERE
    ENDIF.
    WRITE : wa_msg-msgv1,
            wa_msg-msgv2,
            wa_msg-msgv3,
            wa_msg-msgv4.

    APPEND gs_mess TO gt_mess.
    CLEAR gs_mess.
    CLEAR wa_msg.
  ENDLOOP.

  IF gt_mess IS NOT INITIAL.
    gs_layout-colwidth_optimize = 'X'.
    CLEAR gt_fcat.

    gs_fcat-fieldname    = 'MSG'.
    gs_fcat-reptext_ddic = 'Message'.
    gs_fcat-outputlen    = '20'.
    gs_fcat-tabname      = 'GT_MESS'.
    gs_fcat-col_pos      = '1'.
    APPEND gs_fcat TO gt_fcat.
    CLEAR gs_fcat.
    CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
      EXPORTING
        i_callback_program = sy-repid
*       I_CALLBACK_TOP_OF_PAGE = ' '
        is_layout          = gs_layout
        it_fieldcat        = gt_fcat
      TABLES
        t_outtab           = gt_mess
      EXCEPTIONS
        program_error      = 1
        OTHERS             = 2.
    IF sy-subrc <> 0.
      " Implement suitable error handling here
    ENDIF.
  ENDIF.

ENDFORM.

FORM bdc_dynpro USING program
                      dynpro.

  CLEAR wa_bdcdata.
  wa_bdcdata-program  = program.
  wa_bdcdata-dynpro   = dynpro.
  wa_bdcdata-dynbegin = 'X'.
  APPEND wa_bdcdata TO it_bdcdata.
  CLEAR wa_bdcdata.
ENDFORM.

" *----------------------------------------------------------------------
" Insert field
" ----------------------------------------------------------------------
FORM bdc_field USING fnam
                     fval.

  CLEAR wa_bdcdata.
  wa_bdcdata-fnam = fnam.
  wa_bdcdata-fval = fval.
  CONDENSE wa_bdcdata-fval.
  APPEND wa_bdcdata TO it_bdcdata.
  CLEAR wa_bdcdata.
ENDFORM.

*&---------------------------------------------------------------------*
*& Form GET_CREDENTIAL_DATA
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_credential_data.
  CLEAR gw_credential.
  SELECT SINGLE * FROM zmi_credential INTO gw_credential WHERE mi_uname IS NOT NULL.
ENDFORM.

*&---------------------------------------------------------------------*
*& Form GENERATE_IRN_FORM_TAXILA
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM generate_irn_form_taxila.
  ""Create Json String

  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_line          TYPE i.
  DATA lv_docdtls_dt    TYPE c LENGTH 10.
  DATA lv_space         TYPE c LENGTH 1.
  DATA gs_left          TYPE i.
  DATA gs_right         TYPE i.
  DATA gs_in_separator  TYPE c LENGTH 1.
  DATA gs_out_separator TYPE c LENGTH 1.
  DATA char_value       TYPE char20.

  CLEAR charge_type.
  PERFORM clear_variables.

  DATA(ct_final) = gt_final[].
  DELETE ct_final WHERE check <> 'X'.

  LOOP AT ct_final INTO wa_data WHERE check = 'X'. " LOOP AT GT_FINAL INTO WA_DATA WHERE CHECK = 'X'.

    WAIT UP TO 3 SECONDS.
    PERFORM validate_alreday_done_action.

    CLEAR usr_ngstin.
    " * WA_DATA-BILLFROM_GSTIN = '01AMBPG7773M002'.
    user_gstin = wa_data-billfrom_gstin.
    usr_gstin  = wa_data-billfrom_gstin.
    usr_ngstin = wa_data-billfrom_gstin.
    CONDENSE user_gstin.
    CONDENSE usr_gstin.
    CONDENSE usr_ngstin.
    PERFORM get_taxila_credential.
    PERFORM get_token_from_taxila.

    REFRESH li_final[].
    li_final[] = ot_final[].
    DELETE li_final WHERE vbeln <> wa_data-vbeln.
    DESCRIBE TABLE li_final LINES lv_line.

    mij_access_token = '"' && access_token && '",'. " access_token":
    mij_user_gstin   = '"' && user_gstin && '",'.   " user_gstin":
    mij_data_source  = '"' && data_source && '",'.  " DATA_SOURCE":

    ""Transaction Details Started
    mij_category_of_transaction = '"' && wa_data-tran_catg && '",'.   " category_of_transaction":
    mij_charge_type             = '"' && wa_data-tran_typ && '",'.    " charge_type":
    mij_transaction_type        = '"' && wa_data-tran_typ && '",'.    " transaction_type":
    mij_ecommerce_transaction   = '"' && wa_data-tran_ecmtrn && '",'. " ecommerce_transaction":
    mij_ecommerce_gstin         = '"' && wa_data-tran_ecmgstin && '",'. " ecommerce_gstin":
    IF wa_data-tran_ecmgstin IS INITIAL.
      mij_ecommerce_gstin = 'null,'.
    ENDIF.
    ""Transaction Details Closed

    ""For Special Character Issue---------------------""
    " SOC by Gaurav(01.10.2020)
    REPLACE ALL OCCURRENCES OF '\' IN wa_data-billfrom_trdnm WITH '/'.
    REPLACE ALL OCCURRENCES OF '"' IN wa_data-billfrom_trdnm WITH ''.

    REPLACE ALL OCCURRENCES OF '\' IN wa_data-billto_trdnm   WITH '/'.
    REPLACE ALL OCCURRENCES OF '"' IN wa_data-billto_trdnm   WITH ''.

    REPLACE ALL OCCURRENCES OF '\' IN wa_data-shipfrom_trdnm WITH '/'.
    REPLACE ALL OCCURRENCES OF '"' IN wa_data-shipfrom_trdnm WITH ''.

    REPLACE ALL OCCURRENCES OF '\' IN wa_data-shipto_trdnm   WITH '/'.
    REPLACE ALL OCCURRENCES OF '"' IN wa_data-shipto_trdnm   WITH ''.
    " EOC by Gaurav
    ""------------------------------------------------""

    ""Document Details Started
    DATA(ls_doc) = wa_data-doc_no.
    SHIFT ls_doc LEFT DELETING LEADING '0'.
    lv_docdtls_dt = wa_data-doc_dt+6(2) && '/' && wa_data-doc_dt+4(2) && '/' && wa_data-doc_dt+0(4).
    mij_document_type            = '"' && wa_data-doc_typ && '",'. " document_type":
    "*MIJ_DOCUMENT_NUMBER           = '"' && WA_DATA-DOC_NO       && '",'.  "document_number":
    mij_document_number          = '"' && ls_doc && '",'. " document_number":
    mij_document_date            = '"' && lv_docdtls_dt        && '"'.  " document_date":            "&& '",'.  "document_date":
    mij_original_document_number = '"' && wa_data-doc_orginvno && '",'. " original_document_number":
    ""Document Details Closed

*    ""Seller Details Started
    mij_seller_gstin      = '"' && wa_data-billfrom_gstin && '",'. " gstin":
    mij_seller_trade_name = '"' && wa_data-billfrom_trdnm && '",'. " trade_name":
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-billfrom_bno WITH lv_space.
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-billfrom_bnm WITH lv_space.
    mij_seller_building_number = '"' && wa_data-billfrom_bno  && '",'. " building_number"
    mij_seller_building_name   = '"' && wa_data-billfrom_bnm  && '",'. " building_name":
    mij_seller_floor_number    = '"' && wa_data-billfrom_flno && '",'. " floor_number":
    mij_seller_location        = '"' && wa_data-billfrom_loc  && '",'. " location":
    mij_seller_district        = '"' && wa_data-billfrom_dst  && '",'. " district":
    "*MIJ_SELLER_PINCODE        = '"' && WA_DATA-BILLFROM_PIN   && '",'. "pincode":
    mij_seller_pincode         = wa_data-billfrom_pin && ','. " pincode":
    mij_seller_state_code      = '"' && wa_data-billfrom_stcd && '",'. " state_code":
    mij_seller_phone_number    = '"' && wa_data-billfrom_ph   && '",'. " phone_number":
    IF wa_data-billfrom_ph IS INITIAL.
      mij_seller_phone_number = 'null,'.
    ENDIF.
    mij_seller_email = '"' && wa_data-billfrom_em && '"'. " email":
    IF wa_data-billfrom_em IS INITIAL.
      mij_seller_email = 'null'.
    ENDIF.
*    ""Seller Details Closed

*    ""Buyer Details Started
    mij_buyer_gstin      = '"' && wa_data-billto_gstin && '",'. " gstin":
    mij_buyer_trade_name = '"' && wa_data-billto_trdnm && '",'. " trade_name":
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-billto_bno WITH lv_space.
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-billto_bnm WITH lv_space.
    mij_buyer_building_number = '"' && wa_data-billto_bno  && '",'. " building_number":
    mij_buyer_building_name   = '"' && wa_data-billto_bnm  && '",'. " building_name":
    mij_buyer_floor_number    = '"' && wa_data-billto_flno && '",'. " floor_number":
    mij_buyer_location        = '"' && wa_data-billto_loc  && '",'. " location":
    mij_buyer_district        = '"' && wa_data-billto_dst  && '",'. " district":
    "*MIJ_BUYER_PINCODE       = '"' && WA_DATA-BILLTO_PIN   && '",'.  "pincode":
    mij_buyer_pincode         = wa_data-billto_pin && ','. " pincode":
    mij_buyer_state_code      = '"' && wa_data-billto_stcd && '",'. " state_code":
    mij_buyer_phone_number    = '"' && wa_data-billto_ph   && '",'. " phone_number":
    IF wa_data-billto_ph IS INITIAL.
      mij_buyer_phone_number = 'null,'.
    ENDIF.
    mij_buyer_email = '"' && wa_data-billto_em && '"'. " email":
    IF wa_data-billto_em IS INITIAL.
      mij_buyer_email = 'null'.
    ENDIF.
*    ""Buyear Details Closed

*    ""Dispatch Details Started
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-shipfrom_bno WITH lv_space.
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-shipfrom_bnm WITH lv_space.
    mij_dispatch_gstin           = '"' && wa_data-shipfrom_gstin && '",'. " gstin":
    mij_dispatch_trade_name      = '"' && wa_data-shipfrom_trdnm && '",'. " trade_name":
    mij_dispatch_building_number = '"' && wa_data-shipfrom_bno   && '",'. " building_number":
    mij_dispatch_building_name   = '"' && wa_data-shipfrom_bnm   && '",'. " building_name":
    mij_dispatch_floor_number    = '"' && wa_data-shipfrom_flno  && '",'. " floor_number":
    mij_dispatch_location        = '"' && wa_data-shipfrom_loc   && '",'. " location":
    mij_dispatch_district        = '"' && wa_data-shipfrom_dst   && '",'. " district":
    mij_dispatch_pincode         = '"' && wa_data-shipfrom_pin   && '",'. " pincode":
    mij_dispatch_state_code      = '"' && wa_data-shipfrom_stcd  && '"'. " state_code": "*&& '",'. "state_code":
    mij_dispatch_phone_number    = '"' && wa_data-shipfrom_ph    && '",'. " phone_number":
    mij_dispatch_email           = '"' && wa_data-shipfrom_em    && '"'.  " email":
*    ""Dispatch Details Closed
*
*    ""Ship Details Started
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-shipto_bno WITH lv_space.
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-shipto_bnm WITH lv_space.
    mij_ship_gstin           = '"' && wa_data-shipto_gstin && '",'.
    mij_ship_trade_name      = '"' && wa_data-shipto_trdnm && '",'.
    mij_ship_building_number = '"' && wa_data-shipto_bno   && '",'.
    mij_ship_building_name   = '"' && wa_data-shipto_bnm   && '",'.
    mij_ship_floor_number    = '"' && wa_data-shipto_flno  && '",'.
    mij_ship_location        = '"' && wa_data-shipto_loc   && '",'.
    mij_ship_district        = '"' && wa_data-shipto_dst   && '",'.
    mij_ship_pincode         = '"' && wa_data-shipto_pin   && '",'.
    mij_ship_state_code      = '"' && wa_data-shipto_stcd  && '"'. "*'&& '",'.
    mij_ship_phone_number    = '"' && wa_data-shipto_ph    && '",'.
    mij_ship_email           = '"' && wa_data-shipto_em    && '"'.
*    ""Ship Details Closed

*    ""Export Details Started
    "*MIJ_EXPORT_EXPORT_CATEGORY      = '"' && WA_DATA-EXPORT_CATEGORY            && '",'.
    mij_export_ship_bill_number = '"' && wa_data-exp_shipbno && '",'.
    mij_export_ship_bill_date   = '"' && wa_data-exp_shipbdt && '",'.
    mij_export_country_code     = '"' && wa_data-exp_cntcode && '",'.
    mij_export_foreign_currency = '"' && wa_data-exp_forcur && '",'.
    mij_export_port_code        = '"' && wa_data-exp_port && '"'. "&& '",'.
    " MIJ_EXPORT_EXPORT_PAYMENT       = '"' && WA_DATA-EXPORT_PAYMENT             && '"'.
*    ""Export Details Closed

*    ""Payment Details Started
    mij_payment_account_details  = '"' && wa_data-account_details && '",'.
    mij_payment_paid_amount      = '"' && wa_data-pay_balamt      && '",'.
    mij_payment_credit_days      = '"' && wa_data-pay_crday       && '",'.
    mij_payment_credit_transfer  = '"' && wa_data-credit_transfer && '",'.
    mij_payment_direct_debit     = '"' && wa_data-pay_dirdr       && '",'.
    mij_payment_branch_or_ifsc   = '"' && wa_data-branch_or_ifsc  && '",'.
    mij_payment_payment_mode     = '"' && wa_data-pay_mode        && '",'.
    mij_payment_payee_name       = '"' && wa_data-payee_name      && '",'.
    mij_payment_payment_due_date = '"' && wa_data-pay_payduedt    && '",'.
    mij_payment_instruction      = '"' && wa_data-pay_payinstr    && '",'.
    mij_payment_payment_term     = '"' && wa_data-pay_payterm     && '"'.
*    ""Payment Details Closed

*    ""Reference Details Started
    mij_ref_contract_ref_number    = '"' && wa_data-contrct_contrct_ref_num && '",'. " contract_reference_number":
    mij_ref_other_reference        = '"' && wa_data-contrct_othr_ref        && '",'. " other_reference":
    mij_ref_inv_period_start_date  = '"' && wa_data-ref_invstdt             && '",'. " invoice_period_start_date":
    mij_ref_inv_period_end_date    = '"' && wa_data-ref_invenddt            && '",'. " invoice_period_end_date":
    mij_ref_inv_reference_number   = '"' && wa_data-ref_precinvno           && '",'. " invoice_reference_number":
    mij_ref_inv_remarks            = '"' && wa_data-ref_invrmk              && '",'. " invoice_remarks":
    mij_ref_vendor_po_ref_number   = '"' && wa_data-contrct_ven_po_ref_num  && '",'. " vendor_po_reference_number":
    mij_ref_project_ref_number     = '"' && wa_data-contrct_proj_ref_num    && '",'. " project_reference_number":
    mij_ref_receipt_advice_number  = '"' && wa_data-contrct_recpt_adv_num   && '",'. " receipt_advice_number":
    mij_ref_batch_reference_number = '"' && wa_data-contrct_batch_ref_num   && '"'.  " batch_reference_number":
*    ""Reference Details Closed

    IF wa_data-val_assval IS INITIAL.
      wa_data-val_assval = '0'.
    ENDIF.

    IF wa_data-val_cgstval IS INITIAL.
      wa_data-val_cgstval = '0'.
    ENDIF.

    IF wa_data-val_sgstval IS INITIAL.
      wa_data-val_sgstval = '0'.
    ENDIF.

    IF wa_data-val_igstval IS INITIAL.
      wa_data-val_igstval = '0'.
    ENDIF.

    IF wa_data-val_cesval IS INITIAL.
      wa_data-val_cesval = '0'.
    ENDIF.

    IF wa_data-branch_or_ifsc IS INITIAL.
      wa_data-branch_or_ifsc = '0'.
    ENDIF.

    IF wa_data-val_totinvval IS INITIAL.
      wa_data-val_totinvval = '0'.
    ENDIF.

    IF wa_data-val_stcesval IS INITIAL.
      wa_data-val_stcesval = '0'.
    ENDIF.

*    ""Value Details Started
    mij_value_total_assess_value   = '' && wa_data-val_assval     && ','. " total_assessable_value":
    mij_value_total_cgst_value     = '' && wa_data-val_cgstval    && ','. " total_cgst_value":
    mij_value_total_sgst_value     = '' && wa_data-val_sgstval    && ','. " total_sgst_value":
    mij_value_total_igst_value     = '' && wa_data-val_igstval    && ','. " total_igst_value":
    mij_value_total_cess_value     = '' && wa_data-val_cesval     && ','. " total_cess_value":
    mij_value_total_cess_non_value = '' && wa_data-branch_or_ifsc && ','. " total_cess_nonadvol_value":
    mij_value_total_invoice_value  = '' && wa_data-val_totinvval  && ','. " total_invoice_value":
    mij_value_total_cess_v_state   = '' && wa_data-val_stcesval   && ','. " total_cess_value_of_state":
    mij_value_discount             = '"' && wa_data-val_disc    && '",'. " discount":
    mij_value_other_charge         = '"' && wa_data-val_othchrg && '",'. " other_charge":
*    ""Value Details Closed

    IF wa_data-val_othchrg = '0'.
      CLEAR mij_value_other_charge.
      mij_value_other_charge = 'null,'.
    ENDIF.
    REPLACE ALL OCCURRENCES OF '"' IN mij_value_other_charge WITH space.
    CONDENSE mij_value_other_charge.

    val_dt_roundoff   = '0'. "*Not Mandatory But should be zero
    val_dt_tot_inv_ac = '0'. "*Not Mandatory But should be zero

    """"***New Field
    supply_typ   = '"' && wa_data-tran_catg && '",'. " supply_type":
    slr_lgl_name = '"' && wa_data-billfrom_trdnm && '",'. " legal_name"
    slr_adr1     = '"' && wa_data-billfrom_bno   && '",'. " address1":
    slr_adr2     = '"' && wa_data-billfrom_bnm   && '",'. " address2":
    IF wa_data-billfrom_bnm IS INITIAL.
      slr_adr2 = 'null,'.
    ENDIF.
    byr_lgl_name = '"' && wa_data-billto_trdnm && '",'. " legal_name"
    byr_adr1     = '"' && wa_data-billto_bno   && '",'. " address1":
    byr_adr2     = '"' && wa_data-billto_bnm   && '",'. " address2":
    IF wa_data-billto_bnm IS INITIAL.
      byr_adr2 = 'null,'.
    ENDIF.
    byr_pls_supply          = '"' && wa_data-billto_stcd     && '",'.
    disp_comp_name          = '"' && wa_data-shipfrom_trdnm  && '",'. " company_name"
    disp_adr1               = '"' && wa_data-shipfrom_bno    && '",'. " address1"
    disp_adr2               = '"' && wa_data-shipfrom_bnm    && '",'. " address2"
    shp_lgl_name            = '"' && wa_data-shipto_trdnm    && '",'. " legal_name"
    shp_adr1                = '"' && wa_data-shipto_bno      && '",'. " address1":
    shp_adr2                = '"' && wa_data-shipto_bnm      && '",'. " address2":
    rfnd_clm                = '"' && rfnd_clm                && '",'. " refund_claim"

    pymnt_acc_no            = '"' && pymnt_acc_no            && '",'. " port_code"
    ref_inv_remark          = '"' && ref_inv_remark          && '",'.
    ref_inv_prd_strt        = '"' && ref_inv_prd_strt        && '",'.
    ref_inv_prd_end         = '"' && ref_inv_prd_end         && '",'.
    prcdg_inv_dat           = '"' && prcdg_inv_dat           && '",'.
    oth_ref                 = '"' && oth_ref                 && '"'.
    contrct_recpt_adv_num   = '"' && contrct_recpt_adv_num   && '",'.
    contrct_recpt_adv_dat   = '"' && contrct_recpt_adv_dat   && '",'.
    contrct_batch_ref_num   = '"' && contrct_batch_ref_num   && '",'.
    contrct_contrct_ref_num = '"' && contrct_contrct_ref_num && '",'.
    contrct_othr_ref        = '"' && contrct_othr_ref        && '",'.
    contrct_proj_ref_num    = '"' && contrct_proj_ref_num    && '",'.
    contrct_ven_po_ref_num  = '"' && contrct_ven_po_ref_num  && '",'.
    contrct_ven_po_ref_dat  = '"' && contrct_ven_po_ref_dat  && '"'.
    addl_sup_doc_url        = '"' && addl_sup_doc_url        && '",'.
    addl_sup_doc            = '"' && addl_sup_doc            && '",'.
    addl_info               = '"' && addl_info               && '"'.
    val_dt_roundoff         = ''  && val_dt_roundoff         && ','.
    val_dt_tot_inv_ac       = ''  && val_dt_tot_inv_ac       && ''.
    eway_transp_id          = '"' && eway_transp_id          && '",'.
    eway_transp_name        = '"' && eway_transp_name        && '",'.
    eway_transp_mode        = '"' && eway_transp_mode        && '",'.
    eway_transp_dist        = '"' && eway_transp_dist        && '",'.
    eway_transp_doc_num     = '"' && eway_transp_doc_num     && '",'.
    eway_transp_doc_dat     = '"' && eway_transp_doc_dat     && '",'.
    eway_vech_num           = '"' && eway_vech_num           && '",'.
    eway_vech_type          = '"' && eway_vech_type          && '"'.
    """""****End New Field.

    user_gstin  = mij_seller_gstin. "'"01AMBPG7773M002",'.
    data_source = '"erp",'.
    """""******Start:New: JSON:Master India: 07.03.2020*****************************************************"""""""""""""""

    PERFORM condense_variables.
    PERFORM prepare_hdr_data.
    CLEAR mij_gw_string.
    mij_gw_string = '{'
    && '"Version":"1.1",'
    && '"TranDtls":'
    && '{'
    && '"TaxSch":' && '"GST",'
    && '"SupTyp":' && supply_typ " B2B",
    && '"RegRev":' && '"N",'
    && '"EcmGstin":' && mij_ecommerce_gstin
    && '"IgstOnIntra":' && '"N"' " MIJ_ECOMMERCE_GSTIN
    && '},'
    && '"DocDtls":'
    && '{'
    && '"Typ":' && mij_document_type   " INV",
    && '"No":'  && mij_document_number " 20-21/12PD/28",
    && '"Dt":'  && mij_document_date   " 12/10/2020"
    && '},'
    && '"SellerDtls":'
    && '{'
    && '"Gstin":'  && user_gstin            " 01AMBPG7773M002",
    && '"LglNm":'  && slr_lgl_name          " MAWAI INFOTECH LTD.-HO",
    && '"TrdNm":'  && mij_seller_trade_name " MAWAI INFOTECH LTD.-HO",
    && '"Addr1":'  && slr_adr1            " A-164,SEC-63,NOIDA    ",
    && '"Addr2":'  && slr_adr2            " A-164,SEC-63,NOIDA    ",
    && '"Loc":'    && mij_seller_location " GANDHINAGAR",
    && '"Pin":'    && mij_seller_pincode                    " 193502,
    && '"Stcd":'   && mij_seller_state_code " 01",
    && '"Ph":'     && mij_seller_phone_number " 9871512345",
    && '"Em":'     && mij_seller_email " INFO@MAWAIMAIL.COM"
    && '},'
    && '"BuyerDtls":'
    && '{'
    && '"Gstin":'  && mij_buyer_gstin " 09AACCM1950C1ZT",
    && '"LglNm":'  && byr_lgl_name        " HAVELLS INDIA PVT LTD",
    && '"TrdNm":'  && mij_buyer_trade_name " HAVELLS INDIA PVT LTD",
    && '"Pos":'    && byr_pls_supply        " 9",
    && '"Addr1":'  && byr_adr1   " dwyewjhdwhdkw     ",
    && '"Addr2":'  && byr_adr2   " dwyewjhdwhdkw     ",
    && '"Loc":'    && mij_buyer_location " Noida",
    && '"Pin":'    && mij_buyer_pincode                     " 201301,
    && '"Stcd":'   && mij_buyer_state_code " 09",
    && '"Ph":'     && mij_buyer_phone_number " 9818131024",
    && '"Em":'     && mij_buyer_email " abc@gmail.com"
    && '},'

**  "DispDtls": {
**    "Nm": "ABC company pvt ltd",
**    "Addr1": "7th block, kuvempu layout",
**    "Addr2": "kuvempu layout",
**    "Loc": "Banagalore",
**    "Pin": 562160,
**    "Stcd": "29"
**  },

&& '"DispDtls":null,'.

    " **"SOC for ship details changes
    IF wa_data-tran_typ = 'SHP'.

      mij_gw_string = mij_gw_string
      && '"ShipDtls":'
      && '{'
      && '"Gstin":' && mij_ship_gstin      " 29AWGPV7107B1Z1",
      && '"LglNm":' && shp_lgl_name        " CBE company pvt ltd",
      && '"TrdNm":' && mij_ship_trade_name " kuvempu layout",
      && '"Addr1":' && shp_adr1            " 7th block, kuvempu layout",
      && '"Addr2":' && shp_adr2            " kuvempu layout",
      && '"Loc":'   && mij_ship_location   " Banagalore",
      && '"Pin":'   && mij_ship_pincode                     " 562160,
      && '"Stcd":'  && mij_ship_state_code " 29"
      && '},'.

    ELSE.
      mij_gw_string = mij_gw_string && '"ShipDtls":null,'.
    ENDIF.
    " **"EOC for ship details changes

    mij_gw_string = mij_gw_string
    && '"ItemList":'
        && '['
        && '{'.

    CLEAR itm_count.
    CLEAR line_itm.
    DESCRIBE TABLE li_final LINES line_itm.

    LOOP AT li_final INTO lw_data.
      itm_count += 1.

*    ""Item Details Started
      IF lw_data-item_freeqty IS INITIAL.
        lw_data-item_freeqty = 0.
      ENDIF.

      IF lw_data-item_unitprice IS INITIAL.
        lw_data-item_unitprice = 0.
      ENDIF.

      IF lw_data-item_totamt IS INITIAL.
        lw_data-item_totamt = 0.
      ENDIF.

      IF lw_data-item_discount IS INITIAL.
        lw_data-item_discount = 0.
      ENDIF.

      IF lw_data-item_othchrg IS INITIAL.
        lw_data-item_othchrg = 0.
      ENDIF.

      IF lw_data-item_assamt IS INITIAL.
        lw_data-item_assamt = 0.
      ENDIF.

      IF wa_data-item_sgstrt IS INITIAL.
        wa_data-item_sgstrt = 0.
      ENDIF.

      IF lw_data-item_cgstrt IS INITIAL.
        lw_data-item_cgstrt = 0.
      ENDIF.

      IF lw_data-item_igstrt IS INITIAL.
        lw_data-item_igstrt = 0.
      ENDIF.

      IF lw_data-item_cesrt IS INITIAL.
        lw_data-item_cesrt = 0.
      ENDIF.

      IF lw_data-item_cesnonadval IS INITIAL.
        lw_data-item_cesnonadval = 0.
      ENDIF.

      IF lw_data-item_stateces IS INITIAL.
        lw_data-item_stateces = 0.
      ENDIF.

      IF lw_data-item_totitemval IS INITIAL.
        lw_data-item_totitemval = 0.
      ENDIF.

      IF lw_data-item_barcde IS INITIAL. "*Mandatory
        lw_data-item_barcde = '123497'.
      ENDIF.

      IF lw_data-item_batch_nm IS INITIAL. "*Mandatory
        lw_data-item_batch_nm = 'TEST123'.
      ENDIF.

      IF lw_data-item_batch_expdt IS INITIAL. "*Mandatory
        lw_data-item_batch_expdt = '31/12/2020'.
      ENDIF.

      IF lw_data-item_batch_wrdt IS INITIAL. "*Mandatory
        lw_data-item_batch_wrdt = '31/12/2020'.
      ENDIF.

      IF lw_data-itm_pre_tax_val IS INITIAL.
        lw_data-itm_pre_tax_val = '0'.
      ENDIF.

      IF lw_data-itm_gst_rate IS INITIAL.
        lw_data-itm_gst_rate = '0'.
      ENDIF.

      IF lw_data-itm_igst_amt IS INITIAL.
        lw_data-itm_igst_amt = '0'.
      ENDIF.

      IF lw_data-itm_cgst_amt IS INITIAL.
        lw_data-itm_cgst_amt = '0'.
      ENDIF.

      IF lw_data-itm_sgst_amt IS INITIAL.
        lw_data-itm_sgst_amt = '0'.
      ENDIF.

      IF lw_data-itm_cess_amt IS INITIAL.
        lw_data-itm_cess_amt = '0'.
      ENDIF.

      IF lw_data-itm_stat_cess_amt IS INITIAL.
        lw_data-itm_stat_cess_amt = '0'.
      ENDIF.

      IF lw_data-itm_stat_cess_nadvol_amt IS INITIAL.
        lw_data-itm_stat_cess_nadvol_amt = '0'.
      ENDIF.

      CLEAR gs_left.
      CLEAR gs_right.
      CLEAR gs_in_separator.
      CLEAR gs_out_separator.
      gs_left          = 11.
      gs_right         = 2.
      gs_in_separator  = '.'.
      gs_out_separator = '.'.

      SHIFT lw_data-item_unitprice LEFT DELETING LEADING space.
      IF lw_data-item_unitprice IS NOT INITIAL AND lw_data-item_unitprice <> '0'.
        char_value = lw_data-item_unitprice.
        CALL FUNCTION 'HRPBSNO_FORMAT_ZERO'
          EXPORTING
            left          = gs_left
            right         = gs_right
            in_separator  = gs_in_separator
            out_separator = gs_out_separator
          CHANGING
            str           = char_value.
        SHIFT char_value LEFT DELETING LEADING '0'.
        IF char_value+0(1) = '.'.
        ELSE.
          lw_data-item_unitprice = char_value.
        ENDIF.
      ENDIF.

      SHIFT lw_data-item_igstrt LEFT DELETING LEADING space.
      IF lw_data-item_igstrt IS NOT INITIAL AND lw_data-item_igstrt <> '0'.
        char_value = lw_data-item_igstrt.
        CALL FUNCTION 'HRPBSNO_FORMAT_ZERO'
          EXPORTING
            left          = gs_left
            right         = gs_right
            in_separator  = gs_in_separator
            out_separator = gs_out_separator
          CHANGING
            str           = char_value.
        SHIFT char_value LEFT DELETING LEADING '0'.
        IF char_value+0(1) = '.'.
        ELSE.
          lw_data-item_igstrt = char_value.
        ENDIF.
      ENDIF.

      SHIFT lw_data-itm_gst_rate LEFT DELETING LEADING space.
      IF lw_data-itm_gst_rate IS NOT INITIAL AND lw_data-itm_gst_rate <> '0'.
        char_value = lw_data-itm_gst_rate.
        CALL FUNCTION 'HRPBSNO_FORMAT_ZERO'
          EXPORTING
            left          = gs_left
            right         = gs_right
            in_separator  = gs_in_separator
            out_separator = gs_out_separator
          CHANGING
            str           = char_value.
        SHIFT char_value LEFT DELETING LEADING '0'.
        IF char_value+0(1) = '.'.
        ELSE.
          lw_data-itm_gst_rate = char_value.
        ENDIF.
      ENDIF.

      SHIFT lw_data-item_sgstrt LEFT DELETING LEADING space.
      IF lw_data-item_sgstrt IS NOT INITIAL AND lw_data-item_sgstrt <> '0'.
        char_value = lw_data-item_sgstrt.
        CALL FUNCTION 'HRPBSNO_FORMAT_ZERO'
          EXPORTING
            left          = gs_left
            right         = gs_right
            in_separator  = gs_in_separator
            out_separator = gs_out_separator
          CHANGING
            str           = char_value.
        SHIFT char_value LEFT DELETING LEADING '0'.
        IF char_value+0(1) = '.'.
        ELSE.
          lw_data-item_sgstrt = char_value.
        ENDIF.
      ENDIF.

      SHIFT lw_data-item_cgstrt LEFT DELETING LEADING space.
      IF lw_data-item_cgstrt IS NOT INITIAL AND lw_data-item_cgstrt <> '0'.
        char_value = lw_data-item_cgstrt.
        CALL FUNCTION 'HRPBSNO_FORMAT_ZERO'
          EXPORTING
            left          = gs_left
            right         = gs_right
            in_separator  = gs_in_separator
            out_separator = gs_out_separator
          CHANGING
            str           = char_value.
        SHIFT char_value LEFT DELETING LEADING '0'.
        IF char_value+0(1) = '.'.
        ELSE.
          lw_data-item_cgstrt = char_value.
        ENDIF.
      ENDIF.

      " LW_DATA-ITEM_TOTAMT
      " LW_DATA-ITEM_DISCOUNT
      " LW_DATA-ITEM_OTHCHRG
      " LW_DATA-ITEM_ASSAMT
      " LW_DATA-ITEM_CESRT
      " LW_DATA-ITEM_CESNONADVAL
      " LW_DATA-ITEM_STATECES
      " LW_DATA-ITEM_TOTITEMVAL
      " LW_DATA-ITM_PRE_TAX_VAL
      " LW_DATA-ITM_IGST_AMT
      " LW_DATA-ITM_CGST_AMT
      " LW_DATA-ITM_SGST_AMT
      " LW_DATA-ITM_CESS_AMT
      " LW_DATA-ITM_STAT_CESS_AMT
      " LW_DATA-ITM_STAT_CESS_NADVOL_AMT

      IF wa_data-val_dt_roundoff CA '-'.
        REPLACE '-' IN wa_data-val_dt_roundoff WITH ' '.
        CONCATENATE    '-' wa_data-val_dt_roundoff INTO wa_data-val_dt_roundoff. " SEPARATED BY SPACE.
      ENDIF.

      mij_item_product_name        = '"' && lw_data-item_prdnm       && '",'. " product_name":
      mij_item_product_description = '"' && lw_data-item_prddesc     && '",'. " product_description":
      mij_item_hsn_code            = '"' && lw_data-item_hsncd       && '",'. " hsn_code":
      mij_item_bar_code            = '"' && lw_data-item_barcde      && '",'. " bar_code":
      mij_item_quantity            = ''  && lw_data-item_qty         && ','. " quantity":
      mij_item_free_quantity       = ''  && lw_data-item_freeqty     && ','. " free_quantity":
      mij_item_unit                = '"' && lw_data-item_unit        && '",'. " unit":
      mij_item_unit_price          = ''  && lw_data-item_unitprice   && ','. " unit_price":
      mij_item_total_amount        = ''  && lw_data-item_totamt      && ','. " total_amount":
      mij_item_discount            = ''  && lw_data-item_discount    && ','. " discount":
      mij_item_other_charge        = ''  && lw_data-item_othchrg     && ','. " other_charge":
      mij_item_assessable_value    = ''  && lw_data-item_assamt      && ','. " assessable_value":
      mij_item_sgst_rate           = ''  && lw_data-item_sgstrt      && ','. " sgst_rate":
      mij_item_cgst_rate           = ''  && lw_data-item_cgstrt      && ','. " cgst_rate":
      mij_item_igst_rate           = ''  && lw_data-item_igstrt      && ','. " igst_rate":
      mij_item_cess_rate           = ''  && lw_data-item_cesrt       && ','. " cess_rate":
      mij_item_cess_nonadvol_value = ''  && lw_data-item_cesnonadval && ','. " cess_nonadvol_value":
      mij_item_state_cess_rate     = ''  && lw_data-item_stateces    && ','. " state_cess_rate":
      mij_item_total_item_value    = ''  && lw_data-item_totitemval  && ','.  " total_item_value":
      mij_item_batch_name          = '"' && lw_data-item_batch_nm    && '",'. " name":
      mij_item_batch_expiry_date   = '"' && lw_data-item_batch_expdt && '",'. " expiry_date":
      mij_item_batch_warranty_date = '"' && lw_data-item_batch_wrdt  && '"'.  " warranty_date":
      itm_sr_num                   = '"' && lw_data-itm_sr_num               && '",'.
      itm_is_service               = '"' && lw_data-itm_is_service           && '",'.
      itm_pre_tax_val              = ''  && lw_data-itm_pre_tax_val          && ','.
      itm_gst_rate                 = ''  && lw_data-itm_gst_rate             && ','.
      itm_igst_amt                 = ''  && lw_data-itm_igst_amt             && ','.
      itm_cgst_amt                 = ''  && lw_data-itm_cgst_amt             && ','.
      itm_sgst_amt                 = ''  && lw_data-itm_sgst_amt             && ','.
      itm_cess_amt                 = ''  && lw_data-itm_cess_amt             && ','.
      itm_stat_cess_amt            = ''  && lw_data-itm_stat_cess_amt        && ','.
      itm_stat_cess_nadvol_amt     = ''  && lw_data-itm_stat_cess_nadvol_amt && ','.
      itm_cntry_orgin              = '"' && lw_data-itm_cntry_orgin          && '",'.
      itm_odr_line_ref             = '"' && lw_data-itm_odr_line_ref         && '",'.
      itm_prodct_sr_num            = '"' && lw_data-itm_prodct_sr_num        && '",'.
      atr_itm_attribte_detl        = '"' && lw_data-atr_itm_attribte_detl    && '",'.
      atr_itm_attribte_val         = '"' && lw_data-atr_itm_attribte_val     && '"'.

      PERFORM condense_variables.
      "*PERFORM: PREPARE_ITM_DATA.
**      CLEAR  : MIJ_ITM_GW_STRING.

      mij_itm_gw_string = mij_itm_gw_string
      && '"SlNo":'               && itm_sr_num " 1",
      && '"PrdDesc":'            && mij_item_product_description " HONDA CAR",
      && '"IsServc":'            && itm_is_service " N",
      && '"HsnCd":'              && mij_item_hsn_code " 1001",
      && '"Barcde":'             && mij_item_bar_code " Testing",
      && '"Qty":'                && mij_item_quantity " 100.345,
      && '"FreeQty":'            && mij_item_free_quantity " 10,
      && '"Unit":'               && mij_item_unit ""BAG",
      && '"UnitPrice":'          && mij_item_unit_price " 99.545,
      && '"TotAmt":'             && mij_item_total_amount " 9988.84,
      && '"Discount":'           && mij_item_discount
      && '"PreTaxVal":'          && itm_pre_tax_val
      && '"AssAmt":'             && mij_item_assessable_value
      && '"GstRt":'              && itm_gst_rate
      && '"IgstAmt":'            && itm_igst_amt
      && '"CgstAmt":'            && itm_cgst_amt
      && '"SgstAmt":'            && itm_sgst_amt
      && '"CesRt":'              && mij_item_cess_rate
      && '"CesAmt":'             && itm_cess_amt
      && '"CesNonAdvlAmt":'      && mij_item_cess_nonadvol_value
      && '"StateCesRt":'         && mij_item_state_cess_rate
      && '"StateCesAmt":'        && itm_stat_cess_amt
      && '"StateCesNonAdvlAmt":' && itm_stat_cess_nadvol_amt
      && '"OthChrg":'            && mij_item_other_charge
      && '"TotItemVal":'         && mij_item_total_item_value
      && '"OrdLineRef":'         && itm_odr_line_ref
      && '"OrgCntry":'           && itm_cntry_orgin
      && '"PrdSlNo":'            && itm_prodct_sr_num
      && '"BchDtls":'
      && '{'
      && '"Nm":'                 && mij_item_batch_name        " Testing",
      && '"Expdt":'              && mij_item_batch_expiry_date " 22/09/2020",
      && '"wrDt":'               && mij_item_batch_warranty_date " 22/09/2020"
      && '},'
      && '"AttribDtls":'
      && '['
      && '{'
      && '"Nm":'  && atr_itm_attribte_detl " Testing",
      && '"Val":' && atr_itm_attribte_val " 1001"
      && '}'
      && ']'.

      IF line_itm = itm_count.
        mij_itm_gw_string = mij_itm_gw_string && '}'.
      ELSE.
        mij_itm_gw_string = mij_itm_gw_string && '},{'.
      ENDIF.

      PERFORM clear_itm_variables.
      CLEAR lw_data.
    ENDLOOP.

    mij_gw_string = mij_gw_string
    && mij_itm_gw_string
    && '],'. "*']}'.

    mij_gw_string = mij_gw_string
      && '"ValDtls":'
      && '{'
      && '"AssVal":'      && mij_value_total_assess_value  " 9978.84,
      && '"CgstVal":'     && mij_value_total_cgst_value " 0.0,
      && '"SgstVal":'     && mij_value_total_sgst_value " 0.0,
      && '"IgstVal":'     && mij_value_total_igst_value " 1197.46,
      && '"CesVal":'      && mij_value_total_cess_value " 508.94,
      && '"StCesVal":'    && mij_value_total_cess_v_state  " 1202.46,
      && '"Discount":'    && '0,' " 10.0,
      && '"OthChrg":'     && mij_value_other_charge "*'0,'  "20.0,
      && '"RndOffAmt":'   && val_dt_roundoff " 0.3,
      && '"TotInvVal":'   && mij_value_total_invoice_value  " 12908.0,
      && '"TotInvValFc":' && val_dt_tot_inv_ac              " 12897.7
      && '},'
      && '"PayDtls":null,'
      && '"RefDtls":null,'
      && '"AddlDocDtls":null,'
      && '"ExpDtls":null,'
      && '"EwbDtls":null'
      && '}'.

    CONDENSE mij_gw_string.

    PERFORM call_taxila_api_to_gen_irn.

    CLEAR wa_data.
  ENDLOOP.
*  ""------------------------------------------------------------------------------------""
  REFRESH ct_final[].
ENDFORM.

*&---------------------------------------------------------------------*
*& Form CANCEL_IRN_FROM_TAXILA
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM cancel_irn_from_taxila.
  TYPES: BEGIN OF ty_success,
           success TYPE string,
           message TYPE string,
         END OF ty_success.

  TYPES: BEGIN OF ty_result,
           irn        TYPE string,
           canceldate TYPE string,
         END OF ty_result.

  DATA lv_rand                  TYPE i.
  DATA rand_num                 TYPE char10.
  " data Variables declaration for passing URL, Result String(Using get_cdata())
  DATA cp_url                   TYPE string.
  DATA cancl_irn                TYPE string.
  DATA cw_string                TYPE string.
  " data Variables declaration for passing the xml input data into API as a string and lenth
  DATA crlength                 TYPE i.
  " *****data declaration for creating HTTP Client, Request, Error description, error code etc
  DATA clo_http_client          TYPE REF TO if_http_client.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA cw_http_return_code      TYPE i.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA cw_http_error_descr      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA cw_http_error_descr_long TYPE xstring.
  DATA cw_xml_result_str        TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_string1               TYPE string.
  DATA lv_string2               TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_string3               TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_string4               TYPE string.
  DATA lv_success               TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA wa_success               TYPE ty_success.

  FIELD-SYMBOLS <cfs>.

  " TODO: variable is never used (ABAP cleaner)
  DATA: BEGIN OF it_girn,
          success TYPE string,
          message TYPE string,
          result  TYPE ty_result,
        END OF it_girn.

  CLEAR wa_data.
  LOOP AT gt_final INTO wa_data WHERE check = 'X'.

    PERFORM validate_alreday_done_action.

    """**********
    CLEAR usr_ngstin.
    " * WA_DATA-BILLFROM_GSTIN = '01AMBPG7773M002'.
    user_gstin = wa_data-billfrom_gstin.
    usr_gstin  = wa_data-billfrom_gstin.
    usr_ngstin = wa_data-billfrom_gstin.
    CONDENSE user_gstin.
    CONDENSE usr_gstin.
    CONDENSE usr_ngstin.
    CONDENSE user_gstin.
    PERFORM get_taxila_credential.
    PERFORM get_token_from_taxila.

    CLEAR lv_rand.
    CLEAR rand_num.
    CALL FUNCTION 'QF05_RANDOM_INTEGER'
      EXPORTING
        ran_int_max   = 1000
        ran_int_min   = 1
      IMPORTING
        ran_int       = lv_rand
      EXCEPTIONS
        invalid_input = 1.

    rand_num = lv_rand.
    SHIFT rand_num LEFT DELETING LEADING space.

    CLEAR usr_name.
    CLEAR usr_pass.
    CLEAR usr_gstin.
    CLEAR usr_reqid.
    CLEAR usr_auth.
    CLEAR url_canc.
    CLEAR url_det.
    CLEAR url_gen.
    CLEAR url_tkn.
    usr_name = gw_txila-usr_name.
    usr_pass = gw_txila-usr_pass.
    "*usr_gstin   = '36GSPOHM281G2ZP'.
    CONCATENATE 'MAWAI' rand_num INTO usr_reqid.
    CONCATENATE 'Bearer' access_token INTO usr_auth SEPARATED BY space.
    "*usr_auth    = access_token.
    url_canc = gw_txila-url_canc.
    cp_url   = url_canc.
    """**********

    CLEAR cancl_irn.
    cancl_irn = '"' && wa_data-irn && '",'.
    CONDENSE cancl_irn.
    CONDENSE access_token.

    CLEAR cw_string.
    cw_string = '{'
    && '"irn":' && cancl_irn
    && '"cnlrsn":"1",'
    && '"cnlrem":"cancel Remarks"'
    && '}'.

    """*********************************************"""""
    CLEAR crlength.
    cw_string = cw_string. "= LV_JSON.
    crlength = strlen( cw_string ).

    """*********************************************"""""
    " * PERFORM CREATE_URL.
    """*********************************************"""""
    " ****Creation of HTTP Client
    cl_http_client=>create_by_url( EXPORTING  url                = cp_url
                                   IMPORTING  client             = clo_http_client
                                   EXCEPTIONS argument_not_found = 1
                                              plugin_not_active  = 2
                                              internal_error     = 3
                                              OTHERS             = 4 ).

    """*********************************************"""""
    " * PERFORM SET_CALLING_METHOD.
    """*********************************************"""""
    " **** Set up the HTTP data passing method
    clo_http_client->request->set_method( method = 'POST' ).

    """*********************************************"""""
    " * PERFORM SET_VERSION.
    """*********************************************"""""
    " ** Set up the HTTP Post version
    clo_http_client->request->set_version( version = if_http_request=>co_protocol_version_1_1 ). " 1001

    " ***set the content type of request data
    clo_http_client->request->if_http_entity~set_content_type( content_type = 'application/json; charset=utf-8' ).

    " ***Set up the HTTP header
    clo_http_client->request->set_header_field( name  = 'Host'
                                                value = cp_url ).

    clo_http_client->request->set_header_field( name  = 'user_name'
                                                value = usr_name ).

    clo_http_client->request->set_header_field( name  = 'password'
                                                value = usr_pass ).

    clo_http_client->request->set_header_field( name  = 'gstin'
                                                value = usr_ngstin ).

    clo_http_client->request->set_header_field( name  = 'requestid'
                                                value = usr_reqid ).

    clo_http_client->request->set_header_field( name  = 'Authorization'
                                                value = usr_auth ).

    " * Set up the HTTP data i.e pass/set the data into API
    clo_http_client->request->set_cdata( data   = cw_string
                                         offset = 0
                                         length = crlength ).

    """*********************************************"""""
    " * PERFORM SEND_HTTP_REQUEST.
    """*********************************************"""""
    clo_http_client->propertytype_logon_popup = if_http_client=>co_disabled.

    " ** Send the HTTP Post request to the URL.
    clo_http_client->send( EXPORTING  timeout                    = 15   " 15 Seconds
                           EXCEPTIONS http_communication_failure = 1
                                      http_invalid_state         = 2 ).

    """*********************************************"""""
    " * PERFORM RECEIVE_RESPONSE.
    """*********************************************"""""
    " ***Read the Response from API
    clo_http_client->receive( EXCEPTIONS http_communication_failure = 1
                                         http_invalid_state         = 2
                                         http_processing_failed     = 3 ).

    """*********************************************"""""
    " * PERFORM DISPLAY_RESPONSE.
    """*********************************************"""""
    " Get the HTTP return code from the HTTP POST:
    clo_http_client->response->get_status( IMPORTING code = cw_http_return_code ).
    clo_http_client->response->get_status( IMPORTING reason = cw_http_error_descr ).
    cw_http_error_descr_long = clo_http_client->response->get_raw_message( ).

    clo_http_client->refresh_request( EXCEPTIONS http_action_failed = 1
                                                 OTHERS             = 2 ).

    " ****Write the data received back from the POST to the screen:
    CLEAR cw_xml_result_str.
    cw_xml_result_str = clo_http_client->response->get_cdata( ).
    sy-tmaxl = strlen( cw_xml_result_str ).
    ASSIGN cw_xml_result_str TO <cfs>.

    CLEAR canc_irn.
    CLEAR gs_irn.
    """****For ECC
    CLEAR lv_string1.
    CLEAR lv_string2.
    CLEAR lv_string3.
    CLEAR lv_string4.
    SPLIT <cfs> AT '"success":' INTO lv_string1 lv_string2.

    IF lv_string2 IS NOT INITIAL.
      lv_success = lv_string2+0(4).
      IF lv_success = 'true'.

        wa_success-success = 'true'.
        wa_success-message = 'E-Invoice is cancelled successfully'.

        CLEAR cancd_ack.
        CLEAR cancd_date.
        cancd_ack  = ' '.
        cancd_date = sy-datum.

        canc_irn = 'X'.
        gs_irn   = wa_data-irn.

      ENDIF.
    ENDIF.
    """*********

    " CLEAR: IT_CIRN[].
    " /UI2/CL_JSON=>DESERIALIZE(
    "   EXPORTING
    "     JSON = <CFS>
    "     PRETTY_NAME = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE
    "     CHANGING
    "       DATA = IT_GIRN ).
    "
    " MOVE-CORRESPONDING IT_GIRN TO WA_SUCCESS.
    " MOVE-CORRESPONDING IT_GIRN-RESULT TO WA_RESULT.
    " CANCD_ACK  = ''.
    " CANCD_DATE = WA_RESULT-CANCELDATE.

    " * {
    " * "success":true,
    " * "message":"E-Invoice is cancelled successfully",
    " * "result":
    " * {
    " * "Irn":"a5c12dca80e743321740b001fd70953e8738d109865d28ba4013750f2046f229",
    " * "CancelDate":"2019-12-05 14:26:00"
    " * }
    " * }

    " * CLEAR: CANC_IRN, GS_IRN.
    " * CANC_IRN = 'X'.
    " * GS_IRN   = WA_DATA-IRN.
    IF canc_irn IS NOT INITIAL.
      ""**Start: Save Data in ztable: ZSD_EINVOICE
      PERFORM save_data_into_ztable.
      PERFORM cancel_billing_document.
      ""**End: Save Data in ztable: ZSD_EINVOICE
    ELSE.
      ""**Modify display internal table: in case of error
      PERFORM update_ztable_for_error.
      ""**End: Modify display internal table: : in case of error
    ENDIF.

    CLEAR wa_data.
  ENDLOOP.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form GET_TAXILA_CREDENTIAL
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_taxila_credential.
  CLEAR gw_txila.
  SELECT SINGLE * FROM ztxla_credential INTO gw_txila WHERE usr_gstin = usr_gstin. "*USR_NAME IS NOT NULL.
ENDFORM.

*&---------------------------------------------------------------------*
*& Form GET_TOKEN_FROM_TAXILA
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_token_from_taxila.
  " data Variables declaration for passing URL, Result String(Using get_cdata())

  DATA mi_url                   TYPE string.
  DATA mi_http_client           TYPE REF TO if_http_client.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA mi_http_return_code      TYPE i.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA mi_http_error_descr      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA mi_http_error_descr_long TYPE xstring.
  DATA mi_xml_result_str        TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA at1                      TYPE string.
  DATA at2                      TYPE string.
  DATA at3                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA at4                      TYPE string.

  FIELD-SYMBOLS <mi_fs>.

  " data Variables declaration for passing the xml input data into API as a string and lenth

  CLEAR usr_name.
  CLEAR usr_pass.
  CLEAR usr_gstin.
  CLEAR usr_reqid.
  CLEAR usr_auth.
  CLEAR url_canc.
  CLEAR url_det.
  CLEAR url_gen.
  CLEAR url_tkn.
  CLEAR gspappid.
  CLEAR gspappsecret.
  url_tkn      = gw_txila-url_tkn.
  mi_url       = url_tkn.
  gspappid     = gw_txila-gspappid.
  gspappsecret = gw_txila-gspappsecret.

  """*********************************************"""""
  " CLEAR :MI_RLENGTH.
  " MI_STRING = MIW_STRING.
  " MI_RLENGTH = STRLEN( MI_STRING ).

  """*********************************************"""""
  " ****Creation of HTTP Client
  cl_http_client=>create_by_url( EXPORTING  url                = mi_url
                                            ssl_id             = 'DFAULT'
                                 IMPORTING  client             = mi_http_client
                                 EXCEPTIONS argument_not_found = 1
                                            plugin_not_active  = 2
                                            internal_error     = 3
                                            OTHERS             = 4 ).

  """*********************************************"""""
  " **** Set up the HTTP data passing method
  mi_http_client->request->set_method( method = 'POST' ).
  """*********************************************"""""

  " ** Set up the HTTP Post version
  mi_http_client->request->set_version( version = if_http_request=>co_protocol_version_1_1 ). " 1001

  """*********************************************"""""
  " * PERFORM SET_CONTENT_TYPE.
  """*********************************************"""""
  " ***set the content type of request data
  mi_http_client->request->if_http_entity~set_content_type( content_type = 'application/json; charset=utf-8' ).

  """*********************************************"""""
  " * PERFORM SETUP_HTTP_HEADER.
  """*********************************************"""""
  " ***Set up the HTTP header
  mi_http_client->request->set_header_field( name  = 'Host'
                                             value = mi_url ).

  " ***Set up the HTTP header
  mi_http_client->request->set_header_field( name  = 'gspappid'
                                             value = gspappid ).

  mi_http_client->request->set_header_field( name  = 'gspappsecret'
                                             value = gspappsecret ).

  """*********************************************"""""
  " * Set up the HTTP data i.e pass/set the data into API
  "  CALL METHOD MI_HTTP_CLIENT->REQUEST->SET_CDATA
  "    EXPORTING
  "      DATA   = MI_STRING
  "      OFFSET = 0
  "      LENGTH = MI_RLENGTH.

  """*********************************************"""""
  " * PERFORM SEND_HTTP_REQUEST.
  """*********************************************"""""
  " ** Send the HTTP Post request to the URL.
  mi_http_client->send( EXPORTING  timeout                    = 15   " 15 Seconds
                        EXCEPTIONS http_communication_failure = 1
                                   http_invalid_state         = 2 ).

  """*********************************************"""""
  " * PERFORM RECEIVE_RESPONSE.
  """*********************************************"""""
  " ***Read the Response from API
  mi_http_client->receive( EXCEPTIONS http_communication_failure = 1
                                      http_invalid_state         = 2
                                      http_processing_failed     = 3 ).

  """*********************************************"""""
  " * PERFORM DISPLAY_RESPONSE.
  """*********************************************"""""
  " Get the HTTP return code from the HTTP POST:
  mi_http_client->response->get_status( IMPORTING code = mi_http_return_code ).
  mi_http_client->response->get_status( IMPORTING reason = mi_http_error_descr ).
  mi_http_error_descr_long = mi_http_client->response->get_raw_message( ).

  mi_http_client->refresh_request( EXCEPTIONS http_action_failed = 1
                                              OTHERS             = 2 ).

  " ****Write the data received back from the POST to the screen:
  CLEAR mi_xml_result_str.
  mi_xml_result_str = mi_http_client->response->get_cdata( ).
  sy-tmaxl = strlen( mi_xml_result_str ).
  UNASSIGN <mi_fs>.
  ASSIGN mi_xml_result_str TO <mi_fs>.
  "*WRITE:/ <MI_FS>(SY-TMAXL).

*  REFRESH: IT_EINVRESP[].
*  /UI2/CL_JSON=>DESERIALIZE( EXPORTING JSON         = <MI_FS>
*                                       PRETTY_NAME  = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE
*                             CHANGING  DATA         = IT_EINVRESP ).
*
*  CLEAR: WA_EINVRESP.
*  READ TABLE IT_EINVRESP INTO WA_EINVRESP INDEX 1.
*  ACCESS_TOKEN = WA_EINVRESP-ACCESS_TOKEN.

  CLEAR at1.
  CLEAR at2.
  SPLIT <mi_fs> AT ':' INTO at1 at2.
  SPLIT at2 AT ',' INTO at3 at4.
  REPLACE ALL OCCURRENCES OF '"' IN at3 WITH space.
  CLEAR access_token.
  access_token = at3.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form CALL_TAXILA_API_TO_GEN_IRN
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM call_taxila_api_to_gen_irn.
  """*********

  TYPES: BEGIN OF ty_success,
           success TYPE string,
           message TYPE string,
         END OF ty_success.

  TYPES: BEGIN OF ty_result,
           ackno         TYPE string,
           ackdt         TYPE string,
           irn           TYPE string,
           signedinvoice TYPE string,
           signedqrcode  TYPE string,
           status        TYPE string,
           ewbno         TYPE string,
           ewbdt         TYPE string,
           ewbvalidtill  TYPE string,
         END OF ty_result.

  DATA lv_rand                   TYPE i.
  DATA rand_num                  TYPE char10.
  " data Variables declaration for passing URL, Result String(Using get_cdata())
  DATA gp_url1                   TYPE string.
  " data Variables declaration for passing the xml input data into API as a string and lenth
  DATA grlength1                 TYPE i.
  DATA w_string1                 TYPE string.
  " *****data declaration for creating HTTP Client, Request, Error description, error code etc
  DATA glo_http_client1          TYPE REF TO if_http_client.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA gw_http_return_code1      TYPE i.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA gw_http_error_descr1      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA gw_http_error_descr_long1 TYPE xstring.
  DATA gw_xml_result_str1        TYPE string.
  DATA lv_main                   TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_string1                TYPE string.
  DATA lv_string2                TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_string3                TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_string4                TYPE string.
  DATA lv_success                TYPE string.
  DATA wa_success                TYPE ty_success.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv1                       TYPE c LENGTH 255.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv2                       TYPE c LENGTH 255.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv3                       TYPE c LENGTH 255.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv4                       TYPE c LENGTH 255.
  DATA lv5                       TYPE c LENGTH 255.
  DATA lv6                       TYPE c LENGTH 5000.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv7                       TYPE c LENGTH 5000.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv8                       TYPE string.
  DATA lv9                       TYPE string.
  DATA lv10                      TYPE string.
  DATA lv11                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv12                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv13                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv14                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv15                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv16                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv17                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv18                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv19                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv20                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv21                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv22                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv23                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv24                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv25                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv26                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv27                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv28                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv29                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv30                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv31                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv32                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv33                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv34                      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv35                      TYPE string.
  DATA wa_result                 TYPE ty_result.
  DATA lt_string_comp            TYPE TABLE OF swastrtab.
  DATA lv_longtext               TYPE string.
  DATA lw_string_comp            TYPE swastrtab.
  DATA op_irn                    TYPE zsd_einvoice-irn.

  FIELD-SYMBOLS <gfs1>.

  " TODO: variable is only used in commented-out code (ABAP cleaner)
  " TODO: variable is never used (ABAP cleaner)
  DATA: BEGIN OF it_girn,
          success TYPE string,
          message TYPE string,
          result  TYPE ty_result,
        END OF it_girn.

  """*******

  ""Create Json String

  " TODO: remove needless CLEAR (ABAP cleaner)
  CLEAR lv_rand.
  " TODO: remove needless CLEAR (ABAP cleaner)
  CLEAR rand_num.
  CALL FUNCTION 'QF05_RANDOM_INTEGER'
    EXPORTING
      ran_int_max   = 1000
      ran_int_min   = 1
    IMPORTING
      ran_int       = lv_rand
    EXCEPTIONS
      invalid_input = 1.

  rand_num = lv_rand.
  SHIFT rand_num LEFT DELETING LEADING space.

  CLEAR usr_name.
  CLEAR usr_pass.
  CLEAR usr_gstin.
  CLEAR usr_reqid.
  CLEAR usr_auth.
  CLEAR url_canc.
  CLEAR url_det.
  CLEAR url_gen.
  CLEAR url_tkn.
  usr_name  = gw_txila-usr_name.
  usr_pass  = gw_txila-usr_pass.
  "*USR_GSTIN   = '01AMBPG7773M002'.
  usr_reqid = 'MAWAI' && rand_num. "*'any_alpha_numeric_value'.
  CONCATENATE 'Bearer' access_token INTO usr_auth SEPARATED BY space.
  "*USR_AUTH    = ACCESS_TOKEN.
  url_gen = gw_txila-url_gen.
  gp_url1 = url_gen.
  CONDENSE usr_reqid.

  CLEAR grlength1.
  w_string1 = mij_gw_string.
  grlength1 = strlen( w_string1 ).

  " ****Creation of HTTP Client
  cl_http_client=>create_by_url( EXPORTING  url                = gp_url1
                                 IMPORTING  client             = glo_http_client1
                                 EXCEPTIONS argument_not_found = 1
                                            plugin_not_active  = 2
                                            internal_error     = 3
                                            OTHERS             = 4 ).

  " **** Set up the HTTP data passing method
  glo_http_client1->request->set_method( method = 'POST' ).

  " ** Set up the HTTP Post version
  glo_http_client1->request->set_version(
*                                          version = '1001'.
    version = if_http_request=>co_protocol_version_1_1 ). " 1001

  " ***set the content type of request data
  glo_http_client1->request->if_http_entity~set_content_type( content_type = 'application/json; charset=utf-8' ).

  " ***Set up the HTTP header
  glo_http_client1->request->set_header_field( name  = 'Host'
                                               value = gp_url1 ).

  glo_http_client1->request->set_header_field( name  = 'user_name'
                                               value = usr_name ).

  glo_http_client1->request->set_header_field( name  = 'password'
                                               value = usr_pass ).

  glo_http_client1->request->set_header_field( name  = 'gstin'
                                               value = usr_ngstin ). "*USER_GSTIN

  glo_http_client1->request->set_header_field( name  = 'requestid'
                                               value = usr_reqid ).

  glo_http_client1->request->set_header_field( name  = 'Authorization'
                                               value = usr_auth ).

  " * Set up the HTTP data i.e pass/set the data into API
  glo_http_client1->request->set_cdata( data   = w_string1
                                        offset = 0
                                        length = grlength1 ).

  " ** Send the HTTP Post request to the URL.
  glo_http_client1->send( EXPORTING  timeout                    = 15   " 15 Seconds
                          EXCEPTIONS http_communication_failure = 1
                                     http_invalid_state         = 2 ).

  " ***Read the Response from API
  glo_http_client1->receive( EXCEPTIONS http_communication_failure = 1
                                        http_invalid_state         = 2
                                        http_processing_failed     = 3 ).

  " Get the HTTP return code from the HTTP POST:
  glo_http_client1->response->get_status( IMPORTING code = gw_http_return_code1 ).
  glo_http_client1->response->get_status( IMPORTING reason = gw_http_error_descr1 ).
  gw_http_error_descr_long1 = glo_http_client1->response->get_raw_message( ).

  glo_http_client1->refresh_request( EXCEPTIONS http_action_failed = 1
                                                OTHERS             = 2 ).

  " ****Write the data received back from the POST to the screen:
  CLEAR gw_xml_result_str1.
  gw_xml_result_str1 = glo_http_client1->response->get_cdata( ).
  glo_http_client1->close( ).
  sy-tmaxl = strlen( gw_xml_result_str1 ).

  ASSIGN gw_xml_result_str1 TO <gfs1>.
  CLEAR gv_api_ret_msg.
  gv_api_ret_msg = <gfs1>.
  " WRITE:/ <GFS1>(SY-TMAXL).

  " CLEAR: IT_GIRN.
  " /UI2/CL_JSON=>DESERIALIZE( EXPORTING JSON         = <GFS1>
  "                                      PRETTY_NAME  = /UI2/CL_JSON=>PRETTY_MODE-CAMEL_CASE
  "                            CHANGING  DATA         = IT_GIRN ).
  "
  " MOVE-CORRESPONDING IT_GIRN TO WA_SUCCESS.
  " MOVE-CORRESPONDING IT_GIRN-RESULT TO WA_RESULT.

  " {
  " success":true,
  " message":"IRN generated successfully",
  " result":
  " {
  " AckNo":15102573688,
  " AckDt":"2020-05-25 09:51:00",
  " Irn":"fd9204d9218216155dfd784696f961d59e54be88e17d3725c7dbaede7bf08745",
  " SignedInvoice":"eyJhbGciOiJSUzI1NiIsImtpZCI6IjExNUY0NDI2NjE3QTc5MzhCRTF",
  " SignedQRCode":"eyJhbGciOiJSUzI1NiIsImtpZCI6IjExNUY0NDI2NjE3QTc5MzhCRTFCQT",
  " Status":"ACT","EwbNo":null,"EwbDt":null,"EwbValidTill":null
  " }
  " }

  " **""-----------------------------ECC---------------------------------------------""
  " **""Segregate Success/Error Message

  IF <gfs1> IS ASSIGNED.
    lv_main = <gfs1>.
  ENDIF.

  CLEAR lv_string1.
  CLEAR lv_string2.
  CLEAR lv_string3.
  CLEAR lv_string4.
  SPLIT lv_main AT '"success":' INTO lv_string1 lv_string2.

  IF lv_string2 IS NOT INITIAL.
    lv_success = lv_string2+0(4).
    IF lv_success = 'true'.

      wa_success-success = 'true'.
      wa_success-message = 'IRN generated successfully'.

      ASSIGN gw_xml_result_str1 TO <gfs1>.
      CLEAR lv1.
      CLEAR lv2.
      CLEAR lv3.
      CLEAR lv4.
      CLEAR lv5.
      CLEAR lv6.
      CLEAR lv7.
      CLEAR lv8.
      CLEAR lv9.
      CLEAR lv10.
      CLEAR lv11.
      CLEAR lv12.
      CLEAR lv13.
      CLEAR lv14.
      CLEAR lv15.
      CLEAR lv16.
      CLEAR lv17.
      CLEAR lv18.
      CLEAR lv19.
      CLEAR lv20.
      CLEAR lv21.
      CLEAR lv22.
      CLEAR lv23.
      CLEAR lv24.
      CLEAR lv25.
      CLEAR lv26.
      CLEAR lv27.
      CLEAR lv28.
      CLEAR lv29.
      CLEAR lv30.
      CLEAR lv31.
      CLEAR lv32.
      CLEAR lv33.
      CLEAR lv34.
      CLEAR lv35.
      CLEAR signedqrcode.
      CLEAR irn_value.
      CLEAR signedinvoice.

      SPLIT <gfs1> AT ':' INTO lv1 lv2 lv3 lv4 lv5 lv6 lv7 lv8 lv9 lv10 lv11 lv12 lv13 lv14.
      SPLIT lv9    AT ',' INTO irn_value     lv18.
      SPLIT lv11   AT ',' INTO signedqrcode  lv16.
      SPLIT lv10   AT ',' INTO signedinvoice lv20.
      REPLACE ALL OCCURRENCES OF '"' IN signedqrcode  WITH space.
      REPLACE ALL OCCURRENCES OF '"' IN irn_value     WITH space.
      REPLACE ALL OCCURRENCES OF '"' IN signedinvoice WITH space.
      CONDENSE signedqrcode.
      CONDENSE irn_value.
      CONDENSE signedinvoice.

      wa_result-irn           = irn_value.
      wa_result-signedinvoice = signedinvoice.
      wa_result-signedqrcode  = signedqrcode.

**"SOC for AckNo & AckDate by Gaurav(07.01.2021)
      CLEAR gv_lv1.
      CLEAR gv_lv2.
      CLEAR gv_lv3.
      CLEAR gv_lv4.
      CLEAR ackno.
      CLEAR ackdate.
      SPLIT lv5 AT ',' INTO gv_lv1 gv_lv2.
      SPLIT lv6 AT ''  INTO gv_lv3 gv_lv4.
      REPLACE ALL OCCURRENCES OF '"' IN gv_lv1 WITH space.
      REPLACE ALL OCCURRENCES OF '"' IN gv_lv3 WITH space.
      CONDENSE gv_lv1.
      CONDENSE gv_lv3.
      ackno   = gv_lv1.
      ackdate = gv_lv3.
      CONDENSE ackno.
      CONDENSE ackdate.
**"EOC for AckNo & AckDate by Gaurav(07.01.2021)

    ENDIF.
  ENDIF.
  """"********

  CLEAR gs_irn.
  gs_irn        = wa_result-irn.
  signedinvoice = wa_result-signedinvoice.
  signedqrcode  = wa_result-signedqrcode.

  IF wa_success-success = 'true'.

    IF wa_result-irn IS NOT INITIAL.
      "-------Saving the QR Code Returned by Govt. Portal Into invoice respective Text-ID----------"
      IF gs_irn IS NOT INITIAL.

        CLEAR gw_head.
        gw_head-tdobject = 'VBBK'.
        gw_head-tdname   = wa_data-vbeln.
        gw_head-tdid     = 'ZIRN'.
        gw_head-tdspras  = sy-langu.

        REFRESH gt_lines[].
        gw_lines-tdformat = '*'.
        gw_lines-tdline   = gs_irn.
        APPEND gw_lines TO gt_lines.
        CLEAR gw_lines.

        CALL FUNCTION 'SAVE_TEXT'
          EXPORTING
            client          = sy-mandt
            header          = gw_head
            savemode_direct = 'X'
          TABLES
            lines           = gt_lines.

      ENDIF.

      IF signedqrcode IS NOT INITIAL.

        CLEAR gw_head.
        gw_head-tdobject = 'VBBK'.
        gw_head-tdname   = wa_data-vbeln.
        gw_head-tdid     = 'ZQRC'.
        gw_head-tdspras  = sy-langu.

        REFRESH lt_string_comp[].
        CLEAR lv_longtext.
        lv_longtext = signedqrcode.
        CALL FUNCTION 'SWA_STRING_SPLIT'
          EXPORTING
            input_string         = lv_longtext     " string to be split
            max_component_length = 130
          TABLES
            string_components    = lt_string_comp.

        REFRESH gt_lines[].
        LOOP AT lt_string_comp INTO lw_string_comp.

          gw_lines-tdformat = '*'.
          gw_lines-tdline   = lw_string_comp-str. " LS_RETURN-SIGNEDQRCODE.
          APPEND gw_lines TO gt_lines.

          CLEAR gw_lines.
          CLEAR lw_string_comp.
        ENDLOOP.

        CALL FUNCTION 'SAVE_TEXT'
          EXPORTING
            client          = sy-mandt
            header          = gw_head
            savemode_direct = 'X'
          TABLES
            lines           = gt_lines.

      ENDIF.

      """"************************************************************************
      CLEAR canc_irn.
      CLEAR op_irn.
      CONDENSE gs_irn.
      SELECT SINGLE irn FROM zsd_einvoice INTO op_irn WHERE irn = gs_irn.
      IF op_irn IS NOT INITIAL.
        CLEAR gs_irn.
      ENDIF.
      FINAL(ls_len) = strlen( gs_irn ).
      IF ls_len >= 40.
        IF gs_irn IS NOT INITIAL.
          ""**Start: Save Data in ztable: ZSD_EINVOICE
          PERFORM save_data_into_ztable.
          ""**End: Save Data in ztable: ZSD_EINVOICE
        ELSE.
          ""**Modify display internal table: in case of error
          PERFORM update_ztable_for_error.
          ""**End: Modify display internal table: : in case of error
        ENDIF.

      ELSE.

        CLEAR text.
        text = 'Please send this file to SAP/IT Team & Try Again...' && gv_api_ret_msg.
        CALL SCREEN '9002'.

      ENDIF.
      """"************************************************************************

    ELSE.
      CLEAR text.
      text = gv_api_ret_msg.
      CALL SCREEN '9002'.
    ENDIF.

  ELSE.
    CLEAR text.
    text = gv_api_ret_msg.
    CALL SCREEN '9002'.
  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form GENERATE_QRB2C_FORM_MI
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM generate_qrb2c_form_mi.
  DATA payee_acc_num            TYPE string.
  DATA payee_ifsc               TYPE string.
  DATA suplr_upi_id             TYPE string.
  DATA item_name                TYPE string.
  DATA return_type              TYPE string.
  " data Variables declaration for passing URL, Result String(Using get_cdata())
  DATA cp_url                   TYPE string.
  " *****data declaration for creating HTTP Client, Request, Error description, error code etc
  DATA clo_http_client          TYPE REF TO if_http_client.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA cw_http_return_code      TYPE i.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA cw_http_error_descr      TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA cw_http_error_descr_long TYPE xstring.
  DATA cw_xml_result_str        TYPE string.
  """"""""""***************************************
  DATA lv_main                  TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_string1               TYPE string.
  DATA lv_string2               TYPE string.
  DATA lv_string3               TYPE string.
  " TODO: variable is assigned but never used (ABAP cleaner)
  DATA lv_string4               TYPE string.
  DATA lv_success               TYPE string.
  DATA lt_string_comp           TYPE TABLE OF swastrtab.
  DATA lv_longtext              TYPE string.
  DATA lw_string_comp           TYPE swastrtab.

  FIELD-SYMBOLS <cfs>.

  " DATA result_tab        TYPE TABLE OF string.

  " data Variables declaration for passing the xml input data into API as a string and lenth

  DATA(ct_final) = gt_final[].
  DELETE ct_final WHERE check <> 'X'.

  PERFORM clear_variables.
  CLEAR payee_acc_num.
  CLEAR payee_ifsc.
  CLEAR suplr_upi_id.
  CLEAR item_name.
  CLEAR return_type.

  LOOP AT ct_final INTO wa_data WHERE check = 'X'.
    CLEAR qr_b2c.
    CLEAR gs_qrb2c.

    IF wa_data-val_assval IS INITIAL.
      wa_data-val_assval = '0'.
    ENDIF.

    IF wa_data-val_cgstval IS INITIAL.
      wa_data-val_cgstval = '0'.
    ENDIF.

    IF wa_data-val_sgstval IS INITIAL.
      wa_data-val_sgstval = '0'.
    ENDIF.

    IF wa_data-val_igstval IS INITIAL.
      wa_data-val_igstval = '0'.
    ENDIF.

    IF wa_data-val_cesval IS INITIAL.
      wa_data-val_cesval = '0'.
    ENDIF.

    IF wa_data-branch_or_ifsc IS INITIAL.
      wa_data-branch_or_ifsc = '0'.
    ENDIF.

    IF wa_data-val_totinvval IS INITIAL.
      wa_data-val_totinvval = '0'.
    ENDIF.

    IF wa_data-val_stcesval IS INITIAL.
      wa_data-val_stcesval = '0'.
    ENDIF.

    lv_docdtls_dt = wa_data-doc_dt+0(4) && '-' && wa_data-doc_dt+4(2) && '-' && wa_data-doc_dt+6(2).

    mij_buyer_gstin = wa_data-billfrom_gstin. " gstin":
    CONDENSE mij_buyer_gstin.
    SELECT SINGLE * FROM zsd_b2c_qr_data INTO @DATA(gs_qrb2c) WHERE suplr_gstin = @mij_buyer_gstin.
    suplr_upi_id                  = gs_qrb2c-suplr_upi.    "'mastersindia@okaxis'.
    mij_buyer_trade_name          = wa_data-billto_trdnm.  " trade_name":
    payee_acc_num                 = wa_data-payee_acc.     "'0123456789'.
    payee_ifsc                    = wa_data-payee_ifsc.    "'SBIN0011202'.
    mij_document_number           = wa_data-doc_no.        " document_number":
    mij_document_date             = lv_docdtls_dt.         " document_date":
    mij_value_total_invoice_value = wa_data-val_totinvval. " total_invoice_value":
    mij_value_total_cgst_value    = wa_data-val_cgstval.   " total_cgst_value":
    mij_value_total_sgst_value    = wa_data-val_sgstval.   " total_sgst_value":
    mij_value_total_igst_value    = wa_data-val_igstval.   " total_igst_value":
    mij_value_total_cess_value    = wa_data-val_cesval.    " total_cess_value":
    item_name                     = wa_data-item_prddesc.  "'Dell Laptop'.
    return_type                   = 'url'.
    mij_access_token              = access_token && '",'. " access_token":

    CONDENSE mij_buyer_gstin.
    CONDENSE suplr_upi_id.
    CONDENSE mij_buyer_trade_name.
    CONDENSE payee_acc_num.
    CONDENSE payee_ifsc.
    CONDENSE mij_document_number.
    CONDENSE mij_document_date.
    CONDENSE mij_value_total_invoice_value.
    CONDENSE mij_value_total_cgst_value.
    CONDENSE mij_value_total_sgst_value.
    CONDENSE mij_value_total_igst_value.
    CONDENSE mij_value_total_cess_value.
    CONDENSE item_name.
    CONDENSE return_type.
    CONDENSE mij_access_token.

    cp_url = gw_credential-url_qrb2c "*'https://clientbasic.mastersindia.co/PaymentApi/create_payment?'
    && 'supplier_gstin='       && mij_buyer_gstin               && '&'
    && 'supplier_upi_id='      && suplr_upi_id                  && '&' "*:mastersindia@okaxis,
    && 'supplier_name='        && mij_buyer_trade_name          && '&' "*:Masters India,
    && 'payee_account_number=' && payee_acc_num                 && '&' "*:0123456789,
    && 'payee_ifsc='           && payee_ifsc                    && '&' "*:SBIN0011202,
    && 'invoice_number='       && mij_document_number           && '&' "*:INV0001,
    && 'invoice_date='         && mij_document_date             && '&' "*:2021-03-06,
    && 'invoice_total_value='  && mij_value_total_invoice_value && '&' "*:100.8,
    && 'invoice_cgst='         && mij_value_total_cgst_value    && '&' "*:0,
    && 'invoice_sgst='         && mij_value_total_sgst_value    && '&' "*:0,
    && 'invoice_igst='         && mij_value_total_igst_value    && '&' "*:200,
    && 'invoice_cess='         && mij_value_total_cess_value    && '&' "*:100,
    && 'item_name='            && item_name                     && '&' "*:Dell Laptop,
    && 'return_type='          && return_type                   && '&' "*:(opitonal field can be filled as url , or left blank if you want url in the response)
    && 'access_token='         && access_token. "*:c4f4ab03747f092f611fac01c2645f0b9faf5e4f

    CONDENSE cp_url.

    " ****Creation of HTTP Client
    cl_http_client=>create_by_url( EXPORTING  url                = cp_url
                                   IMPORTING  client             = clo_http_client
                                   EXCEPTIONS argument_not_found = 1
                                              plugin_not_active  = 2
                                              internal_error     = 3
                                              OTHERS             = 4 ).

    " ** Send the HTTP Post request to the URL.
    clo_http_client->send( EXPORTING  timeout                    = 15   " 15 Seconds
                           EXCEPTIONS http_communication_failure = 1
                                      http_invalid_state         = 2 ).

    " ***Read the Response from API
    clo_http_client->receive( EXCEPTIONS http_communication_failure = 1
                                         http_invalid_state         = 2
                                         http_processing_failed     = 3 ).

    " * CLEAR CW_XML_RESULT_STR .
    " * CW_XML_RESULT_STR = CLO_HTTP_CLIENT->RESPONSE->GET_CDATA( ).
    " * SPLIT CW_XML_RESULT_STR AT CL_ABAP_CHAR_UTILITIES=>CR_LF INTO TABLE RESULT_TAB .

    " Get the HTTP return code from the HTTP POST:
    clo_http_client->response->get_status( IMPORTING code = cw_http_return_code ).
    clo_http_client->response->get_status( IMPORTING reason = cw_http_error_descr ).
    cw_http_error_descr_long = clo_http_client->response->get_raw_message( ).

    clo_http_client->refresh_request( EXCEPTIONS http_action_failed = 1
                                                 OTHERS             = 2 ).

    " ****Write the data received back from the POST to the screen:
    CLEAR cw_xml_result_str.
    cw_xml_result_str = clo_http_client->response->get_cdata( ).
    sy-tmaxl = strlen( cw_xml_result_str ).
    ASSIGN cw_xml_result_str TO <cfs>.

    IF <cfs> IS ASSIGNED.
      lv_main = <cfs>.
      gv_api_ret_msg = <cfs>.
    ENDIF.

    CLEAR lv_string1.
    CLEAR lv_string2.
    CLEAR lv_string3.
    CLEAR lv_string4.
    CLEAR canc_irn.
    lv_string2 = lv_main+0(11).
    IF lv_string2 IS NOT INITIAL.
      lv_success = lv_string2+10(1).
      IF lv_success = '1'.

        CLEAR lv_string1.
        CLEAR lv_string2.
        CLEAR lv_string3.
        CLEAR lv_string4.
        SPLIT lv_main AT '"message":"' INTO lv_string1 lv_string2.
        SPLIT lv_string2 AT '"}' INTO lv_string3 lv_string4.
        REPLACE ALL OCCURRENCES OF '"' IN lv_string3 WITH space.
        REPLACE ALL OCCURRENCES OF '\' IN lv_string3 WITH space.
        CONDENSE lv_string3.

        gs_qrb2c = lv_string3.

        qr_b2c = 'X'.

      ELSE.
        CLEAR text.
        text = gv_api_ret_msg.
        CALL SCREEN '9002'.
      ENDIF.

    ELSE.
      CLEAR text.
      text = gv_api_ret_msg.
      CALL SCREEN '9002'.
    ENDIF.

    IF gs_qrb2c IS NOT INITIAL.

      """"****Saving Payment QR code-text in text ID
      CLEAR gw_head.
      gw_head-tdobject = 'VBBK'.
      gw_head-tdname   = wa_data-vbeln.
      gw_head-tdid     = 'ZIRN'.
      gw_head-tdspras  = sy-langu.

      REFRESH gt_lines[].
      gw_lines-tdformat = '*'.
      gw_lines-tdline   = 'B2C-CUSTOMER'.
      APPEND gw_lines TO gt_lines.
      CLEAR gw_lines.

      CALL FUNCTION 'SAVE_TEXT'
        EXPORTING
          client          = sy-mandt
          header          = gw_head
          savemode_direct = 'X'
        TABLES
          lines           = gt_lines.
      """"****End: Saving Payment QR code-text in text ID

      """"****Saving Payment QR code in text ID
      CLEAR gw_head.
      gw_head-tdobject = 'VBBK'.
      gw_head-tdname   = wa_data-vbeln.
      gw_head-tdid     = 'ZQRC'.
      gw_head-tdspras  = sy-langu.

      REFRESH lt_string_comp[].
      CLEAR lv_longtext.

      lv_longtext = gs_qrb2c.

      CALL FUNCTION 'SWA_STRING_SPLIT'
        EXPORTING
          input_string         = lv_longtext     " string to be split
          max_component_length = 130
        TABLES
          string_components    = lt_string_comp.

      REFRESH gt_lines[].
      LOOP AT lt_string_comp INTO lw_string_comp.

        gw_lines-tdformat = '*'.
        gw_lines-tdline   = lw_string_comp-str. " LS_RETURN-SIGNEDQRCODE.
        APPEND gw_lines TO gt_lines.

        CLEAR gw_lines.
        CLEAR lw_string_comp.
      ENDLOOP.

      CALL FUNCTION 'SAVE_TEXT'
        EXPORTING
          client          = sy-mandt
          header          = gw_head
          savemode_direct = 'X'
        TABLES
          lines           = gt_lines.

      """"****End: Saving Payment QR code in text ID

    ENDIF.

    IF qr_b2c IS NOT INITIAL.
      ""**Start: Save Data in ztable: ZSD_EINVOICE
      PERFORM save_data_into_ztable_qrb2c.
      ""**End: Save Data in ztable: ZSD_EINVOICE
    ELSE.
      ""**Modify display internal table: in case of error
      PERFORM update_ztable_for_error.
      ""**End: Modify display internal table: : in case of error
    ENDIF.

    CLEAR wa_data.
  ENDLOOP.

  REFRESH ct_final[].

ENDFORM.

*&---------------------------------------------------------------------*
*& Form SAVE_DATA_INTO_ZTABLE_QRB2C
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM save_data_into_ztable_qrb2c.
  osd_grid->check_changed_data( ).

  REFRESH st_final[].
  LOOP AT gt_final INTO gw_final WHERE vbeln = wa_data-vbeln. " CHECK = 'X'.

    REFRESH color_tab[].
    REFRESH lt_edit[].
    gs_index = sy-tabix.
    MOVE-CORRESPONDING gw_final TO sw_final.

    CLEAR gw_final-colortab.
    gw_final-stat_ind      = '@5B@'. "*OK
    sw_final-irn           = 'B2C-CUSTOMER'.
    sw_final-signed_inv    = ' '.
    sw_final-signed_qrcode = gs_qrb2c.
    sw_final-irn_gen_by    = sy-uname.
    sw_final-irn_gen_date  = sy-datum.
    sw_final-irn_gen_time  = sy-uzeit.
    IF irnwbtl = 'X'.
      sw_final-server_dtl = 'WEBTEL'.
    ELSEIF irnftxla = 'X'.
      sw_final-server_dtl = 'TXLA'.
    ELSE.
      sw_final-server_dtl = 'MI'.
    ENDIF.

    " Soc for Ackno & Ackdate by Gaurav(07.01.2021)
    sw_final-einv_ack_no   = ' '.
    sw_final-einv_ack_date = ' '.
    " Eoc for Ackno & Ackdate by Gaurav(07.01.2021)

    """"****For Cell Color
    CLEAR wa_color.
    wa_color-fname = 'IRN'.
    wa_color-color-col = 5. " red color   5: "green color   3: "yellow    7:  "violet
    APPEND wa_color TO color_tab.
    INSERT LINES OF color_tab INTO TABLE gw_final-colortab.
    """"****End: For Cell Color

    """****For Disable Row
    ls_edit-style = cl_gui_alv_grid=>mc_style_disabled.
    INSERT ls_edit INTO TABLE lt_edit.
    INSERT LINES OF lt_edit INTO TABLE gw_final-style.
    """****End: For Disable Row

    APPEND sw_final TO st_final.

    ""**Start: Udate Final table for display
    gw_final-irn   = 'B2C customer register successfully'.
    gw_final-check = ' '.
    MODIFY gt_final FROM gw_final INDEX gs_index TRANSPORTING irn
                                                              cancd_irn
                                                              stat_ind
                                                              check
                                                              colortab
                                                              style
                                                              irn_gen_by
                                                              irn_gen_date
                                                              irn_gen_time
                                                              cancd_by
                                                              cancd_date
                                                              cancd_time.
    ""**End: Udate Final table for display

    CLEAR gw_final.
    CLEAR sw_final.
  ENDLOOP.

  IF st_final[] IS NOT INITIAL.
    MODIFY zsd_einvoice FROM TABLE st_final[].
  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form CREATE_FIELDCAT_QRB2C
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM create_fieldcat_qrb2c.
  DATA count TYPE i.

  REFRESH sd_fieldcat[].

  """"""********************Start:Main Header****************************************************
  count += 1.
  PERFORM fcat
    USING count
          'CHECK'
          'SELECT'
          '6'
          abap_false.
  count += 1.
  PERFORM fcat
    USING count
          'STAT_IND'
          'STATUS'
          '6'
          abap_false.
  count += 1.
  PERFORM fcat
    USING count
          'DOC_TYP_DESC'
          'Doc Description'
          '15'
          abap_false.
  count += 1.
  PERFORM fcat
    USING count
          'VBELN'
          'Billing Doc'
          '12'
          abap_false.
  count += 1.
  PERFORM fcat
    USING count
          'GSTIN'
          'GSTIN'
          '18'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'IRN'
          'IRN'
          '10'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'BUKRS'
          'Company Code'
          '10'
          abap_true.
  """"""********************End:Main Header****************************************************
  count += 1.
  PERFORM fcat
    USING count
          'PAYEE_ACC'
          'Payee A/C No'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'PAYEE_IFSC'
          'Payee IFSC'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'TRAN_CATG'
          'Supply_type'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'DOC_TYP'
          'Document_type'
          '15'
          abap_true. " document_type
  count += 1.
  PERFORM fcat
    USING count
          'DOC_NO'
          'Document_number'
          '15'
          abap_true. " document_number
  count += 1.
  PERFORM fcat
    USING count
          'DOC_DT'
          'Document_date'
          '15'
          abap_true. " document_date
  count += 1.
  PERFORM fcat
    USING count
          'VAL_TOTINVVAL'
          'total_invoice_value'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'VAL_CGSTVAL'
          'total_cgst_value'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'VAL_SGSTVAL'
          'total_sgst_value'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'VAL_IGSTVAL'
          'total_igst_value'
          '15'
          abap_true.
  count += 1.
  PERFORM fcat
    USING count
          'VAL_CESVAL'
          'total_cess_value'
          '15'
          abap_true.

ENDFORM.



INCLUDE zmi_envoice_process_user_coi01.

INCLUDE zmi_envoice_process_exiti01.

*&---------------------------------------------------------------------*
*& Module STATUS_9002 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE status_9002 OUTPUT.
* SET PF-STATUS 'xxxxxxxx'.
* SET TITLEBAR 'xxx'.

  SET PF-STATUS 'STATUS'.
* SET TITLEBAR 'xxx'.

  CASE sy-ucomm.
    WHEN 'BACK'.
      LEAVE TO SCREEN '0'.
    WHEN OTHERS.
  ENDCASE.


  IF text_editor IS INITIAL.
    CREATE OBJECT editor_container
      EXPORTING
        container_name              = 'API_CONT'
      EXCEPTIONS
        cntl_error                  = 1
        cntl_system_error           = 2
        create_error                = 3
        lifetime_error              = 4
        lifetime_dynpro_dynpro_link = 5.

    text_editor = NEW #( parent                     = editor_container
*                         WORDWRAP_MODE              = CL_GUI_TEXTEDIT=>WORDWRAP_AT_FIXED_POSITION
                         wordwrap_position          = line_length
                         wordwrap_to_linebreak_mode = cl_gui_textedit=>true ).

    text_editor->set_toolbar_mode( toolbar_mode = cl_gui_textedit=>false ).

    text_editor->set_statusbar_mode( statusbar_mode = cl_gui_textedit=>false ).

    text_editor->set_textstream( EXPORTING  text                   = text
                                 EXCEPTIONS error_cntl_call_method = 1
                                            not_supported_by_gui   = 2
                                            OTHERS                 = 3 ).

    IF sy-subrc <> 0.
      " Implement suitable error handling here
    ENDIF.
  ENDIF.
ENDMODULE.

*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_9002  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE user_command_9002 INPUT.
  text_editor->get_textstream( EXPORTING  only_when_modified     = cl_gui_textedit=>true
                               IMPORTING  text                   = text
*                                          IS_MODIFIED            =
                               EXCEPTIONS error_cntl_call_method = 1
                                          not_supported_by_gui   = 2
                                          OTHERS                 = 3 ).

  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
               WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

  cl_gui_cfw=>flush( EXCEPTIONS cntl_system_error = 1
                                cntl_error        = 2
                                OTHERS            = 3 ).

ENDMODULE.


*&---------------------------------------------------------------------*
*& Form generate_irn_from_webtel
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM generate_irn_from_webtel .

  ""Create Json String
  DATA: gw_string1(15000) TYPE c,
        lv_index          TYPE sy-tabix,
        lv_idx(100)       TYPE c,
        lv_line           TYPE i,
        rlength1          TYPE i,
        w_string1         TYPE string.

  CLEAR: charge_type.
  PERFORM: clear_variables.

  DATA(ct_final) = gt_final[].
  DELETE ct_final WHERE check NE 'X'.

  DATA: lv_docdtls_dt(10) TYPE c.
  LOOP AT ct_final INTO wa_data WHERE check = 'X'.

    WAIT UP TO 2 SECONDS.
    PERFORM validate_alreday_done_action.

    CLEAR: usr_ngstin.
**    WA_DATA-BILLFROM_GSTIN = '01AMBPG7773M002'.
    user_gstin  = wa_data-billfrom_gstin.
    usr_gstin   = wa_data-billfrom_gstin.
    usr_ngstin  = wa_data-billfrom_gstin.
    CONDENSE: user_gstin, usr_gstin, usr_ngstin.
*    PERFORM get_taxila_credential.
*    PERFORM get_token_from_taxila.

    REFRESH: li_final[].
    li_final[] = ot_final[].
    DELETE li_final WHERE vbeln NE wa_data-vbeln.
    DESCRIBE TABLE li_final LINES lv_line.

    DATA: lv_space TYPE c.
    mij_access_token  = '"' && access_token && '",'.  "access_token":
    mij_user_gstin    = '"' && user_gstin && '",'.    "user_gstin":
    mij_data_source   = '"' && data_source && '",'.   "DATA_SOURCE":

    ""Transaction Details Started
    mij_category_of_transaction   = '"' && wa_data-tran_catg && '",'.        "category_of_transaction":
    mij_charge_type               = '"' && wa_data-tran_typ && '",'.         "charge_type":
    mij_transaction_type          = '"' && wa_data-tran_typ && '",'.         "transaction_type":
    mij_ecommerce_transaction     = '"' && wa_data-tran_ecmtrn && '",'.      "ecommerce_transaction":
    mij_ecommerce_gstin           = '"' && wa_data-tran_ecmgstin && '",'.     "ecommerce_gstin":
    IF wa_data-tran_ecmgstin IS INITIAL.
      mij_ecommerce_gstin          = 'null,'.
    ENDIF.
    ""Transaction Details Closed

    ""For Special Character Issue---------------------""
    "SOC by Gaurav(01.10.2020)
    REPLACE ALL OCCURRENCES OF '\' IN wa_data-billfrom_trdnm WITH '/'.
    REPLACE ALL OCCURRENCES OF '"'  IN wa_data-billfrom_trdnm WITH ''.

    REPLACE ALL OCCURRENCES OF '\' IN wa_data-billto_trdnm   WITH '/'.
    REPLACE ALL OCCURRENCES OF '"' IN wa_data-billto_trdnm   WITH ''.

    REPLACE ALL OCCURRENCES OF '\' IN wa_data-shipfrom_trdnm WITH '/'.
    REPLACE ALL OCCURRENCES OF '"' IN wa_data-shipfrom_trdnm WITH ''.

    REPLACE ALL OCCURRENCES OF '\' IN wa_data-shipto_trdnm   WITH '/'.
    REPLACE ALL OCCURRENCES OF '"' IN wa_data-shipto_trdnm   WITH ''.
    "EOC by Gaurav
    ""------------------------------------------------""

    ""Document Details Started
    DATA(ls_doc) = wa_data-doc_no.
    SHIFT ls_doc LEFT DELETING LEADING '0'.
    lv_docdtls_dt = wa_data-doc_dt+6(2) && '/' && wa_data-doc_dt+4(2) && '/' && wa_data-doc_dt+0(4).
    mij_document_type             = '"' && wa_data-doc_typ      && '",'.  "document_type":
    "*MIJ_DOCUMENT_NUMBER           = '"' && WA_DATA-DOC_NO       && '",'.  "document_number":
    mij_document_number           = '"' && ls_doc       && '",'.  "document_number":
    mij_document_date             = '"' && lv_docdtls_dt        && '"'.   "document_date":            "&& '",'.  "document_date":
    mij_original_document_number  = '"' && wa_data-doc_orginvno && '",'.  "original_document_number":
    ""Document Details Closed

*    ""Seller Details Started
    mij_seller_gstin       = '"' && wa_data-billfrom_gstin && '",'. "gstin":
    mij_seller_trade_name  = '"' && wa_data-billfrom_trdnm && '",'. "trade_name":
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-billfrom_bno WITH lv_space.
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-billfrom_bnm WITH lv_space.
    mij_seller_building_number  = '"' && wa_data-billfrom_bno   && '",'. "building_number"
    mij_seller_building_name    = '"' && wa_data-billfrom_bnm   && '",'. "building_name":
    mij_seller_floor_number     = '"' && wa_data-billfrom_flno  && '",'. "floor_number":
    mij_seller_location         = '"' && wa_data-billfrom_loc   && '",'. "location":
    mij_seller_district         = '"' && wa_data-billfrom_dst   && '",'. "district":
    "*MIJ_SELLER_PINCODE        = '"' && WA_DATA-BILLFROM_PIN   && '",'. "pincode":
    mij_seller_pincode          = wa_data-billfrom_pin   && ','. "pincode":
    mij_seller_state_code       = '"' && wa_data-billfrom_stcd  && '",'. "state_code":
    mij_seller_phone_number     = '"' && wa_data-billfrom_ph    && '",'. "phone_number":
    IF wa_data-billfrom_ph IS INITIAL.
      mij_seller_phone_number    = 'null,'.
    ENDIF.
    mij_seller_email            = '"' && wa_data-billfrom_em    && '"'.  "email":
    IF wa_data-billfrom_em IS INITIAL.
      mij_seller_email           = 'null'.
    ENDIF.
*    ""Seller Details Closed

*    ""Buyer Details Started
    mij_buyer_gstin      = '"' && wa_data-billto_gstin && '",'.  "gstin":
    mij_buyer_trade_name = '"' && wa_data-billto_trdnm && '",'.  "trade_name":
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-billto_bno WITH lv_space.
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-billto_bnm WITH lv_space.
    mij_buyer_building_number = '"' && wa_data-billto_bno   && '",'.  "building_number":
    mij_buyer_building_name   = '"' && wa_data-billto_bnm   && '",'.  "building_name":
    mij_buyer_floor_number    = '"' && wa_data-billto_flno  && '",'.  "floor_number":
    mij_buyer_location        = '"' && wa_data-billto_loc   && '",'.  "location":
    mij_buyer_district        = '"' && wa_data-billto_dst   && '",'.  "district":
    "*MIJ_BUYER_PINCODE       = '"' && WA_DATA-BILLTO_PIN   && '",'.  "pincode":
    mij_buyer_pincode         = wa_data-billto_pin   && ','.  "pincode":
    mij_buyer_state_code      = '"' && wa_data-billto_stcd  && '",'.  "state_code":
    mij_buyer_phone_number    = '"' && wa_data-billto_ph    && '",'.  "phone_number":
    IF wa_data-billto_ph IS INITIAL.
      mij_buyer_phone_number   =  'null,'.
    ENDIF.
    mij_buyer_email           = '"' && wa_data-billto_em    && '"'.   "email":
    IF wa_data-billto_em IS INITIAL.
      mij_buyer_email           = 'null'.
    ENDIF.
*    ""Buyear Details Closed

*    ""Dispatch Details Started
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-shipfrom_bno WITH lv_space.
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-shipfrom_bnm WITH lv_space.
    mij_dispatch_gstin            = '"' && wa_data-shipfrom_gstin && '",'. "gstin":
    mij_dispatch_trade_name       = '"' && wa_data-shipfrom_trdnm && '",'. "trade_name":
    mij_dispatch_building_number  = '"' && wa_data-shipfrom_bno   && '",'. "building_number":
    mij_dispatch_building_name    = '"' && wa_data-shipfrom_bnm   && '",'. "building_name":
    mij_dispatch_floor_number     = '"' && wa_data-shipfrom_flno  && '",'. "floor_number":
    mij_dispatch_location         = '"' && wa_data-shipfrom_loc   && '",'. "location":
    mij_dispatch_district         = '"' && wa_data-shipfrom_dst   && '",'. "district":
    mij_dispatch_pincode          = '"' && wa_data-shipfrom_pin   && '",'. "pincode":
    mij_dispatch_state_code       = '"' && wa_data-shipfrom_stcd  && '"'. "state_code": "*&& '",'. "state_code":
    mij_dispatch_phone_number     = '"' && wa_data-shipfrom_ph    && '",'. "phone_number":
    mij_dispatch_email            = '"' && wa_data-shipfrom_em    && '"'.  "email":
*    ""Dispatch Details Closed
*
*    ""Ship Details Started
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-shipto_bno WITH lv_space.
    REPLACE ALL OCCURRENCES OF ',' IN wa_data-shipto_bnm WITH lv_space.
    mij_ship_gstin            = '"' && wa_data-shipto_gstin && '",'.
    mij_ship_trade_name       = '"' && wa_data-shipto_trdnm && '",'.
    mij_ship_building_number  = '"' && wa_data-shipto_bno   && '",'.
    mij_ship_building_name    = '"' && wa_data-shipto_bnm   && '",'.
    mij_ship_floor_number     = '"' && wa_data-shipto_flno  && '",'.
    mij_ship_location         = '"' && wa_data-shipto_loc   && '",'.
    mij_ship_district         = '"' && wa_data-shipto_dst   && '",'.
    mij_ship_pincode          = '"' && wa_data-shipto_pin   && '",'.
    mij_ship_state_code       = '"' && wa_data-shipto_stcd  && '"'. "*'&& '",'.
    mij_ship_phone_number     = '"' && wa_data-shipto_ph    && '",'.
    mij_ship_email            = '"' && wa_data-shipto_em    && '"'.
*    ""Ship Details Closed

*    ""Export Details Started
    "*MIJ_EXPORT_EXPORT_CATEGORY      = '"' && WA_DATA-EXPORT_CATEGORY            && '",'.
    mij_export_ship_bill_number     = '"' && wa_data-exp_shipbno           && '",'.
    mij_export_ship_bill_date       = '"' && wa_data-exp_shipbdt             && '",'.
    mij_export_country_code         = '"' && wa_data-exp_cntcode               && '",'.
    mij_export_foreign_currency     = '"' && wa_data-exp_forcur         && '",'.
    mij_export_port_code            = '"' && wa_data-exp_port                  && '"'. "&& '",'.
    "MIJ_EXPORT_EXPORT_PAYMENT       = '"' && WA_DATA-EXPORT_PAYMENT             && '"'.
*    ""Export Details Closed

*    ""Payment Details Started
    mij_payment_account_details   = '"' && wa_data-account_details      && '",'.
    mij_payment_paid_amount       = '"' && wa_data-pay_balamt           && '",'.
    mij_payment_credit_days       = '"' && wa_data-pay_crday            && '",'.
    mij_payment_credit_transfer   = '"' && wa_data-credit_transfer      && '",'.
    mij_payment_direct_debit      = '"' && wa_data-pay_dirdr            && '",'.
    mij_payment_branch_or_ifsc    = '"' && wa_data-branch_or_ifsc       && '",'.
    mij_payment_payment_mode      = '"' && wa_data-pay_mode             && '",'.
    mij_payment_payee_name        = '"' && wa_data-payee_name           && '",'.
    mij_payment_payment_due_date  = '"' && wa_data-pay_payduedt         && '",'.
    mij_payment_instruction       = '"' && wa_data-pay_payinstr         && '",'.
    mij_payment_payment_term      = '"' && wa_data-pay_payterm          && '"'.
*    ""Payment Details Closed

*    ""Reference Details Started
    mij_ref_contract_ref_number     = '"' && wa_data-contrct_contrct_ref_num     && '",'. "contract_reference_number":
    mij_ref_other_reference         = '"' && wa_data-contrct_othr_ref            && '",'. "other_reference":
    mij_ref_inv_period_start_date   = '"' && wa_data-ref_invstdt                 && '",'. "invoice_period_start_date":
    mij_ref_inv_period_end_date     = '"' && wa_data-ref_invenddt                && '",'. "invoice_period_end_date":
    mij_ref_inv_reference_number    = '"' && wa_data-ref_precinvno               && '",'. "invoice_reference_number":
    mij_ref_inv_remarks             = '"' && wa_data-ref_invrmk                  && '",'. "invoice_remarks":
    mij_ref_vendor_po_ref_number    = '"' && wa_data-contrct_ven_po_ref_num      && '",'. "vendor_po_reference_number":
    mij_ref_project_ref_number      = '"' && wa_data-contrct_proj_ref_num        && '",'. "project_reference_number":
    mij_ref_receipt_advice_number   = '"' && wa_data-contrct_recpt_adv_num       && '",'. "receipt_advice_number":
    mij_ref_batch_reference_number  = '"' && wa_data-contrct_batch_ref_num       && '"'.  "batch_reference_number":
*    ""Reference Details Closed

    IF wa_data-val_assval IS INITIAL.
      wa_data-val_assval = '0'.
    ENDIF.

    IF wa_data-val_cgstval IS INITIAL.
      wa_data-val_cgstval  = '0'.
    ENDIF.

    IF wa_data-val_sgstval IS INITIAL.
      wa_data-val_sgstval = '0'.
    ENDIF.

    IF wa_data-val_igstval IS INITIAL.
      wa_data-val_igstval = '0'.
    ENDIF.

    IF wa_data-val_cesval IS INITIAL.
      wa_data-val_cesval = '0'.
    ENDIF.

    IF wa_data-branch_or_ifsc IS INITIAL.
      wa_data-branch_or_ifsc = '0'.
    ENDIF.

    IF wa_data-val_totinvval IS INITIAL.
      wa_data-val_totinvval = '0'.
    ENDIF.

    IF wa_data-val_stcesval IS INITIAL.
      wa_data-val_stcesval = '0'.
    ENDIF.

*    ""Value Details Started
    mij_value_total_assess_value      = '' && wa_data-val_assval     && ','.  "total_assessable_value":
    mij_value_total_cgst_value        = '' && wa_data-val_cgstval    && ','.  "total_cgst_value":
    mij_value_total_sgst_value        = '' && wa_data-val_sgstval    && ','.  "total_sgst_value":
    mij_value_total_igst_value        = '' && wa_data-val_igstval    && ','.  "total_igst_value":
    mij_value_total_cess_value        = '' && wa_data-val_cesval     && ','.  "total_cess_value":
    mij_value_total_cess_non_value    = '' && wa_data-branch_or_ifsc && ','.  "total_cess_nonadvol_value":
    mij_value_total_invoice_value     = '' && wa_data-val_totinvval  && ','.  "total_invoice_value":
    mij_value_total_cess_v_state      = '' && wa_data-val_stcesval   && ','.  "total_cess_value_of_state":
    mij_value_discount                = '"' && wa_data-val_disc       && '",'.  "discount":
    mij_value_other_charge            = '"' && wa_data-val_othchrg    && '",'.   "other_charge":
*    ""Value Details Closed

    IF wa_data-val_othchrg EQ '0'.
      CLEAR mij_value_other_charge.
      mij_value_other_charge = 'null,'.
    ENDIF.
    REPLACE ALL OCCURRENCES OF '"' IN mij_value_other_charge WITH space.
    CONDENSE mij_value_other_charge.

    val_dt_roundoff                = '0'. "*Not Mandatory But should be zero
    val_dt_tot_inv_ac              = '0'. "*Not Mandatory But should be zero

    """"***New Field
    supply_typ                = '"' && wa_data-tran_catg  && '",'. "supply_type":
    slr_lgl_name              = '"' && wa_data-billfrom_trdnm    && '",'. "legal_name"
    slr_adr1                  = '"' && wa_data-billfrom_bno      && '",'. "address1":
    slr_adr2                  = '"' && wa_data-billfrom_bnm      && '",'. "address2":
    IF wa_data-billfrom_bnm IS INITIAL.
      slr_adr2                 = 'null,'.
    ENDIF.
    byr_lgl_name              = '"' && wa_data-billto_trdnm      && '",'. "legal_name"
    byr_adr1                  = '"' && wa_data-billto_bno        && '",'. "address1":
    byr_adr2                  = '"' && wa_data-billto_bnm        && '",'. "address2":
    IF wa_data-billto_bnm IS INITIAL.
      byr_adr2                 = 'null,'.
    ENDIF.
    byr_pls_supply            = '"' && wa_data-billto_stcd       && '",'.
    disp_comp_name            = '"' && wa_data-shipfrom_trdnm    && '",'. "company_name"
    disp_adr1                 = '"' && wa_data-shipfrom_bno      && '",'. "address1"
    disp_adr2                 = '"' && wa_data-shipfrom_bnm      && '",'. "address2"
    shp_lgl_name              = '"' && wa_data-shipto_trdnm      && '",'. "legal_name"
    shp_adr1                  = '"' && wa_data-shipto_bno        && '",'. "address1":
    shp_adr2                  = '"' && wa_data-shipto_bnm        && '",'. "address2":
    rfnd_clm                  = '"' && rfnd_clm                  && '",'. "refund_claim"

    pymnt_acc_no              = '"' && pymnt_acc_no              && '",'. "port_code"
    ref_inv_remark            = '"' && ref_inv_remark            && '",'.
    ref_inv_prd_strt          = '"' && ref_inv_prd_strt          && '",'.
    ref_inv_prd_end           = '"' && ref_inv_prd_end           && '",'.
    prcdg_inv_dat             = '"' && prcdg_inv_dat             && '",'.
    oth_ref                   = '"' && oth_ref                   && '"'.
    contrct_recpt_adv_num     = '"' && contrct_recpt_adv_num     && '",'.
    contrct_recpt_adv_dat     = '"' && contrct_recpt_adv_dat     && '",'.
    contrct_batch_ref_num     = '"' && contrct_batch_ref_num     && '",'.
    contrct_contrct_ref_num   = '"' && contrct_contrct_ref_num   && '",'.
    contrct_othr_ref          = '"' && contrct_othr_ref          && '",'.
    contrct_proj_ref_num      = '"' && contrct_proj_ref_num      && '",'.
    contrct_ven_po_ref_num    = '"' && contrct_ven_po_ref_num    && '",'.
    contrct_ven_po_ref_dat    = '"' && contrct_ven_po_ref_dat    && '"'.
    addl_sup_doc_url          = '"' && addl_sup_doc_url          && '",'.
    addl_sup_doc              = '"' && addl_sup_doc              && '",'.
    addl_info                 = '"' && addl_info                 && '"'.
    val_dt_roundoff           = ''  && val_dt_roundoff           && ','.
    val_dt_tot_inv_ac         = ''  && val_dt_tot_inv_ac         && ''.
    eway_transp_id            = '"' && eway_transp_id            && '",'.
    eway_transp_name          = '"' && eway_transp_name          && '",'.
    eway_transp_mode          = '"' && eway_transp_mode          && '",'.
    eway_transp_dist          = '"' && eway_transp_dist          && '",'.
    eway_transp_doc_num       = '"' && eway_transp_doc_num       && '",'.
    eway_transp_doc_dat       = '"' && eway_transp_doc_dat       && '",'.
    eway_vech_num             = '"' && eway_vech_num             && '",'.
    eway_vech_type            = '"' && eway_vech_type            && '"'.
    """""****End New Field.

    user_gstin                     = mij_seller_gstin. "'"01AMBPG7773M002",'.
    data_source                    = '"erp",'.
    """""******Start:New: JSON:Master India: 07.03.2020*****************************************************"""""""""""""""

    PERFORM: condense_variables.
    PERFORM: prepare_hdr_data.
    CLEAR:  mij_gw_string.
    DATA : lv_null TYPE char10 .
    lv_null = 'null' .
    CONDENSE : lv_null .


    SELECT SINGLE * FROM zeinv_wbtl_cred INTO @DATA(lv_webtel_cred) WHERE plant_gstin = @wa_data-billfrom_gstin  AND api_mode = 'EINV'.
    IF sy-subrc NE  0 .
      MESSAGE 'Please maintain credential' TYPE 'E' .
    ELSE .
      lv_wbtl_url = lv_webtel_cred-url_einv_gen .

    ENDIF .

    DATA : lv_gstin TYPE char20 .
    IF sy-sysid = 'DS4' .
      lv_gstin = lv_webtel_cred-einvusername .
      lv_webtel_cred-plant_gstin = lv_gstin .
    ELSE .
      lv_gstin =  wa_data-billfrom_gstin .
    ENDIF .

    CLEAR : mij_itm_gw_string , mij_gw_string , mij_gw_string .

    mij_gw_string = '{'

    && '"CDKey":' && '"' && lv_webtel_cred-cdkey && '",' """" 1000687",'
    &&  '"EInvUserName":'  && '"' && lv_webtel_cred-einvusername && '",'
    && '"EInvPassword":'   && '"' && lv_webtel_cred-einvpassword && '",'
    && '"EFUserName":'    && '"' && lv_webtel_cred-efusername && '",'
    && '"EFPassword":'   && '"' && lv_webtel_cred-efpassword && '",'
    && '"GSTIN":'  &&  '"' && lv_gstin && '",'   """" LV_WEBTEL_CRED-plant_gstin
    && '"GetQRImg":'  && '"0",'
    && '"GetSignedInvoice":'  && '"1",'
    && '"Version":"1.01",'
    && '"TranDtls":'
    && '{'
    && '"TaxSch":' && '"GST",'
    && '"SupTyp":' && supply_typ              "B2B",
    && '"RegRev":' && '"N",'
    && '"EcmGstin":' && mij_ecommerce_gstin
    && '"IgstOnIntra":' && '"N"' "MIJ_ECOMMERCE_GSTIN
    && '},'
    && '"DocDtls":'
    && '{'
    && '"Typ":' && mij_document_type    "INV",
    && '"No":'  && mij_document_number  "20-21/12PD/28",
    && '"Dt":'  && mij_document_date    "12/10/2020"
    && '},'
    && '"SellerDtls":'
    && '{'
    && '"Gstin":'  &&  '"' && lv_gstin && '",' """" && LV_WEBTEL_CRED-plant_gstin
    && '"LglNm":'  && slr_lgl_name                "MAWAI INFOTECH LTD.-HO",
    && '"TrdNm":'  && mij_seller_trade_name       "MAWAI INFOTECH LTD.-HO",
    && '"Addr1":'  && slr_adr1                    "A-164,SEC-63,NOIDA    ",
    && '"Addr2":'  && slr_adr2                    "A-164,SEC-63,NOIDA    ",
    && '"Loc":'    && mij_seller_location         "GANDHINAGAR",
    && '"Pin":'    && mij_seller_pincode          "" '110096,'  """" mij_seller_pincode                    "193502,
    && '"Stcd":'   && mij_seller_state_code         "01",
    && '"Ph":'     && mij_seller_phone_number         "9871512345",
    && '"Em":'     && mij_seller_email         "INFO@MAWAIMAIL.COM"
    && '},'
    && '"BuyerDtls":'
    && '{'
    && '"Gstin":'  && mij_buyer_gstin                "09AACCM1950C1ZT",
    && '"LglNm":'  && byr_lgl_name                "HAVELLS INDIA PVT LTD",
    && '"TrdNm":'  && mij_buyer_trade_name                "HAVELLS INDIA PVT LTD",
    && '"Pos":'    && byr_pls_supply                "9",
    && '"Addr1":'  && byr_adr1                "dwyewjhdwhdkw     ",
    && '"Addr2":'  && byr_adr2                "dwyewjhdwhdkw     ",
    && '"Loc":'    && mij_buyer_location                "Noida",
    && '"Pin":'    && mij_buyer_pincode                     "201301,
    && '"Stcd":'   && mij_buyer_state_code                "09",
    && '"Ph":'     && mij_buyer_phone_number                "9818131024",
    && '"Em":'     && mij_buyer_email                "abc@gmail.com"
    && '},'

  && '"DispDtls":' && '{'
  &&  '"Nm":' && lv_null && ','
  &&  '"Addr1":'  && lv_null && ','
  &&  '"Addr2":' && lv_null && ','
  &&  '"Loc":'  && lv_null && ','
  &&  '"Pin":'  && lv_null && ','
  &&  '"Stcd":'  && lv_null && '' &&
  '},'  .

    """ && '"DispDtls":null,'.

***"SOC for ship details changes
    IF wa_data-tran_typ EQ 'SHP'.

      mij_gw_string = mij_gw_string
      &&'"ShipDtls":'
      &&'{'
      &&'"Gstin":' && mij_ship_gstin           "29AWGPV7107B1Z1",
      &&'"LglNm":' && shp_lgl_name             "CBE company pvt ltd",
      &&'"TrdNm":' && mij_ship_trade_name      "kuvempu layout",
      &&'"Addr1":' && shp_adr1                 "7th block, kuvempu layout",
      &&'"Addr2":' && shp_adr2                 "kuvempu layout",
      &&'"Loc":'   && mij_ship_location        "Banagalore",
      &&'"Pin":'   && mij_ship_pincode                      "562160,
      &&'"Stcd":'  && mij_ship_state_code      "29"
      &&'},'.

    ELSE.
      mij_gw_string = mij_gw_string && '"ShipDtls":null,'.
    ENDIF.
***"EOC for ship details changes

    mij_gw_string = mij_gw_string
    && '"ItemList":'
        && '['
        && '{'.

    CLEAR: itm_count, line_itm.
    DESCRIBE TABLE li_final LINES line_itm.

    LOOP AT li_final INTO lw_data.
      itm_count = itm_count + 1.

*    ""Item Details Started
      IF lw_data-item_freeqty IS INITIAL.
        lw_data-item_freeqty = 0.
      ENDIF.

      IF lw_data-item_unitprice IS INITIAL.
        lw_data-item_unitprice = 0.
      ENDIF.

      IF lw_data-item_totamt IS INITIAL.
        lw_data-item_totamt = 0.
      ENDIF.

      IF lw_data-item_discount IS INITIAL.
        lw_data-item_discount = 0.
      ENDIF.

      IF lw_data-item_othchrg IS INITIAL.
        lw_data-item_othchrg = 0.
      ENDIF.

      IF lw_data-item_assamt IS INITIAL.
        lw_data-item_assamt = 0.
      ENDIF.

      IF wa_data-item_sgstrt IS INITIAL.
        wa_data-item_sgstrt = 0.
      ENDIF.

      IF lw_data-item_cgstrt IS INITIAL.
        lw_data-item_cgstrt = 0.
      ENDIF.

      IF lw_data-item_igstrt IS INITIAL.
        lw_data-item_igstrt = 0.
      ENDIF.

      IF lw_data-item_cesrt IS INITIAL.
        lw_data-item_cesrt = 0.
      ENDIF.

      IF lw_data-item_cesnonadval IS INITIAL.
        lw_data-item_cesnonadval = 0.
      ENDIF.

      IF lw_data-item_stateces IS INITIAL.
        lw_data-item_stateces = 0.
      ENDIF.

      IF lw_data-item_totitemval IS INITIAL.
        lw_data-item_totitemval = 0.
      ENDIF.

      IF lw_data-item_barcde IS INITIAL.          "*Mandatory
        lw_data-item_barcde = '123497'.
      ENDIF.

      IF lw_data-item_batch_nm IS INITIAL.        "*Mandatory
        lw_data-item_batch_nm = 'TEST123'.
      ENDIF.

      IF lw_data-item_batch_expdt IS INITIAL.     "*Mandatory
        lw_data-item_batch_expdt = '31/12/2020'.
      ENDIF.

      IF lw_data-item_batch_wrdt IS INITIAL.      "*Mandatory
        lw_data-item_batch_wrdt = '31/12/2020'.
      ENDIF.

      IF lw_data-itm_pre_tax_val  IS INITIAL.
        lw_data-itm_pre_tax_val                = '0'.
      ENDIF.

      IF lw_data-itm_gst_rate IS INITIAL.
        lw_data-itm_gst_rate                   = '0'.
      ENDIF.

      IF lw_data-itm_igst_amt IS INITIAL.
        lw_data-itm_igst_amt                   = '0'.
      ENDIF.

      IF lw_data-itm_cgst_amt IS INITIAL.
        lw_data-itm_cgst_amt                   = '0'.
      ENDIF.

      IF lw_data-itm_sgst_amt IS INITIAL.
        lw_data-itm_sgst_amt                   = '0'.
      ENDIF.

      IF lw_data-itm_cess_amt IS INITIAL.
        lw_data-itm_cess_amt                   = '0'.
      ENDIF.

      IF lw_data-itm_stat_cess_amt IS INITIAL.
        lw_data-itm_stat_cess_amt              = '0'.
      ENDIF.

      IF lw_data-itm_stat_cess_nadvol_amt IS INITIAL.
        lw_data-itm_stat_cess_nadvol_amt       = '0'.
      ENDIF.

      DATA: gs_left          TYPE  i,
            gs_right         TYPE  i,
            gs_in_separator  TYPE  c,
            gs_out_separator TYPE  c,
            char_value       TYPE  char20.

      CLEAR: gs_left, gs_right, gs_in_separator, gs_out_separator.
      gs_left             = 11.
      gs_right            = 2.
      gs_in_separator     = '.'.
      gs_out_separator    = '.'.

      SHIFT lw_data-item_unitprice LEFT DELETING LEADING space.
      IF lw_data-item_unitprice IS NOT INITIAL AND lw_data-item_unitprice NE '0'.
        char_value = lw_data-item_unitprice.
        CALL FUNCTION 'HRPBSNO_FORMAT_ZERO'
          EXPORTING
            left          = gs_left
            right         = gs_right
            in_separator  = gs_in_separator
            out_separator = gs_out_separator
          CHANGING
            str           = char_value.
        SHIFT char_value LEFT DELETING LEADING '0'.
        IF char_value+0(1) EQ '.'.
        ELSE.
          lw_data-item_unitprice = char_value.
        ENDIF.
      ENDIF.

      SHIFT lw_data-item_igstrt LEFT DELETING LEADING space.
      IF lw_data-item_igstrt IS NOT INITIAL AND lw_data-item_igstrt NE '0'.
        char_value = lw_data-item_igstrt.
        CALL FUNCTION 'HRPBSNO_FORMAT_ZERO'
          EXPORTING
            left          = gs_left
            right         = gs_right
            in_separator  = gs_in_separator
            out_separator = gs_out_separator
          CHANGING
            str           = char_value.
        SHIFT char_value LEFT DELETING LEADING '0'.
        IF char_value+0(1) EQ '.'.
        ELSE.
          lw_data-item_igstrt = char_value.
        ENDIF.
      ENDIF.

      SHIFT lw_data-itm_gst_rate  LEFT DELETING LEADING space.
      IF lw_data-itm_gst_rate IS NOT INITIAL AND lw_data-itm_gst_rate NE '0'.
        char_value = lw_data-itm_gst_rate.
        CALL FUNCTION 'HRPBSNO_FORMAT_ZERO'
          EXPORTING
            left          = gs_left
            right         = gs_right
            in_separator  = gs_in_separator
            out_separator = gs_out_separator
          CHANGING
            str           = char_value.
        SHIFT char_value LEFT DELETING LEADING '0'.
        IF char_value+0(1) EQ '.'.
        ELSE.
          lw_data-itm_gst_rate = char_value.
        ENDIF.
      ENDIF.

      SHIFT lw_data-item_sgstrt  LEFT DELETING LEADING space.
      IF lw_data-item_sgstrt IS NOT INITIAL AND lw_data-item_sgstrt NE '0'.
        char_value = lw_data-item_sgstrt.
        CALL FUNCTION 'HRPBSNO_FORMAT_ZERO'
          EXPORTING
            left          = gs_left
            right         = gs_right
            in_separator  = gs_in_separator
            out_separator = gs_out_separator
          CHANGING
            str           = char_value.
        SHIFT char_value LEFT DELETING LEADING '0'.
        IF char_value+0(1) EQ '.'.
        ELSE.
          lw_data-item_sgstrt = char_value.
        ENDIF.
      ENDIF.

      SHIFT lw_data-item_cgstrt  LEFT DELETING LEADING space.
      IF lw_data-item_cgstrt IS NOT INITIAL AND lw_data-item_cgstrt NE '0'.
        char_value = lw_data-item_cgstrt.
        CALL FUNCTION 'HRPBSNO_FORMAT_ZERO'
          EXPORTING
            left          = gs_left
            right         = gs_right
            in_separator  = gs_in_separator
            out_separator = gs_out_separator
          CHANGING
            str           = char_value.
        SHIFT char_value LEFT DELETING LEADING '0'.
        IF char_value+0(1) EQ '.'.
        ELSE.
          lw_data-item_cgstrt = char_value.
        ENDIF.
      ENDIF.

      IF wa_data-val_dt_roundoff  CA '-'.
        REPLACE '-' IN wa_data-val_dt_roundoff  WITH ' '.
        CONCATENATE    '-'  wa_data-val_dt_roundoff INTO wa_data-val_dt_roundoff." SEPARATED BY SPACE.
      ENDIF.

      mij_item_product_name         = '"' && lw_data-item_prdnm       && '",'. "product_name":
      mij_item_product_description  = '"' && lw_data-item_prddesc     && '",'. "product_description":
      mij_item_hsn_code             = '"' && lw_data-item_hsncd       && '",'. "hsn_code":  lw_data-item_hsncd  lw_data-item_hsncd'87071000'
      mij_item_bar_code             = '"' && lw_data-item_barcde      && '",'. "bar_code":
      mij_item_quantity             = ''  && lw_data-item_qty         && ','. "quantity":
      mij_item_free_quantity        = ''  && lw_data-item_freeqty     && ','. "free_quantity":
      mij_item_unit                 = '"' && lw_data-item_unit        && '",'. "unit": lw_data-item_unit
      mij_item_unit_price           = ''  && lw_data-item_unitprice   && ','. "unit_price":
      mij_item_total_amount         = ''  && lw_data-item_totamt      && ','. "total_amount":
      mij_item_discount             = ''  && lw_data-item_discount    && ','. "discount":
      mij_item_other_charge         = ''  && lw_data-item_othchrg     && ','. "other_charge":
      mij_item_assessable_value     = ''  && lw_data-item_assamt      && ','. "assessable_value":
      mij_item_sgst_rate            = ''  && lw_data-item_sgstrt      && ','. "sgst_rate":
      mij_item_cgst_rate            = ''  && lw_data-item_cgstrt      && ','. "cgst_rate":
      mij_item_igst_rate            = ''  && lw_data-item_igstrt      && ','. "igst_rate":
      mij_item_cess_rate            = ''  && lw_data-item_cesrt       && ','. "cess_rate":
      mij_item_cess_nonadvol_value  = ''  && lw_data-item_cesnonadval && ','. "cess_nonadvol_value":
      mij_item_state_cess_rate      = ''  && lw_data-item_stateces    && ','. "state_cess_rate":
      mij_item_total_item_value     = ''  && lw_data-item_totitemval  && ','.  "total_item_value":
      mij_item_batch_name           = '"' && lw_data-item_batch_nm    && '",'. "name":
      mij_item_batch_expiry_date    = '"' && lw_data-item_batch_expdt && '",'. "expiry_date":
      mij_item_batch_warranty_date  = '"' && lw_data-item_batch_wrdt  && '"'.  "warranty_date":
      itm_sr_num                    = '"' && lw_data-itm_sr_num                && '",'.
      itm_is_service                = '"' && lw_data-itm_is_service            && '",'.
      itm_pre_tax_val               = ''  && lw_data-itm_pre_tax_val           && ','.
      itm_gst_rate                  = ''  && lw_data-itm_gst_rate              && ','.
      itm_igst_amt                  = ''  && lw_data-itm_igst_amt              && ','.
      itm_cgst_amt                  = ''  && lw_data-itm_cgst_amt              && ','.
      itm_sgst_amt                  = ''  && lw_data-itm_sgst_amt              && ','.
      itm_cess_amt                  = ''  && lw_data-itm_cess_amt              && ','.
      itm_stat_cess_amt             = ''  && lw_data-itm_stat_cess_amt         && ','.
      itm_stat_cess_nadvol_amt      = ''  && lw_data-itm_stat_cess_nadvol_amt  && ','.
      itm_cntry_orgin               = '"' && lw_data-itm_cntry_orgin           && '",'.
      itm_odr_line_ref              = '"' && lw_data-itm_odr_line_ref          && '",'.
      itm_prodct_sr_num             = '"' && lw_data-itm_prodct_sr_num         && '",'.
      atr_itm_attribte_detl         = '"' && lw_data-atr_itm_attribte_detl     && '",'.
      atr_itm_attribte_val          = '"' && lw_data-atr_itm_attribte_val      && '"'.

      PERFORM: condense_variables.
      "*PERFORM: PREPARE_ITM_DATA.
**      CLEAR  : MIJ_ITM_GW_STRING.

      mij_itm_gw_string = mij_itm_gw_string
      && '"SlNo":'                 && itm_sr_num   "1",
      && '"PrdDesc":'              && mij_item_product_description   "HONDA CAR",
      && '"IsServc":'              && itm_is_service   "N",
      && '"HsnCd":'                && mij_item_hsn_code   "1001",
      && '"Barcde":'               && mij_item_bar_code   "Testing",
      && '"Qty":'                  && mij_item_quantity   "100.345,
      && '"FreeQty":'              && mij_item_free_quantity   "10,
      && '"Unit":'                 && mij_item_unit   ""BAG",
      && '"UnitPrice":'            && mij_item_unit_price   "99.545,
      && '"TotAmt":'               && mij_item_total_amount   "9988.84,
      && '"Discount":'             && mij_item_discount
      && '"PreTaxVal":'            && itm_pre_tax_val
      && '"AssAmt":'               && mij_item_assessable_value
      && '"GstRt":'                && itm_gst_rate
      && '"IgstAmt":'              && itm_igst_amt
      && '"CgstAmt":'              && itm_cgst_amt
      && '"SgstAmt":'              && itm_sgst_amt
      && '"CesRt":'                && mij_item_cess_rate
      && '"CesAmt":'               && itm_cess_amt
      && '"CesNonAdvlAmt":'        && mij_item_cess_nonadvol_value
      && '"StateCesRt":'           && mij_item_state_cess_rate
      && '"StateCesAmt":'          && itm_stat_cess_amt
      && '"StateCesNonAdvlAmt":'   && itm_stat_cess_nadvol_amt
      && '"OthChrg":'              && mij_item_other_charge
      && '"TotItemVal":'           && mij_item_total_item_value
      && '"OrdLineRef":'           && itm_odr_line_ref
      && '"OrgCntry":'             && itm_cntry_orgin
      && '"PrdSlNo":'              && itm_prodct_sr_num
      && '"BchDtls":'
      && '{'
      && '"Nm":'                   && mij_item_batch_name             "Testing",
      && '"Expdt":'                && mij_item_batch_expiry_date      "22/09/2020",
      && '"wrDt":'                 && mij_item_batch_warranty_date     "22/09/2020"
      && '},'
      && '"AttribDtls":'
      && '['
      && '{'
      && '"Nm":'  &&  atr_itm_attribte_detl        "Testing",
      && '"Val":' &&  atr_itm_attribte_val        "1001"
      && '}'
      && ']'.

      IF line_itm EQ itm_count.
        mij_itm_gw_string = mij_itm_gw_string &&  '}'.
      ELSE.
        mij_itm_gw_string = mij_itm_gw_string &&  '},{'.
      ENDIF.

      PERFORM: clear_itm_variables.
      CLEAR: lw_data.
    ENDLOOP.

    mij_gw_string = mij_gw_string
    && mij_itm_gw_string
    &&  '],'. "*']}'.

    mij_gw_string = mij_gw_string
      && '"ValDtls":'
      && '{'
      && '"AssVal":'        && mij_value_total_assess_value   "9978.84,
      && '"CgstVal":'       && mij_value_total_cgst_value   "0.0,
      && '"SgstVal":'       && mij_value_total_sgst_value   "0.0,
      && '"IgstVal":'       && mij_value_total_igst_value   "1197.46,
      && '"CesVal":'        && mij_value_total_cess_value   "508.94,
      && '"StCesVal":'      && mij_value_total_cess_v_state   "1202.46,
      && '"Discount":'      && '0,'  "10.0,
      && '"OthChrg":'       && mij_value_other_charge "*'0,'  "20.0,
      && '"RndOffAmt":'     && val_dt_roundoff  "0.3,
      && '"TotInvVal":'     && mij_value_total_invoice_value  "12908.0,
      && '"TotInvValFc":'   && val_dt_tot_inv_ac  "12897.7
      && '},'
      && '"PayDtls":null,'
      && '"RefDtls":null,'

       &&      '"AddlDocDtls":' && '['
       && '{'
       &&  '"Url":' && '"https://einv-apisandbox.nic.in",'
       && '"Docs":' && '"Test Doc",'
       && '"Info":' &&  '"Document Test"'
       && '}'
       && '],'

*      && '"AddlDocDtls":null,'

  && '"ExpDtls":' && '{'
  && '"ShipBNo":'  &&  '"A-248",'
  &&  '"ShipBDt":'  && '"01/08/2020",'
  && '"Port":' &&  '"INABG1",'
  && '"RefClm":' &&  '"N",'
  && '"ForCur":'  && '"AED",'
  && '"CntCode":'  && '"AE",'
  && '"ExpDuty":' &&  'null'
  && '},'

*      && '"ExpDtls":null,'
      && '"EwbDtls":null'
      && '}'.

    CONDENSE mij_gw_string.

    .

*    IF gw_showj IS INITIAL.
    PERFORM call_webtel_api_to_gen_irn.
*      PERFORM call_taxila_api_to_gen_irn.
*    ELSE.
*      CLEAR: text.
*      text = mij_gw_string.
*      CALL SCREEN '9002'.
*    ENDIF.

    CLEAR: wa_data.
  ENDLOOP.
*  ""------------------------------------------------------------------------------------""
  REFRESH: ct_final[].


ENDFORM.
*&---------------------------------------------------------------------*
*& Form call_webtel_api_to_gen_irn
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM call_webtel_api_to_gen_irn .

  """*********
  TYPES: BEGIN OF ty_success,
           success TYPE string,
           message TYPE string,
         END OF ty_success.

  TYPES: BEGIN OF ty_result,
           ackno         TYPE string,
           ackdt         TYPE string,
           irn           TYPE string,
           signedinvoice TYPE string,
           signedqrcode  TYPE string,
           status        TYPE string,
           ewbno         TYPE string,
           ewbdt         TYPE string,
           ewbvalidtill  TYPE string,
         END OF ty_result.

  DATA: BEGIN OF it_girn,
          success TYPE string,
          message TYPE string,
          result  TYPE ty_result,
        END OF it_girn.

  DATA: wa_success TYPE ty_success,
        wa_result  TYPE ty_result.
  """*******

  DATA:
    lv1(255)  TYPE c,
    lv2(255)  TYPE c,
    lv3(255)  TYPE c,
    lv4(255)  TYPE c,
    lv5(255)  TYPE c,
    lv6(5000) TYPE c,
    lv7(5000) TYPE c,
    lv8       TYPE string,
    lv9       TYPE string,
    lv10      TYPE string,
    lv11      TYPE string,
    lv12      TYPE string,
    lv13      TYPE string,
    lv14      TYPE string,
    lv15      TYPE string,
    lv16      TYPE string,
    lv17      TYPE string,
    lv18      TYPE string,
    lv19      TYPE string,
    lv20      TYPE string,
    lv21      TYPE string,
    lv22      TYPE string,
    lv23      TYPE string,
    lv24      TYPE string,
    lv25      TYPE string,
    lv26      TYPE string,
    lv27      TYPE string,
    lv28      TYPE string,
    lv29      TYPE string,
    lv30      TYPE string,
    lv31      TYPE string,
    lv32      TYPE string,
    lv33      TYPE string,
    lv34      TYPE string,
    lv35      TYPE string.

  ""Create Json String
  DATA: gw_string1(15000) TYPE c,
        lv_index          TYPE sy-tabix,
        lv_idx(100)       TYPE c,
        lv_line           TYPE i,
        rlength1          TYPE i,
        w_string1         TYPE string.

******data declaration for creating HTTP Client, Request, Error description, error code etc
  DATA: glo_http_client1          TYPE REF TO if_http_client,
        gld_request1              TYPE REF TO if_http_request,
        gw_http_error_descr1      TYPE string,
        gw_http_error_descr_long1 TYPE xstring,
        gw_http_return_code1      TYPE i.

* data Variables declaration for passing URL, Result String(Using get_cdata())
  DATA:gp_url1            TYPE string,
       gw_xml_result_str1 TYPE string.

* data Variables declaration for passing the xml input data into API as a string and lenth
  DATA: grlength1 TYPE i.
  DATA: lv_rand  TYPE i,
        rand_num TYPE char10.

  CLEAR: lv_rand, rand_num.
  CALL FUNCTION 'QF05_RANDOM_INTEGER'
    EXPORTING
      ran_int_max   = 1000
      ran_int_min   = 1
    IMPORTING
      ran_int       = lv_rand
    EXCEPTIONS
      invalid_input = 1.

  rand_num = lv_rand.
  SHIFT rand_num LEFT DELETING LEADING space.

  CLEAR: usr_name, usr_pass, usr_gstin, usr_reqid, usr_auth, url_canc, url_det, url_gen, url_tkn.
*  usr_name    = gw_txila-usr_name.
*  usr_pass    = gw_txila-usr_pass.
  "*USR_GSTIN   = '01AMBPG7773M002'.
*  usr_reqid   = 'MAWAI' && rand_num. "*'any_alpha_numeric_value'.
*  CONCATENATE 'Bearer' access_token INTO usr_auth SEPARATED BY space.
  "*USR_AUTH    = ACCESS_TOKEN.
*  url_gen     = gw_txila-url_gen.
*  gp_url1     = url_gen.
*  CONDENSE usr_reqid.

  CLEAR :grlength1.
  w_string1 = mij_gw_string.
  grlength1 = strlen( w_string1 ).
**  BREAK mawai_sd .
**  BREAK mawai_abap .

  gp_url1 = lv_wbtl_url.
  .
*  gp_url1 = 'http://EinvSandbox.webtel.in/v1.03/GenIRN2' .

*****Creation of HTTP Client
  cl_http_client=>create_by_url(
    EXPORTING
      url                = gp_url1
    IMPORTING
      client             = glo_http_client1
    EXCEPTIONS
      argument_not_found = 1
      plugin_not_active  = 2
      internal_error     = 3
      OTHERS             = 4 ).

***** Set up the HTTP data passing method
  CALL METHOD glo_http_client1->request->set_method
    EXPORTING
      method = 'POST'.

*** Set up the HTTP Post version
  CALL METHOD glo_http_client1->request->set_version
    EXPORTING
*     version = '1001'.
      version = if_http_request=>co_protocol_version_1_1.   " 1001

****set the content type of request data
  CALL METHOD glo_http_client1->request->if_http_entity~set_content_type
    EXPORTING
      content_type = 'application/json; charset=utf-8'.

****Set up the HTTP header
*  glo_http_client1->request->set_header_field(
*    name = 'Host'
*    value = gp_url1
*    ).

*  glo_http_client1->request->set_header_field(
*    name  = 'user_name'
*    value = usr_name
*    ).

*  glo_http_client1->request->set_header_field(
*    name  = 'password'
*    value = usr_pass
*    ).

*  glo_http_client1->request->set_header_field(
*    name  = 'gstin'
*    value = usr_ngstin "*USER_GSTIN
*    ).

*  glo_http_client1->request->set_header_field(
*    name  = 'requestid'
*    value = usr_reqid
*    ).

*  glo_http_client1->request->set_header_field(
*    name  = 'Authorization'
*    value = usr_auth
*    ).

**Set up the HTTP data i.e pass/set the data into API
  CALL METHOD glo_http_client1->request->set_cdata
    EXPORTING
      data   = w_string1
      offset = 0
      length = grlength1.

*** Send the HTTP Post request to the URL.
  CALL METHOD glo_http_client1->send
    EXPORTING
      timeout                    = 60   " 15 Seconds
    EXCEPTIONS
      http_communication_failure = 1
      http_invalid_state         = 2.

****Read the Response from API
  CALL METHOD glo_http_client1->receive
    EXCEPTIONS
      http_communication_failure = 1
      http_invalid_state         = 2
      http_processing_failed     = 3.

* Get the HTTP return code from the HTTP POST:
  glo_http_client1->response->get_status( IMPORTING code = gw_http_return_code1 ).
  glo_http_client1->response->get_status( IMPORTING reason = gw_http_error_descr1 ).
  gw_http_error_descr_long1 = glo_http_client1->response->get_raw_message( ).

  CALL METHOD glo_http_client1->refresh_request(
    EXCEPTIONS
      http_action_failed = 1
      OTHERS             = 2 ).

*****Write the data received back from the POST to the screen:
  CLEAR gw_xml_result_str1.
  gw_xml_result_str1 = glo_http_client1->response->get_cdata( ).
  glo_http_client1->close( ).
  sy-tmaxl = strlen( gw_xml_result_str1 ).

  FIELD-SYMBOLS: <gfs1>.
  ASSIGN gw_xml_result_str1 TO <gfs1>.
  CLEAR: gv_api_ret_msg.
  gv_api_ret_msg = <gfs1>.

***""-----------------------------ECC---------------------------------------------""
***""Segregate Success/Error Message

  DATA: lv_main    TYPE string,
        lv_string1 TYPE string,
        lv_string2 TYPE string,
        lv_string3 TYPE string,
        lv_string4 TYPE string,
        lv_success TYPE string.

  IF <gfs1> IS ASSIGNED.
    lv_main = <gfs1>.
  ENDIF.

  CLEAR: lv_string1, lv_string2, lv_string3, lv_string4.
  SPLIT lv_main AT '"Status":"' INTO lv_string1 lv_string2.

  DATA : lv_a TYPE string, lv_b TYPE string,lv_c TYPE string .
  """""" added by sumit :""""" split messsage for webtel . . .. ..  """"" sumit """"
  IF lv_string2 IS NOT INITIAL AND lv_string2+0(1) = '1' .

    """""""""""""""""""""""""""""""""
    SPLIT gw_xml_result_str1 AT '"Irn":"' INTO lv_a lv_b .
    CLEAR  : lv_a .
    SPLIT lv_b AT '"' INTO lv_a lv_c .
    irn_value = lv_a .
    CLEAR : lv_a , lv_b .

    SPLIT gw_xml_result_str1 AT '"SignedQRCode":"' INTO lv_a lv_b .
    CLEAR  : lv_a .
    SPLIT lv_b AT '"' INTO lv_a lv_c .
    signedqrcode  = lv_a .

    CLEAR : lv_a , lv_b .
    SPLIT gw_xml_result_str1 AT '"SignedInvoice":"' INTO lv_a lv_b .
    CLEAR  : lv_a .
    SPLIT lv_b AT '"' INTO lv_a lv_c .
    signedinvoice  = lv_a .

    CLEAR : lv_a , lv_b .
    SPLIT gw_xml_result_str1 AT '"AckDate":"' INTO lv_a lv_b .
    CLEAR  : lv_a .
    SPLIT lv_b AT '"' INTO lv_a lv_c .
    ackdate  = lv_a .

    CLEAR : lv_a , lv_b .
    SPLIT gw_xml_result_str1 AT '"AckNo":' INTO lv_a lv_b .
    CLEAR  : lv_a .
    SPLIT lv_b AT '"' INTO lv_a lv_c .
    REPLACE ALL OCCURRENCES OF ',' IN lv_a WITH '' .
    ackno  = lv_a .

    """""""""""""""""""""""""""""""""

    wa_success-success = 'true'.
    wa_success-message = 'IRN generated successfully'.

    wa_result-irn             = irn_value.
    wa_result-signedinvoice   = signedinvoice.
    wa_result-signedqrcode    = signedqrcode.

    gs_irn        = wa_result-irn.
    signedinvoice = wa_result-signedinvoice.
    signedqrcode  = wa_result-signedqrcode.

    CONDENSE: ackno,ackdate.

    IF gs_irn IS NOT INITIAL.

      CLEAR : gw_head.
      gw_head-tdobject = 'VBBK'.
      gw_head-tdname   = wa_data-vbeln.
      gw_head-tdid     = 'ZIRN'.
      gw_head-tdspras  = sy-langu.

      REFRESH : gt_lines[].
      gw_lines-tdformat = '*'.
      gw_lines-tdline  = gs_irn.
      APPEND gw_lines TO gt_lines.
      CLEAR : gw_lines.

      CALL FUNCTION 'SAVE_TEXT'
        EXPORTING
          client          = sy-mandt
          header          = gw_head
          savemode_direct = 'X'
        TABLES
          lines           = gt_lines.

    ENDIF.

    DATA: lt_string_comp TYPE TABLE OF swastrtab,
          lw_string_comp TYPE swastrtab,
          lv_longtext    TYPE string.

    IF signedqrcode IS NOT INITIAL.

      CLEAR : gw_head.
      gw_head-tdobject = 'VBBK'.
      gw_head-tdname   = wa_data-vbeln.
      gw_head-tdid     = 'ZQRC'.
      gw_head-tdspras  = sy-langu.

      REFRESH: lt_string_comp[].
      CLEAR: lv_longtext.
      lv_longtext = signedqrcode.
      CALL FUNCTION 'SWA_STRING_SPLIT'
        EXPORTING
          input_string         = lv_longtext     "string to be split
          max_component_length = 130
        TABLES
          string_components    = lt_string_comp.

      REFRESH gt_lines[].
      LOOP AT lt_string_comp INTO lw_string_comp.

        gw_lines-tdformat = '*'.
        gw_lines-tdline   = lw_string_comp-str. "LS_RETURN-SIGNEDQRCODE.
        APPEND gw_lines TO gt_lines.

        CLEAR : gw_lines, lw_string_comp.
      ENDLOOP.

      CALL FUNCTION 'SAVE_TEXT'
        EXPORTING
          client          = sy-mandt
          header          = gw_head
          savemode_direct = 'X'
        TABLES
          lines           = gt_lines.

    ENDIF.

    ""**Start: Save Data in ztable: ZSD_EINVOICE
    PERFORM save_data_into_ztable.

  ELSE .

    PERFORM update_ztable_for_error.
    ""**End: Modify display internal table: : in case of error

    CLEAR: text.
    text = gv_api_ret_msg.
    CALL SCREEN '9002'.

  ENDIF .

ENDFORM.
*&---------------------------------------------------------------------*
*& Form cancel_irn_from_webtel
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM cancel_irn_from_webtel .

******data declaration for creating HTTP Client, Request, Error description, error code etc
  DATA: clo_http_client          TYPE REF TO if_http_client,
        cld_request              TYPE REF TO if_http_request,
        cw_http_error_descr      TYPE string,
        cw_http_error_descr_long TYPE xstring,
        cw_http_return_code      TYPE i.

* data Variables declaration for passing URL, Result String(Using get_cdata())
  DATA:cp_url            TYPE string,
       cw_xml_result_str TYPE string.

* data Variables declaration for passing the xml input data into API as a string and lenth
  DATA: crlength         TYPE i,
        cw_string        TYPE string,
        cgw_string(5000) TYPE c,
        cancl_irn        TYPE string.

  DATA:
    lv1(255)   TYPE c,
    lv2(255)   TYPE c,
    lv3(255)   TYPE c,
    lv4(255)   TYPE c,
    lv5(255)   TYPE c,
    lv6(5000)  TYPE c,
    lv7(5000)  TYPE c,
    lv8(255)   TYPE c,
    lv9(255)   TYPE c,
    lv10(100)  TYPE c,
    lv11(100)  TYPE c,
    lv12(100)  TYPE c,
    lv13(100)  TYPE c,
    lv14(100)  TYPE c,
    lv15(100)  TYPE c,
    lv16(100)  TYPE c,
    lv17(100)  TYPE c,
    lv18(100)  TYPE c,
    lv19(100)  TYPE c,
    lv20(200)  TYPE c,
    lv21(100)  TYPE c,
    lv22(5000) TYPE c,
    lv23(100)  TYPE c,
    lv24(5000) TYPE c,
    lv25(100)  TYPE c,
    lv26(100)  TYPE c,
    lv27(100)  TYPE c,
    lv28(100)  TYPE c,
    lv29(100)  TYPE c,
    lv30(100)  TYPE c,
    lv31(100)  TYPE c,
    lv32(100)  TYPE c,
    lv33(100)  TYPE c,
    lv34(100)  TYPE c,
    lv35(100)  TYPE c.

  CLEAR: wa_data.
  LOOP AT gt_final INTO wa_data WHERE check = 'X'.

    SELECT SINGLE * FROM zeinv_wbtl_cred INTO @DATA(lv_webtel_cred) WHERE plant_gstin = @wa_data-billfrom_gstin  AND api_mode = 'EINV'.
    IF sy-subrc NE  0 .
      MESSAGE 'Please maintain credential' TYPE 'E' .
    ELSE .

    ENDIF .

    DATA : lv_gstin TYPE char20 .
    IF sy-sysid = 'DS4' .
      lv_gstin = lv_webtel_cred-einvusername .
      lv_webtel_cred-plant_gstin = lv_gstin .
    ELSE .
      lv_gstin =  wa_data-billfrom_gstin .
    ENDIF .

    PERFORM validate_alreday_done_action.

    CLEAR: cancl_irn.
    cancl_irn = '"' && wa_data-irn && '",'.
    CONDENSE cancl_irn.
    CONDENSE access_token.

    mij_seller_gstin = '"' && lv_gstin && '",'.
    CONDENSE mij_seller_gstin.
    user_gstin  = mij_seller_gstin.




**    && '"CDKey":' && '"' && LV_WEBTEL_CRED-cdkey && '",' """" 1000687",'
**    &&  '"EInvUserName":'  && '"' && LV_WEBTEL_CRED-einvusername && '",'
**    && '"EInvPassword":'   && '"' && LV_WEBTEL_CRED-einvpassword && '",'
**    && '"EFUserName":'    && '"' && LV_WEBTEL_CRED-efusername && '",'
**    && '"EFPassword":'   && '"' && LV_WEBTEL_CRED-efpassword && '",'
**    && '"GSTIN":'  &&  '"' && LV_GSTIN && '",'   """" LV_WEBTEL_CRED-plant_gstin

    cw_string = '{'
 && '"Push_Data_List":' && '{'
 && '"Data":' && '['
 && '{'
 && '"Irn":' && cancl_irn
 && '"GSTIN":' && user_gstin
 && '"CnlRsn":' && '"1",'
 && '"CnlRem":' && '"Wrong Entry",'
 && '"CDKey":' && '"' && lv_webtel_cred-cdkey && '",' """" 1000687",'
 && '"EFUserName":' && '"' && lv_webtel_cred-efusername && '",' """user_gstin
 && '"EFPassword":'  && '"' && lv_webtel_cred-efpassword && '",'
 && '"EInvUserName":' && '"' && lv_webtel_cred-einvusername && '",'
 && '"EInvPassword":'  && '"' && lv_webtel_cred-einvpassword && '"'
 && '}'
 && ']'
 && '}'
 && '}' .


    cp_url = lv_webtel_cred-url_einv_canc .

    """*********************************************"""""
    CLEAR :crlength.
    cw_string = cw_string. "= LV_JSON.
    crlength = strlen( cw_string ).

    """*********************************************"""""
**  PERFORM CREATE_URL.
    """*********************************************"""""
*****Creation of HTTP Client
    cl_http_client=>create_by_url(
      EXPORTING
        url                = cp_url
      IMPORTING
        client             = clo_http_client
      EXCEPTIONS
        argument_not_found = 1
        plugin_not_active  = 2
        internal_error     = 3
        OTHERS             = 4 ).

    """*********************************************"""""
**  PERFORM SET_CALLING_METHOD.
    """*********************************************"""""
***** Set up the HTTP data passing method
    CALL METHOD clo_http_client->request->set_method
      EXPORTING
        method = 'POST'.

    """*********************************************"""""
**  PERFORM SET_VERSION.
    """*********************************************"""""
*** Set up the HTTP Post version
    CALL METHOD clo_http_client->request->set_version
      EXPORTING
        version = if_http_request=>co_protocol_version_1_1.   " 1001

    """*********************************************"""""
**  PERFORM SET_CONTENT_TYPE.
    """*********************************************"""""
****set the content type of request data
    CALL METHOD clo_http_client->request->if_http_entity~set_content_type
      EXPORTING
        content_type = 'application/json; charset=utf-8'.

    """*********************************************"""""
**  PERFORM SETUP_HTTP_HEADER.
    """*********************************************"""""
****Set up the HTTP header
    clo_http_client->request->set_header_field(
      name  = 'Host'
      value = cp_url
    ).

    """*********************************************"""""
**  PERFORM PASS_DATA_TO_API.
    """*********************************************"""""
**Set up the HTTP data i.e pass/set the data into API
    CALL METHOD clo_http_client->request->set_cdata
      EXPORTING
        data   = cw_string
        offset = 0
        length = crlength.

    """*********************************************"""""
**  PERFORM SEND_HTTP_REQUEST.
    """*********************************************"""""
    clo_http_client->propertytype_logon_popup = if_http_client=>co_disabled.

*** Send the HTTP Post request to the URL.
    CALL METHOD clo_http_client->send
      EXPORTING
        timeout                    = 60   " 15 Seconds
      EXCEPTIONS
        http_communication_failure = 1
        http_invalid_state         = 2.

    """*********************************************"""""
**  PERFORM RECEIVE_RESPONSE.
    """*********************************************"""""
****Read the Response from API
    CALL METHOD clo_http_client->receive
      EXCEPTIONS
        http_communication_failure = 1
        http_invalid_state         = 2
        http_processing_failed     = 3.

    """*********************************************"""""
**  PERFORM DISPLAY_RESPONSE.
    """*********************************************"""""
* Get the HTTP return code from the HTTP POST:
    clo_http_client->response->get_status( IMPORTING code = cw_http_return_code ).
    clo_http_client->response->get_status( IMPORTING reason = cw_http_error_descr ).
    cw_http_error_descr_long = clo_http_client->response->get_raw_message( ).

    CALL METHOD clo_http_client->refresh_request(
      EXCEPTIONS
        http_action_failed = 1
        OTHERS             = 2 ).


*****Write the data received back from the POST to the screen:
    CLEAR cw_xml_result_str.
    cw_xml_result_str = clo_http_client->response->get_cdata( ).
    sy-tmaxl = strlen( cw_xml_result_str ).
    FIELD-SYMBOLS: <cfs>.
    ASSIGN cw_xml_result_str TO <cfs>.
    "* WRITE:/ <CFS>(SY-TMAXL).

    """"""""""***************************************
    DATA: lv_main    TYPE string,
          lv_string1 TYPE string,
          lv_string2 TYPE string,
          lv_string3 TYPE string,
          lv_string4 TYPE string,
          lv_success TYPE string.

    IF <cfs> IS ASSIGNED.
      lv_main = <cfs>.
      gv_api_ret_msg = <cfs>.
    ENDIF.
    DATA : lv_a TYPE string, lv_b TYPE string,lv_c TYPE string .
    CLEAR: lv_string1, lv_string2, lv_string3, lv_string4, canc_irn.
    SPLIT lv_main AT '"Status":"' INTO lv_string1 lv_string2.

*      .

    IF lv_string2 IS NOT INITIAL AND lv_string2+0(1) = '1' .

      """""""""""""""""""""""""""""""""
      SPLIT cw_xml_result_str AT '"CancelDate":"' INTO lv_a lv_b .
      CLEAR  : lv_a .
      SPLIT lv_b AT '"' INTO lv_a lv_c .
      irn_value = lv_a .
      CLEAR : lv_a , lv_b .

      canc_irn = 'X'.
      gs_irn   = wa_data-irn .
      """""""""""""""""""""""""""""""""

*    wa_success-success = 'true'.
*    wa_success-message = 'IRN Cancelled successfully'.

      ""**Start: Save Data in ztable: ZSD_EINVOICE
      PERFORM save_data_into_ztable.
*      perform cancel_billing_document.

    ELSE .

      PERFORM update_ztable_for_error.
      ""**End: Modify display internal table: : in case of error

      CLEAR: text.
      text = gv_api_ret_msg.
      CALL SCREEN '9002'.

    ENDIF .

  ENDLOOP.

ENDFORM.
